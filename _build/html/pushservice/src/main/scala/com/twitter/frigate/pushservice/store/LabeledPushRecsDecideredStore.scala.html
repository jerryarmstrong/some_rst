<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../../../../" id="documentation_options" src="../../../../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>package com.twitter.frigate.pushservice.store</p>
<p>import com.twitter.conversions.DurationOps._
import com.twitter.finagle.stats.StatsReceiver
import com.twitter.frigate.common.candidate.TargetDecider
import com.twitter.frigate.common.history.History
import com.twitter.frigate.common.history.HistoryStoreKeyContext
import com.twitter.frigate.common.history.PushServiceHistoryStore
import com.twitter.frigate.data_pipeline.thriftscala._
import com.twitter.frigate.thriftscala.FrigateNotification
import com.twitter.hermit.store.labeled_push_recs.LabeledPushRecsJoinedWithNotificationHistoryStore
import com.twitter.logging.Logger
import com.twitter.storehaus.ReadableStore
import com.twitter.util.Future
import com.twitter.util.Time</p>
<dl class="simple">
<dt>case class LabeledPushRecsVerifyingStoreKey(</dt><dd><p>historyStoreKey: HistoryStoreKeyContext,
useHydratedDataset: Boolean,
verifyHydratedDatasetResults: Boolean) {
def userId: Long = historyStoreKey.targetUserId</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>case class LabeledPushRecsVerifyingStoreResponse(</dt><dd><p>userHistory: UserHistoryValue,
unequalNotificationsUnhydratedToHydrated: Option[</p>
<blockquote>
<div><p>Map[(Time, FrigateNotification), FrigateNotification]</p>
</div></blockquote>
<p>],
missingFromHydrated: Option[Map[Time, FrigateNotification]])</p>
</dd>
<dt>case class LabeledPushRecsVerifyingStore(</dt><dd><p>labeledPushRecsStore: ReadableStore[UserHistoryKey, UserHistoryValue],
historyStore: PushServiceHistoryStore</p>
</dd>
<dt>)(</dt><dd><dl>
<dt>implicit stats: StatsReceiver)</dt><dd><p>extends ReadableStore[LabeledPushRecsVerifyingStoreKey, LabeledPushRecsVerifyingStoreResponse] {</p>
</dd>
<dt>private def getByJoiningWithRealHistory(</dt><dd><p>key: HistoryStoreKeyContext</p>
</dd>
<dt>): Future[Option[UserHistoryValue]] = {</dt><dd><p>val historyFut = historyStore.get(key, Some(365.days))
val toJoinWithRealHistoryFut = labeledPushRecsStore.get(UserHistoryKey.UserId(key.targetUserId))
Future.join(historyFut, toJoinWithRealHistoryFut).map {</p>
<blockquote>
<div><p>case (_, None) =&gt; None
case (History(realtimeHistoryMap), Some(uhValue)) =&gt;</p>
<blockquote>
<div><dl class="simple">
<dt>Some(</dt><dd><dl class="simple">
<dt>LabeledPushRecsJoinedWithNotificationHistoryStore</dt><dd><p>.joinLabeledPushRecsSentWithNotificationHistory(uhValue, realtimeHistoryMap, stats)</p>
</dd>
</dl>
</dd>
</dl>
<p>)</p>
</div></blockquote>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private def processUserHistoryValue(uhValue: UserHistoryValue): Map[Time, FrigateNotification] = {</dt><dd><dl>
<dt>uhValue.events</dt><dd><p>.getOrElse(Nil)
.collect {</p>
<blockquote>
<div><dl>
<dt>case Event(</dt><dd><blockquote>
<div><blockquote>
<div><p>EventType.LabeledPushRecSend,
Some(tsMillis),
Some(EventUnion.LabeledPushRecSendEvent(lprs: LabeledPushRecSendEvent))</p>
</div></blockquote>
<p>) if lprs.pushRecSendEvent.frigateNotification.isDefined =&gt;</p>
</div></blockquote>
<p>Time.fromMilliseconds(tsMillis) -&gt; lprs.pushRecSendEvent.frigateNotification.get</p>
</dd>
</dl>
</div></blockquote>
<p>}
.toMap</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<dl>
<dt>override def get(</dt><dd><p>key: LabeledPushRecsVerifyingStoreKey</p>
</dd>
<dt>): Future[Option[LabeledPushRecsVerifyingStoreResponse]] = {</dt><dd><p>val uhKey = UserHistoryKey.UserId(key.userId)
if (!key.useHydratedDataset) {</p>
<blockquote>
<div><dl class="simple">
<dt>getByJoiningWithRealHistory(key.historyStoreKey).map { uhValueOpt =&gt;</dt><dd><p>uhValueOpt.map { uhValue =&gt; LabeledPushRecsVerifyingStoreResponse(uhValue, None, None) }</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<dl>
<dt>} else {</dt><dd><dl>
<dt>labeledPushRecsStore.get(uhKey).flatMap { hydratedValueOpt: Option[UserHistoryValue] =&gt;</dt><dd><dl>
<dt>if (!key.verifyHydratedDatasetResults) {</dt><dd><dl class="simple">
<dt>Future.value(hydratedValueOpt.map { uhValue =&gt;</dt><dd><p>LabeledPushRecsVerifyingStoreResponse(uhValue, None, None)</p>
</dd>
</dl>
<p>})</p>
</dd>
<dt>} else {</dt><dd><dl>
<dt>getByJoiningWithRealHistory(key.historyStoreKey).map {</dt><dd><dl>
<dt>joinedWithRealHistoryOpt: Option[UserHistoryValue] =&gt;</dt><dd><dl class="simple">
<dt>val joinedWithRealHistoryMap =</dt><dd><p>joinedWithRealHistoryOpt.map(processUserHistoryValue).getOrElse(Map.empty)</p>
</dd>
</dl>
<p>val hydratedMap = hydratedValueOpt.map(processUserHistoryValue).getOrElse(Map.empty)
val unequal = joinedWithRealHistoryMap.flatMap {</p>
<blockquote>
<div><dl>
<dt>case (time, frigateNotif) =&gt;</dt><dd><dl class="simple">
<dt>hydratedMap.get(time).collect {</dt><dd><p>case n if n != frigateNotif =&gt; ((time, frigateNotif), n)</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
</div></blockquote>
<p>}
val missing = joinedWithRealHistoryMap.filter {</p>
<blockquote>
<div><p>case (time, frigateNotif) =&gt; !hydratedMap.contains(time)</p>
</div></blockquote>
<p>}
hydratedValueOpt.map { hydratedValue =&gt;</p>
<blockquote>
<div><p>LabeledPushRecsVerifyingStoreResponse(hydratedValue, Some(unequal), Some(missing))</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>case class LabeledPushRecsStoreKey(target: TargetDecider, historyStoreKey: HistoryStoreKeyContext) {</dt><dd><p>def userId: Long = historyStoreKey.targetUserId</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>case class LabeledPushRecsDecideredStore(</dt><dd><dl class="simple">
<dt>verifyingStore: ReadableStore[</dt><dd><p>LabeledPushRecsVerifyingStoreKey,
LabeledPushRecsVerifyingStoreResponse</p>
</dd>
</dl>
<p>],
useHydratedLabeledSendsDatasetDeciderKey: String,
verifyHydratedLabeledSendsForHistoryDeciderKey: String</p>
</dd>
<dt>)(</dt><dd><dl class="simple">
<dt>implicit globalStats: StatsReceiver)</dt><dd><p>extends ReadableStore[LabeledPushRecsStoreKey, UserHistoryValue] {</p>
</dd>
</dl>
<p>private val log = Logger()
private val stats = globalStats.scope(“LabeledPushRecsDecideredStore”)
private val numComparisons = stats.counter(“num_comparisons”)
private val numMissingStat = stats.stat(“num_missing”)
private val numUnequalStat = stats.stat(“num_unequal”)</p>
<dl>
<dt>override def get(key: LabeledPushRecsStoreKey): Future[Option[UserHistoryValue]] = {</dt><dd><dl class="simple">
<dt>val useHydrated = key.target.isDeciderEnabled(</dt><dd><p>useHydratedLabeledSendsDatasetDeciderKey,
stats,
useRandomRecipient = true</p>
</dd>
</dl>
<p>)</p>
<dl>
<dt>val verifyHydrated = if (useHydrated) {</dt><dd><dl class="simple">
<dt>key.target.isDeciderEnabled(</dt><dd><p>verifyHydratedLabeledSendsForHistoryDeciderKey,
stats,
useRandomRecipient = true</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
<p>} else false</p>
<p>val newKey = LabeledPushRecsVerifyingStoreKey(key.historyStoreKey, useHydrated, verifyHydrated)
verifyingStore.get(newKey).map {</p>
<blockquote>
<div><p>case None =&gt; None
case Some(LabeledPushRecsVerifyingStoreResponse(uhValue, unequalOpt, missingOpt)) =&gt;</p>
<blockquote>
<div><dl>
<dt>(unequalOpt, missingOpt) match {</dt><dd><dl class="simple">
<dt>case (Some(unequal), Some(missing)) =&gt;</dt><dd><p>numComparisons.incr()
numMissingStat.add(missing.size)
numUnequalStat.add(unequal.size)</p>
</dd>
</dl>
<p>case _ =&gt; //no-op</p>
</dd>
</dl>
<p>}
Some(uhValue)</p>
</div></blockquote>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../../../../index2.rst.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../../../../index2.rst.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../../../../_sources/pushservice/src/main/scala/com/twitter/frigate/pushservice/store/LabeledPushRecsDecideredStore.scala.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>