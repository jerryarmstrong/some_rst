<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>use crate::{MAX_NUM_INPUTS, MAX_NUM_MODELS, MAX_NUM_OUTPUTS};
use arrayvec::ArrayVec;
use clap::Parser;
use log::info;
use once_cell::sync::OnceCell;
use std::error::Error;
use time::OffsetDateTime;
use time::format_description::well_known::Rfc3339;
#[derive(Parser, Debug, Clone)]
///Navi is configured through CLI arguments(for now) defined below.
//TODO: use clap_serde to make it config file driven
pub struct Args {</p>
<blockquote>
<div><p>#[clap(short, long, help = “gRPC port Navi runs ons”)]
pub port: i32,
#[clap(long, default_value_t = 9000, help = “prometheus metrics port”)]
pub prometheus_port: u16,
#[clap(</p>
<blockquote>
<div><p>short,
long,
default_value_t = 1,
help = “number of worker threads for tokio async runtime”</p>
</div></blockquote>
<p>)]
pub num_worker_threads: usize,
#[clap(</p>
<blockquote>
<div><p>long,
default_value_t = 14,
help = “number of blocking threads in tokio blocking thread pool”</p>
</div></blockquote>
<p>)]
pub max_blocking_threads: usize,
#[clap(long, default_value = “16”, help = “maximum batch size for a batch”)]
pub max_batch_size: Vec&lt;String&gt;,
#[clap(</p>
<blockquote>
<div><p>short,
long,
default_value = “2”,
help = “max wait time for accumulating a batch”</p>
</div></blockquote>
<p>)]
pub batch_time_out_millis: Vec&lt;String&gt;,
#[clap(</p>
<blockquote>
<div><p>long,
default_value_t = 90,
help = “threshold to start dropping batches under stress”</p>
</div></blockquote>
<p>)]
pub batch_drop_millis: u64,
#[clap(</p>
<blockquote>
<div><p>long,
default_value_t = 300,
help = “polling interval for new version of a model and META.json config”</p>
</div></blockquote>
<p>)]
pub model_check_interval_secs: u64,
#[clap(</p>
<blockquote>
<div><p>short,
long,
default_value = “models/pvideo/”,
help = “root directory for models”</p>
</div></blockquote>
<p>)]
pub model_dir: Vec&lt;String&gt;,
#[clap(</p>
<blockquote>
<div><p>long,
help = “directory containing META.json config. separate from model_dir to facilitate remote config management”</p>
</div></blockquote>
<p>)]
pub meta_json_dir: Option&lt;String&gt;,
#[clap(short, long, default_value = “”, help = “directory for ssl certs”)]
pub ssl_dir: String,
#[clap(</p>
<blockquote>
<div><p>long,
help = “call out to external process to check model updates. custom logic can be written to pull from hdfs, gcs etc”</p>
</div></blockquote>
<p>)]
pub modelsync_cli: Option&lt;String&gt;,
#[clap(</p>
<blockquote>
<div><p>long,
default_value_t = 1,
help = “specify how many versions Navi retains in memory. good for cases of rolling model upgrade”</p>
</div></blockquote>
<p>)]
pub versions_per_model: usize,
#[clap(</p>
<blockquote>
<div><p>short,
long,
help = “most runtimes support loading ops custom writen. currently only implemented for TF”</p>
</div></blockquote>
<p>)]
pub customops_lib: Option&lt;String&gt;,
#[clap(</p>
<blockquote>
<div><p>long,
default_value = “8”,
help = “number of threads to paralleling computations inside an op”</p>
</div></blockquote>
<p>)]
pub intra_op_parallelism: Vec&lt;String&gt;,
#[clap(</p>
<blockquote>
<div><p>long,
help = “number of threads to parallelize computations of the graph”</p>
</div></blockquote>
<p>)]
pub inter_op_parallelism: Vec&lt;String&gt;,
#[clap(</p>
<blockquote>
<div><p>long,
help = “signature of a serving. only TF”</p>
</div></blockquote>
<p>)]
pub serving_sig: Vec&lt;String&gt;,
#[clap(long, default_value = “examples”, help = “name of each input tensor”)]
pub input: Vec&lt;String&gt;,
#[clap(long, default_value = “output_0”, help = “name of each output tensor”)]
pub output: Vec&lt;String&gt;,
#[clap(</p>
<blockquote>
<div><p>long,
default_value_t = 500,
help = “max warmup records to use. warmup only implemented for TF”</p>
</div></blockquote>
<p>)]
pub max_warmup_records: usize,
#[clap(long, value_parser = Args::parse_key_val::&lt;String, String&gt;, value_delimiter=’,’)]
pub onnx_global_thread_pool_options: Vec&lt;(String, String)&gt;,
#[clap(
long,
default_value = “true”,
help = “when to use graph parallelization. only for ONNX”
)]
pub onnx_use_parallel_mode: String,
// #[clap(long, default_value = “false”)]
// pub onnx_use_onednn: String,
#[clap(</p>
<blockquote>
<div><p>long,
default_value = “true”,
help = “trace internal memory allocation and generate bulk memory allocations. only for ONNX. turn if off if batch size dynamic”</p>
</div></blockquote>
<p>)]
pub onnx_use_memory_pattern: String,
#[clap(long, value_parser = Args::parse_key_val::&lt;String, String&gt;, value_delimiter=’,’)]
pub onnx_ep_options: Vec&lt;(String, String)&gt;,
#[clap(long, help = “choice of gpu EPs for ONNX: cuda or tensorrt”)]
pub onnx_gpu_ep: Option&lt;String&gt;,
#[clap(</p>
<blockquote>
<div><p>long,
default_value = “home”,
help = “converter for various input formats”</p>
</div></blockquote>
<p>)]
pub onnx_use_converter: Option&lt;String&gt;,
#[clap(</p>
<blockquote>
<div><p>long,
help = “whether to enable runtime profiling. only implemented for ONNX for now”</p>
</div></blockquote>
<p>)]
pub profiling: Option&lt;String&gt;,
#[clap(</p>
<blockquote>
<div><p>long,
default_value = “”,
help = “metrics reporting for discrete features. only for Home converter for now”</p>
</div></blockquote>
<p>)]
pub onnx_report_discrete_feature_ids: Vec&lt;String&gt;,
#[clap(</p>
<blockquote>
<div><p>long,
default_value = “”,
help = “metrics reporting for continuous features. only for Home converter for now”</p>
</div></blockquote>
<p>)]
pub onnx_report_continuous_feature_ids: Vec&lt;String&gt;,</p>
</div></blockquote>
<p>}</p>
<dl>
<dt>impl Args {</dt><dd><dl>
<dt>pub fn get_model_specs(model_dir: Vec&lt;String&gt;) -&gt; Vec&lt;String&gt; {</dt><dd><dl>
<dt>let model_specs = model_dir</dt><dd><p>.iter()
//let it panic if some model_dir are wrong
.map(<a href="#id1"><span class="problematic" id="id2">|dir|</span></a> {</p>
<blockquote>
<div><dl class="simple">
<dt>dir.trim_end_matches(‘/’)</dt><dd><p>.rsplit_once(‘/’)
.unwrap()
.1
.to_owned()</p>
</dd>
</dl>
</div></blockquote>
<p>})
.collect();</p>
</dd>
</dl>
<p>info!(“all model_specs: {:?}”, model_specs);
model_specs</p>
</dd>
</dl>
<p>}
pub fn version_str_to_epoch(dt_str: &amp;str) -&gt; Result&lt;i64, anyhow::Error&gt; {</p>
<blockquote>
<div><dl>
<dt>dt_str</dt><dd><p>.parse::&lt;i64&gt;()
.or_else(<a href="#id3"><span class="problematic" id="id4">|_|</span></a> {</p>
<blockquote>
<div><dl class="simple">
<dt>let ts = OffsetDateTime::parse(dt_str, &amp;Rfc3339)</dt><dd><p>.map(<a href="#id5"><span class="problematic" id="id6">|d|</span></a> (d.unix_timestamp_nanos()/1_000_000) as i64);</p>
</dd>
<dt>if ts.is_ok() {</dt><dd><p>info!(“original version {} -&gt; {}”, dt_str, ts.unwrap());</p>
</dd>
</dl>
<p>}
ts</p>
</div></blockquote>
<p>})
.map_err(anyhow::Error::msg)</p>
</dd>
</dl>
</div></blockquote>
<p>}
/// Parse a single key-value pair
fn parse_key_val&lt;T, U&gt;(s: &amp;str) -&gt; Result&lt;(T, U), Box&lt;dyn Error + Send + Sync + ‘static&gt;&gt;
where</p>
<blockquote>
<div><p>T: std::str::FromStr,
T::Err: Error + Send + Sync + ‘static,
U: std::str::FromStr,
U::Err: Error + Send + Sync + ‘static,</p>
</div></blockquote>
<dl>
<dt>{</dt><dd><dl class="simple">
<dt>let pos = s</dt><dd><p>.find(‘=’)
.ok_or_else(|| format!(“invalid KEY=value: no <cite>=</cite> found in <cite>{}</cite>”, s))?;</p>
</dd>
</dl>
<p>Ok((s[..pos].parse()?, s[pos + 1..].parse()?))</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>lazy_static! {</dt><dd><p>pub static ref ARGS: Args = Args::parse();
pub static ref MODEL_SPECS: ArrayVec&lt;String, MAX_NUM_MODELS&gt; = {</p>
<blockquote>
<div><p>let mut specs = ArrayVec::&lt;String, MAX_NUM_MODELS&gt;::new();
Args::get_model_specs(ARGS.model_dir.clone())</p>
<blockquote>
<div><p>.into_iter()
.for_each(<a href="#id7"><span class="problematic" id="id8">|m|</span></a> specs.push(m));</p>
</div></blockquote>
<p>specs</p>
</div></blockquote>
<p>};
pub static ref INPUTS: ArrayVec&lt;OnceCell&lt;ArrayVec&lt;String, MAX_NUM_INPUTS&gt;&gt;, MAX_NUM_MODELS&gt; = {</p>
<blockquote>
<div><dl>
<dt>let mut inputs =</dt><dd><p>ArrayVec::&lt;OnceCell&lt;ArrayVec&lt;String, MAX_NUM_INPUTS&gt;&gt;, MAX_NUM_MODELS&gt;::new();</p>
</dd>
<dt>for (idx, o) in ARGS.input.iter().enumerate() {</dt><dd><dl>
<dt>if o.trim().is_empty() {</dt><dd><p>info!(“input spec is empty for model {}, auto detect later”, idx);
inputs.push(OnceCell::new());</p>
</dd>
<dt>} else {</dt><dd><dl class="simple">
<dt>inputs.push(OnceCell::with_value(</dt><dd><dl class="simple">
<dt>o.split(“,”)</dt><dd><p>.map(<a href="#id9"><span class="problematic" id="id10">|s|</span></a> s.to_owned())
.collect::&lt;ArrayVec&lt;String, MAX_NUM_INPUTS&gt;&gt;(),</p>
</dd>
</dl>
</dd>
</dl>
<p>));</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}
info!(“all inputs:{:?}”, inputs);
inputs</p>
</div></blockquote>
<p>};
pub static ref OUTPUTS: ArrayVec&lt;ArrayVec&lt;String, MAX_NUM_OUTPUTS&gt;, MAX_NUM_MODELS&gt; = {</p>
<blockquote>
<div><p>let mut outputs = ArrayVec::&lt;ArrayVec&lt;String, MAX_NUM_OUTPUTS&gt;, MAX_NUM_MODELS&gt;::new();
for o in ARGS.output.iter() {</p>
<blockquote>
<div><dl class="simple">
<dt>outputs.push(</dt><dd><dl class="simple">
<dt>o.split(“,”)</dt><dd><p>.map(<a href="#id11"><span class="problematic" id="id12">|s|</span></a> s.to_owned())
.collect::&lt;ArrayVec&lt;String, MAX_NUM_OUTPUTS&gt;&gt;(),</p>
</dd>
</dl>
</dd>
</dl>
<p>);</p>
</div></blockquote>
<p>}
info!(“all outputs:{:?}”, outputs);
outputs</p>
</div></blockquote>
<p>};</p>
</dd>
</dl>
<p>}</p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../_sources/navi/navi/src/cli_args.rs.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>