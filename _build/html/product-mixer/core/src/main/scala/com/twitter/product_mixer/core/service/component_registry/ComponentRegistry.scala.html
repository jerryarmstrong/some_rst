<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../../../../../../" id="documentation_options" src="../../../../../../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>package com.twitter.product_mixer.core.service.component_registry</p>
<p>import com.twitter.finagle.stats.StatsReceiver
import com.twitter.product_mixer.core.model.common.Component
import com.twitter.product_mixer.core.model.common.identifier.ComponentIdentifier
import com.twitter.product_mixer.core.model.common.identifier.ComponentIdentifierStack
import com.twitter.util.Activity
import com.twitter.util.Future
import com.twitter.util.Try
import com.twitter.util.logging.Logging
import java.util.concurrent.ConcurrentHashMap
import javax.inject.Inject
import javax.inject.Singleton
import scala.collection.JavaConverters._</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>The [[ComponentRegistry]] works closely with [[ComponentIdentifier]]s and the [[com.twitter.product_mixer.core.product.registry.ProductPipelineRegistry]]</p></li>
<li><p>to provide the Product Mixer framework information about the [[com.twitter.product_mixer.core.pipeline.Pipeline]]s and [[Component]]s</p></li>
<li><p>that make up an application.</p></li>
<li></li>
<li><p>This registration allows us to configure alerts and dashboards,</p></li>
<li><p>to query your application structure letting us display the graph of the execution and the results of queries,</p></li>
<li><p>and to garner insight into usages.</p></li>
<li></li>
<li><p>The registry is a snapshot of the state of the world when pipelines were last built successfully.</p></li>
<li><p>For most services, this only happens once on startup. However, some services may rebuild their</p></li>
<li><p>pipelines dynamically later on.</p></li>
</ul>
<p><a href="#id1"><span class="problematic" id="id2">*</span></a>/</p>
</dd>
</dl>
<p>&#64;Singleton
class ComponentRegistry &#64;Inject() (statsReceiver: StatsReceiver) {</p>
<blockquote>
<div><p>// Initially pending until the first snapshot is built by [[ProductPipelineRegistry]]
private val (snapshotActivity, snapshotWitness) = Activity[ComponentRegistrySnapshot]()
private val snapshotCount = statsReceiver.counter(“ComponentRegistry”, “SnapshotCount”)</p>
<p>def get: Future[ComponentRegistrySnapshot] = snapshotActivity.values.toFuture.lowerFromTry
private[core] def set(snapshot: ComponentRegistrySnapshot): Unit = {</p>
<blockquote>
<div><p>snapshotCount.incr()
snapshotWitness.notify(Try(snapshot))</p>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>}</p>
<p>class ComponentRegistrySnapshot() extends Logging {</p>
<blockquote>
<div><p>/** for storing the [[RegisteredComponent]]s <a href="#id3"><span class="problematic" id="id4">*</span></a>/
private[this] val componentRegistry =</p>
<blockquote>
<div><p>new ConcurrentHashMap[ComponentIdentifier, RegisteredComponent]</p>
</div></blockquote>
<p>/** for determining the children of a [[ComponentIdentifier]] <a href="#id5"><span class="problematic" id="id6">*</span></a>/
private[this] val componentChildren =</p>
<blockquote>
<div><p>new ConcurrentHashMap[ComponentIdentifier, Set[ComponentIdentifier]]</p>
</div></blockquote>
<p>/** for determining [[ComponentIdentifier]] uniqueness within a given [[ComponentIdentifierStack]] <a href="#id7"><span class="problematic" id="id8">*</span></a>/
private[this] val componentHierarchy =</p>
<blockquote>
<div><p>new ConcurrentHashMap[ComponentIdentifierStack, Set[ComponentIdentifier]]</p>
</div></blockquote>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Register the given [[Component]] at the end of path provided by <cite>parentIdentifierStack</cite></p></li>
<li><p>or throws an exception if adding the component results in an invalid configuration.</p></li>
<li></li>
<li><p>&#64;throws ChildComponentCollisionException if a [[Component]] with the same [[ComponentIdentifier]] is registered</p></li>
<li><p>more than once under the same parent.</p></li>
<li><p>e.g. if you register <cite>ComponentA</cite> under <cite>ProductA -&gt; PipelineA</cite> twice,</p></li>
<li><p>this exception will be thrown when registering <cite>ComponentA</cite> the second</p></li>
<li><p>time. This is pretty much always a configuration error due to copy-pasting</p></li>
<li><p>and forgetting to update the identifier, or accidentally using the same</p></li>
<li><p>component twice under the same parent. If this didn’t throw, stats from</p></li>
<li><p>these 2 components would be indistinguishable.</p></li>
<li></li>
<li><p>&#64;throws ComponentIdentifierCollisionException if a [[Component]] with the same [[ComponentIdentifier]] is registered</p></li>
<li><p>but it’s type is not the same as a previously registered [[Component]]</p></li>
<li><p>with the same [[ComponentIdentifier]]</p></li>
<li><p>e.g. if you register 2 [[Component]]s with the same [[ComponentIdentifier]]</p></li>
<li><p>such as <cite>new Component</cite> and an instance of</p></li>
<li><p><cite>class MyComponent extends Component</cite> the <cite>new Component</cite> will have a</p></li>
<li><p>type of <cite>Component</cite> and the other one will have a type of <cite>MyComponent</cite></p></li>
<li><p>which will throw. This is usually due to copy-pasting a component as</p></li>
<li><p>a starting point and forgetting to update the identifier. If this</p></li>
<li><p>didn’t throw, absolute stats from these 2 components would be</p></li>
<li><p>indistinguishable.</p></li>
<li></li>
<li></li>
<li><p>&#64;note this will log details of component identifier reuse if the underling components are not equal, but otherwise are of the same class.</p></li>
<li><p>Their stats will be merged and indistinguishable but since they are the same name and same class, we assume the differences are</p></li>
<li><p>minor enough that this is okay, but make a note in the log at startup in case someone sees unexpected metrics, we can look</p></li>
<li><p>back at the logs and see the details.</p></li>
<li></li>
<li><p>&#64;param component the component to register</p></li>
<li><p>&#64;param parentIdentifierStack the complete [[ComponentIdentifierStack]] excluding the current [[Component]]’s [[ComponentIdentifier]]</p></li>
</ul>
<p><a href="#id9"><span class="problematic" id="id10">*</span></a>/</p>
</dd>
<dt>def register(</dt><dd><p>component: Component,
parentIdentifierStack: ComponentIdentifierStack</p>
</dd>
<dt>): Unit = synchronized {</dt><dd><p>val identifier = component.identifier
val parentIdentifier = parentIdentifierStack.peek</p>
<dl>
<dt>val registeredComponent =</dt><dd><p>RegisteredComponent(identifier, component, component.identifier.file.value)</p>
</dd>
<dt>componentRegistry.asScala</dt><dd><p>.get(identifier)
.filter(_.component != component) // only do the foreach if the components aren’t equal
.foreach {</p>
<blockquote>
<div><dl>
<dt>case existingComponent if existingComponent.component.getClass != component.getClass =&gt;</dt><dd><dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>The same component may be registered under different parent components.</p></li>
<li><p>However, different component types cannot use the same component identifier.</p></li>
<li></li>
<li><p>This catches some copy-pasting of a config or component and forgetting to update the identifier.</p></li>
</ul>
<p><a href="#id11"><span class="problematic" id="id12">*</span></a>/</p>
</dd>
<dt>throw new ComponentIdentifierCollisionException(</dt><dd><p>componentIdentifier = identifier,
component = registeredComponent,
existingComponent = componentRegistry.get(identifier),
parentIdentifierStack = parentIdentifierStack,
existingIdentifierStack = componentHierarchy.search[ComponentIdentifierStack](</p>
<blockquote>
<div><p>1,
(stack, identifiers) =&gt; if (identifiers.contains(identifier)) stack else null)</p>
</div></blockquote>
</dd>
</dl>
<p>)</p>
</dd>
<dt>case existingComponent =&gt;</dt><dd><dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>The same component may be registered under different parent components.</p></li>
<li><p>However, if the components are not equal it __may <a href="#id17"><span class="problematic" id="id18">be__</span></a> a configuration error</p></li>
<li><p>so we log a detailed description of the issue in case they need to debug.</p></li>
<li></li>
<li><p>This warns customers of some copy-pasting of a config or component and forgetting to update the</p></li>
<li><p>identifier and of reusing components with hard-coded values which are configured differently.</p></li>
</ul>
<p><a href="#id13"><span class="problematic" id="id14">*</span></a>/</p>
</dd>
<dt>val existingIdentifierStack = componentHierarchy.search[ComponentIdentifierStack](</dt><dd><p>1,
(stack, identifiers) =&gt; if (identifiers.contains(identifier)) stack else null)</p>
</dd>
<dt>logger.info(</dt><dd><dl class="simple">
<dt>s”Found duplicate identifiers for non-equal components, $identifier from ${registeredComponent.sourceFile} “ +</dt><dd><p>s”under ${parentIdentifierStack.componentIdentifiers.reverse.mkString(” -&gt; “)} “ +
s”was already defined and is unequal to ${existingComponent.sourceFile} “ +
s”under ${existingIdentifierStack.componentIdentifiers.reverse.mkString(” -&gt; “)}. “ +
s”Merging these components in the registry, this will result in their metrics being merged. “ +
s”If these components should have separate metrics, consider providing unique identifiers for them instead.”</p>
</dd>
</dl>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>/** The same component may not be registered multiple times under the same parent <a href="#id15"><span class="problematic" id="id16">*</span></a>/
if (componentHierarchy.getOrDefault(parentIdentifierStack, Set.empty).contains(identifier))</p>
<blockquote>
<div><p>throw new ChildComponentCollisionException(identifier, parentIdentifierStack)</p>
</div></blockquote>
<p>// add component to registry
componentRegistry.putIfAbsent(identifier, registeredComponent)
// add component to parent’s <cite>children</cite> set for easy lookup
componentChildren.merge(parentIdentifier, Set(identifier), _ ++ _)
// add the component to the hierarchy under it’s parent’s identifier stack
componentHierarchy.merge(parentIdentifierStack, Set(identifier), _ ++ _)</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>def getAllRegisteredComponents: Seq[RegisteredComponent] =</dt><dd><p>componentRegistry.values.asScala.toSeq.sorted</p>
</dd>
<dt>def getChildComponents(component: ComponentIdentifier): Seq[ComponentIdentifier] =</dt><dd><dl class="simple">
<dt>Option(componentChildren.get(component)) match {</dt><dd><p>case Some(components) =&gt; components.toSeq.sorted(ComponentIdentifier.ordering)
case None =&gt; Seq.empty</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
<dl>
<dt>class ComponentIdentifierCollisionException(</dt><dd><p>componentIdentifier: ComponentIdentifier,
component: RegisteredComponent,
existingComponent: RegisteredComponent,
parentIdentifierStack: ComponentIdentifierStack,
existingIdentifierStack: ComponentIdentifierStack)</p>
<blockquote>
<div><dl class="simple">
<dt>extends IllegalArgumentException(</dt><dd><dl class="simple">
<dt>s”Tried to register component $componentIdentifier: of type ${component.component.getClass} from ${component.sourceFile} “ +</dt><dd><p>s”under ${parentIdentifierStack.componentIdentifiers.reverse.mkString(” -&gt; “)} “ +
s”but it was already defined with a different type ${existingComponent.component.getClass} from ${existingComponent.sourceFile} “ +
s”under ${existingIdentifierStack.componentIdentifiers.reverse.mkString(” -&gt; “)}. “ +
s”Ensure you aren’t reusing a component identifier which can happen when copy-pasting existing component code by accident”)</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
</dd>
<dt>class ChildComponentCollisionException(</dt><dd><p>componentIdentifier: ComponentIdentifier,
parentIdentifierStack: ComponentIdentifierStack)</p>
<blockquote>
<div><dl class="simple">
<dt>extends IllegalArgumentException(</dt><dd><p>s”Component $componentIdentifier already defined under parent component $parentIdentifierStack”)</p>
</dd>
</dl>
</div></blockquote>
</dd>
</dl>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../../../../../../index2.rst.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../../../../../../index2.rst.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../../../../../../_sources/product-mixer/core/src/main/scala/com/twitter/product_mixer/core/service/component_registry/ComponentRegistry.scala.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>