<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../../../../" id="documentation_options" src="../../../../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>package com.twitter.visibility.interfaces.conversations</p>
<p>import com.twitter.decider.Decider
import com.twitter.finagle.stats.StatsReceiver
import com.twitter.gizmoduck.thriftscala.User
import com.twitter.spam.rtf.thriftscala.FilteredReason
import com.twitter.spam.rtf.thriftscala.FilteredReason.UnspecifiedReason
import com.twitter.spam.rtf.thriftscala.SafetyLevel
import com.twitter.spam.rtf.thriftscala.SafetyResult
import com.twitter.stitch.Stitch
import com.twitter.timelines.render.thriftscala.RichText
import com.twitter.timelines.render.thriftscala.TombstoneDisplayType
import com.twitter.timelines.render.thriftscala.TombstoneInfo
import com.twitter.tweetypie.thriftscala.GetTweetFieldsResult
import com.twitter.tweetypie.thriftscala.TweetFieldsResultFailed
import com.twitter.tweetypie.thriftscala.TweetFieldsResultFiltered
import com.twitter.tweetypie.thriftscala.TweetFieldsResultFound
import com.twitter.tweetypie.thriftscala.TweetFieldsResultNotFound
import com.twitter.tweetypie.thriftscala.TweetFieldsResultState
import com.twitter.visibility.VisibilityLibrary
import com.twitter.visibility.builder.tweets.ModerationFeatures
import com.twitter.visibility.builder.users.AuthorFeatures
import com.twitter.visibility.builder.users.RelationshipFeatures
import com.twitter.visibility.builder.users.ViewerFeatures
import com.twitter.visibility.common.UserRelationshipSource
import com.twitter.visibility.common.UserSource
import com.twitter.visibility.common.actions.InterstitialReason
import com.twitter.visibility.common.actions.LimitedEngagementReason
import com.twitter.visibility.common.actions.TombstoneReason
import com.twitter.visibility.common.actions.converter.scala.InterstitialReasonConverter
import com.twitter.visibility.common.actions.converter.scala.LocalizedMessageConverter
import com.twitter.visibility.common.actions.converter.scala.TombstoneReasonConverter
import com.twitter.visibility.common.filtered_reason.FilteredReasonHelper
import com.twitter.visibility.configapi.configs.VisibilityDeciderGates
import com.twitter.visibility.features.FocalTweetId
import com.twitter.visibility.features.TweetId
import com.twitter.visibility.models.ContentId
import com.twitter.visibility.models.SafetyLevel.Tombstoning
import com.twitter.visibility.models.ViewerContext
import com.twitter.visibility.results.richtext.EpitaphToRichText
import com.twitter.visibility.results.richtext.LocalizedMessageToRichText
import com.twitter.visibility.results.urt.ReasonToUrtParser
import com.twitter.visibility.results.urt.SafetyResultToUrtParser
import com.twitter.visibility.rules._
import com.twitter.visibility.{thriftscala =&gt; t}</p>
<dl>
<dt>case class TombstoneVisibilityRequest(</dt><dd><p>conversationId: Long,
focalTweetId: Long,
tweets: Seq[(GetTweetFieldsResult, Option[SafetyLevel])],
authorMap: Map[</p>
<blockquote>
<div><p>Long,
User</p>
</div></blockquote>
<p>],
moderatedTweetIds: Seq[Long],
viewerContext: ViewerContext,
useRichText: Boolean = true)</p>
</dd>
</dl>
<p>case class TombstoneVisibilityResponse(tweetVerdicts: Map[Long, VfTombstone])</p>
<dl>
<dt>case class TombstoneVisibilityLibrary(</dt><dd><p>visibilityLibrary: VisibilityLibrary,
statsReceiver: StatsReceiver,
decider: Decider) {</p>
<dl>
<dt>private case class TombstoneType(</dt><dd><p>tweetId: Long,
tombstoneId: Long,
action: Action) {</p>
<p>lazy val isInnerTombstone: Boolean = tweetId != tombstoneId</p>
<dl>
<dt>lazy val tombstoneDisplayType: TombstoneDisplayType = action match {</dt><dd><dl class="simple">
<dt>case _: InterstitialLimitedEngagements | _: EmergencyDynamicInterstitial =&gt;</dt><dd><p>TombstoneDisplayType.NonCompliant</p>
</dd>
</dl>
<p>case _ =&gt; TombstoneDisplayType.Inline</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<p>val En: String = “en”
val View: String = “View”
val relationshipFeatures =</p>
<blockquote>
<div><dl class="simple">
<dt>new RelationshipFeatures(</dt><dd><p>statsReceiver)</p>
</dd>
</dl>
</div></blockquote>
<p>val visibilityDeciderGates = VisibilityDeciderGates(decider)</p>
<dl class="simple">
<dt>def toAction(</dt><dd><p>filteredReason: FilteredReason,
actionStatsReceiver: StatsReceiver</p>
</dd>
</dl>
<p>): Option[Action] = {</p>
<blockquote>
<div><dl class="simple">
<dt>val enableLocalizedInterstitials =</dt><dd><p>visibilityDeciderGates.enableConvosLocalizedInterstitial()</p>
</dd>
<dt>val enableLegacyInterstitials =</dt><dd><p>visibilityDeciderGates.enableConvosLegacyInterstitial()</p>
</dd>
</dl>
<p>val tombstoneStatsReceiver = actionStatsReceiver.scope(“tombstone”)
val interstitialLocalStatsReceiver =</p>
<blockquote>
<div><p>actionStatsReceiver.scope(“interstitial”).scope(“localized”)</p>
</div></blockquote>
<dl>
<dt>val interstitialLegacyStatsReceiver =</dt><dd><p>actionStatsReceiver.scope(“interstitial”).scope(“legacy”)</p>
</dd>
<dt>filteredReason match {</dt><dd><dl>
<dt>case _ if FilteredReasonHelper.isTombstone(filteredReason) =&gt;</dt><dd><dl>
<dt>createLocalizedTombstone(filteredReason, tombstoneStatsReceiver) match {</dt><dd><p>case tombstoneOpt &#64; Some(LocalizedTombstone(_, _)) =&gt; tombstoneOpt
case _ =&gt;</p>
<blockquote>
<div><p>createTombstone(Epitaph.Unavailable, tombstoneStatsReceiver, Some(“emptyTombstone”))</p>
</div></blockquote>
</dd>
</dl>
<p>}</p>
</dd>
<dt>case _</dt><dd><blockquote>
<div><dl class="simple">
<dt>if enableLocalizedInterstitials &amp;&amp;</dt><dd><p>FilteredReasonHelper.isLocalizedSuppressedReasonInterstitial(filteredReason) =&gt;</p>
</dd>
</dl>
</div></blockquote>
<dl>
<dt>FilteredReasonHelper.getLocalizedSuppressedReasonInterstitial(filteredReason) match {</dt><dd><dl>
<dt>case Some(t.Interstitial(reasonOpt, Some(message))) =&gt;</dt><dd><dl>
<dt>InterstitialReasonConverter.fromThrift(reasonOpt).map { interstitialReason =&gt;</dt><dd><p>interstitialLocalStatsReceiver.counter(“interstitial”).incr()
Interstitial(</p>
<blockquote>
<div><p>Reason.fromInterstitialReason(interstitialReason),
Some(LocalizedMessageConverter.fromThrift(message)))</p>
</div></blockquote>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>case _ =&gt; None</p>
</dd>
</dl>
<p>}</p>
</dd>
<dt>case _ if FilteredReasonHelper.containNsfwMedia(filteredReason) =&gt;</dt><dd><p>None</p>
</dd>
<dt>case _ if FilteredReasonHelper.possiblyUndesirable(filteredReason) =&gt;</dt><dd><p>None</p>
</dd>
<dt>case _ if FilteredReasonHelper.reportedTweet(filteredReason) =&gt;</dt><dd><dl>
<dt>filteredReason match {</dt><dd><dl>
<dt>case FilteredReason.ReportedTweet(true) =&gt;</dt><dd><p>interstitialLegacyStatsReceiver.counter(“fr_reported”).incr()
Some(Interstitial(Reason.ViewerReportedAuthor))</p>
</dd>
<dt>case FilteredReason.SafetyResult(safetyResult: SafetyResult)</dt><dd><blockquote>
<div><p>if enableLegacyInterstitials =&gt;</p>
</div></blockquote>
<dl>
<dt>val safetyResultReported = InterstitialReasonConverter</dt><dd><dl class="simple">
<dt>.fromAction(safetyResult.action).collect {</dt><dd><p>case InterstitialReason.ViewerReportedTweet =&gt; true
case InterstitialReason.ViewerReportedAuthor =&gt; true</p>
</dd>
</dl>
<p>}.getOrElse(false)</p>
</dd>
<dt>if (safetyResultReported) {</dt><dd><p>interstitialLegacyStatsReceiver.counter(“reported_author”).incr()
Some(Interstitial(Reason.ViewerReportedAuthor))</p>
</dd>
</dl>
<p>} else None</p>
</dd>
</dl>
<p>case _ =&gt; None</p>
</dd>
</dl>
<p>}</p>
</dd>
<dt>case _ if FilteredReasonHelper.tweetMatchesViewerMutedKeyword(filteredReason) =&gt;</dt><dd><dl>
<dt>filteredReason match {</dt><dd><dl>
<dt>case FilteredReason.TweetMatchesViewerMutedKeyword(_) =&gt;</dt><dd><p>interstitialLegacyStatsReceiver.counter(“fr_muted_keyword”).incr()
Some(Interstitial(Reason.MutedKeyword))</p>
</dd>
<dt>case FilteredReason.SafetyResult(safetyResult: SafetyResult)</dt><dd><blockquote>
<div><p>if enableLegacyInterstitials =&gt;</p>
</div></blockquote>
<dl>
<dt>val safetyResultMutedKeyword = InterstitialReasonConverter</dt><dd><dl class="simple">
<dt>.fromAction(safetyResult.action).collect {</dt><dd><p>case _: InterstitialReason.MatchesMutedKeyword =&gt; true</p>
</dd>
</dl>
<p>}.getOrElse(false)</p>
</dd>
<dt>if (safetyResultMutedKeyword) {</dt><dd><p>interstitialLegacyStatsReceiver.counter(“muted_keyword”).incr()
Some(Interstitial(Reason.MutedKeyword))</p>
</dd>
</dl>
<p>} else None</p>
</dd>
</dl>
<p>case _ =&gt; None</p>
</dd>
</dl>
<p>}</p>
</dd>
<dt>case _ =&gt;</dt><dd><p>None</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}</p>
<dl class="simple">
<dt>def toAction(</dt><dd><p>tfrs: TweetFieldsResultState,
actionStatsReceiver: StatsReceiver</p>
</dd>
</dl>
<p>): Option[Action] = {</p>
<blockquote>
<div><p>val enableLocalizedInterstitials = visibilityDeciderGates.enableConvosLocalizedInterstitial()
val enableLegacyInterstitials = visibilityDeciderGates.enableConvosLegacyInterstitial()</p>
<p>val tombstoneStatsReceiver = actionStatsReceiver.scope(“tombstone”)
val interstitialLocalStatsReceiver =</p>
<blockquote>
<div><p>actionStatsReceiver.scope(“interstitial”).scope(“localized”)</p>
</div></blockquote>
<dl class="simple">
<dt>val interstitialLegacyStatsReceiver =</dt><dd><p>actionStatsReceiver.scope(“interstitial”).scope(“legacy”)</p>
</dd>
</dl>
<p>tfrs match {</p>
<blockquote>
<div><dl>
<dt>case TweetFieldsResultState.NotFound(TweetFieldsResultNotFound(_, _, Some(filteredReason)))</dt><dd><blockquote>
<div><p>if FilteredReasonHelper.isTombstone(filteredReason) =&gt;</p>
</div></blockquote>
<p>createLocalizedTombstone(filteredReason, tombstoneStatsReceiver)</p>
</dd>
<dt>case TweetFieldsResultState.NotFound(tfr: TweetFieldsResultNotFound) if tfr.deleted =&gt;</dt><dd><p>createTombstone(Epitaph.Deleted, tombstoneStatsReceiver)</p>
</dd>
<dt>case TweetFieldsResultState.NotFound(_: TweetFieldsResultNotFound) =&gt;</dt><dd><p>createTombstone(Epitaph.NotFound, tombstoneStatsReceiver)</p>
</dd>
<dt>case TweetFieldsResultState.Failed(TweetFieldsResultFailed(_, _, _)) =&gt;</dt><dd><p>createTombstone(Epitaph.Unavailable, tombstoneStatsReceiver, Some(“failed”))</p>
</dd>
<dt>case TweetFieldsResultState.Filtered(TweetFieldsResultFiltered(UnspecifiedReason(true))) =&gt;</dt><dd><p>createTombstone(Epitaph.Unavailable, tombstoneStatsReceiver, Some(“filtered”))</p>
</dd>
<dt>case TweetFieldsResultState.Filtered(TweetFieldsResultFiltered(filteredReason)) =&gt;</dt><dd><p>toAction(filteredReason, actionStatsReceiver)</p>
</dd>
<dt>case TweetFieldsResultState.Found(TweetFieldsResultFound(_, _, Some(filteredReason)))</dt><dd><blockquote>
<div><dl class="simple">
<dt>if enableLocalizedInterstitials &amp;&amp;</dt><dd><p>FilteredReasonHelper.isSuppressedReasonPublicInterestInterstial(filteredReason) =&gt;</p>
</dd>
</dl>
</div></blockquote>
<p>interstitialLocalStatsReceiver.counter(“ipi”).incr()
FilteredReasonHelper</p>
<blockquote>
<div><p>.getSafetyResult(filteredReason)
.flatMap(_.reason)
.flatMap(PublicInterest.SafetyResultReasonToReason.get) match {
case Some(safetyResultReason) =&gt;</p>
<blockquote>
<div><dl>
<dt>FilteredReasonHelper</dt><dd><p>.getSuppressedReasonPublicInterestInterstial(filteredReason)
.map(edi =&gt; edi.localizedMessage)
.map(tlm =&gt; LocalizedMessageConverter.fromThrift(tlm))
.map(lm =&gt;</p>
<blockquote>
<div><dl class="simple">
<dt>InterstitialLimitedEngagements(</dt><dd><p>safetyResultReason,
Some(LimitedEngagementReason.NonCompliant),
lm))</p>
</dd>
</dl>
</div></blockquote>
</dd>
</dl>
</div></blockquote>
<p>case _ =&gt; None</p>
</div></blockquote>
<p>}</p>
</dd>
<dt>case TweetFieldsResultState.Found(TweetFieldsResultFound(_, _, Some(filteredReason)))</dt><dd><blockquote>
<div><dl class="simple">
<dt>if enableLegacyInterstitials &amp;&amp;</dt><dd><p>FilteredReasonHelper.isSuppressedReasonPublicInterestInterstial(filteredReason) =&gt;</p>
</dd>
</dl>
</div></blockquote>
<p>interstitialLegacyStatsReceiver.counter(“ipi”).incr()
FilteredReasonHelper</p>
<blockquote>
<div><p>.getSafetyResult(filteredReason)
.flatMap(_.reason)
.flatMap(PublicInterest.SafetyResultReasonToReason.get)
.map(InterstitialLimitedEngagements(_, Some(LimitedEngagementReason.NonCompliant)))</p>
</div></blockquote>
</dd>
<dt>case TweetFieldsResultState.Found(TweetFieldsResultFound(_, _, Some(filteredReason)))</dt><dd><blockquote>
<div><dl class="simple">
<dt>if enableLocalizedInterstitials &amp;&amp;</dt><dd><dl class="simple">
<dt>FilteredReasonHelper.isLocalizedSuppressedReasonEmergencyDynamicInterstitial(</dt><dd><p>filteredReason) =&gt;</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>interstitialLocalStatsReceiver.counter(“edi”).incr()
FilteredReasonHelper</p>
<blockquote>
<div><p>.getSuppressedReasonEmergencyDynamicInterstitial(filteredReason)
.map(e =&gt;</p>
<blockquote>
<div><dl class="simple">
<dt>EmergencyDynamicInterstitial(</dt><dd><p>e.copy,
e.link,
LocalizedMessageConverter.fromThrift(e.localizedMessage)))</p>
</dd>
</dl>
</div></blockquote>
</div></blockquote>
</dd>
<dt>case TweetFieldsResultState.Found(TweetFieldsResultFound(_, _, Some(filteredReason)))</dt><dd><blockquote>
<div><dl class="simple">
<dt>if enableLegacyInterstitials &amp;&amp;</dt><dd><p>FilteredReasonHelper.isSuppressedReasonEmergencyDynamicInterstitial(filteredReason) =&gt;</p>
</dd>
</dl>
</div></blockquote>
<p>interstitialLegacyStatsReceiver.counter(“edi”).incr()
FilteredReasonHelper</p>
<blockquote>
<div><p>.getSuppressedReasonEmergencyDynamicInterstitial(filteredReason)
.map(e =&gt; EmergencyDynamicInterstitial(e.copy, e.link))</p>
</div></blockquote>
</dd>
<dt>case TweetFieldsResultState.Found(TweetFieldsResultFound(tweet, _, _))</dt><dd><blockquote>
<div><p>if tweet.perspective.exists(_.reported) =&gt;</p>
</div></blockquote>
<p>interstitialLegacyStatsReceiver.counter(“reported”).incr()
Some(Interstitial(Reason.ViewerReportedAuthor))</p>
</dd>
<dt>case TweetFieldsResultState.Found(</dt><dd><blockquote>
<div><p>TweetFieldsResultFound(_, _, Some(UnspecifiedReason(true)))) =&gt;</p>
</div></blockquote>
<p>None</p>
</dd>
<dt>case TweetFieldsResultState.Found(TweetFieldsResultFound(_, _, Some(filteredReason))) =&gt;</dt><dd><p>toAction(filteredReason, actionStatsReceiver)</p>
</dd>
<dt>case _ =&gt;</dt><dd><p>None</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>}</p>
<dl>
<dt>private[conversations] def shouldTruncateDescendantsWhenFocal(action: Action): Boolean =</dt><dd><dl>
<dt>action match {</dt><dd><dl>
<dt>case _: InterstitialLimitedEngagements | _: EmergencyDynamicInterstitial =&gt;</dt><dd><p>true</p>
</dd>
<dt>case Tombstone(Epitaph.Bounced, _) | Tombstone(Epitaph.BounceDeleted, _) =&gt;</dt><dd><p>true</p>
</dd>
<dt>case LocalizedTombstone(TombstoneReason.Bounced, _) |</dt><dd><blockquote>
<div><p>LocalizedTombstone(TombstoneReason.BounceDeleted, _) =&gt;</p>
</div></blockquote>
<p>true</p>
</dd>
<dt>case LimitedEngagements(LimitedEngagementReason.NonCompliant, _) =&gt;</dt><dd><p>true</p>
</dd>
</dl>
<p>case _ =&gt; false</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>def apply(request: TombstoneVisibilityRequest): Stitch[TombstoneVisibilityResponse] = {</p>
<blockquote>
<div><dl class="simple">
<dt>val moderationFeatures = new ModerationFeatures(</dt><dd><p>moderationSource = request.moderatedTweetIds.contains,
statsReceiver = statsReceiver</p>
</dd>
</dl>
<p>)</p>
<dl class="simple">
<dt>val userSource = UserSource.fromFunction({</dt><dd><dl class="simple">
<dt>case (userId, _) =&gt;</dt><dd><dl class="simple">
<dt>request.authorMap</dt><dd><p>.get(userId)
.map(Stitch.value).getOrElse(Stitch.NotFound)</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p>})</p>
<p>val authorFeatures = new AuthorFeatures(userSource, statsReceiver)
val viewerFeatures = new ViewerFeatures(userSource, statsReceiver)</p>
<p>val languageTag = request.viewerContext.requestCountryCode.getOrElse(En)
val firstRound: Seq[(GetTweetFieldsResult, Option[TombstoneType])] = request.tweets.map {</p>
<blockquote>
<div><dl>
<dt>case (gtfr, safetyLevel) =&gt;</dt><dd><dl>
<dt>val actionStats = statsReceiver</dt><dd><p>.scope(“action”)
.scope(safetyLevel.map(_.toString().toLowerCase()).getOrElse(“unknown_safety_level”))</p>
</dd>
<dt>toAction(gtfr.tweetResult, actionStats) match {</dt><dd><dl>
<dt>case Some(action) =&gt;</dt><dd><p>(gtfr, Some(TombstoneType(gtfr.tweetId, gtfr.tweetId, action)))</p>
</dd>
<dt>case None =&gt;</dt><dd><dl>
<dt>val quotedTweetId: Option[Long] = gtfr.tweetResult match {</dt><dd><dl class="simple">
<dt>case TweetFieldsResultState.Found(TweetFieldsResultFound(tweet, _, _)) =&gt;</dt><dd><p>tweet.quotedTweet.map(_.tweetId)</p>
</dd>
</dl>
<p>case _ =&gt; None</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>(quotedTweetId, gtfr.quotedTweetResult) match {</dt><dd><dl>
<dt>case (Some(quotedTweetId), Some(tfrs)) =&gt;</dt><dd><p>val qtActionStats = actionStats.scope(“quoted”)
toAction(tfrs, qtActionStats) match {</p>
<blockquote>
<div><dl class="simple">
<dt>case None =&gt;</dt><dd><p>(gtfr, None)</p>
</dd>
<dt>case Some(action) =&gt;</dt><dd><p>(gtfr, Some(TombstoneType(gtfr.tweetId, quotedTweetId, action)))</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
</dd>
<dt>case _ =&gt;</dt><dd><p>(gtfr, None)</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
<dl>
<dt>val (firstRoundActions, secondRoundInput) = firstRound.partition {</dt><dd><dl class="simple">
<dt>case (_, Some(tombstoneType)) =&gt;</dt><dd><p>!tombstoneType.isInnerTombstone</p>
</dd>
</dl>
<p>case (_, None) =&gt; false</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>def invokeVisibilityLibrary(tweetId: Long, author: User): Stitch[Action] = {</dt><dd><dl>
<dt>visibilityLibrary</dt><dd><dl>
<dt>.runRuleEngine(</dt><dd><p>ContentId.TweetId(tweetId),
visibilityLibrary.featureMapBuilder(</p>
<blockquote>
<div><dl>
<dt>Seq(</dt><dd><p>viewerFeatures.forViewerContext(request.viewerContext),
moderationFeatures.forTweetId(tweetId),
authorFeatures.forAuthor(author),
relationshipFeatures</p>
<blockquote>
<div><p>.forAuthor(author, request.viewerContext.userId),</p>
</div></blockquote>
<p>_.withConstantFeature(TweetId, tweetId),
_.withConstantFeature(FocalTweetId, request.focalTweetId)</p>
</dd>
</dl>
<p>)</p>
</div></blockquote>
<p>),
request.viewerContext,
Tombstoning</p>
</dd>
</dl>
<p>).map(_.verdict)</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<dl>
<dt>val secondRoundActions: Stitch[Seq[(GetTweetFieldsResult, Option[TombstoneType])]] =</dt><dd><dl>
<dt>Stitch.traverse(secondRoundInput) {</dt><dd><dl>
<dt>case (gtfr: GetTweetFieldsResult, firstRoundTombstone: Option[TombstoneType]) =&gt;</dt><dd><dl>
<dt>val secondRoundTombstone: Stitch[Option[TombstoneType]] = gtfr.tweetResult match {</dt><dd><dl>
<dt>case TweetFieldsResultState.Found(TweetFieldsResultFound(tweet, _, _)) =&gt;</dt><dd><p>val tweetId = tweet.id</p>
<dl>
<dt>tweet.coreData</dt><dd><p>.flatMap { coreData =&gt; request.authorMap.get(coreData.userId) } match {
case Some(author) =&gt;</p>
<blockquote>
<div><dl>
<dt>invokeVisibilityLibrary(tweetId, author).flatMap {</dt><dd><dl>
<dt>case Allow =&gt;</dt><dd><p>val quotedTweetId = tweet.quotedTweet.map(_.tweetId)
val quotedTweetAuthor = tweet.quotedTweet.flatMap { qt =&gt;</p>
<blockquote>
<div><p>request.authorMap.get(qt.userId)</p>
</div></blockquote>
<p>}</p>
<dl>
<dt>(quotedTweetId, quotedTweetAuthor) match {</dt><dd><dl>
<dt>case (Some(quotedTweetId), Some(quotedTweetAuthor)) =&gt;</dt><dd><dl class="simple">
<dt>invokeVisibilityLibrary(quotedTweetId, quotedTweetAuthor).flatMap {</dt><dd><dl class="simple">
<dt>case Allow =&gt;</dt><dd><p>Stitch.None</p>
</dd>
<dt>case reason =&gt;</dt><dd><p>Stitch.value(Some(TombstoneType(tweetId, quotedTweetId, reason)))</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</dd>
<dt>case _ =&gt;</dt><dd><p>Stitch.None</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</dd>
<dt>case reason =&gt;</dt><dd><p>Stitch.value(Some(TombstoneType(tweetId, tweetId, reason)))</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<dl class="simple">
<dt>case None =&gt;</dt><dd><p>Stitch.None</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</dd>
<dt>case _ =&gt;</dt><dd><p>Stitch.None</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>secondRoundTombstone.map { opt =&gt; opt.orElse(firstRoundTombstone) }.map { opt =&gt;</dt><dd><p>(gtfr, opt)</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</dd>
<dt>secondRoundActions.map { secondRound =&gt;</dt><dd><dl>
<dt>val tombstones: Seq[(Long, VfTombstone)] = (firstRoundActions ++ secondRound).flatMap {</dt><dd><p>case (gtfr, tombstoneTypeOpt) =&gt; {</p>
<blockquote>
<div><dl>
<dt>val nonCompliantLimitedEngagementsOpt = gtfr.tweetResult match {</dt><dd><dl>
<dt>case TweetFieldsResultState.Found(TweetFieldsResultFound(_, _, Some(filteredReason)))</dt><dd><blockquote>
<div><p>if FilteredReasonHelper.isLimitedEngagementsNonCompliant(filteredReason) =&gt;</p>
</div></blockquote>
<p>Some(LimitedEngagements(LimitedEngagementReason.NonCompliant))</p>
</dd>
</dl>
<p>case _ =&gt; None</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>(tombstoneTypeOpt, nonCompliantLimitedEngagementsOpt) match {</dt><dd><dl>
<dt>case (Some(tombstoneType), nonCompliantOpt) =&gt;</dt><dd><p>val tombstoneId = tombstoneType.tombstoneId
val action = tombstoneType.action
val textOpt: Option[RichText] = action match {</p>
<blockquote>
<div><dl>
<dt>case InterstitialLimitedEngagements(_, _, Some(localizedMessage), _) =&gt;</dt><dd><p>Some(LocalizedMessageToRichText(localizedMessage))</p>
</dd>
<dt>case ipi: InterstitialLimitedEngagements =&gt;</dt><dd><dl>
<dt>Some(</dt><dd><dl>
<dt>SafetyResultToUrtParser.fromSafetyResultToRichText(</dt><dd><dl class="simple">
<dt>SafetyResult(</dt><dd><p>Some(PublicInterest.ReasonToSafetyResultReason(ipi.reason)),
ipi.toActionThrift()</p>
</dd>
</dl>
<p>),
languageTag</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
<p>)</p>
</dd>
<dt>case EmergencyDynamicInterstitial(_, _, Some(localizedMessage), _) =&gt;</dt><dd><p>Some(LocalizedMessageToRichText(localizedMessage))</p>
</dd>
<dt>case edi: EmergencyDynamicInterstitial =&gt;</dt><dd><dl>
<dt>Some(</dt><dd><dl>
<dt>SafetyResultToUrtParser.fromSafetyResultToRichText(</dt><dd><dl class="simple">
<dt>SafetyResult(</dt><dd><p>None,
edi.toActionThrift()</p>
</dd>
</dl>
<p>),
languageTag</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
<p>)</p>
</dd>
<dt>case Tombstone(epitaph, _) =&gt;</dt><dd><dl class="simple">
<dt>if (request.useRichText)</dt><dd><p>Some(EpitaphToRichText(epitaph, languageTag))</p>
</dd>
<dt>else</dt><dd><p>Some(EpitaphToRichText(Epitaph.UnavailableWithoutLink, languageTag))</p>
</dd>
</dl>
</dd>
<dt>case LocalizedTombstone(_, message) =&gt;</dt><dd><dl class="simple">
<dt>if (request.useRichText)</dt><dd><p>Some(LocalizedMessageToRichText(LocalizedMessageConverter.toThrift(message)))</p>
</dd>
<dt>else</dt><dd><p>Some(EpitaphToRichText(Epitaph.UnavailableWithoutLink, languageTag))</p>
</dd>
</dl>
</dd>
<dt>case Interstitial(_, Some(localizedMessage), _) =&gt;</dt><dd><p>Some(LocalizedMessageToRichText.apply(localizedMessage))</p>
</dd>
<dt>case interstitial: Interstitial =&gt;</dt><dd><p>ReasonToUrtParser.fromReasonToRichText(interstitial.reason, languageTag)</p>
</dd>
<dt>case _ =&gt;</dt><dd><p>None</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
<p>val isRoot: Boolean = gtfr.tweetId == request.conversationId
val isOuter: Boolean = tombstoneId == request.conversationId
val revealTextOpt: Option[RichText] = action match {</p>
<blockquote>
<div><dl>
<dt>case _: InterstitialLimitedEngagements | _: EmergencyDynamicInterstitial</dt><dd><blockquote>
<div><p>if isRoot &amp;&amp; isOuter =&gt;</p>
</div></blockquote>
<p>None</p>
</dd>
<dt>case _: Interstitial | _: InterstitialLimitedEngagements |</dt><dd><blockquote>
<div><p>_: EmergencyDynamicInterstitial =&gt;</p>
</div></blockquote>
<p>Some(ReasonToUrtParser.getRichRevealText(languageTag))</p>
</dd>
<dt>case _ =&gt;</dt><dd><p>None</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
<dl>
<dt>val includeTweet = action match {</dt><dd><dl>
<dt>case _: Interstitial | _: InterstitialLimitedEngagements |</dt><dd><blockquote>
<div><p>_: EmergencyDynamicInterstitial =&gt;</p>
</div></blockquote>
<p>true</p>
</dd>
</dl>
<p>case _ =&gt; false</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>val truncateForAction: Boolean =</dt><dd><p>shouldTruncateDescendantsWhenFocal(action)</p>
</dd>
<dt>val truncateForNonCompliant: Boolean =</dt><dd><dl class="simple">
<dt>nonCompliantOpt</dt><dd><p>.map(shouldTruncateDescendantsWhenFocal).getOrElse(false)</p>
</dd>
</dl>
</dd>
<dt>val truncateDescendants: Boolean =</dt><dd><p>truncateForAction || truncateForNonCompliant</p>
</dd>
<dt>val tombstone = textOpt match {</dt><dd><dl>
<dt>case Some(_) if request.useRichText =&gt;</dt><dd><dl>
<dt>VfTombstone(</dt><dd><p>includeTweet = includeTweet,
action = action,
tombstoneInfo = Some(</p>
<blockquote>
<div><dl class="simple">
<dt>TombstoneInfo(</dt><dd><p>cta = None,
revealText = None,
richText = textOpt,
richRevealText = revealTextOpt</p>
</dd>
</dl>
<p>)</p>
</div></blockquote>
<p>),
tombstoneDisplayType = tombstoneType.tombstoneDisplayType,
truncateDescendantsWhenFocal = truncateDescendants</p>
</dd>
</dl>
<p>)</p>
</dd>
<dt>case Some(_) =&gt;</dt><dd><dl>
<dt>VfTombstone(</dt><dd><p>includeTweet = includeTweet,
action = action,
tombstoneInfo = Some(</p>
<blockquote>
<div><dl>
<dt>TombstoneInfo(</dt><dd><dl class="simple">
<dt>text = textOpt</dt><dd><dl class="simple">
<dt>.map(richText =&gt; richText.text).getOrElse(</dt><dd><p>“”</p>
</dd>
</dl>
</dd>
</dl>
<p>cta = None,
revealText = revealTextOpt.map(_.text),
richText = None,
richRevealText = None</p>
</dd>
</dl>
<p>)</p>
</div></blockquote>
<p>),
tombstoneDisplayType = tombstoneType.tombstoneDisplayType,
truncateDescendantsWhenFocal = truncateDescendants</p>
</dd>
</dl>
<p>)</p>
</dd>
<dt>case None =&gt;</dt><dd><dl>
<dt>VfTombstone(</dt><dd><p>includeTweet = false,
action = action,
tombstoneInfo = Some(</p>
<blockquote>
<div><dl class="simple">
<dt>TombstoneInfo(</dt><dd><p>cta = None,
revealText = None,
richText = Some(EpitaphToRichText(Epitaph.Unavailable, languageTag)),
richRevealText = None</p>
</dd>
</dl>
<p>)</p>
</div></blockquote>
<p>),
tombstoneDisplayType = tombstoneType.tombstoneDisplayType,
truncateDescendantsWhenFocal = truncateDescendants</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<p>Some((gtfr.tweetId, tombstone))</p>
</dd>
<dt>case (None, Some(limitedEngagements))</dt><dd><blockquote>
<div><p>if shouldTruncateDescendantsWhenFocal(limitedEngagements) =&gt;</p>
</div></blockquote>
<dl class="simple">
<dt>val tombstone = VfTombstone(</dt><dd><p>tombstoneId = gtfr.tweetId,
includeTweet = true,
action = limitedEngagements,
tombstoneInfo = None,
tombstoneDisplayType = TombstoneDisplayType.NonCompliant,
truncateDescendantsWhenFocal = true</p>
</dd>
</dl>
<p>)
Some((gtfr.tweetId, tombstone))</p>
</dd>
<dt>case _ =&gt;</dt><dd><p>None</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>TombstoneVisibilityResponse(</dt><dd><p>tweetVerdicts = tombstones.toMap</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}</p>
<dl class="simple">
<dt>private def createLocalizedTombstone(</dt><dd><p>filteredReason: FilteredReason,
tombstoneStats: StatsReceiver,</p>
</dd>
</dl>
<p>): Option[LocalizedTombstone] = {</p>
<blockquote>
<div><p>val tombstoneOpt = FilteredReasonHelper.getTombstone(filteredReason)
tombstoneOpt match {</p>
<blockquote>
<div><dl>
<dt>case Some(t.Tombstone(reasonOpt, Some(message))) =&gt;</dt><dd><dl>
<dt>TombstoneReasonConverter.fromThrift(reasonOpt).map { localReason =&gt;</dt><dd><dl class="simple">
<dt>tombstoneStats</dt><dd><p>.scope(“localized”).counter(localReason.toString().toLowerCase()).incr()</p>
</dd>
</dl>
<p>LocalizedTombstone(localReason, LocalizedMessageConverter.fromThrift(message))</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>case _ =&gt; None</p>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>}</p>
<dl>
<dt>private def createTombstone(</dt><dd><p>epitaph: Epitaph,
tombstoneStats: StatsReceiver,
extraCounterOpt: Option[String] = None</p>
</dd>
<dt>): Option[Action] = {</dt><dd><dl class="simple">
<dt>tombstoneStats</dt><dd><p>.scope(“legacy”)
.counter(epitaph.toString().toLowerCase())
.incr()</p>
</dd>
<dt>extraCounterOpt.map { extraCounter =&gt;</dt><dd><dl class="simple">
<dt>tombstoneStats</dt><dd><p>.scope(“legacy”)
.scope(epitaph.toString().toLowerCase())
.counter(extraCounter)
.incr()</p>
</dd>
</dl>
</dd>
</dl>
<p>}
Some(Tombstone(epitaph))</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../../../../index2.rst.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../../../../index2.rst.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../../../../_sources/visibilitylib/src/main/scala/com/twitter/visibility/interfaces/conversations/TombstoneVisibilityLibrary.scala.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>