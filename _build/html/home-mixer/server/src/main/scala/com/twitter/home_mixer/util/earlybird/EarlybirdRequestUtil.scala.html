<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../../../../../" id="documentation_options" src="../../../../../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>package com.twitter.home_mixer.util.earlybird</p>
<p>import com.twitter.conversions.DurationOps._
import com.twitter.search.common.query.thriftjava.{thriftscala =&gt; scq}
import com.twitter.search.common.ranking.{thriftscala =&gt; scr}
import com.twitter.search.earlybird.{thriftscala =&gt; eb}
import com.twitter.timelines.clients.relevance_search.SearchClient.TweetFeatures
import com.twitter.timelines.clients.relevance_search.SearchClient.TweetTypes
import com.twitter.timelines.clients.relevance_search.SearchQueryBuilder
import com.twitter.timelines.clients.relevance_search.SearchQueryBuilder.QueryWithNamedDisjunctions
import com.twitter.timelines.earlybird.common.options.EarlybirdScoringModelConfig
import com.twitter.timelines.earlybird.common.utils.SearchOperator
import com.twitter.util.Duration</p>
<p>object EarlybirdRequestUtil {</p>
<blockquote>
<div><p>val DefaultMaxHitsToProcess = 1000
val DefaultSearchProcessingTimeout: Duration = 200.milliseconds
val DefaultHydrationMaxNumResultsPerShard = 1000
val DefaultQueryMaxNumResultsPerShard = 300
val DefaultHydrationCollectorParams = mkCollectorParams(DefaultHydrationMaxNumResultsPerShard)</p>
<p>private val queryBuilder = new SearchQueryBuilder</p>
<dl>
<dt>object EarlybirdScoringModels {</dt><dd><dl class="simple">
<dt>val UnifiedEngagementProd: Seq[EarlybirdScoringModelConfig] = Seq(</dt><dd><p>EarlybirdScoringModelConfig(“timelines_unified_engagement_prod.schema_based”, 1.0)</p>
</dd>
</dl>
<p>)</p>
<dl class="simple">
<dt>val UnifiedEngagementRectweet: Seq[EarlybirdScoringModelConfig] = Seq(</dt><dd><p>EarlybirdScoringModelConfig(“timelines_unified_engagement_rectweet.schema_based”, 1.0)</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private[earlybird] def mkCollectorParams(numResultsToReturn: Int): scq.CollectorParams = {</dt><dd><dl>
<dt>scq.CollectorParams(</dt><dd><p>// numResultsToReturn defines how many results each EB shard will return to search root
numResultsToReturn = numResultsToReturn,
// terminationParams.maxHitsToProcess is used for early terminating per shard results fetching.
terminationParams = Some(</p>
<blockquote>
<div><dl class="simple">
<dt>scq.CollectorTerminationParams(</dt><dd><p>maxHitsToProcess = Some(DefaultMaxHitsToProcess),
timeoutMs = DefaultSearchProcessingTimeout.inMilliseconds.toInt</p>
</dd>
</dl>
<p>))</p>
</div></blockquote>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private def getRankingParams(</dt><dd><p>authorScoreMap: Option[Map[Long, Double]],
tensorflowModel: Option[String],
ebModels: Seq[EarlybirdScoringModelConfig]</p>
</dd>
<dt>): Option[scr.ThriftRankingParams] = {</dt><dd><dl>
<dt>if (tensorflowModel.nonEmpty) {</dt><dd><dl>
<dt>Some(</dt><dd><dl class="simple">
<dt>scr.ThriftRankingParams(</dt><dd><p><cite>type</cite> = Some(scr.ThriftScoringFunctionType.TensorflowBased),
selectedTensorflowModel = tensorflowModel,
minScore = -1.0e100,
applyBoosts = false,
authorSpecificScoreAdjustments = authorScoreMap</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
<p>)</p>
</dd>
<dt>} else if (ebModels.nonEmpty) {</dt><dd><dl>
<dt>Some(</dt><dd><dl class="simple">
<dt>scr.ThriftRankingParams(</dt><dd><p><cite>type</cite> = Some(scr.ThriftScoringFunctionType.ModelBased),
selectedModels = Some(ebModels.map(m =&gt; m.name -&gt; m.weight).toMap),
applyBoosts = false,
minScore = -1.0e100,
authorSpecificScoreAdjustments = authorScoreMap</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
<p>} else None</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>def getTweetsRequest(</dt><dd><p>userId: Option[Long],
clientId: Option[String],
skipVeryRecentTweets: Boolean,
followedUserIds: Set[Long],
retweetsMutedUserIds: Set[Long],
beforeTweetIdExclusive: Option[Long],
afterTweetIdExclusive: Option[Long],
excludedTweetIds: Option[Set[Long]] = None,
maxCount: Int,
tweetTypes: TweetTypes.ValueSet,
authorScoreMap: Option[Map[Long, Double]] = None,
tensorflowModel: Option[String] = None,
ebModels: Seq[EarlybirdScoringModelConfig] = Seq.empty,
queryMaxNumResultsPerShard: Int = DefaultQueryMaxNumResultsPerShard</p>
</dd>
</dl>
<p>): eb.EarlybirdRequest = {</p>
<blockquote>
<div><dl class="simple">
<dt>val QueryWithNamedDisjunctions(query, namedDisjunctionMap) = queryBuilder.create(</dt><dd><p>followedUserIds,
retweetsMutedUserIds,
beforeTweetIdExclusive,
afterTweetIdExclusive,
semanticCoreIds = None,
languages = None,
tweetTypes = tweetTypes,
searchOperator = SearchOperator.Exclude,
tweetFeatures = TweetFeatures.All,
excludedTweetIds = excludedTweetIds.getOrElse(Set.empty),
enableExcludeSourceTweetIdsQuery = false</p>
</dd>
</dl>
<p>)
val ebRankingParams = getRankingParams(authorScoreMap, tensorflowModel, ebModels)
val relOptions = RelevanceSearchUtil.RelevanceOptions.copy(</p>
<blockquote>
<div><p>rankingParams = ebRankingParams</p>
</div></blockquote>
<p>)</p>
<p>val followedUserIdsSeq = followedUserIds.toSeq
val namedDisjunctionMapOpt =</p>
<blockquote>
<div><p>if (namedDisjunctionMap.isEmpty) None
else Some(namedDisjunctionMap.mapValues(_.toSeq))</p>
</div></blockquote>
<dl class="simple">
<dt>val thriftQuery = eb.ThriftSearchQuery(</dt><dd><p>serializedQuery = Some(query.serialize),
fromUserIDFilter64 = Some(followedUserIdsSeq),
numResults = maxCount,
collectConversationId = true,
rankingMode = eb.ThriftSearchRankingMode.Relevance,
relevanceOptions = Some(relOptions),
collectorParams = Some(mkCollectorParams(queryMaxNumResultsPerShard)),
facetFieldNames = Some(RelevanceSearchUtil.FacetsToFetch),
resultMetadataOptions = Some(RelevanceSearchUtil.MetadataOptions),
searcherId = userId,
searchStatusIds = None,
namedDisjunctionMap = namedDisjunctionMapOpt</p>
</dd>
</dl>
<p>)</p>
<dl class="simple">
<dt>eb.EarlybirdRequest(</dt><dd><p>searchQuery = thriftQuery,
clientId = clientId,
getOlderResults = Some(false),
followedUserIds = Some(followedUserIdsSeq),
getProtectedTweetsOnly = Some(false),
timeoutMs = DefaultSearchProcessingTimeout.inMilliseconds.toInt,
skipVeryRecentTweets = skipVeryRecentTweets,
numResultsToReturnAtRoot = Some(maxCount)</p>
</dd>
</dl>
<p>)</p>
</div></blockquote>
<p>}</p>
<dl class="simple">
<dt>def getTweetsFeaturesRequest(</dt><dd><p>userId: Option[Long],
tweetIds: Option[Seq[Long]],
clientId: Option[String],
getOnlyProtectedTweets: Boolean = false,
authorScoreMap: Option[Map[Long, Double]] = None,
tensorflowModel: Option[String] = None,
ebModels: Seq[EarlybirdScoringModelConfig] = Seq.empty</p>
</dd>
</dl>
<p>): eb.EarlybirdRequest = {</p>
<blockquote>
<div><p>val candidateSize = tweetIds.getOrElse(Seq.empty).size
val ebRankingParams = getRankingParams(authorScoreMap, tensorflowModel, ebModels)
val relOptions = RelevanceSearchUtil.RelevanceOptions.copy(</p>
<blockquote>
<div><p>rankingParams = ebRankingParams</p>
</div></blockquote>
<p>)
val thriftQuery = eb.ThriftSearchQuery(</p>
<blockquote>
<div><p>numResults = candidateSize,
collectConversationId = true,
rankingMode = eb.ThriftSearchRankingMode.Relevance,
relevanceOptions = Some(relOptions),
collectorParams = Some(DefaultHydrationCollectorParams),
facetFieldNames = Some(RelevanceSearchUtil.FacetsToFetch),
resultMetadataOptions = Some(RelevanceSearchUtil.MetadataOptions),
searcherId = userId,
searchStatusIds = tweetIds.map(_.toSet),</p>
</div></blockquote>
<p>)</p>
<dl class="simple">
<dt>eb.EarlybirdRequest(</dt><dd><p>searchQuery = thriftQuery,
clientId = clientId,
getOlderResults = Some(false),
getProtectedTweetsOnly = Some(getOnlyProtectedTweets),
timeoutMs = DefaultSearchProcessingTimeout.inMilliseconds.toInt,
skipVeryRecentTweets = true,
// This param decides # of tweets to return from search superRoot and realtime/protected/Archive roots.
// It takes higher precedence than ThriftSearchQuery.numResults
numResultsToReturnAtRoot = Some(candidateSize)</p>
</dd>
</dl>
<p>)</p>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>}</p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../../../../../index.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../../../../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../../../../../_sources/home-mixer/server/src/main/scala/com/twitter/home_mixer/util/earlybird/EarlybirdRequestUtil.scala.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>