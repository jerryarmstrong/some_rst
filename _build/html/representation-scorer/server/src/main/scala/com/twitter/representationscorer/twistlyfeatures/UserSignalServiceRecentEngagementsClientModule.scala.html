<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../../../../" id="documentation_options" src="../../../../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>package com.twitter.representationscorer.twistlyfeatures</p>
<p>import com.github.benmanes.caffeine.cache.Caffeine
import com.twitter.stitch.cache.EvictingCache
import com.google.inject.Provides
import com.twitter.finagle.stats.StatsReceiver
import com.twitter.inject.TwitterModule
import com.twitter.representationscorer.common.RepresentationScorerDecider
import com.twitter.stitch.Stitch
import com.twitter.stitch.cache.ConcurrentMapCache
import com.twitter.stitch.cache.MemoizeQuery
import com.twitter.strato.client.Client
import com.twitter.strato.generated.client.recommendations.user_signal_service.SignalsClientColumn
import java.util.concurrent.ConcurrentMap
import java.util.concurrent.TimeUnit
import javax.inject.Singleton</p>
<p>object UserSignalServiceRecentEngagementsClientModule extends TwitterModule {</p>
<blockquote>
<div><p>&#64;Singleton
&#64;Provides
def provide(</p>
<blockquote>
<div><p>client: Client,
decider: RepresentationScorerDecider,
statsReceiver: StatsReceiver</p>
</div></blockquote>
<dl>
<dt>): Long =&gt; Stitch[Engagements] = {</dt><dd><p>val stratoClient = new SignalsClientColumn(client)</p>
<p>/*
This cache holds a users recent engagements for a short period of time, such that batched requests
for multiple (userid, tweetid) pairs don’t all need to fetch them.</p>
<p>[1] Caffeine cache keys/values must be objects, so we cannot use the <cite>Long</cite> primitive directly.
The boxed java.lang.Long works as a key, since it is an object. In most situations the compiler
can see where auto(un)boxing can occur. However, here we seem to need some wrapper functions
with explicit types to allow the boxing to happen.</p>
<blockquote>
<div><p><a href="#id1"><span class="problematic" id="id2">*</span></a>/</p>
</div></blockquote>
<dl>
<dt>val mapCache: ConcurrentMap[java.lang.Long, Stitch[Engagements]] =</dt><dd><dl>
<dt>Caffeine</dt><dd><p>.newBuilder()
.expireAfterWrite(5, TimeUnit.SECONDS)
.maximumSize(</p>
<blockquote>
<div><p>1000 // We estimate 5M unique users in a 5m period - with 2k RSX instances, assume that one will see &lt; 1k in a 5s period</p>
</div></blockquote>
<p>)
.build[java.lang.Long, Stitch[Engagements]]
.asMap</p>
</dd>
</dl>
</dd>
</dl>
<p>statsReceiver.provideGauge(“ussRecentEngagementsClient”, “cache_size”) { mapCache.size.toFloat }</p>
<dl class="simple">
<dt>val engagementsClient =</dt><dd><p>new UserSignalServiceRecentEngagementsClient(stratoClient, decider, statsReceiver)</p>
</dd>
</dl>
<p>val f = (l: java.lang.Long) =&gt; engagementsClient.get(l) // See note [1] above
val cachedCall = MemoizeQuery(f, EvictingCache.lazily(new ConcurrentMapCache(mapCache)))
(l: Long) =&gt; cachedCall(l) // see note [1] above</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}</p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../../../../index2.rst.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../../../../index2.rst.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../../../../_sources/representation-scorer/server/src/main/scala/com/twitter/representationscorer/twistlyfeatures/UserSignalServiceRecentEngagementsClientModule.scala.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>