<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../../../../" id="documentation_options" src="../../../../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>package com.twitter.cr_mixer.similarity_engine</p>
<p>import com.twitter.cr_mixer.model.SimilarityEngineInfo
import com.twitter.cr_mixer.model.SourceInfo
import com.twitter.cr_mixer.model.TweetWithScore
import com.twitter.cr_mixer.param.ConsumerBasedWalsParams
import com.twitter.cr_mixer.similarity_engine.ConsumerBasedWalsSimilarityEngine.Query
import com.twitter.cr_mixer.thriftscala.SimilarityEngineType
import com.twitter.cr_mixer.thriftscala.SourceType
import com.twitter.finagle.stats.StatsReceiver
import com.twitter.simclusters_v2.thriftscala.InternalId
import com.twitter.storehaus.ReadableStore
import com.twitter.timelines.configapi
import com.twitter.util.Future
import io.grpc.ManagedChannel
import tensorflow.serving.Predict.PredictRequest
import tensorflow.serving.Predict.PredictResponse
import tensorflow.serving.PredictionServiceGrpc
import org.tensorflow.example.Feature
import org.tensorflow.example.Int64List
import org.tensorflow.example.FloatList
import org.tensorflow.example.Features
import org.tensorflow.example.Example
import tensorflow.serving.Model
import org.tensorflow.framework.TensorProto
import org.tensorflow.framework.DataType
import org.tensorflow.framework.TensorShapeProto
import com.twitter.finagle.grpc.FutureConverters
import java.util.ArrayList
import java.lang
import com.twitter.util.Return
import com.twitter.util.Throw
import java.util.concurrent.ConcurrentHashMap
import scala.jdk.CollectionConverters._</p>
<p>// Stats object maintain a set of stats that are specific to the Wals Engine.
case class WalsStats(scope: String, scopedStats: StatsReceiver) {</p>
<blockquote>
<div><p>val requestStat = scopedStats.scope(scope)
val inputSignalSize = requestStat.stat(“input_signal_size”)</p>
<p>val latency = requestStat.stat(“latency_ms”)
val latencyOnError = requestStat.stat(“error_latency_ms”)
val latencyOnSuccess = requestStat.stat(“success_latency_ms”)</p>
<p>val requests = requestStat.counter(“requests”)
val success = requestStat.counter(“success”)
val failures = requestStat.scope(“failures”)</p>
<dl class="simple">
<dt>def onFailure(t: Throwable, startTimeMs: Long) {</dt><dd><p>val duration = System.currentTimeMillis() - startTimeMs
latency.add(duration)
latencyOnError.add(duration)
failures.counter(t.getClass.getName).incr()</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>def onSuccess(startTimeMs: Long) {</dt><dd><p>val duration = System.currentTimeMillis() - startTimeMs
latency.add(duration)
latencyOnSuccess.add(duration)
success.incr()</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}</p>
<p>// StatsMap maintains a mapping from Model’s input signature to a stats receiver
// The Wals model suports multiple input signature which can run different graphs internally and
// can have a different performance profile.
// Invoking StatsReceiver.stat() on each request can create a new stat object and can be expensive
// in performance critical paths.
object WalsStatsMap {</p>
<blockquote>
<div><p>val mapping = new ConcurrentHashMap[String, WalsStats]()</p>
<dl class="simple">
<dt>def get(scope: String, scopedStats: StatsReceiver): WalsStats = {</dt><dd><p>mapping.computeIfAbsent(scope, (scope) =&gt; WalsStats(scope, scopedStats))</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}</p>
<dl>
<dt>case class ConsumerBasedWalsSimilarityEngine(</dt><dd><p>homeNaviGRPCClient: ManagedChannel,
adsFavedNaviGRPCClient: ManagedChannel,
adsMonetizableNaviGRPCClient: ManagedChannel,
statsReceiver: StatsReceiver)</p>
<blockquote>
<div><dl class="simple">
<dt>extends ReadableStore[</dt><dd><p>Query,
Seq[TweetWithScore]</p>
</dd>
</dl>
<p>] {</p>
</div></blockquote>
<dl>
<dt>override def get(</dt><dd><p>query: ConsumerBasedWalsSimilarityEngine.Query</p>
</dd>
<dt>): Future[Option[Seq[TweetWithScore]]] = {</dt><dd><p>val startTimeMs = System.currentTimeMillis()
val stats =</p>
<blockquote>
<div><dl class="simple">
<dt>WalsStatsMap.get(</dt><dd><p>query.wilyNsName + “/” + query.modelSignatureName,
statsReceiver.scope(“NaviPredictionService”)</p>
</dd>
</dl>
<p>)</p>
</div></blockquote>
<p>stats.requests.incr()
stats.inputSignalSize.add(query.sourceIds.size)
try {</p>
<blockquote>
<div><p>// avoid inference calls is source signals are empty
if (query.sourceIds.isEmpty) {</p>
<blockquote>
<div><p>Future.value(Some(Seq.empty))</p>
</div></blockquote>
<dl>
<dt>} else {</dt><dd><dl class="simple">
<dt>val grpcClient = query.wilyNsName match {</dt><dd><p>case “navi-wals-recommended-tweets-home-client” =&gt; homeNaviGRPCClient
case “navi-wals-ads-faved-tweets” =&gt; adsFavedNaviGRPCClient
case “navi-wals-ads-monetizable-tweets” =&gt; adsFavedNaviGRPCClient
// default to homeNaviGRPCClient
case _ =&gt; homeNaviGRPCClient</p>
</dd>
</dl>
<p>}
val stub = PredictionServiceGrpc.newFutureStub(grpcClient)
val inferRequest = getModelInput(query)</p>
<dl>
<dt>FutureConverters</dt><dd><p>.RichListenableFuture(stub.predict(inferRequest)).toTwitter
.transform {</p>
<blockquote>
<div><dl class="simple">
<dt>case Return(resp) =&gt;</dt><dd><p>stats.onSuccess(startTimeMs)
Future.value(Some(getModelOutput(query, resp)))</p>
</dd>
<dt>case Throw(e) =&gt;</dt><dd><p>stats.onFailure(e, startTimeMs)
Future.exception(e)</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<dl class="simple">
<dt>} catch {</dt><dd><p>case e: Throwable =&gt; Future.exception(e)</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>def getFeaturesForRecommendations(query: ConsumerBasedWalsSimilarityEngine.Query): Example = {</dt><dd><p>val tweetIds = new ArrayList[lang.Long]()
val tweetFaveWeight = new ArrayList[lang.Float]()</p>
<dl>
<dt>query.sourceIds.foreach { sourceInfo =&gt;</dt><dd><dl>
<dt>val weight = sourceInfo.sourceType match {</dt><dd><p>case SourceType.TweetFavorite | SourceType.Retweet =&gt; 1.0f
// currently no-op - as we do not get negative signals
case SourceType.TweetDontLike | SourceType.TweetReport | SourceType.AccountMute |</p>
<blockquote>
<div><blockquote>
<div><p>SourceType.AccountBlock =&gt;</p>
</div></blockquote>
<p>0.0f</p>
</div></blockquote>
<p>case _ =&gt; 0.0f</p>
</dd>
</dl>
<p>}
sourceInfo.internalId match {</p>
<blockquote>
<div><dl class="simple">
<dt>case InternalId.TweetId(tweetId) =&gt;</dt><dd><p>tweetIds.add(tweetId)
tweetFaveWeight.add(weight)</p>
</dd>
<dt>case _ =&gt;</dt><dd><dl class="simple">
<dt>throw new IllegalArgumentException(</dt><dd><p>s”Invalid InternalID - does not contain TweetId for Source Signal: ${sourceInfo}”)</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>val tweetIdsFeature =</dt><dd><dl>
<dt>Feature</dt><dd><dl class="simple">
<dt>.newBuilder().setInt64List(</dt><dd><dl class="simple">
<dt>Int64List</dt><dd><p>.newBuilder().addAllValue(tweetIds).build()</p>
</dd>
</dl>
</dd>
</dl>
<p>).build()</p>
</dd>
</dl>
</dd>
<dt>val tweetWeightsFeature = Feature</dt><dd><dl class="simple">
<dt>.newBuilder().setFloatList(</dt><dd><p>FloatList.newBuilder().addAllValue(tweetFaveWeight).build()).build()</p>
</dd>
</dl>
</dd>
<dt>val features = Features</dt><dd><p>.newBuilder()
.putFeature(“tweet_ids”, tweetIdsFeature)
.putFeature(“tweet_weights”, tweetWeightsFeature)
.build()</p>
</dd>
</dl>
<p>Example.newBuilder().setFeatures(features).build()</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>def getModelInput(query: ConsumerBasedWalsSimilarityEngine.Query): PredictRequest = {</dt><dd><p>val tfExample = getFeaturesForRecommendations(query)</p>
<dl>
<dt>val inferenceRequest = PredictRequest</dt><dd><p>.newBuilder()
.setModelSpec(</p>
<blockquote>
<div><dl class="simple">
<dt>Model.ModelSpec</dt><dd><p>.newBuilder()
.setName(query.modelName)
.setSignatureName(query.modelSignatureName))</p>
</dd>
</dl>
</div></blockquote>
<dl>
<dt>.putInputs(</dt><dd><p>query.modelInputName,
TensorProto</p>
<blockquote>
<div><p>.newBuilder()
.setDtype(DataType.DT_STRING)
.setTensorShape(TensorShapeProto</p>
<blockquote>
<div><p>.newBuilder()
.addDim(TensorShapeProto.Dim.newBuilder().setSize(1)))</p>
</div></blockquote>
<p>.addStringVal(tfExample.toByteString)
.build()</p>
</div></blockquote>
</dd>
</dl>
<p>).build()</p>
</dd>
</dl>
<p>inferenceRequest</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>def getModelOutput(query: Query, response: PredictResponse): Seq[TweetWithScore] = {</dt><dd><p>val outputName = query.modelOutputName
if (response.containsOutputs(outputName)) {</p>
<blockquote>
<div><dl class="simple">
<dt>val tweetList = response.getOutputsMap</dt><dd><p>.get(outputName)
.getInt64ValList.asScala</p>
</dd>
<dt>tweetList.zip(tweetList.size to 1 by -1).map { (tweetWithScore) =&gt;</dt><dd><p>TweetWithScore(tweetWithScore._1, tweetWithScore._2.toLong)</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<dl class="simple">
<dt>} else {</dt><dd><p>Seq.empty</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>object ConsumerBasedWalsSimilarityEngine {</dt><dd><dl class="simple">
<dt>case class Query(</dt><dd><p>sourceIds: Seq[SourceInfo],
modelName: String,
modelInputName: String,
modelOutputName: String,
modelSignatureName: String,
wilyNsName: String,</p>
</dd>
</dl>
<p>)</p>
<dl>
<dt>def fromParams(</dt><dd><p>sourceIds: Seq[SourceInfo],
params: configapi.Params,</p>
</dd>
<dt>): EngineQuery[Query] = {</dt><dd><dl>
<dt>EngineQuery(</dt><dd><dl class="simple">
<dt>Query(</dt><dd><p>sourceIds,
params(ConsumerBasedWalsParams.ModelNameParam),
params(ConsumerBasedWalsParams.ModelInputNameParam),
params(ConsumerBasedWalsParams.ModelOutputNameParam),
params(ConsumerBasedWalsParams.ModelSignatureNameParam),
params(ConsumerBasedWalsParams.WilyNsNameParam),</p>
</dd>
</dl>
<p>),
params</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>def toSimilarityEngineInfo(</dt><dd><p>score: Double</p>
</dd>
<dt>): SimilarityEngineInfo = {</dt><dd><dl class="simple">
<dt>SimilarityEngineInfo(</dt><dd><p>similarityEngineType = SimilarityEngineType.ConsumerBasedWalsANN,
modelId = None,
score = Some(score))</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../../../../index.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../../../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../../../../_sources/cr-mixer/server/src/main/scala/com/twitter/cr_mixer/similarity_engine/ConsumerBasedWalsSimilarityEngine.scala.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>