<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../../" id="documentation_options" src="../../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>package com.twitter.simclusters_v2.scalding.common</p>
<p>import com.fasterxml.jackson.core.JsonGenerator
import com.fasterxml.jackson.databind.ObjectMapper
import com.fasterxml.jackson.databind.ObjectWriter
import com.fasterxml.jackson.module.scala.DefaultScalaModule
import com.fasterxml.jackson.module.scala.ScalaObjectMapper
import com.twitter.algebird.Aggregator
import com.twitter.algebird.Moments
import com.twitter.algebird.MultiAggregator
import com.twitter.algebird.SetSizeAggregator
import com.twitter.algebird.SketchMap
import com.twitter.algebird.SketchMapParams
import com.twitter.algebird.mutable.PriorityQueueMonoid
import com.twitter.bijection.Injection
import com.twitter.hashing.KeyHasher
import com.twitter.scalding.Execution
import com.twitter.scalding.Stat
import com.twitter.scalding.TypedPipe
import com.twitter.scalding.UniqueID
import java.io.File
import java.io.PrintWriter
import scala.sys.process._</p>
<dl>
<dt>object Util {</dt><dd><p>private val formatter = java.text.NumberFormat.getNumberInstance</p>
<dl class="simple">
<dt>private val jsonMapper = {</dt><dd><p>val mapper = new ObjectMapper() with ScalaObjectMapper
mapper.registerModule(DefaultScalaModule)
mapper.configure(JsonGenerator.Feature.WRITE_NUMBERS_AS_STRINGS, true)
mapper</p>
</dd>
</dl>
<p>}</p>
<p>val prettyJsonMapper: ObjectWriter = jsonMapper.writerWithDefaultPrettyPrinter()</p>
<dl>
<dt>def getCustomCounters[T](exec: Execution[T]): Execution[Map[String, Long]] = {</dt><dd><dl>
<dt>exec.getCounters.map {</dt><dd><dl>
<dt>case (_, counters) =&gt;</dt><dd><dl class="simple">
<dt>counters.toMap.collect {</dt><dd><dl class="simple">
<dt>case (key, value) if key.group == “Scalding Custom” =&gt;</dt><dd><p>key.counter -&gt; value</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>def getCustomCountersString[T](exec: Execution[T]): Execution[String] = {</dt><dd><dl>
<dt>getCustomCounters(exec).map { map =&gt;</dt><dd><dl class="simple">
<dt>val customCounterStrings = map.toList.map {</dt><dd><dl class="simple">
<dt>case (key, value) =&gt;</dt><dd><p>s”$key:${formatter.format(value)}”</p>
</dd>
</dl>
</dd>
</dl>
<p>}
if (customCounterStrings.nonEmpty) {</p>
<blockquote>
<div><p>“Printing all custom counters:n” + customCounterStrings.mkString(”n”)</p>
</div></blockquote>
<dl class="simple">
<dt>} else {</dt><dd><p>“No custom counters to print”</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<p>// Note ideally this should not allow T that is itself Execution[U] i.e. don’t accept
// nested executions
def printCounters[T](exec: Execution[T]): Execution[Unit] = {</p>
<blockquote>
<div><p>getCustomCountersString(exec).map { s =&gt; println(s) }</p>
</div></blockquote>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Print some basic stats of a numeric column.</p></li>
</ul>
<p><a href="#id1"><span class="problematic" id="id2">*</span></a>/</p>
</dd>
<dt>def printSummaryOfNumericColumn[V](</dt><dd><p>input: TypedPipe[V],
columnName: Option[String] = None</p>
</dd>
<dt>)(</dt><dd><p>implicit num: Numeric[V]</p>
</dd>
<dt>): Execution[String] = {</dt><dd><p>lazy val randomSampler = Aggregator.reservoirSample[V](100)</p>
<p>lazy val percentiles = QTreeMultiAggregator(Seq(0.05, 0.25, 0.50, 0.75, 0.95))</p>
<p>lazy val moments = Moments.numericAggregator</p>
<dl>
<dt>val multiAggregator = MultiAggregator(</dt><dd><p>Aggregator.size,
percentiles,
Aggregator.max,
Aggregator.min,
Aggregator.numericSum,
moments,
randomSampler</p>
</dd>
<dt>).andThenPresent {</dt><dd><dl>
<dt>case (<a href="#id5"><span class="problematic" id="id6">size_</span></a>, <a href="#id7"><span class="problematic" id="id8">percentiles_</span></a>, <a href="#id9"><span class="problematic" id="id10">max_</span></a>, <a href="#id11"><span class="problematic" id="id12">min_</span></a>, <a href="#id13"><span class="problematic" id="id14">sum_</span></a>, <a href="#id15"><span class="problematic" id="id16">moments_</span></a>, <a href="#id17"><span class="problematic" id="id18">samples_</span></a>) =&gt;</dt><dd><dl class="simple">
<dt><a href="#id19"><span class="problematic" id="id20">percentiles_</span></a>.mapValues(_.toString) ++ Map(</dt><dd><p>“size” -&gt; <a href="#id21"><span class="problematic" id="id22">size_</span></a>.toString,
“max” -&gt; <a href="#id23"><span class="problematic" id="id24">max_</span></a>.toString,
“min” -&gt; <a href="#id25"><span class="problematic" id="id26">min_</span></a>.toString,
“sum” -&gt; <a href="#id27"><span class="problematic" id="id28">sum_</span></a>.toString,
“avg” -&gt; <a href="#id29"><span class="problematic" id="id30">moments_</span></a>.mean.toString,
“stddev” -&gt; <a href="#id31"><span class="problematic" id="id32">moments_</span></a>.stddev.toString,
“skewness” -&gt; <a href="#id33"><span class="problematic" id="id34">moments_</span></a>.skewness.toString,
“samples” -&gt; <a href="#id35"><span class="problematic" id="id36">samples_</span></a>.mkString(“,”)</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<dl>
<dt>input</dt><dd><p>.aggregate(multiAggregator)
.toIterableExecution
.map { m =&gt;</p>
<blockquote>
<div><dl class="simple">
<dt>val summary =</dt><dd><p>s”Column Name: $columnNamenSummary:n${Util.prettyJsonMapper.writeValueAsString(m)}”</p>
</dd>
</dl>
<p>println(summary)
summary</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Output some basic stats of a categorical column.</p></li>
<li></li>
<li><p>Note that HeavyHitters only work when the distribution is skewed.</p></li>
</ul>
<p><a href="#id3"><span class="problematic" id="id4">*</span></a>/</p>
</dd>
<dt>def printSummaryOfCategoricalColumn[V](</dt><dd><p>input: TypedPipe[V],
columnName: Option[String] = None</p>
</dd>
<dt>)(</dt><dd><p>implicit injection: Injection[V, Array[Byte]]</p>
</dd>
</dl>
<p>): Execution[String] = {</p>
<blockquote>
<div><p>lazy val randomSampler = Aggregator.reservoirSample[V](100)</p>
<p>lazy val uniqueCounter = new SetSizeAggregator[V](hllBits = 13, maxSetSize = 1000)(injection)</p>
<dl>
<dt>lazy val sketchMapParams =</dt><dd><p>SketchMapParams[V](seed = 1618, eps = 0.001, delta = 0.05, heavyHittersCount = 20)(injection)</p>
</dd>
<dt>lazy val heavyHitter =</dt><dd><p>SketchMap.aggregator[V, Long](sketchMapParams).composePrepare[V](v =&gt; v -&gt; 1L)</p>
</dd>
<dt>val multiAggregator = MultiAggregator(</dt><dd><p>Aggregator.size,
uniqueCounter,
heavyHitter,
randomSampler</p>
</dd>
<dt>).andThenPresent {</dt><dd><dl>
<dt>case (<a href="#id37"><span class="problematic" id="id38">size_</span></a>, <a href="#id39"><span class="problematic" id="id40">uniqueSize_</span></a>, <a href="#id41"><span class="problematic" id="id42">heavyHitter_</span></a>, <a href="#id43"><span class="problematic" id="id44">sampler_</span></a>) =&gt;</dt><dd><dl>
<dt>Map(</dt><dd><p>“size” -&gt; <a href="#id45"><span class="problematic" id="id46">size_</span></a>.toString,
“unique” -&gt; <a href="#id47"><span class="problematic" id="id48">uniqueSize_</span></a>.toString,
“samples” -&gt; <a href="#id49"><span class="problematic" id="id50">sampler_</span></a>.mkString(“,”),
“heavyHitter” -&gt; <a href="#id51"><span class="problematic" id="id52">heavyHitter_</span></a>.heavyHitterKeys</p>
<blockquote>
<div><dl class="simple">
<dt>.map { key =&gt;</dt><dd><p>val freq = sketchMapParams.frequency(key, <a href="#id53"><span class="problematic" id="id54">heavyHitter_</span></a>.valuesTable)
key -&gt; freq</p>
</dd>
</dl>
<p>}
.sortBy(-_._2).mkString(“,”)</p>
</div></blockquote>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<dl>
<dt>input</dt><dd><p>.aggregate(multiAggregator)
.toIterableExecution
.map { m =&gt;</p>
<blockquote>
<div><dl class="simple">
<dt>val summary =</dt><dd><p>s”Column Name: $columnNamenSummary:n${Util.prettyJsonMapper.writeValueAsString(m)}”</p>
</dd>
</dl>
<p>println(summary)
summary</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
<dl class="simple">
<dt>val edgeOrdering: Ordering[(Long, Long)] = Ordering.by {</dt><dd><p>case (fromNodeId, toNodeId) =&gt; hashToLong(fromNodeId, toNodeId)</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>def reservoirSamplerMonoidForPairs[K, V](</dt><dd><p>sampleSize: Int</p>
</dd>
<dt>)(</dt><dd><p>implicit ord: Ordering[K]</p>
</dd>
<dt>): PriorityQueueMonoid[(K, V)] = {</dt><dd><p>implicit val fullOrdering: Ordering[(K, V)] = Ordering.by(_._1)
new PriorityQueueMonoid[(K, V)](sampleSize)</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>def reservoirSamplerMonoid[T, U](</dt><dd><p>sampleSize: Int,
convert: T =&gt; U</p>
</dd>
<dt>)(</dt><dd><p>implicit ord: Ordering[U]</p>
</dd>
<dt>): PriorityQueueMonoid[T] = {</dt><dd><p>new PriorityQueueMonoid[T](sampleSize)(Ordering.by(convert))</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>def hashToLong(a: Long, b: Long): Long = {</dt><dd><p>val bb = java.nio.ByteBuffer.allocate(16)
bb.putLong(a)
bb.putLong(b)
KeyHasher.KETAMA.hashKey(bb.array())</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>def hashToLong(a: Long): Long = {</dt><dd><p>val bb = java.nio.ByteBuffer.allocate(8)
bb.putLong(a)
KeyHasher.KETAMA.hashKey(bb.array())</p>
</dd>
</dl>
<p>}</p>
<p>// <a class="reference external" href="https://en.wikipedia.org/wiki/Pearson_correlation_coefficient">https://en.wikipedia.org/wiki/Pearson_correlation_coefficient</a>
def computeCorrelation(pairedIter: Iterator[(Double, Double)]): Double = {</p>
<blockquote>
<div><dl>
<dt>val (len, xSum, ySum, x2Sum, y2Sum, xySum) =</dt><dd><dl class="simple">
<dt>pairedIter.foldLeft((0.0, 0.0, 0.0, 0.0, 0.0, 0.0)) {</dt><dd><dl class="simple">
<dt>case ((l, xs, ys, x2s, y2s, xys), (x, y)) =&gt;</dt><dd><p>(l + 1, xs + x, ys + y, x2s + x * x, y2s + y * y, xys + x * y)</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>val den = math.sqrt(len * x2Sum - xSum * xSum) * math.sqrt(len * y2Sum - ySum * ySum)
if (den &gt; 0) {</p>
<blockquote>
<div><p>(len * xySum - xSum * ySum) / den</p>
</div></blockquote>
<p>} else 0.0</p>
</div></blockquote>
<p>}</p>
<p>// <a class="reference external" href="https://en.wikipedia.org/wiki/Cosine_similarity">https://en.wikipedia.org/wiki/Cosine_similarity</a>
def cosineSimilarity(pairedIter: Iterator[(Double, Double)]): Double = {</p>
<blockquote>
<div><dl class="simple">
<dt>val (xySum, x2Sum, y2Sum) = pairedIter.foldLeft(0.0, 0.0, 0.0) {</dt><dd><dl class="simple">
<dt>case ((xy, x2, y2), (x, y)) =&gt;</dt><dd><p>(xy + x * y, x2 + x * x, y2 + y * y)</p>
</dd>
</dl>
</dd>
</dl>
<p>}
val den = math.sqrt(x2Sum) * math.sqrt(y2Sum)
if (den &gt; 0) {</p>
<blockquote>
<div><p>xySum / den</p>
</div></blockquote>
<p>} else 0.0</p>
</div></blockquote>
<p>}</p>
<dl class="simple">
<dt>case class Distribution(</dt><dd><p>avg: Double,
stdDev: Double,
p1: Double,
p10: Double,
p50: Double,
p90: Double,
p99: Double)</p>
</dd>
</dl>
<p>val emptyDist: Distribution = Distribution(0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0)</p>
<dl>
<dt>def distributionFromArray(l: Array[Double]): Distribution = {</dt><dd><p>val s = l.sorted
val len = l.length</p>
<dl>
<dt>if (len &lt; 1) {</dt><dd><p>emptyDist</p>
</dd>
<dt>} else {</dt><dd><dl>
<dt>def pctToIndex(p: Double): Int = {</dt><dd><p>val idx = math.round(l.length * p).toInt
if (idx &lt; 0) {</p>
<blockquote>
<div><p>0</p>
</div></blockquote>
<dl class="simple">
<dt>} else if (idx &gt;= len) {</dt><dd><p>len - 1</p>
</dd>
<dt>} else {</dt><dd><p>idx</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>val (sum, sumSquared) = l.foldLeft((0.0, 0.0)) {</dt><dd><dl class="simple">
<dt>case ((curSum, curSumSquared), x) =&gt;</dt><dd><p>(curSum + x, curSumSquared + x * x)</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<p>val avg = sum / len
val stdDev = math.sqrt(sumSquared / len - avg * avg)
Distribution(</p>
<blockquote>
<div><p>avg,
stdDev,
p1 = s(pctToIndex(0.01)),
p10 = s(pctToIndex(0.1)),
p50 = s(pctToIndex(0.5)),
p90 = s(pctToIndex(0.9)),
p99 = s(pctToIndex(0.99)))</p>
</div></blockquote>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<p>// Calculate cumulative frequency using Scalding Custom Counters.
// Increment all buckets by 1 where value &lt;= bucket_threshold.
case class CumulativeStat(</p>
<blockquote>
<div><p>key: String,
buckets: Seq[Double]</p>
</div></blockquote>
<dl>
<dt>)(</dt><dd><p>implicit uniqueID: UniqueID) {</p>
<dl class="simple">
<dt>val counters = buckets.map { bucket =&gt;</dt><dd><p>bucket -&gt; Stat(key + “_&lt;=” + bucket.toString)</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>def incForValue(value: Double): Unit = {</dt><dd><dl class="simple">
<dt>counters.foreach {</dt><dd><dl class="simple">
<dt>case (bucket, stat) =&gt;</dt><dd><p>if (value &lt;= bucket) stat.inc()</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>def sendEmail(text: String, subject: String, toAddress: String): String = {</dt><dd><p>val file = File.createTempFile(”<a href="#id55"><span class="problematic" id="id56">somePrefix_</span></a>”, “_someSuffix”)
println(s”Email body is at ${file.getPath}”)
val writer = new PrintWriter(file)
writer.write(text)
writer.close()</p>
<p>val mailCmd = s”cat ${file.getPath}” #| Seq(“mail”, “-s”, subject, toAddress)
mailCmd.!!</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../../index.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../../_sources/src/scala/com/twitter/simclusters_v2/scalding/common/Util.scala.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>