<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../../../" id="documentation_options" src="../../../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>package com.twitter.simclusters_v2.scalding
package multi_type_graph.assemble_multi_type_graph</p>
<p>import com.twitter.dal.client.dataset.{KeyValDALDataset, SnapshotDALDataset}
import com.twitter.scalding.{Execution, _}
import com.twitter.scalding_internal.dalv2.DALWrite.{D, _}
import com.twitter.scalding_internal.multiformat.format.keyval.KeyVal
import com.twitter.simclusters_v2.scalding.common.TypedRichPipe.typedPipeToRichPipe
import com.twitter.simclusters_v2.scalding.common.Util
import com.twitter.simclusters_v2.thriftscala.{</p>
<blockquote>
<div><p>LeftNode,
Noun,
NounWithFrequency,
NounWithFrequencyList,
RightNodeType,
RightNodeTypeStruct,
RightNodeWithEdgeWeight,
RightNodeWithEdgeWeightList,
MultiTypeGraphEdge</p>
</div></blockquote>
<p>}
import com.twitter.wtf.scalding.jobs.common.DateRangeExecutionApp
import java.util.TimeZone</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>In this file, we assemble the multi_type_graph user-entity engagement signals</p></li>
<li></li>
<li><p>It works as follows and the following datasets are produced as a result:</p></li>
<li></li>
<li><ol class="arabic simple">
<li><p>FullGraph (fullMultiTypeGraphSnapshotDataset) : reads datasets from multiple sources and generates</p></li>
</ol>
</li>
<li><p>a bipartite graph with LeftNode -&gt; RightNode edges, capturing a user’s engagement with varied entity types</p></li>
<li></li>
<li><ol class="arabic simple" start="2">
<li><p>TruncatedGraph (truncatedMultiTypeGraphKeyValDataset): a truncated version of the FullGraph</p></li>
</ol>
</li>
<li><p>where we only store the topK most frequently occurring RightNodes in the bipartite graph LeftNode -&gt; RightNode</p></li>
<li></li>
<li><ol class="arabic simple" start="3">
<li><p>TopKNouns (topKRightNounsKeyValDataset): this stores the topK most frequent Nouns for each engagement type</p></li>
</ol>
</li>
<li><p>Please note that this dataset is currently only being used for the debugger to find which nodes we consider as the</p></li>
<li><p>most frequently occurring, in FullGraph</p></li>
</ul>
<p><a href="#id1"><span class="problematic" id="id2">*</span></a>/</p>
</dd>
<dt>trait AssembleMultiTypeGraphBaseApp extends DateRangeExecutionApp {</dt><dd><dl class="simple">
<dt>val truncatedMultiTypeGraphKeyValDataset: KeyValDALDataset[</dt><dd><p>KeyVal[LeftNode, RightNodeWithEdgeWeightList]</p>
</dd>
</dl>
<p>]
val topKRightNounsKeyValDataset: KeyValDALDataset[</p>
<blockquote>
<div><p>KeyVal[RightNodeTypeStruct, NounWithFrequencyList]</p>
</div></blockquote>
<p>]
val fullMultiTypeGraphSnapshotDataset: SnapshotDALDataset[MultiTypeGraphEdge]
val isAdhoc: Boolean
val truncatedMultiTypeGraphMHOutputPath: String
val topKRightNounsMHOutputPath: String
val fullMultiTypeGraphThriftOutputPath: String</p>
<dl>
<dt>override def runOnDateRange(</dt><dd><p>args: Args</p>
</dd>
<dt>)(</dt><dd><p>implicit dateRange: DateRange,
timeZone: TimeZone,
uniqueID: UniqueID</p>
</dd>
<dt>): Execution[Unit] = {</dt><dd><p>import Config._
import AssembleMultiTypeGraph._</p>
<p>val numKeysInTruncatedGraph = Stat(“num_keys_truncated_mts”)
val numKeysInTopKNounsGraph = Stat(“num_keys_topk_nouns_mts”)</p>
<dl class="simple">
<dt>val fullGraph: TypedPipe[(LeftNode, RightNodeWithEdgeWeight)] =</dt><dd><p>getFullGraph().count(“num_entries_full_graph”)</p>
</dd>
<dt>val topKRightNodes: TypedPipe[(RightNodeType, Seq[(Noun, Double)])] =</dt><dd><dl class="simple">
<dt>getTopKRightNounsWithFrequencies(</dt><dd><p>fullGraph,
TopKConfig,
GlobalDefaultMinFrequencyOfRightNodeType)</p>
</dd>
</dl>
</dd>
<dt>val truncatedGraph: TypedPipe[(LeftNode, RightNodeWithEdgeWeight)] =</dt><dd><p>getTruncatedGraph(fullGraph, topKRightNodes).count(“num_entries_truncated_graph”)</p>
</dd>
</dl>
<p>// key transformations - truncated graph, keyed by LeftNode
val truncatedGraphKeyedBySrc: TypedPipe[(LeftNode, RightNodeWithEdgeWeightList)] =</p>
<blockquote>
<div><dl>
<dt>truncatedGraph</dt><dd><dl class="simple">
<dt>.map {</dt><dd><dl class="simple">
<dt>case (LeftNode.UserId(userId), rightNodeWithWeight) =&gt;</dt><dd><p>userId -&gt; List(rightNodeWithWeight)</p>
</dd>
</dl>
</dd>
</dl>
<p>}
.sumByKey
.map {</p>
<blockquote>
<div><dl class="simple">
<dt>case (userId, rightNodeWithWeightList) =&gt;</dt><dd><p>(LeftNode.UserId(userId), RightNodeWithEdgeWeightList(rightNodeWithWeightList))</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
</dd>
</dl>
</div></blockquote>
<p>// key transformation - topK nouns, keyed by the RightNodeNounType
val topKNounsKeyedByType: TypedPipe[(RightNodeTypeStruct, NounWithFrequencyList)] =</p>
<blockquote>
<div><dl>
<dt>topKRightNodes</dt><dd><dl>
<dt>.map {</dt><dd><dl>
<dt>case (rightNodeType, rightNounsWithScoresList) =&gt;</dt><dd><dl>
<dt>val nounsListWithFrequency: Seq[NounWithFrequency] = rightNounsWithScoresList</dt><dd><dl class="simple">
<dt>.map {</dt><dd><dl class="simple">
<dt>case (noun, aggregatedFrequency) =&gt;</dt><dd><p>NounWithFrequency(noun, aggregatedFrequency)</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>(RightNodeTypeStruct(rightNodeType), NounWithFrequencyList(nounsListWithFrequency))</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
</div></blockquote>
<p>//WriteExecs - truncated graph
val truncatedGraphTsvExec: Execution[Unit] =</p>
<blockquote>
<div><dl class="simple">
<dt>truncatedGraphKeyedBySrc.writeExecution(</dt><dd><p>TypedTsv[(LeftNode, RightNodeWithEdgeWeightList)](AdhocRootPrefix + “truncated_graph_tsv”))</p>
</dd>
</dl>
</div></blockquote>
<dl>
<dt>val truncatedGraphDALExec: Execution[Unit] = truncatedGraphKeyedBySrc</dt><dd><dl class="simple">
<dt>.map {</dt><dd><dl class="simple">
<dt>case (leftNode, rightNodeWithWeightList) =&gt;</dt><dd><p>numKeysInTruncatedGraph.inc()
KeyVal(leftNode, rightNodeWithWeightList)</p>
</dd>
</dl>
</dd>
</dl>
<p>}
.writeDALVersionedKeyValExecution(</p>
<blockquote>
<div><p>truncatedMultiTypeGraphKeyValDataset,
D.Suffix(</p>
<blockquote>
<div><dl>
<dt>(if (!isAdhoc)</dt><dd><blockquote>
<div><p>RootPath</p>
</div></blockquote>
<dl>
<dt>else</dt><dd><blockquote>
<div><p>AdhocRootPrefix)</p>
</div></blockquote>
<ul class="simple">
<li><p>truncatedMultiTypeGraphMHOutputPath),</p></li>
</ul>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>ExplicitEndTime(dateRange.`end`)</p>
</div></blockquote>
<p>)</p>
</dd>
</dl>
<p>//WriteExec - topK rightnouns
val topKNounsTsvExec: Execution[Unit] =</p>
<blockquote>
<div><dl class="simple">
<dt>topKNounsKeyedByType.writeExecution(</dt><dd><dl class="simple">
<dt>TypedTsv[(RightNodeTypeStruct, NounWithFrequencyList)](</dt><dd><p>AdhocRootPrefix + “top_k_right_nouns_tsv”))</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>// writing topKNouns MH dataset for debugger
val topKNounsDALExec: Execution[Unit] = topKNounsKeyedByType</p>
<blockquote>
<div><dl>
<dt>.map {</dt><dd><dl>
<dt>case (engagementType, rightList) =&gt;</dt><dd><dl class="simple">
<dt>val rightListMH =</dt><dd><p>NounWithFrequencyList(rightList.nounWithFrequencyList.take(TopKRightNounsForMHDump))</p>
</dd>
</dl>
<p>numKeysInTopKNounsGraph.inc()
KeyVal(engagementType, rightListMH)</p>
</dd>
</dl>
</dd>
</dl>
<p>}
.writeDALVersionedKeyValExecution(</p>
<blockquote>
<div><p>topKRightNounsKeyValDataset,
D.Suffix(</p>
<blockquote>
<div><dl>
<dt>(if (!isAdhoc)</dt><dd><blockquote>
<div><p>RootPath</p>
</div></blockquote>
<dl>
<dt>else</dt><dd><blockquote>
<div><p>AdhocRootPrefix)</p>
</div></blockquote>
<ul class="simple">
<li><p>topKRightNounsMHOutputPath),</p></li>
</ul>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>ExplicitEndTime(dateRange.`end`)</p>
</div></blockquote>
<p>)</p>
</div></blockquote>
<p>//WriteExec - fullGraph
val fullGraphDALExec: Execution[Unit] = fullGraph</p>
<blockquote>
<div><dl>
<dt>.map {</dt><dd><dl class="simple">
<dt>case (leftNode, rightNodeWithWeight) =&gt;</dt><dd><p>MultiTypeGraphEdge(leftNode, rightNodeWithWeight)</p>
</dd>
</dl>
</dd>
<dt>}.writeDALSnapshotExecution(</dt><dd><p>fullMultiTypeGraphSnapshotDataset,
D.Daily,
D.Suffix(</p>
<blockquote>
<div><dl>
<dt>(if (!isAdhoc)</dt><dd><blockquote>
<div><p>RootThriftPath</p>
</div></blockquote>
<dl>
<dt>else</dt><dd><blockquote>
<div><p>AdhocRootPrefix)</p>
</div></blockquote>
<ul class="simple">
<li><p>fullMultiTypeGraphThriftOutputPath),</p></li>
</ul>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>D.Parquet,
dateRange.`end`</p>
</dd>
</dl>
<p>)</p>
</div></blockquote>
<dl class="simple">
<dt>if (isAdhoc) {</dt><dd><dl class="simple">
<dt>Util.printCounters(</dt><dd><dl class="simple">
<dt>Execution</dt><dd><dl class="simple">
<dt>.zip(</dt><dd><p>truncatedGraphTsvExec,
topKNounsTsvExec,
truncatedGraphDALExec,
topKNounsDALExec,
fullGraphDALExec).unit)</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
</dd>
<dt>} else {</dt><dd><dl class="simple">
<dt>Util.printCounters(</dt><dd><p>Execution.zip(truncatedGraphDALExec, topKNounsDALExec, fullGraphDALExec).unit)</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../../../index.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../../../_sources/src/scala/com/twitter/simclusters_v2/scalding/multi_type_graph/assemble_multi_type_graph/AssembleMultiTypeGraphBaseApp.scala.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>