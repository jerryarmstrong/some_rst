<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../" id="documentation_options" src="../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>package com.twitter.search.earlybird_root;</p>
<p>import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.SortedSet;
import java.util.TreeSet;</p>
<p>import javax.inject.Inject;
import javax.inject.Named;
import javax.inject.Singleton;</p>
<p>import com.google.common.base.Preconditions;
import com.google.common.collect.Lists;
import com.google.common.collect.Maps;</p>
<p>import org.slf4j.Logger;
import org.slf4j.LoggerFactory;</p>
<p>import com.twitter.finagle.Service;
import com.twitter.finagle.SimpleFilter;
import com.twitter.finagle.stats.StatsReceiver;
import com.twitter.search.common.decider.SearchDecider;
import com.twitter.search.common.metrics.SearchCounter;
import com.twitter.search.common.root.PartitionConfig;
import com.twitter.search.common.root.PartitionLoggingSupport;
import com.twitter.search.common.root.RequestSuccessStats;
import com.twitter.search.common.root.RootClientServiceBuilder;
import com.twitter.search.common.root.ScatterGatherService;
import com.twitter.search.common.root.ScatterGatherSupport;
import com.twitter.search.common.root.SearchRootModule;
import com.twitter.search.common.schema.earlybird.EarlybirdCluster;
import com.twitter.search.earlybird.config.TierConfig;
import com.twitter.search.earlybird.config.TierInfo;
import com.twitter.search.earlybird.config.TierInfoSource;
import com.twitter.search.earlybird.config.TierInfoUtil;
import com.twitter.search.earlybird.config.TierInfoWrapper;
import com.twitter.search.earlybird.thrift.EarlybirdRequest;
import com.twitter.search.earlybird.thrift.EarlybirdResponse;
import com.twitter.search.earlybird.thrift.EarlybirdResponseCode;
import com.twitter.search.earlybird.thrift.EarlybirdService.ServiceIface;
import com.twitter.search.earlybird.thrift.ThriftSearchResults;
import com.twitter.search.earlybird_root.common.EarlybirdRequestContext;
import com.twitter.search.earlybird_root.filters.EarlybirdTimeRangeFilter;
import com.twitter.search.earlybird_root.filters.RequestContextToEarlybirdRequestFilter;
import com.twitter.util.Function;
import com.twitter.util.Future;</p>
<p>&#64;Singleton
public class EarlybirdServiceChainBuilder {</p>
<blockquote>
<div><p>private static final Logger LOG = LoggerFactory.getLogger(EarlybirdServiceChainBuilder.class);</p>
<p>private static final String SEARCH_METHOD_NAME = “search”;</p>
<dl class="simple">
<dt>private static final EarlybirdResponse TIER_SKIPPED_RESPONSE =</dt><dd><dl class="simple">
<dt>new EarlybirdResponse(EarlybirdResponseCode.TIER_SKIPPED, 0)</dt><dd><p>.setSearchResults(new ThriftSearchResults())
.setDebugString(“Request to cluster dropped by decider, or sent as dark read.”);</p>
</dd>
</dl>
</dd>
</dl>
<p>private final EarlybirdTierThrottleDeciders tierThrottleDeciders;</p>
<p>private final RequestContextToEarlybirdRequestFilter requestContextToEarlybirdRequestFilter;</p>
<p>private final SearchDecider decider;
private final String normalizedSearchRootName;
private final RootClientServiceBuilder&lt;ServiceIface&gt; clientServiceBuilder;
private final String partitionPath;
private final int numPartitions;
private final SortedSet&lt;TierInfo&gt; tierInfos;
private final PartitionAccessController partitionAccessController;
private final StatsReceiver statsReceiver;</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Construct a ScatterGatherServiceChain, by loading configurations from earlybird-tiers.yml.</p></li>
</ul>
<p><a href="#id1"><span class="problematic" id="id2">*</span></a>/</p>
</dd>
</dl>
<p>&#64;Inject
public EarlybirdServiceChainBuilder(</p>
<blockquote>
<div><blockquote>
<div><p>PartitionConfig partitionConfig,
RequestContextToEarlybirdRequestFilter requestContextToEarlybirdRequestFilter,
EarlybirdTierThrottleDeciders tierThrottleDeciders,
&#64;Named(SearchRootModule.NAMED_NORMALIZED_SEARCH_ROOT_NAME) String normalizedSearchRootName,
SearchDecider decider,
TierInfoSource tierConfig,
RootClientServiceBuilder&lt;ServiceIface&gt; clientServiceBuilder,
PartitionAccessController partitionAccessController,
StatsReceiver statsReceiver) {</p>
</div></blockquote>
<p>this.partitionAccessController = partitionAccessController;
this.tierThrottleDeciders = Preconditions.checkNotNull(tierThrottleDeciders);
this.requestContextToEarlybirdRequestFilter = requestContextToEarlybirdRequestFilter;
this.normalizedSearchRootName = normalizedSearchRootName;
this.decider = decider;
this.statsReceiver = statsReceiver;</p>
<p>List&lt;TierInfo&gt; tierInformation = tierConfig.getTierInformation();
if (tierInformation == null || tierInformation.isEmpty()) {</p>
<blockquote>
<div><dl class="simple">
<dt>LOG.error(</dt><dd><p>“No tier found in config file {} Did you set SEARCH_ENV correctly?”,
tierConfig.getConfigFileType());</p>
</dd>
</dl>
<p>throw new RuntimeException(“No tier found in tier config file.”);</p>
</div></blockquote>
<p>}</p>
<p>// Get the tier info from the tier config yml file
TreeSet&lt;TierInfo&gt; infos = new TreeSet&lt;&gt;(TierInfoUtil.TIER_COMPARATOR);
infos.addAll(tierInformation);
this.tierInfos = Collections.unmodifiableSortedSet(infos);
this.clientServiceBuilder = clientServiceBuilder;
this.partitionPath = partitionConfig.getPartitionPath();
this.numPartitions = partitionConfig.getNumPartitions();</p>
<p>LOG.info(“Found the following tiers from config: {}”, tierInfos);</p>
</div></blockquote>
<p>}</p>
<p>/** Builds the chain of services that should be queried on each request. <a href="#id3"><span class="problematic" id="id4">*</span></a>/
public List&lt;Service&lt;EarlybirdRequestContext, EarlybirdResponse&gt;&gt; buildServiceChain(</p>
<blockquote>
<div><blockquote>
<div><p>ScatterGatherSupport&lt;EarlybirdRequestContext, EarlybirdResponse&gt; support,
PartitionLoggingSupport&lt;EarlybirdRequestContext&gt; partitionLoggingSupport) {</p>
</div></blockquote>
<p>// Make sure the tier serving ranges do not overlap and do not have gaps.
TierInfoUtil.checkTierServingRanges(tierInfos);</p>
<p>List&lt;Service&lt;EarlybirdRequestContext, EarlybirdResponse&gt;&gt; chain = Lists.newArrayList();</p>
<dl>
<dt>for (TierInfo tierInfo<span class="classifier">tierInfos) {</span></dt><dd><p>String tierName = tierInfo.getTierName();
if (tierInfo.isEnabled()) {</p>
<blockquote>
<div><p>String rewrittenPartitionPath = partitionPath;
// This rewriting rule must match the rewriting rule inside
// EarlybirdServer#joinServerSet().
if (!TierConfig.DEFAULT_TIER_NAME.equals(tierName)) {</p>
<blockquote>
<div><p>rewrittenPartitionPath = partitionPath + “/” + tierName;</p>
</div></blockquote>
<p>}</p>
<dl class="simple">
<dt>clientServiceBuilder.initializeWithPathSuffix(</dt><dd><p>tierInfo.getTierName(),
numPartitions,
rewrittenPartitionPath);</p>
</dd>
<dt>try {</dt><dd><dl class="simple">
<dt>chain.add(createTierService(</dt><dd><p>support, tierInfo, clientServiceBuilder, partitionLoggingSupport));</p>
</dd>
</dl>
</dd>
<dt>} catch (Exception e) {</dt><dd><p>LOG.error(“Failed to build clients for tier: {}”, tierInfo.getTierName());
throw new RuntimeException(e);</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<dl class="simple">
<dt>} else {</dt><dd><p>LOG.info(“Skipped disabled tier: {}”, tierName);</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<p>return chain;</p>
</div></blockquote>
<p>}</p>
<dl>
<dt>private Service&lt;EarlybirdRequestContext, EarlybirdResponse&gt; createTierService(</dt><dd><blockquote>
<div><p>ScatterGatherSupport&lt;EarlybirdRequestContext, EarlybirdResponse&gt; support,
final TierInfo tierInfo,
RootClientServiceBuilder&lt;ServiceIface&gt; builder,
PartitionLoggingSupport&lt;EarlybirdRequestContext&gt; partitionLoggingSupport) {</p>
</div></blockquote>
<p>final String tierName = tierInfo.getTierName();
RequestSuccessStats stats = new RequestSuccessStats(tierName);</p>
<dl class="simple">
<dt>List&lt;Service&lt;EarlybirdRequest, EarlybirdResponse&gt;&gt; services =</dt><dd><p>builder.safeBuildServiceList(SEARCH_METHOD_NAME);</p>
</dd>
</dl>
<p>// Get the client list for this tier, and apply the degradationTrackerFilter to each response.
//
// We currently do this only for the EarlybirdSearchMultiTierAdaptor (the full archive cluster).
// If we want to do this for all clusters (or if we want to apply any other filter to all
// earlybird responses, for other clusters), we should change ScatterGatherService’s constructor
// to take in a filter, and apply it there.
ClientBackupFilter backupFilter = new ClientBackupFilter(</p>
<blockquote>
<div><p>“<a href="#id5"><span class="problematic" id="id6">root_</span></a>” + EarlybirdCluster.FULL_ARCHIVE.getNameForStats(),
tierName,
statsReceiver,
decider);</p>
</div></blockquote>
<p>List&lt;Service&lt;EarlybirdRequestContext, EarlybirdResponse&gt;&gt; clients = Lists.newArrayList();
ClientLatencyFilter latencyFilter = new ClientLatencyFilter(tierName);
for (Service&lt;EarlybirdRequest, EarlybirdResponse&gt; client : services) {</p>
<blockquote>
<div><dl class="simple">
<dt>clients.add(requestContextToEarlybirdRequestFilter</dt><dd><p>.andThen(backupFilter)
.andThen(latencyFilter)
.andThen(client));</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
<p>clients = SkipPartitionFilter.wrapServices(tierName, clients, partitionAccessController);</p>
<p>// Build the scatter gather service for this tier.
// Each tier has their own stats.
ScatterGatherService&lt;EarlybirdRequestContext, EarlybirdResponse&gt; scatterGatherService =</p>
<blockquote>
<div><dl class="simple">
<dt>new ScatterGatherService&lt;&gt;(</dt><dd><p>support, clients, stats, partitionLoggingSupport);</p>
</dd>
</dl>
</div></blockquote>
<dl class="simple">
<dt>SimpleFilter&lt;EarlybirdRequestContext, EarlybirdResponse&gt; tierThrottleFilter =</dt><dd><p>getTierThrottleFilter(tierInfo, tierName);</p>
</dd>
<dt>EarlybirdTimeRangeFilter timeRangeFilter =</dt><dd><dl class="simple">
<dt>EarlybirdTimeRangeFilter.newTimeRangeFilterWithQueryRewriter(</dt><dd><p>(requestContext, userOverride) -&gt; new TierInfoWrapper(tierInfo, userOverride),
decider);</p>
</dd>
</dl>
</dd>
<dt>return tierThrottleFilter</dt><dd><p>.andThen(timeRangeFilter)
.andThen(scatterGatherService);</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private SimpleFilter&lt;EarlybirdRequestContext, EarlybirdResponse&gt; getTierThrottleFilter(</dt><dd><blockquote>
<div><p>final TierInfo tierInfo,
final String tierName) {</p>
</div></blockquote>
<p>// A filter that throttles request rate.
final String tierThrottleDeciderKey = tierThrottleDeciders.getTierThrottleDeciderKey(</p>
<blockquote>
<div><p>normalizedSearchRootName, tierName);</p>
</div></blockquote>
<dl>
<dt>SimpleFilter&lt;EarlybirdRequestContext, EarlybirdResponse&gt; tierThrottleFilter =</dt><dd><dl>
<dt>new SimpleFilter&lt;EarlybirdRequestContext, EarlybirdResponse&gt;() {</dt><dd><dl>
<dt>private final Map&lt;TierInfo.RequestReadType, SearchCounter&gt; readCounts =</dt><dd><p>getReadCountsMap();</p>
</dd>
<dt>private Map&lt;TierInfo.RequestReadType, SearchCounter&gt; getReadCountsMap() {</dt><dd><dl class="simple">
<dt>Map&lt;TierInfo.RequestReadType, SearchCounter&gt; readCountsMap =</dt><dd><p>Maps.newEnumMap(TierInfo.RequestReadType.class);</p>
</dd>
<dt>for (TierInfo.RequestReadType readType<span class="classifier">TierInfo.RequestReadType.values()) {</span></dt><dd><dl class="simple">
<dt>readCountsMap.put(readType,</dt><dd><dl class="simple">
<dt>SearchCounter.export(”<a href="#id7"><span class="problematic" id="id8">earlybird_tier_</span></a>” + tierName + “_”</dt><dd><ul class="simple">
<li><p>readType.name().toLowerCase() + “_read_count”));</p></li>
</ul>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p>}
return Collections.unmodifiableMap(readCountsMap);</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>private final SearchCounter tierRequestDroppedByDeciderCount =</dt><dd><dl class="simple">
<dt>SearchCounter.export(”<a href="#id9"><span class="problematic" id="id10">earlybird_tier_</span></a>” + tierName</dt><dd><ul class="simple">
<li><p>“_request_dropped_by_decider_count”);</p></li>
</ul>
</dd>
</dl>
</dd>
</dl>
<p>&#64;Override
public Future&lt;EarlybirdResponse&gt; apply(</p>
<blockquote>
<div><blockquote>
<div><p>EarlybirdRequestContext requestContext,
Service&lt;EarlybirdRequestContext, EarlybirdResponse&gt; service) {</p>
</div></blockquote>
<p>// a blank response is returned when a request is dropped by decider, or
// a request is sent as a dark read.
final Future&lt;EarlybirdResponse&gt; blankTierResponse = Future.value(TIER_SKIPPED_RESPONSE);
if (tierThrottleDeciders.shouldSendRequestToTier(tierThrottleDeciderKey)) {</p>
<blockquote>
<div><dl class="simple">
<dt>TierInfoWrapper tierInfoWrapper =</dt><dd><p>new TierInfoWrapper(tierInfo, requestContext.useOverrideTierConfig());</p>
</dd>
</dl>
<p>TierInfo.RequestReadType readType = tierInfoWrapper.getReadType();
readCounts.get(readType).increment();
switch (readType) {</p>
<blockquote>
<div><dl>
<dt>case DARK:</dt><dd><p>// dark read: call backend but do not wait for results
service.apply(requestContext);
return blankTierResponse;</p>
</dd>
<dt>case GREY:</dt><dd><p>// grey read: call backend, wait for results, but discard results.
return service.apply(requestContext).flatMap(</p>
<blockquote>
<div><dl>
<dt>new Function&lt;EarlybirdResponse, Future&lt;EarlybirdResponse&gt;&gt;() {</dt><dd><p>&#64;Override
public Future&lt;EarlybirdResponse&gt; apply(EarlybirdResponse v1) {</p>
<blockquote>
<div><p>// No matter what’s returned, always return blankTierResponse.
return blankTierResponse;</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>});</p>
</div></blockquote>
</dd>
<dt>case LIGHT:</dt><dd><p>// light read: return the future from the backend service.
return service.apply(requestContext);</p>
</dd>
<dt>default:</dt><dd><p>throw new RuntimeException(“Unknown read type: “ + readType);</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
</div></blockquote>
<dl class="simple">
<dt>} else {</dt><dd><p>// Request is dropped by throttle decider
tierRequestDroppedByDeciderCount.increment();
return blankTierResponse;</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>};</p>
</dd>
</dl>
<p>return tierThrottleFilter;</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}</p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../index2.rst.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../index2.rst.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../_sources/src/java/com/twitter/search/earlybird_root/EarlybirdServiceChainBuilder.java.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>