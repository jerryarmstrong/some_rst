<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../../" id="documentation_options" src="../../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>package com.twitter.search.earlybird_root.common;</p>
<p>import java.util.ArrayList;
import java.util.List;
import java.util.Set;</p>
<p>import javax.annotation.Nullable;</p>
<p>import scala.Option;</p>
<p>import com.google.common.base.Preconditions;
import com.google.common.collect.ImmutableSet;
import com.google.common.collect.Sets;</p>
<p>import com.twitter.common.util.Clock;
import com.twitter.context.thriftscala.Viewer;
import com.twitter.search.common.decider.SearchDecider;
import com.twitter.search.common.features.thrift.ThriftSearchFeatureSchemaSpecifier;
import com.twitter.search.earlybird.thrift.EarlybirdRequest;
import com.twitter.search.earlybird.thrift.ThriftSearchQuery;
import com.twitter.search.queryparser.query.Query;
import com.twitter.search.queryparser.query.QueryParserException;</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>A class that wraps a request and additional per-request data that should be passed to services.</p></li>
<li></li>
<li><p>This class should be immutable. At the very least, it must be thread-safe. In practice, since</p></li>
<li><p>EarlybirdRequest is a mutable Thrift structure, the users of this class need to make sure that</p></li>
<li><p>once a request is used to create a RequestContext instance, it is not modified.</p></li>
<li></li>
<li><p>If the request needs to be modified, a new RequestContext with the modified EarlybirdRequest</p></li>
<li><p>should be created.</p></li>
</ul>
<p><a href="#id1"><span class="problematic" id="id2">*</span></a>/</p>
</dd>
</dl>
<p>public final class EarlybirdRequestContext {</p>
<blockquote>
<div><p>private static final String OVERRIDE_TIER_CONFIGS_DECIDER_KEY = “use_override_tier_configs”;</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Creates a new context with the provided earlybird request, and using the given decider.</p></li>
</ul>
<p><a href="#id3"><span class="problematic" id="id4">*</span></a>/</p>
</dd>
<dt>public static EarlybirdRequestContext newContext(</dt><dd><blockquote>
<div><p>EarlybirdRequest request,
SearchDecider decider,
Option&lt;Viewer&gt; twitterContextViewer,
Clock clock) throws QueryParserException {</p>
</div></blockquote>
<p>// Try to capture created time as early as possible. For example, we want to account for query
// parsing time.
long createdTimeMillis = clock.nowMillis();</p>
<p>boolean useOverrideTierConfig = decider.isAvailable(OVERRIDE_TIER_CONFIGS_DECIDER_KEY);</p>
<p>Query parsedQuery = QueryParsingUtils.getParsedQuery(request);</p>
<dl class="simple">
<dt>return new EarlybirdRequestContext(</dt><dd><p>request,
parsedQuery,
useOverrideTierConfig,
createdTimeMillis,
twitterContextViewer);</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Intersection of the userID and the flock response, which is set in the followedUserIds field.</p></li>
<li><p>This is used for protected cluster.</p></li>
</ul>
<p><a href="#id5"><span class="problematic" id="id6">*</span></a>/</p>
</dd>
<dt>public static EarlybirdRequestContext newContextWithRestrictFromUserIdFilter64(</dt><dd><blockquote>
<div><p>EarlybirdRequestContext requestContext) {</p>
</div></blockquote>
<p>Preconditions.checkArgument(requestContext.getRequest().isSetFollowedUserIds());</p>
<p>EarlybirdRequest request = requestContext.getRequest().deepCopy();
List&lt;Long&gt; toIntersect = request.getFollowedUserIds();
ThriftSearchQuery searchQuery = request.getSearchQuery();
if (!searchQuery.isSetFromUserIDFilter64()) {</p>
<blockquote>
<div><p>searchQuery.setFromUserIDFilter64(new ArrayList&lt;&gt;(toIntersect));</p>
</div></blockquote>
<dl>
<dt>} else {</dt><dd><dl class="simple">
<dt>Set&lt;Long&gt; intersection = Sets.intersection(</dt><dd><p>Sets.newHashSet(searchQuery.getFromUserIDFilter64()),
Sets.newHashSet(toIntersect));</p>
</dd>
</dl>
<p>searchQuery.setFromUserIDFilter64(new ArrayList&lt;&gt;(intersection));</p>
</dd>
</dl>
<p>}</p>
<p>return new EarlybirdRequestContext(requestContext, request, requestContext.getParsedQuery());</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Makes an exact copy of the provided request context, by cloning the underlying earlybird</p></li>
<li><p>request.</p></li>
</ul>
<p><a href="#id7"><span class="problematic" id="id8">*</span></a>/</p>
</dd>
<dt>public static EarlybirdRequestContext copyRequestContext(</dt><dd><blockquote>
<div><p>EarlybirdRequestContext requestContext,
Query parsedQuery) {</p>
</div></blockquote>
<p>return new EarlybirdRequestContext(requestContext, parsedQuery);</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Creates a new context with the provided request, context and reset both the feature schemas</p></li>
<li><p>cached in client and the feature schemas cached in the local cache.</p></li>
</ul>
<p><a href="#id9"><span class="problematic" id="id10">*</span></a>/</p>
</dd>
<dt>public static EarlybirdRequestContext newContext(</dt><dd><blockquote>
<div><p>EarlybirdRequest oldRequest,
EarlybirdRequestContext oldRequestContext,
List&lt;ThriftSearchFeatureSchemaSpecifier&gt; featureSchemasAvailableInCache,
List&lt;ThriftSearchFeatureSchemaSpecifier&gt; featureSchemasAvailableInClient) {</p>
</div></blockquote>
<p>EarlybirdRequest request = oldRequest.deepCopy();
request.getSearchQuery().getResultMetadataOptions()</p>
<blockquote>
<div><p>.setFeatureSchemasAvailableInClient(featureSchemasAvailableInCache);</p>
</div></blockquote>
<p>ImmutableSet&lt;ThriftSearchFeatureSchemaSpecifier&gt; featureSchemaSetAvailableInClient = null;
if (featureSchemasAvailableInClient != null) {</p>
<blockquote>
<div><p>featureSchemaSetAvailableInClient = ImmutableSet.copyOf(featureSchemasAvailableInClient);</p>
</div></blockquote>
<p>}</p>
<dl class="simple">
<dt>return new EarlybirdRequestContext(</dt><dd><p>request,
EarlybirdRequestType.of(request),
oldRequestContext.getParsedQuery(),
oldRequestContext.useOverrideTierConfig(),
oldRequestContext.getCreatedTimeMillis(),
oldRequestContext.getTwitterContextViewer(),
featureSchemaSetAvailableInClient);</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>public EarlybirdRequestContext deepCopy() {</dt><dd><dl class="simple">
<dt>return new EarlybirdRequestContext(request.deepCopy(), parsedQuery, useOverrideTierConfig,</dt><dd><p>createdTimeMillis, twitterContextViewer);</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<p>private final EarlybirdRequest request;
// EarlybirdRequestType should not change for a given request. Computing it once here so that we
// don’t need to compute it from the request every time we want to use it.
private final EarlybirdRequestType earlybirdRequestType;
// The parsed query matching the serialized query in the request. May be null if the request does
// not contain a serialized query.
// If a request’s serialized query needs to be rewritten for any reason, a new
// EarlybirdRequestContext should be created, with a new EarlybirdRequest (with a new serialized
// query), and a new parsed query (matching the new serialized query).
&#64;Nullable
private final Query parsedQuery;
private final boolean useOverrideTierConfig;
private final long createdTimeMillis;
private final Option&lt;Viewer&gt; twitterContextViewer;</p>
<p>&#64;Nullable
private final ImmutableSet&lt;ThriftSearchFeatureSchemaSpecifier&gt; featureSchemasAvailableInClient;</p>
<dl>
<dt>private EarlybirdRequestContext(</dt><dd><blockquote>
<div><p>EarlybirdRequest request,
Query parsedQuery,
boolean useOverrideTierConfig,
long createdTimeMillis,
Option&lt;Viewer&gt; twitterContextViewer) {</p>
</div></blockquote>
<dl class="simple">
<dt>this(request,</dt><dd><p>EarlybirdRequestType.of(request),
parsedQuery,
useOverrideTierConfig,
createdTimeMillis,
twitterContextViewer,
null);</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private EarlybirdRequestContext(</dt><dd><blockquote>
<div><p>EarlybirdRequest request,
EarlybirdRequestType earlybirdRequestType,
Query parsedQuery,
boolean useOverrideTierConfig,
long createdTimeMillis,
Option&lt;Viewer&gt; twitterContextViewer,
&#64;Nullable ImmutableSet&lt;ThriftSearchFeatureSchemaSpecifier&gt; featureSchemasAvailableInClient) {</p>
</div></blockquote>
<p>this.request = Preconditions.checkNotNull(request);
this.earlybirdRequestType = earlybirdRequestType;
this.parsedQuery = parsedQuery;
this.useOverrideTierConfig = useOverrideTierConfig;
this.createdTimeMillis = createdTimeMillis;
this.twitterContextViewer = twitterContextViewer;
this.featureSchemasAvailableInClient = featureSchemasAvailableInClient;</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>private EarlybirdRequestContext(EarlybirdRequestContext otherContext, Query otherParsedQuery) {</dt><dd><p>this(otherContext, otherContext.getRequest().deepCopy(), otherParsedQuery);</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private EarlybirdRequestContext(EarlybirdRequestContext otherContext,</dt><dd><blockquote>
<div><p>EarlybirdRequest otherRequest,
Query otherParsedQuery) {</p>
</div></blockquote>
<dl class="simple">
<dt>this(otherRequest,</dt><dd><p>otherContext.earlybirdRequestType,
otherParsedQuery,
otherContext.useOverrideTierConfig,
otherContext.createdTimeMillis,
otherContext.twitterContextViewer,
null);</p>
</dd>
</dl>
<p>Preconditions.checkState(request.isSetSearchQuery());
this.request.getSearchQuery().setSerializedQuery(otherParsedQuery.serialize());</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>public EarlybirdRequest getRequest() {</dt><dd><p>return request;</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>public boolean useOverrideTierConfig() {</dt><dd><p>return useOverrideTierConfig;</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>public EarlybirdRequestType getEarlybirdRequestType() {</dt><dd><p>return earlybirdRequestType;</p>
</dd>
</dl>
<p>}</p>
<p>&#64;Nullable
public Query getParsedQuery() {</p>
<blockquote>
<div><p>return parsedQuery;</p>
</div></blockquote>
<p>}</p>
<dl class="simple">
<dt>public long getCreatedTimeMillis() {</dt><dd><p>return createdTimeMillis;</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>public Option&lt;Viewer&gt; getTwitterContextViewer() {</dt><dd><p>return twitterContextViewer;</p>
</dd>
</dl>
<p>}</p>
<p>&#64;Nullable
public Set&lt;ThriftSearchFeatureSchemaSpecifier&gt; getFeatureSchemasAvailableInClient() {</p>
<blockquote>
<div><p>return featureSchemasAvailableInClient;</p>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>}</p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../../index2.rst.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../../index2.rst.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../../_sources/src/java/com/twitter/search/earlybird_root/common/EarlybirdRequestContext.java.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>