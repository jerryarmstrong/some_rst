<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../" id="documentation_options" src="../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>package com.twitter.search.earlybird;</p>
<p>import java.net.InetSocketAddress;
import java.util.concurrent.atomic.AtomicReference;</p>
<p>import org.apache.thrift.protocol.TCompactProtocol;
import org.apache.thrift.protocol.TProtocolFactory;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;</p>
<p>import com.twitter.finagle.ListeningServer;
import com.twitter.finagle.Service;
import com.twitter.finagle.SslException;
import com.twitter.finagle.ThriftMux;
import com.twitter.finagle.mtls.server.MtlsThriftMuxServer;
import com.twitter.finagle.mux.transport.OpportunisticTls;
import com.twitter.finagle.stats.MetricsStatsReceiver;
import com.twitter.finagle.thrift.ThriftClientRequest;
import com.twitter.finagle.util.ExitGuard;
import com.twitter.finagle.zipkin.thrift.ZipkinTracer;
import com.twitter.search.common.dark.DarkProxy;
import com.twitter.search.earlybird.common.config.EarlybirdProperty;
import com.twitter.search.earlybird.exception.CriticalExceptionHandler;
import com.twitter.search.earlybird.exception.EarlybirdFinagleServerMonitor;
import com.twitter.search.earlybird.thrift.EarlybirdService;
import com.twitter.server.filter.AdmissionControl;
import com.twitter.server.filter.cpuAdmissionControl;
import com.twitter.util.Await;
import com.twitter.util.Duration;
import com.twitter.util.TimeoutException;</p>
<dl>
<dt>public class EarlybirdProductionFinagleServerManager implements EarlybirdFinagleServerManager {</dt><dd><dl class="simple">
<dt>private static final Logger LOG =</dt><dd><p>LoggerFactory.getLogger(EarlybirdProductionFinagleServerManager.class);</p>
</dd>
</dl>
<p>private final AtomicReference&lt;ListeningServer&gt; warmUpFinagleServer = new AtomicReference&lt;&gt;();
private final AtomicReference&lt;ListeningServer&gt; productionFinagleServer = new AtomicReference&lt;&gt;();
private final EarlybirdFinagleServerMonitor unhandledExceptionMonitor;</p>
<dl>
<dt>public EarlybirdProductionFinagleServerManager(</dt><dd><blockquote>
<div><p>CriticalExceptionHandler criticalExceptionHandler) {</p>
</div></blockquote>
<dl class="simple">
<dt>this.unhandledExceptionMonitor =</dt><dd><p>new EarlybirdFinagleServerMonitor(criticalExceptionHandler);</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<p>&#64;Override
public boolean isWarmUpServerRunning() {</p>
<blockquote>
<div><p>return warmUpFinagleServer.get() != null;</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public void startWarmUpFinagleServer(EarlybirdService.ServiceIface serviceIface,</p>
<blockquote>
<div><blockquote>
<div><p>String serviceName,
int port) {</p>
</div></blockquote>
<p>TProtocolFactory protocolFactory = new TCompactProtocol.Factory();
startFinagleServer(warmUpFinagleServer, “warmup”,</p>
<blockquote>
<div><p>new EarlybirdService.Service(serviceIface, protocolFactory),
protocolFactory, serviceName, port);</p>
</div></blockquote>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public void stopWarmUpFinagleServer(Duration serverCloseWaitTime) throws InterruptedException {</p>
<blockquote>
<div><p>stopFinagleServer(warmUpFinagleServer, serverCloseWaitTime, “Warm up”);</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public boolean isProductionServerRunning() {</p>
<blockquote>
<div><p>return productionFinagleServer.get() != null;</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public void startProductionFinagleServer(DarkProxy&lt;ThriftClientRequest, byte[]&gt; darkProxy,</p>
<blockquote>
<div><blockquote>
<div><p>EarlybirdService.ServiceIface serviceIface,
String serviceName,
int port) {</p>
</div></blockquote>
<p>TProtocolFactory protocolFactory = new TCompactProtocol.Factory();
startFinagleServer(productionFinagleServer, “production”,</p>
<blockquote>
<div><p>darkProxy.toFilter().andThen(new EarlybirdService.Service(serviceIface, protocolFactory)),
protocolFactory, serviceName, port);</p>
</div></blockquote>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public void stopProductionFinagleServer(Duration serverCloseWaitTime)</p>
<blockquote>
<div><blockquote>
<div><p>throws InterruptedException {</p>
</div></blockquote>
<p>stopFinagleServer(productionFinagleServer, serverCloseWaitTime, “Production”);</p>
</div></blockquote>
<p>}</p>
<dl>
<dt>private void startFinagleServer(AtomicReference target, String serverDescription,</dt><dd><blockquote>
<div><p>Service&lt;byte[], byte[]&gt; service, TProtocolFactory protocolFactory, String serviceName,
int port) {</p>
</div></blockquote>
<p>target.set(getServer(service, serviceName, port, protocolFactory));
LOG.info(“Started EarlybirdServer “ + serverDescription + “ finagle server on port “ + port);</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private ListeningServer getServer(</dt><dd><blockquote>
<div><p>Service&lt;byte[], byte[]&gt; service, String serviceName, int port,
TProtocolFactory protocolFactory) {</p>
</div></blockquote>
<p>MetricsStatsReceiver statsReceiver = new MetricsStatsReceiver();
ThriftMux.Server server = new MtlsThriftMuxServer(ThriftMux.server())</p>
<blockquote>
<div><p>.withMutualTls(EarlybirdProperty.getServiceIdentifier())
.withServiceClass(EarlybirdService.class)
.withOpportunisticTls(OpportunisticTls.Required())
.withLabel(serviceName)
.withStatsReceiver(statsReceiver)
.withTracer(ZipkinTracer.mk(statsReceiver))
.withMonitor(unhandledExceptionMonitor)
.withProtocolFactory(protocolFactory);</p>
</div></blockquote>
<dl class="simple">
<dt>if (cpuAdmissionControl.isDefined()) {</dt><dd><dl class="simple">
<dt>LOG.info(“cpuAdmissionControl flag is set, replacing AuroraThrottlingAdmissionFilter”</dt><dd><ul class="simple">
<li><p>“ with LinuxCpuAdmissionFilter”);</p></li>
</ul>
</dd>
<dt>server = server</dt><dd><p>.configured(AdmissionControl.auroraThrottling().off().mk())
.configured(AdmissionControl.linuxCpu().useGlobalFlag().mk());</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<p>return server.serve(new InetSocketAddress(port), service);</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private void stopFinagleServer(AtomicReference&lt;ListeningServer&gt; finagleServer,</dt><dd><blockquote>
<div><p>Duration serverCloseWaitTime,
String serverDescription) throws InterruptedException {</p>
</div></blockquote>
<dl>
<dt>try {</dt><dd><dl class="simple">
<dt>LOG.info(“Waiting for “ + serverDescription + “ finagle server to close. “</dt><dd><ul class="simple">
<li><p>“Current time is “ + System.currentTimeMillis());</p></li>
</ul>
</dd>
</dl>
<p>Await.result(finagleServer.get().close(), serverCloseWaitTime);
LOG.info(“Stopped “ + serverDescription + “ finagle server. Current time is “</p>
<blockquote>
<div><ul class="simple">
<li><p>System.currentTimeMillis());</p></li>
</ul>
</div></blockquote>
<p>finagleServer.set(null);</p>
</dd>
<dt>} catch (TimeoutException e) {</dt><dd><p>LOG.warn(serverDescription + “ finagle server did not shutdown cleanly.”, e);</p>
</dd>
<dt>} catch (SslException e) {</dt><dd><p>// Closing the Thrift port seems to throw an SSLException (SSLEngine closed already).
// See SEARCH-29449. Log the exception and reset finagleServer, so that future calls to
// startProductionFinagleServer() succeed.
LOG.warn(“Got a SSLException while trying to close the Thrift port.”, e);
finagleServer.set(null);</p>
</dd>
<dt>} catch (InterruptedException e) {</dt><dd><p>// If we catch an InterruptedException here, it means that we’re probably shutting down.
// We should propagate this exception, and rely on EarlybirdServer.stopThriftService()
// to do the right thing.
throw e;</p>
</dd>
<dt>} catch (Exception e) {</dt><dd><p>LOG.error(e.getMessage(), e);</p>
</dd>
<dt>} finally {</dt><dd><p>// If the finagle server does not close cleanly, this line prints details about
// the ExitGuards.
LOG.info(serverDescription + “ server ExitGuard explanation: “ + ExitGuard.explainGuards());</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../index2.rst.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../index2.rst.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../_sources/src/java/com/twitter/search/earlybird/EarlybirdProductionFinagleServerManager.java.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>