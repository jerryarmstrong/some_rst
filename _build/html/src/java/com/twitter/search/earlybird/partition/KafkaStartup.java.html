<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../../" id="documentation_options" src="../../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>package com.twitter.search.earlybird.partition;</p>
<p>import java.io.Closeable;
import java.util.Optional;</p>
<p>import com.google.common.annotations.VisibleForTesting;
import com.google.common.base.Stopwatch;</p>
<p>import org.slf4j.Logger;
import org.slf4j.LoggerFactory;</p>
<p>import com.twitter.search.common.config.Config;
import com.twitter.search.common.decider.SearchDecider;
import com.twitter.search.common.metrics.SearchLongGauge;
import com.twitter.search.earlybird.EarlybirdStatus;
import com.twitter.search.earlybird.common.config.EarlybirdConfig;
import com.twitter.search.earlybird.exception.CriticalExceptionHandler;
import com.twitter.search.earlybird.exception.EarlybirdStartupException;
import com.twitter.search.earlybird.partition.freshstartup.FreshStartupHandler;
import com.twitter.search.earlybird.querycache.QueryCacheManager;
import com.twitter.search.earlybird.thrift.EarlybirdStatusCode;
import com.twitter.search.queryparser.query.QueryParserException;</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Handles starting an Earlybird from Kafka topics.</p></li>
<li></li>
<li><p>Currently very unoptimized – future versions will implement parallel indexing and loading</p></li>
<li><p>serialized data from HDFS. See <a class="reference external" href="http://go/removing-dl-tdd">http://go/removing-dl-tdd</a>.</p></li>
</ul>
<p><a href="#id1"><span class="problematic" id="id2">*</span></a>/</p>
</dd>
<dt>public class KafkaStartup implements EarlybirdStartup {</dt><dd><p>private static final Logger LOG = LoggerFactory.getLogger(KafkaStartup.class);</p>
<p>private final EarlybirdKafkaConsumer earlybirdKafkaConsumer;
private final StartupUserEventIndexer startupUserEventIndexer;
private final QueryCacheManager queryCacheManager;
private final SegmentManager segmentManager;
private final EarlybirdIndexLoader earlybirdIndexLoader;
private final FreshStartupHandler freshStartupHandler;
private final UserUpdatesStreamIndexer userUpdatesStreamIndexer;
private final UserScrubGeoEventStreamIndexer userScrubGeoEventStreamIndexer;
private final SearchIndexingMetricSet searchIndexingMetricSet;
private final SearchLongGauge loadedIndex;
private final SearchLongGauge freshStartup;
private final MultiSegmentTermDictionaryManager multiSegmentTermDictionaryManager;
private final AudioSpaceEventsStreamIndexer audioSpaceEventsStreamIndexer;
private final CriticalExceptionHandler earlybirdExceptionHandler;
private final SearchDecider decider;</p>
<p>private static final String FRESH_STARTUP = “fresh startup”;
private static final String INGEST_UNTIL_CURRENT = “ingest until current”;
private static final String LOAD_FLUSHED_INDEX = “load flushed index”;
private static final String SETUP_QUERY_CACHE = “setting up query cache”;
private static final String USER_UPDATES_STARTUP = “user updates startup”;
private static final String AUDIO_SPACES_STARTUP = “audio spaces startup”;
private static final String BUILD_MULTI_SEGMENT_TERM_DICTIONARY =</p>
<blockquote>
<div><p>“build multi segment term dictionary”;</p>
</div></blockquote>
<dl class="simple">
<dt>public KafkaStartup(</dt><dd><p>SegmentManager segmentManager,
EarlybirdKafkaConsumer earlybirdKafkaConsumer,
StartupUserEventIndexer startupUserEventIndexer,
UserUpdatesStreamIndexer userUpdatesStreamIndexer,
UserScrubGeoEventStreamIndexer userScrubGeoEventStreamIndexer,
AudioSpaceEventsStreamIndexer audioSpaceEventsStreamIndexer,
QueryCacheManager queryCacheManager,
EarlybirdIndexLoader earlybirdIndexLoader,
FreshStartupHandler freshStartupHandler,
SearchIndexingMetricSet searchIndexingMetricSet,
MultiSegmentTermDictionaryManager multiSegmentTermDictionaryManager,
CriticalExceptionHandler earlybirdExceptionHandler,
SearchDecider decider</p>
</dd>
<dt>) {</dt><dd><p>this.segmentManager = segmentManager;
this.earlybirdKafkaConsumer = earlybirdKafkaConsumer;
this.startupUserEventIndexer = startupUserEventIndexer;
this.queryCacheManager = queryCacheManager;
this.earlybirdIndexLoader = earlybirdIndexLoader;
this.freshStartupHandler = freshStartupHandler;
this.userUpdatesStreamIndexer = userUpdatesStreamIndexer;
this.userScrubGeoEventStreamIndexer = userScrubGeoEventStreamIndexer;
this.audioSpaceEventsStreamIndexer = audioSpaceEventsStreamIndexer;
this.searchIndexingMetricSet = searchIndexingMetricSet;
this.loadedIndex = SearchLongGauge.export(“kafka_startup_loaded_index”);
this.freshStartup = SearchLongGauge.export(“fresh_startup”);
this.multiSegmentTermDictionaryManager = multiSegmentTermDictionaryManager;
this.earlybirdExceptionHandler = earlybirdExceptionHandler;
this.decider = decider;
freshStartup.set(0);</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private void userEventsStartup() {</dt><dd><p>LOG.info(“Start indexing user events.”);</p>
<p>startupUserEventIndexer.indexAllEvents();</p>
<p>LOG.info(“Finished loading/indexing user events.”);</p>
<p>// User updates are now current, keep them current by continuing to index from the stream.
LOG.info(“Starting to run UserUpdatesStreamIndexer”);
new Thread(userUpdatesStreamIndexer::run, “userupdates-stream-indexer”).start();</p>
<dl>
<dt>if (EarlybirdConfig.consumeUserScrubGeoEvents()) {</dt><dd><p>// User scrub geo events are now current,
// keep them current by continuing to index from the stream.
LOG.info(“Starting to run UserScrubGeoEventsStreamIndexer”);
new Thread(userScrubGeoEventStreamIndexer::run,</p>
<blockquote>
<div><p>“userScrubGeoEvents-stream-indexer”).start();</p>
</div></blockquote>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private void loadAudioSpaceEvents() {</dt><dd><p>LOG.info(“Index audio space events…”);
EarlybirdStatus.beginEvent(AUDIO_SPACES_STARTUP,</p>
<blockquote>
<div><p>searchIndexingMetricSet.startupInAudioSpaceEventIndexer);</p>
</div></blockquote>
<dl class="simple">
<dt>if (audioSpaceEventsStreamIndexer == null) {</dt><dd><p>LOG.error(“Null audioSpaceEventsStreamIndexer”);
return;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>if (decider.isAvailable(“enable_reading_audio_space_events”)) {</dt><dd><p>Stopwatch stopwatch = Stopwatch.createStarted();
audioSpaceEventsStreamIndexer.seekToBeginning();
audioSpaceEventsStreamIndexer.readRecordsUntilCurrent();
LOG.info(“Finished reading audio spaces in {}”, stopwatch);
audioSpaceEventsStreamIndexer.printSummary();</p>
<dl class="simple">
<dt>new Thread(audioSpaceEventsStreamIndexer::run,</dt><dd><p>“audioSpaceEvents-stream-indexer”).start();</p>
</dd>
</dl>
</dd>
<dt>} else {</dt><dd><p>LOG.info(“Reading audio space events not enabled”);</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>EarlybirdStatus.endEvent(AUDIO_SPACES_STARTUP,</dt><dd><p>searchIndexingMetricSet.startupInAudioSpaceEventIndexer);</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private void tweetsAndUpdatesStartup() throws EarlybirdStartupException {</dt><dd><p>LOG.info(“Index tweets and updates…”);
EarlybirdStatus.beginEvent(LOAD_FLUSHED_INDEX,</p>
<blockquote>
<div><p>searchIndexingMetricSet.startupInLoadFlushedIndex);</p>
</div></blockquote>
<p>EarlybirdIndex index;</p>
<p>// Set when you want to get a server from starting to ready quickly for development
// purposes.
boolean fastDevStartup = EarlybirdConfig.getBool(“fast_dev_startup”);</p>
<p>Optional&lt;EarlybirdIndex&gt; optIndex = Optional.empty();
if (!fastDevStartup) {</p>
<blockquote>
<div><p>optIndex = earlybirdIndexLoader.loadIndex();</p>
</div></blockquote>
<p>}</p>
<dl>
<dt>if (optIndex.isPresent()) {</dt><dd><p>loadedIndex.set(1);
LOG.info(“Loaded an index.”);
index = optIndex.get();
EarlybirdStatus.endEvent(LOAD_FLUSHED_INDEX,</p>
<blockquote>
<div><p>searchIndexingMetricSet.startupInLoadFlushedIndex);</p>
</div></blockquote>
</dd>
<dt>} else {</dt><dd><p>LOG.info(“Didn’t load an index, indexing from scratch.”);
freshStartup.set(1);
boolean parallelIndexFromScratch = EarlybirdConfig.getBool(</p>
<blockquote>
<div><p>“parallel_index_from_scratch”);</p>
</div></blockquote>
<p>LOG.info(“parallel_index_from_scratch: {}”, parallelIndexFromScratch);
EarlybirdStatus.beginEvent(FRESH_STARTUP,</p>
<blockquote>
<div><p>searchIndexingMetricSet.startupInFreshStartup);</p>
</div></blockquote>
<dl>
<dt>try {</dt><dd><dl class="simple">
<dt>if (fastDevStartup) {</dt><dd><p>index = freshStartupHandler.fastIndexFromScratchForDevelopment();</p>
</dd>
<dt>} else if (parallelIndexFromScratch) {</dt><dd><p>index = freshStartupHandler.parallelIndexFromScratch();</p>
</dd>
<dt>} else {</dt><dd><p>index = freshStartupHandler.indexFromScratch();</p>
</dd>
</dl>
<p>}</p>
</dd>
<dt>} catch (Exception ex) {</dt><dd><p>throw new EarlybirdStartupException(ex);</p>
</dd>
<dt>} finally {</dt><dd><dl class="simple">
<dt>EarlybirdStatus.endEvent(FRESH_STARTUP,</dt><dd><p>searchIndexingMetricSet.startupInFreshStartup);</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<p>LOG.info(“Index has {} segments.”, index.getSegmentInfoList().size());
if (index.getSegmentInfoList().size() &gt; 0) {</p>
<blockquote>
<div><p>LOG.info(“Inserting segments into SegmentManager”);
for (SegmentInfo segmentInfo : index.getSegmentInfoList()) {</p>
<blockquote>
<div><p>segmentManager.putSegmentInfo(segmentInfo);</p>
</div></blockquote>
<p>}</p>
<dl class="simple">
<dt>earlybirdKafkaConsumer.prepareAfterStartingWithIndex(</dt><dd><p>index.getMaxIndexedTweetId()</p>
</dd>
</dl>
<p>);</p>
</div></blockquote>
<p>}</p>
<p>// Build the Multi segment term dictionary before catching up on indexing to ensure that the
// segments won’t roll and delete the oldest segment while a multi segment term dictionary that
// includes that segment is being built.
buildMultiSegmentTermDictionary();</p>
<p>segmentManager.logState(“Starting ingestUntilCurrent”);
LOG.info(“partial updates indexed: {}”, segmentManager.getNumPartialUpdates());
EarlybirdStatus.beginEvent(INGEST_UNTIL_CURRENT,</p>
<blockquote>
<div><p>searchIndexingMetricSet.startupInIngestUntilCurrent);</p>
</div></blockquote>
<p>earlybirdKafkaConsumer.ingestUntilCurrent(index.getTweetOffset(), index.getUpdateOffset());</p>
<p>validateSegments();
segmentManager.logState(“ingestUntilCurrent is done”);
LOG.info(“partial updates indexed: {}”, segmentManager.getNumPartialUpdates());
EarlybirdStatus.endEvent(INGEST_UNTIL_CURRENT,</p>
<blockquote>
<div><p>searchIndexingMetricSet.startupInIngestUntilCurrent);</p>
</div></blockquote>
<p>new Thread(earlybirdKafkaConsumer::run, “earlybird-kafka-consumer”).start();</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>protected void validateSegments() throws EarlybirdStartupException {</dt><dd><dl class="simple">
<dt>if (!Config.environmentIsTest()) {</dt><dd><p>// Unfortunately, many tests start Earlybirds with 0 indexed documents, so we disable this
// check in tests.
validateSegmentsForNonTest();</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>protected void validateSegmentsForNonTest() throws EarlybirdStartupException {</dt><dd><p>// SEARCH-24123: Prevent Earlybird from starting if there are no indexed documents.
if (segmentManager.getNumIndexedDocuments() == 0) {</p>
<blockquote>
<div><p>throw new EarlybirdStartupException(“Earlybird has zero indexed documents.”);</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private void queryCacheStartup() throws EarlybirdStartupException {</dt><dd><dl class="simple">
<dt>EarlybirdStatus.beginEvent(SETUP_QUERY_CACHE,</dt><dd><p>searchIndexingMetricSet.startupInQueryCacheUpdates);</p>
</dd>
<dt>try {</dt><dd><p>queryCacheManager.setupTasksIfNeeded(segmentManager);</p>
</dd>
<dt>} catch (QueryParserException e) {</dt><dd><p>LOG.error(“Exception when setting up query cache tasks”);
throw new EarlybirdStartupException(e);</p>
</dd>
</dl>
<p>}</p>
<p>queryCacheManager.waitUntilAllQueryCachesAreBuilt();</p>
<p>// Print the sizes of the query caches so that we can see that they’re built.
Iterable&lt;SegmentInfo&gt; segmentInfos =</p>
<blockquote>
<div><p>segmentManager.getSegmentInfos(SegmentManager.Filter.All, SegmentManager.Order.OLD_TO_NEW);</p>
</div></blockquote>
<p>segmentManager.logState(“After building query caches”);
for (SegmentInfo segmentInfo : segmentInfos) {</p>
<blockquote>
<div><dl class="simple">
<dt>LOG.info(“Segment: {}, Total cardinality: {}”, segmentInfo.getSegmentName(),</dt><dd><p>segmentInfo.getIndexSegment().getQueryCachesCardinality());</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
<p>// We’re done building the query caches for all segments, and the earlybird is ready to become
// current. Restrict all future query cache task runs to one single core, to make sure our
// searcher threads are not impacted.
queryCacheManager.setWorkerPoolSizeAfterStartup();
EarlybirdStatus.endEvent(SETUP_QUERY_CACHE,</p>
<blockquote>
<div><p>searchIndexingMetricSet.startupInQueryCacheUpdates);</p>
</div></blockquote>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Closes all currently running Indexers.</p></li>
</ul>
<p><a href="#id3"><span class="problematic" id="id4">*</span></a>/</p>
</dd>
</dl>
<p>&#64;VisibleForTesting
public void shutdownIndexing() {</p>
<blockquote>
<div><p>LOG.info(“Shutting down KafkaStartup.”);</p>
<p>earlybirdKafkaConsumer.close();
userUpdatesStreamIndexer.close();
userScrubGeoEventStreamIndexer.close();
// Note that the QueryCacheManager is shut down in EarlybirdServer::shutdown.</p>
</div></blockquote>
<p>}</p>
<dl>
<dt>private void buildMultiSegmentTermDictionary() {</dt><dd><dl class="simple">
<dt>EarlybirdStatus.beginEvent(BUILD_MULTI_SEGMENT_TERM_DICTIONARY,</dt><dd><p>searchIndexingMetricSet.startupInMultiSegmentTermDictionaryUpdates);</p>
</dd>
</dl>
<p>Stopwatch stopwatch = Stopwatch.createStarted();
LOG.info(“Building multi segment term dictionary”);
multiSegmentTermDictionaryManager.buildDictionary();
LOG.info(“Done with building multi segment term dictionary in {}”, stopwatch);
EarlybirdStatus.endEvent(BUILD_MULTI_SEGMENT_TERM_DICTIONARY,</p>
<blockquote>
<div><p>searchIndexingMetricSet.startupInMultiSegmentTermDictionaryUpdates);</p>
</div></blockquote>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private void parallelIndexingStartup() throws EarlybirdStartupException {</dt><dd><p>Thread userEventsThread = new Thread(this::userEventsStartup, “index-user-events-startup”);
Thread tweetsAndUpdatesThread = new Thread(() -&gt; {</p>
<blockquote>
<div><dl class="simple">
<dt>try {</dt><dd><p>tweetsAndUpdatesStartup();</p>
</dd>
<dt>} catch (EarlybirdStartupException e) {</dt><dd><p>earlybirdExceptionHandler.handle(this, e);</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}, “index-tweets-and-updates-startup”);
Thread audioSpaceEventsThread = new Thread(this::loadAudioSpaceEvents,</p>
<blockquote>
<div><p>“index-audio-space-events-startup”);</p>
</div></blockquote>
<p>userEventsThread.start();
tweetsAndUpdatesThread.start();
audioSpaceEventsThread.start();</p>
<dl class="simple">
<dt>try {</dt><dd><p>userEventsThread.join();</p>
</dd>
<dt>} catch (InterruptedException e) {</dt><dd><p>throw new EarlybirdStartupException(“Interrupted while indexing user events”);</p>
</dd>
</dl>
<p>}
try {</p>
<blockquote>
<div><p>tweetsAndUpdatesThread.join();</p>
</div></blockquote>
<dl class="simple">
<dt>} catch (InterruptedException e) {</dt><dd><p>throw new EarlybirdStartupException(“Interrupted while indexing tweets and updates”);</p>
</dd>
</dl>
<p>}
try {</p>
<blockquote>
<div><p>audioSpaceEventsThread.join();</p>
</div></blockquote>
<dl class="simple">
<dt>} catch (InterruptedException e) {</dt><dd><p>throw new EarlybirdStartupException(“Interrupted while indexing audio space events”);</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Does startups and starts indexing. Returns when the earlybird</p></li>
<li><p>is current.</p></li>
</ul>
<p><a href="#id5"><span class="problematic" id="id6">*</span></a>/</p>
</dd>
</dl>
<p>&#64;Override
public Closeable start() throws EarlybirdStartupException {</p>
<blockquote>
<div><p>parallelIndexingStartup();
queryCacheStartup();</p>
<p>EarlybirdStatus.setStatus(EarlybirdStatusCode.CURRENT);</p>
<p>return this::shutdownIndexing;</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}</p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../../index2.rst.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../../index2.rst.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../../_sources/src/java/com/twitter/search/earlybird/partition/KafkaStartup.java.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>