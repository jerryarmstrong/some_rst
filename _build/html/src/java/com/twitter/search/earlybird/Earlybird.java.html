<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../" id="documentation_options" src="../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>package com.twitter.search.earlybird;</p>
<p>import java.io.File;
import java.io.IOException;
import java.net.InetAddress;
import java.net.UnknownHostException;
import java.util.Arrays;
import java.util.Map;
import java.util.function.Predicate;
import java.util.stream.Collectors;</p>
<p>import com.google.common.annotations.VisibleForTesting;
import com.google.common.base.Preconditions;</p>
<p>import org.slf4j.Logger;
import org.slf4j.LoggerFactory;</p>
<p>import com.twitter.app.Flag;
import com.twitter.app.Flaggable;
import com.twitter.finagle.Http;
import com.twitter.finagle.http.HttpMuxer;
import com.twitter.search.common.aurora.AuroraInstanceKey;
import com.twitter.search.common.config.Config;
import com.twitter.search.common.config.LoggerConfiguration;
import com.twitter.search.common.constants.SearchThriftWebFormsAccess;
import com.twitter.search.common.metrics.BuildInfoStats;
import com.twitter.search.common.util.Kerberos;
import com.twitter.search.common.util.PlatformStatsExporter;
import com.twitter.search.earlybird.admin.EarlybirdAdminManager;
import com.twitter.search.earlybird.admin.EarlybirdHealthHandler;
import com.twitter.search.earlybird.common.config.EarlybirdConfig;
import com.twitter.search.earlybird.common.config.EarlybirdProperty;
import com.twitter.search.earlybird.exception.EarlybirdStartupException;
import com.twitter.search.earlybird.exception.UncaughtExceptionHandler;
import com.twitter.search.earlybird.factory.EarlybirdServerFactory;
import com.twitter.search.earlybird.factory.EarlybirdWireModule;
import com.twitter.search.earlybird.thrift.EarlybirdService;
import com.twitter.search.earlybird.util.EarlybirdDecider;
import com.twitter.server.handler.DeciderHandler$;
import com.twitter.server.AbstractTwitterServer;
import com.twitter.thriftwebforms.DisplaySettingsConfig;
import com.twitter.thriftwebforms.MethodOptionsAccessConfig;
import com.twitter.thriftwebforms.ThriftClientSettingsConfig;
import com.twitter.thriftwebforms.ThriftMethodSettingsConfig;
import com.twitter.thriftwebforms.ThriftServiceSettings;
import com.twitter.thriftwebforms.ThriftWebFormsSettings;
import com.twitter.thriftwebforms.TwitterServerThriftWebForms;
import com.twitter.util.Await;
import com.twitter.util.TimeoutException;</p>
<dl>
<dt>public class Earlybird extends AbstractTwitterServer {</dt><dd><p>private static final Logger LOG = LoggerFactory.getLogger(Earlybird.class);</p>
<p>// Flags defined here need to be processed before setting override values to EarlybirdConfig.</p>
<dl class="simple">
<dt>private final Flag&lt;File&gt; configFile = flag().create(</dt><dd><p>“config_file”,
new File(“earlybird-search.yml”),
“specify config file”,
Flaggable.ofFile()</p>
</dd>
</dl>
<p>);</p>
<dl class="simple">
<dt>private final Flag&lt;String&gt; logDir = flag().create(</dt><dd><p>“earlybird_log_dir”,
“”,
“override log dir from config file”,
Flaggable.ofString()</p>
</dd>
</dl>
<p>);</p>
<dl class="simple">
<dt>private final Map&lt;String, Flag&lt;?&gt;&gt; flagMap = Arrays.stream(EarlybirdProperty.values())</dt><dd><dl class="simple">
<dt>.collect(Collectors.toMap(</dt><dd><p>property -&gt; property.name(),
property -&gt; property.createFlag(flag())));</p>
</dd>
</dl>
</dd>
<dt>private final UncaughtExceptionHandler uncaughtExceptionHandler =</dt><dd><p>new UncaughtExceptionHandler();</p>
</dd>
</dl>
<p>private EarlybirdServer earlybirdServer;
private EarlybirdAdminManager earlybirdAdminManager;</p>
<dl class="simple">
<dt>public Earlybird() {</dt><dd><p>// Default health handler is added inside Lifecycle trait.  To override that we need to set it
// in the constructor since HttpAdminServer is started before Earlybird.preMain() is called.
HttpMuxer.addHandler(“/health”, new EarlybirdHealthHandler());</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Needs to be called from preMain and not from onInit() as flags / args parsing happens after</p></li>
<li><p>onInit() is called.</p></li>
</ul>
<p><a href="#id1"><span class="problematic" id="id2">*</span></a>/</p>
</dd>
</dl>
<p>&#64;VisibleForTesting
void configureFromFlagsAndSetupLogging() {</p>
<blockquote>
<div><p>// Makes sure the EarlybirdStats is injected with a variable repository.
EarlybirdConfig.init(configFile.getWithDefault().get().getName());</p>
<dl class="simple">
<dt>if (logDir.isDefined()) {</dt><dd><p>EarlybirdConfig.overrideLogDir(logDir.get().get());</p>
</dd>
</dl>
<p>}
new LoggerConfiguration(EarlybirdConfig.getLogPropertiesFile(),</p>
<blockquote>
<div><p>EarlybirdConfig.getLogDir()).configure();</p>
</div></blockquote>
<p>String instanceKey = System.getProperty(“aurora.instanceKey”);
if (instanceKey != null) {</p>
<blockquote>
<div><p>EarlybirdConfig.setAuroraInstanceKey(AuroraInstanceKey.fromInstanceKey(instanceKey));
LOG.info(“Earlybird is running on Aurora”);
checkRequiredProperties(EarlybirdProperty::isRequiredOnAurora, “Aurora”);</p>
</div></blockquote>
<dl class="simple">
<dt>} else {</dt><dd><p>LOG.info(“Earlybird is running on dedicated hardware”);
checkRequiredProperties(EarlybirdProperty::isRequiredOnDedicated, “dedicated hardware”);</p>
</dd>
</dl>
<p>}
LOG.info(“Config environment: {}”, Config.getEnvironment());</p>
<dl class="simple">
<dt>if (adminPort().isDefined() &amp;&amp; adminPort().get().isDefined()) {</dt><dd><p>int adminPort = adminPort().get().get().getPort();
LOG.info(“Admin port is {}”, adminPort);
EarlybirdConfig.setAdminPort(adminPort);</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>EarlybirdConfig.setOverrideValues(</dt><dd><dl class="simple">
<dt>flagMap.values().stream()</dt><dd><p>.filter(Flag::isDefined)
.collect(Collectors.toMap(Flag::name, flag -&gt; flag.get().get())));</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>}</p>
<dl>
<dt>private void checkRequiredProperties(</dt><dd><blockquote>
<div><p>Predicate&lt;EarlybirdProperty&gt; propertyPredicate, String location) {</p>
</div></blockquote>
<dl>
<dt>Arrays.stream(EarlybirdProperty.values())</dt><dd><p>.filter(propertyPredicate)
.map(property -&gt; flagMap.get(property.name()))
.forEach(flag -&gt;</p>
<blockquote>
<div><dl class="simple">
<dt>Preconditions.checkState(flag.isDefined(),</dt><dd><p>“-%s is required on %s”, flag.name(), location));</p>
</dd>
</dl>
</div></blockquote>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private void logEarlybirdInfo() {</dt><dd><dl class="simple">
<dt>try {</dt><dd><p>LOG.info(“Hostname: {}”, InetAddress.getLocalHost().getHostName());</p>
</dd>
<dt>} catch (UnknownHostException e) {</dt><dd><p>LOG.info(“Unable to be get local host: {}”, e.getMessage());</p>
</dd>
</dl>
<p>}
LOG.info(“Earlybird info [Name: {}, Zone: {}, Env: {}]”,</p>
<blockquote>
<div><p>EarlybirdProperty.EARLYBIRD_NAME.get(),
EarlybirdProperty.ZONE.get(),
EarlybirdProperty.ENV.get());</p>
</div></blockquote>
<dl class="simple">
<dt>LOG.info(“Earlybird scrubgen from Aurora: {}]”,</dt><dd><p>EarlybirdProperty.EARLYBIRD_SCRUB_GEN.get());</p>
</dd>
</dl>
<p>LOG.info(“Find final partition config by searching the log for &quot;Partition config info&quot;”);</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private EarlybirdServer makeEarlybirdServer() {</dt><dd><p>EarlybirdWireModule earlybirdWireModule = new EarlybirdWireModule();
EarlybirdServerFactory earlybirdFactory = new EarlybirdServerFactory();
try {</p>
<blockquote>
<div><p>return earlybirdFactory.makeEarlybirdServer(earlybirdWireModule);</p>
</div></blockquote>
<dl class="simple">
<dt>} catch (IOException e) {</dt><dd><p>LOG.error(“Exception while constructing EarlybirdServer.”, e);
throw new RuntimeException(e);</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private void setupThriftWebForms() {</dt><dd><dl>
<dt>TwitterServerThriftWebForms.addAdminRoutes(this, TwitterServerThriftWebForms.apply(</dt><dd><dl>
<dt>ThriftWebFormsSettings.apply(</dt><dd><p>DisplaySettingsConfig.DEFAULT,
ThriftServiceSettings.apply(</p>
<blockquote>
<div><p>EarlybirdService.ServiceIface.class.getSimpleName(),
EarlybirdConfig.getThriftPort()),</p>
</div></blockquote>
<dl class="simple">
<dt>ThriftClientSettingsConfig.makeCompactRequired(</dt><dd><p>EarlybirdProperty.getServiceIdentifier()),</p>
</dd>
<dt>ThriftMethodSettingsConfig.access(</dt><dd><dl class="simple">
<dt>MethodOptionsAccessConfig.byLdapGroup(</dt><dd><p>SearchThriftWebFormsAccess.READ_LDAP_GROUP))),</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p>scala.reflect.ClassTag$.MODULE$.apply(EarlybirdService.ServiceIface.class)));</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>private void setupDeciderWebForms() {</dt><dd><dl class="simple">
<dt>addAdminRoute(</dt><dd><dl class="simple">
<dt>DeciderHandler$.MODULE$.route(</dt><dd><p>“earlybird”,
EarlybirdDecider.getMutableDecisionMaker(),
EarlybirdDecider.getDecider()));</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<p>&#64;Override
public Http.Server configureAdminHttpServer(Http.Server server) {</p>
<blockquote>
<div><p>return server.withMonitor(uncaughtExceptionHandler);</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public void preMain() {</p>
<blockquote>
<div><p>configureFromFlagsAndSetupLogging();
logEarlybirdInfo();
LOG.info(“Starting preMain()”);</p>
<p>BuildInfoStats.export();
PlatformStatsExporter.exportPlatformStats();</p>
<p>// Use our own exception handler to monitor all unhandled exceptions.
Thread.setDefaultUncaughtExceptionHandler((thread, e) -&gt; {</p>
<blockquote>
<div><p>LOG.error(“Invoked default uncaught exception handler.”);
uncaughtExceptionHandler.handle(e);</p>
</div></blockquote>
<p>});
LOG.info(“Registered unhandled exception monitor.”);</p>
<dl class="simple">
<dt>Kerberos.kinit(</dt><dd><p>EarlybirdConfig.getString(“kerberos_user”, “”),
EarlybirdConfig.getString(“kerberos_keytab_path”, “”)</p>
</dd>
</dl>
<p>);</p>
<p>LOG.info(“Creating earlybird server.”);
earlybirdServer = makeEarlybirdServer();</p>
<dl class="simple">
<dt>uncaughtExceptionHandler.setShutdownHook(() -&gt; {</dt><dd><p>earlybirdServer.shutdown();
this.close();</p>
</dd>
</dl>
<p>});</p>
<p>earlybirdAdminManager = EarlybirdAdminManager.create(earlybirdServer);
earlybirdAdminManager.start();
LOG.info(“Started admin interface.”);</p>
<p>setupThriftWebForms();
setupDeciderWebForms();</p>
<p>LOG.info(“Opened thrift serving form.”);</p>
<p>LOG.info(“preMain() complete.”);</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public void main() throws InterruptedException, TimeoutException, EarlybirdStartupException {</p>
<blockquote>
<div><p>innerMain();</p>
</div></blockquote>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Setting up an innerMain() so that tests can mock out the contents of main without interfering</p></li>
<li><p>with reflection being done in App.scala looking for a method named “main”.</p></li>
</ul>
<p><a href="#id3"><span class="problematic" id="id4">*</span></a>/</p>
</dd>
</dl>
<p>&#64;VisibleForTesting
void innerMain() throws TimeoutException, InterruptedException, EarlybirdStartupException {</p>
<blockquote>
<div><p>LOG.info(“Starting main().”);</p>
<p>// If this method throws, TwitterServer will catch the exception and call close, so we don’t
// catch it here.
try {</p>
<blockquote>
<div><p>earlybirdServer.start();</p>
</div></blockquote>
<dl class="simple">
<dt>} catch (Throwable throwable) {</dt><dd><p>LOG.error(“Exception while starting:”, throwable);
throw throwable;</p>
</dd>
</dl>
<p>}</p>
<p>Await.ready(adminHttpServer());
LOG.info(“main() complete.”);</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public void onExit() {</p>
<blockquote>
<div><p>LOG.info(“Starting onExit()”);
earlybirdServer.shutdown();
try {</p>
<blockquote>
<div><p>earlybirdAdminManager.doShutdown();</p>
</div></blockquote>
<dl class="simple">
<dt>} catch (InterruptedException e) {</dt><dd><p>LOG.warn(“earlybirdAdminManager shutdown was interrupted with “ + e);</p>
</dd>
</dl>
<p>}
LOG.info(“onExit() complete.”);</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}</p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../index2.rst.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../index2.rst.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../_sources/src/java/com/twitter/search/earlybird/Earlybird.java.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>