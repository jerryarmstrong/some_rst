<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../../" id="documentation_options" src="../../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>package com.twitter.search.earlybird.partition;</p>
<p>import java.util.EnumMap;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.atomic.AtomicLong;</p>
<p>import com.twitter.search.common.metrics.SearchCounter;
import com.twitter.search.common.metrics.SearchLongGauge;
import com.twitter.search.common.metrics.SearchRateCounter;
import com.twitter.search.common.metrics.SearchStatsReceiver;
import com.twitter.search.common.metrics.SearchTimerStats;
import com.twitter.search.common.schema.thriftjava.ThriftIndexingEventType;
import com.twitter.search.earlybird.util.ScheduledExecutorManager;</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Collection of common metrics used in the indexing, and related code.</p></li>
<li><p>We create a set/holder for them as we want to create all counters only one time, and these</p></li>
<li><p>counters can be used by both SimpleUpdateIndexer, PartitionIndexer, EarlybirdSegment, and others.</p></li>
</ul>
<p><a href="#id1"><span class="problematic" id="id2">*</span></a>/</p>
</dd>
<dt>public class SearchIndexingMetricSet {</dt><dd><dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>A proxy for the creation time of the “freshest” tweet that we have in the index.</p></li>
<li><p>It is used in computing the index freshness stat “earlybird_index_freshness_millis”.</p></li>
<li><ul>
<li><p>In the realtme clusters, this should match the creation time of highestStatusId.</p></li>
</ul>
</li>
<li><ul>
<li><p>In the archive clusters, this should match the timestamp of the latest indexed day.</p></li>
</ul>
</li>
</ul>
<p><a href="#id3"><span class="problematic" id="id4">*</span></a>/</p>
</dd>
</dl>
<p>public final SearchLongGauge freshestTweetTimeMillis;</p>
<p>/** The highest indexed tweet ID. Used to compute index freshness. <a href="#id5"><span class="problematic" id="id6">*</span></a>/
public final SearchLongGauge highestStatusId;</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>The current timeslice’s ID. We can compare this to indexer’s exported current timeslice ID to</p></li>
<li><p>identify stuck timeslice rolls.</p></li>
</ul>
<p><a href="#id7"><span class="problematic" id="id8">*</span></a>/</p>
</dd>
</dl>
<p>public final SearchLongGauge currentTimesliceId;</p>
<p>/** The number of archive timeslices that we failed to process. <a href="#id9"><span class="problematic" id="id10">*</span></a>/
public final SearchCounter archiveTimeSliceBuildFailedCounter;</p>
<p>/** The number of times we checked a segment’s size on disk. <a href="#id11"><span class="problematic" id="id12">*</span></a>/
public final SearchCounter segmentSizeCheckCount;</p>
<p>/** The number of segments that have reached their max size. <a href="#id13"><span class="problematic" id="id14">*</span></a>/
public final SearchCounter maxSegmentSizeReachedCounter;</p>
<p>/** The number of indexed tweets and the aggregate indexing latencies in microseconds. <em>/
public final SearchTimerStats statusStats;
/*</em> The number of applied updates and the aggregate indexing latencies in microseconds. <em>/
public final SearchTimerStats updateStats;
/*</em> The number of retried updates and the aggregate indexing latencies in microseconds. <em>/
public final SearchTimerStats updateRetryStats;
/*</em> The number of applied user updates and the aggregate indexing latencies in microseconds. <em>/
public final SearchTimerStats userUpdateIndexingStats;
/*</em> The number of applied userGeoScrubEvents and the aggregate indexing latencies in</p>
<blockquote>
<div><ul class="simple">
<li><p>microseconds. <a href="#id15"><span class="problematic" id="id16">*</span></a>/</p></li>
</ul>
</div></blockquote>
<p>public final SearchTimerStats userScrubGeoIndexingStats;
/** The number of updates attempted on missing tweets. <em>/
public final SearchRateCounter updateOnMissingTweetCounter;
/*</em> The number of updates dropped. <a href="#id17"><span class="problematic" id="id18">*</span></a>/
public final SearchRateCounter droppedUpdateEvent;</p>
<p>/** The latencies in microseconds of the PartitionIndexer loop. <em>/
public final SearchTimerStats partitionIndexerRunLoopCounter;
/*</em> The latencies in microseconds of the PartitionIndexer.indexFromReaders() calls. <em>/
public final SearchTimerStats partitionIndexerIndexFromReadersCounter;
/*</em> The number of invocations of the PartitionIndexer task. <a href="#id19"><span class="problematic" id="id20">*</span></a>/
public final SearchCounter partitionIndexerIterationCounter;</p>
<p>/** The number of unsorted updates handled by SimpleUpdateIndexer. <em>/
public final SearchCounter simpleUpdateIndexerUnsortedUpdateCounter;
/*</em> The number of unsorted updates with the wrong segment handled by SimpleUpdateIndexer. <a href="#id21"><span class="problematic" id="id22">*</span></a>/
public final SearchCounter simpleUpdateIndexerUnsortedUpdateWithWrongSegmentCounter;</p>
<p>/** The number of invocations of the SimpleUserUpdateIndexer task. <a href="#id23"><span class="problematic" id="id24">*</span></a>/
public final SearchCounter simpleUserUpdateIndexerIterationCounter;</p>
<p>/** The number of exceptions encountered by SimpleSegmentIndexer while indexing a segment. <a href="#id25"><span class="problematic" id="id26">*</span></a>/
public final SearchCounter simpleSegmentIndexerExceptionCounter;</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>A map from TIE update type to the creation time of the updated tweet in milliseconds of the</p></li>
<li><p>freshest update we have indexed.</p></li>
</ul>
<p><a href="#id27"><span class="problematic" id="id28">*</span></a>/</p>
</dd>
<dt>public final EnumMap&lt;ThriftIndexingEventType, AtomicLong&gt; updateFreshness =</dt><dd><p>new EnumMap&lt;&gt;(ThriftIndexingEventType.class);</p>
</dd>
</dl>
<p>public final SearchStatsReceiver searchStatsReceiver;</p>
<dl>
<dt>public static class StartupMetric {</dt><dd><p>// Switched from 0 to 1 during the event.
private SearchLongGauge duringGauge;
// Switched from 0 to time it takes, in milliseconds.
private SearchLongGauge durationMillisGauge;</p>
<dl class="simple">
<dt>StartupMetric(String name) {</dt><dd><p>this.duringGauge = SearchLongGauge.export(name);
this.durationMillisGauge = SearchLongGauge.export(”<a href="#id29"><span class="problematic" id="id30">duration_of_</span></a>” + name);</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>public void begin() {</dt><dd><p>duringGauge.set(1);</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>public void end(long durationInMillis) {</dt><dd><p>duringGauge.set(0);
durationMillisGauge.set(durationInMillis);</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<p>public final StartupMetric startupInProgress;
public final StartupMetric startupInIndexCompletedSegments;
public final StartupMetric startupInLoadCompletedSegments;
public final StartupMetric startupInIndexUpdatesForCompletedSegments;
public final StartupMetric startupInCurrentSegment;
public final StartupMetric startupInUserUpdates;
public final StartupMetric startupInQueryCacheUpdates;
public final StartupMetric startupInMultiSegmentTermDictionaryUpdates;
public final StartupMetric startupInWarmUp;</p>
<p>// Kafka metrics
public final StartupMetric startupInLoadFlushedIndex;
public final StartupMetric startupInFreshStartup;
public final StartupMetric startupInIngestUntilCurrent;
public final StartupMetric startupInUserUpdatesStartup;
public final StartupMetric startupInUserEventIndexer;
public final StartupMetric startupInAudioSpaceEventIndexer;</p>
<dl>
<dt>public SearchIndexingMetricSet(SearchStatsReceiver searchStatsReceiver) {</dt><dd><dl class="simple">
<dt>this.freshestTweetTimeMillis = searchStatsReceiver.getLongGauge(</dt><dd><p>“earlybird_freshest_tweet_timestamp_millis”);</p>
</dd>
</dl>
<p>this.highestStatusId = searchStatsReceiver.getLongGauge(“highest_indexed_status_id”);
this.currentTimesliceId = searchStatsReceiver.getLongGauge(“earlybird_current_timeslice_id”);
this.archiveTimeSliceBuildFailedCounter = searchStatsReceiver.getCounter(</p>
<blockquote>
<div><p>“archive_time_slice_build_failed”);</p>
</div></blockquote>
<p>this.segmentSizeCheckCount = searchStatsReceiver.getCounter(“segment_size_check_count”);
this.maxSegmentSizeReachedCounter = searchStatsReceiver.getCounter(“max_segment_reached”);</p>
<dl class="simple">
<dt>this.statusStats = searchStatsReceiver.getTimerStats(</dt><dd><p>“index_status”, TimeUnit.MICROSECONDS, false, false, false);</p>
</dd>
<dt>this.updateStats = searchStatsReceiver.getTimerStats(</dt><dd><p>“updates”, TimeUnit.MICROSECONDS, false, false, false);</p>
</dd>
<dt>this.updateRetryStats = searchStatsReceiver.getTimerStats(</dt><dd><p>“update_retries”, TimeUnit.MICROSECONDS, false, false, false);</p>
</dd>
<dt>this.userUpdateIndexingStats = searchStatsReceiver.getTimerStats(</dt><dd><p>“user_updates”, TimeUnit.MICROSECONDS, false, false, false);</p>
</dd>
<dt>this.userScrubGeoIndexingStats = searchStatsReceiver.getTimerStats(</dt><dd><p>“user_scrub_geo”, TimeUnit.MICROSECONDS, false, false, false);</p>
</dd>
<dt>this.updateOnMissingTweetCounter = searchStatsReceiver.getRateCounter(</dt><dd><p>“index_update_on_missing_tweet”);</p>
</dd>
</dl>
<p>this.droppedUpdateEvent = searchStatsReceiver.getRateCounter(“dropped_update_event”);</p>
<dl>
<dt>this.partitionIndexerRunLoopCounter = searchStatsReceiver.getTimerStats(</dt><dd><p>“partition_indexer_run_loop”, TimeUnit.MICROSECONDS, false, true, false);</p>
</dd>
<dt>this.partitionIndexerIndexFromReadersCounter = searchStatsReceiver.getTimerStats(</dt><dd><p>“partition_indexer_indexFromReaders”, TimeUnit.MICROSECONDS, false, true, false);</p>
</dd>
<dt>this.partitionIndexerIterationCounter = searchStatsReceiver.getCounter(</dt><dd><p>ScheduledExecutorManager.SCHEDULED_EXECUTOR_TASK_PREFIX + “PartitionIndexer”);</p>
</dd>
<dt>this.simpleUpdateIndexerUnsortedUpdateCounter = searchStatsReceiver.getCounter(</dt><dd><p>“simple_update_indexer_unsorted_update_count”);</p>
</dd>
<dt>this.simpleUpdateIndexerUnsortedUpdateWithWrongSegmentCounter = searchStatsReceiver.getCounter(</dt><dd><p>“simple_update_indexer_unsorted_update_with_wrong_segment_count”);</p>
</dd>
<dt>this.simpleUserUpdateIndexerIterationCounter = searchStatsReceiver.getCounter(</dt><dd><p>ScheduledExecutorManager.SCHEDULED_EXECUTOR_TASK_PREFIX + “SimpleUserUpdateIndexer”);</p>
</dd>
<dt>this.simpleSegmentIndexerExceptionCounter = searchStatsReceiver.getCounter(</dt><dd><p>“exception_while_indexing_segment”);</p>
</dd>
<dt>for (ThriftIndexingEventType type<span class="classifier">ThriftIndexingEventType.values()) {</span></dt><dd><p>AtomicLong freshness = new AtomicLong(0);
updateFreshness.put(type, freshness);
String statName = (”<a href="#id31"><span class="problematic" id="id32">index_freshness_</span></a>” + type + “_age_millis”).toLowerCase();
searchStatsReceiver.getCustomGauge(statName,</p>
<blockquote>
<div><p>() -&gt; System.currentTimeMillis() - freshness.get());</p>
</div></blockquote>
</dd>
</dl>
<p>}</p>
<p>this.startupInProgress = new StartupMetric(“startup_in_progress”);
this.startupInIndexCompletedSegments = new StartupMetric(“startup_in_index_completed_segments”);
this.startupInLoadCompletedSegments = new StartupMetric(“startup_in_load_completed_segments”);
this.startupInIndexUpdatesForCompletedSegments =</p>
<blockquote>
<div><p>new StartupMetric(“startup_in_index_updates_for_completed_segments”);</p>
</div></blockquote>
<p>this.startupInCurrentSegment = new StartupMetric(“startup_in_current_segment”);
this.startupInUserUpdates = new StartupMetric(“startup_in_user_updates”);
this.startupInQueryCacheUpdates = new StartupMetric(“startup_in_query_cache_updates”);
this.startupInMultiSegmentTermDictionaryUpdates =</p>
<blockquote>
<div><p>new StartupMetric(“startup_in_multi_segment_dictionary_updates”);</p>
</div></blockquote>
<p>this.startupInWarmUp = new StartupMetric(“startup_in_warm_up”);</p>
<p>this.startupInLoadFlushedIndex = new StartupMetric(“startup_in_load_flushed_index”);
this.startupInFreshStartup = new StartupMetric(“startup_in_fresh_startup”);
this.startupInIngestUntilCurrent = new StartupMetric(“startup_in_ingest_until_current”);
this.startupInUserUpdatesStartup = new StartupMetric(“startup_in_user_updates_startup”);
this.startupInUserEventIndexer = new StartupMetric(“startup_in_user_events_indexer”);
this.startupInAudioSpaceEventIndexer =</p>
<blockquote>
<div><p>new StartupMetric(“startup_in_audio_space_events_indexer”);</p>
</div></blockquote>
<dl class="simple">
<dt>searchStatsReceiver.getCustomGauge(“earlybird_index_freshness_millis”,</dt><dd><p>this::getIndexFreshnessInMillis);</p>
</dd>
</dl>
<p>this.searchStatsReceiver = searchStatsReceiver;</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>long getIndexFreshnessInMillis() {</dt><dd><p>return System.currentTimeMillis() - freshestTweetTimeMillis.get();</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../../index.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../../_sources/src/java/com/twitter/search/earlybird/partition/SearchIndexingMetricSet.java.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>