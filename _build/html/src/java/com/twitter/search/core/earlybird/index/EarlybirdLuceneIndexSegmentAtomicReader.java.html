<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../../../" id="documentation_options" src="../../../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>package com.twitter.search.core.earlybird.index;</p>
<p>import java.io.IOException;</p>
<p>import com.google.common.base.Preconditions;</p>
<p>import org.apache.lucene.index.BinaryDocValues;
import org.apache.lucene.index.FieldInfos;
import org.apache.lucene.index.FilterLeafReader;
import org.apache.lucene.index.LeafMetaData;
import org.apache.lucene.index.LeafReader;
import org.apache.lucene.index.NumericDocValues;
import org.apache.lucene.index.PointValues;
import org.apache.lucene.index.PostingsEnum;
import org.apache.lucene.index.SortedDocValues;
import org.apache.lucene.index.SortedNumericDocValues;
import org.apache.lucene.index.SortedSetDocValues;
import org.apache.lucene.index.StoredFieldVisitor;
import org.apache.lucene.index.Term;
import org.apache.lucene.index.Terms;
import org.apache.lucene.index.TermsEnum;
import org.apache.lucene.search.DocIdSetIterator;
import org.apache.lucene.store.Directory;
import org.apache.lucene.util.Bits;
import org.apache.lucene.util.BytesRef;</p>
<p>import com.twitter.search.common.encoding.docvalues.CSFTypeUtil;
import com.twitter.search.common.encoding.features.IntegerEncodedFeatures;
import com.twitter.search.common.schema.base.EarlybirdFieldType;
import com.twitter.search.common.schema.base.FeatureConfiguration;
import com.twitter.search.common.schema.base.Schema.FieldInfo;
import com.twitter.search.core.earlybird.index.column.ColumnStrideFieldDocValues;
import com.twitter.search.core.earlybird.index.column.ColumnStrideFieldIndex;</p>
<dl>
<dt>public final class EarlybirdLuceneIndexSegmentAtomicReader</dt><dd><blockquote>
<div><p>extends EarlybirdIndexSegmentAtomicReader {</p>
</div></blockquote>
<dl>
<dt>private abstract static class DocIdSetIteratorWrapper extends NumericDocValues {</dt><dd><p>private final DocIdSetIterator delegate;</p>
<dl class="simple">
<dt>public DocIdSetIteratorWrapper(DocIdSetIterator delegate) {</dt><dd><p>this.delegate = Preconditions.checkNotNull(delegate);</p>
</dd>
</dl>
<p>}</p>
<p>&#64;Override
public int docID() {</p>
<blockquote>
<div><p>return delegate.docID();</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public int nextDoc() throws IOException {</p>
<blockquote>
<div><p>return delegate.nextDoc();</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public int advance(int target) throws IOException {</p>
<blockquote>
<div><p>return delegate.advance(target);</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public long cost() {</p>
<blockquote>
<div><p>return delegate.cost();</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private static class BytesRefBasedIntegerEncodedFeatures extends IntegerEncodedFeatures {</dt><dd><p>private final BytesRef bytesRef;
private final int numInts;</p>
<dl class="simple">
<dt>public BytesRefBasedIntegerEncodedFeatures(BytesRef bytesRef, int numInts) {</dt><dd><p>this.bytesRef = bytesRef;
this.numInts = numInts;</p>
</dd>
</dl>
<p>}</p>
<p>&#64;Override
public int getInt(int pos) {</p>
<blockquote>
<div><p>return CSFTypeUtil.convertFromBytes(bytesRef.bytes, bytesRef.offset, pos);</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public void setInt(int pos, int value) {</p>
<blockquote>
<div><p>throw new UnsupportedOperationException();</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public int getNumInts() {</p>
<blockquote>
<div><p>return numInts;</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}</p>
<p>private static final int OLDEST_DOC_SKIP_INTERVAL = 256;</p>
<p>private final LeafReader delegate;</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Do not add public constructors to this class. EarlybirdLuceneIndexSegmentAtomicReader instances</p></li>
<li><p>should be created only by calling EarlybirdLuceneIndexSegmentData.createAtomicReader(), to make</p></li>
<li><p>sure everything is set up properly (such as CSF readers).</p></li>
</ul>
<p><a href="#id1"><span class="problematic" id="id2">*</span></a>/</p>
</dd>
<dt>EarlybirdLuceneIndexSegmentAtomicReader(</dt><dd><blockquote>
<div><p>EarlybirdIndexSegmentData segmentData, Directory directory) throws IOException {</p>
</div></blockquote>
<p>super(segmentData);
this.delegate = getDelegateReader(directory);</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private LeafReader getDelegateReader(Directory directory) throws IOException {</dt><dd><dl>
<dt>LeafReader directoryReader =</dt><dd><p>EarlybirdIndexSegmentData.getLeafReaderFromOptimizedDirectory(directory);</p>
</dd>
<dt>return new FilterLeafReader(directoryReader) {</dt><dd><p>&#64;Override
public NumericDocValues getNumericDocValues(String field) throws IOException {</p>
<blockquote>
<div><p>EarlybirdFieldType type = getSchema().getFieldInfo(field).getFieldType();
if ((type == null) || !type.isCsfViewField()) {</p>
<blockquote>
<div><p>return in.getNumericDocValues(field);</p>
</div></blockquote>
<p>}</p>
<p>// Compute as many things as possible once, outside the NumericDocValues.get() call.
String baseFieldName = getSchema().getFieldInfo(type.getCsfViewBaseFieldId()).getName();
FieldInfo baseFieldInfo =</p>
<blockquote>
<div><p>Preconditions.checkNotNull(getSchema().getFieldInfo(baseFieldName));</p>
</div></blockquote>
<p>EarlybirdFieldType baseFieldType = baseFieldInfo.getFieldType();
Preconditions.checkState(!baseFieldType.isCsfVariableLength());
int numInts = baseFieldType.getCsfFixedLengthNumValuesPerDoc();
FeatureConfiguration featureConfiguration =</p>
<blockquote>
<div><p>Preconditions.checkNotNull(type.getCsfViewFeatureConfiguration());</p>
</div></blockquote>
<p>Preconditions.checkArgument(featureConfiguration.getValueIndex() &lt; numInts);</p>
<dl>
<dt>if (numInts == 1) {</dt><dd><p>// All encoded tweet features are encoded in a single integer.
NumericDocValues numericDocValues = in.getNumericDocValues(baseFieldName);
return new DocIdSetIteratorWrapper(numericDocValues) {</p>
<blockquote>
<div><p>&#64;Override
public long longValue() throws IOException {</p>
<blockquote>
<div><dl class="simple">
<dt>return (numericDocValues.longValue() &amp; featureConfiguration.getBitMask())</dt><dd><p>&gt;&gt; featureConfiguration.getBitStartPosition();</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public boolean advanceExact(int target) throws IOException {</p>
<blockquote>
<div><p>return numericDocValues.advanceExact(target);</p>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>};</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>BinaryDocValues binaryDocValues =</dt><dd><p>Preconditions.checkNotNull(in.getBinaryDocValues(baseFieldName));</p>
</dd>
<dt>return new DocIdSetIteratorWrapper(binaryDocValues) {</dt><dd><p>&#64;Override
public long longValue() throws IOException {</p>
<blockquote>
<div><p>BytesRef data = binaryDocValues.binaryValue();
IntegerEncodedFeatures encodedFeatures =</p>
<blockquote>
<div><p>new BytesRefBasedIntegerEncodedFeatures(data, numInts);</p>
</div></blockquote>
<p>return encodedFeatures.getFeatureValue(featureConfiguration);</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public boolean advanceExact(int target) throws IOException {</p>
<blockquote>
<div><p>return binaryDocValues.advanceExact(target);</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>};</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public CacheHelper getCoreCacheHelper() {</p>
<blockquote>
<div><p>return in.getCoreCacheHelper();</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public CacheHelper getReaderCacheHelper() {</p>
<blockquote>
<div><p>return in.getReaderCacheHelper();</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>};</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private TermsEnum getTermsEnumAtTerm(Term term) throws IOException {</dt><dd><p>Terms terms = terms(term.field());
if (terms == null) {</p>
<blockquote>
<div><p>return null;</p>
</div></blockquote>
<p>}</p>
<p>TermsEnum termsEnum = terms.iterator();
return termsEnum.seekExact(term.bytes()) ? termsEnum : null;</p>
</dd>
</dl>
<p>}</p>
<p>&#64;Override
public int getOldestDocID(Term term) throws IOException {</p>
<blockquote>
<div><p>TermsEnum termsEnum = getTermsEnumAtTerm(term);
if (termsEnum == null) {</p>
<blockquote>
<div><p>return EarlybirdIndexSegmentAtomicReader.TERM_NOT_FOUND;</p>
</div></blockquote>
<p>}</p>
<p>PostingsEnum td = termsEnum.postings(null);
int oldestDocID = td.nextDoc();
if (oldestDocID == DocIdSetIterator.NO_MORE_DOCS) {</p>
<blockquote>
<div><p>return EarlybirdIndexSegmentAtomicReader.TERM_NOT_FOUND;</p>
</div></blockquote>
<p>}</p>
<p>final int docFreq = termsEnum.docFreq();
if (docFreq &gt; OLDEST_DOC_SKIP_INTERVAL * 16) {</p>
<blockquote>
<div><p>final int skipSize = docFreq / OLDEST_DOC_SKIP_INTERVAL;
do {</p>
<blockquote>
<div><p>oldestDocID = td.docID();</p>
</div></blockquote>
<p>} while (td.advance(oldestDocID + skipSize) != DocIdSetIterator.NO_MORE_DOCS);</p>
<p>td = delegate.postings(term);
td.advance(oldestDocID);</p>
</div></blockquote>
<p>}</p>
<dl class="simple">
<dt>do {</dt><dd><p>oldestDocID = td.docID();</p>
</dd>
</dl>
<p>} while (td.nextDoc() != DocIdSetIterator.NO_MORE_DOCS);</p>
<p>return oldestDocID;</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public int getTermID(Term term) throws IOException {</p>
<blockquote>
<div><p>TermsEnum termsEnum = getTermsEnumAtTerm(term);
return termsEnum != null</p>
<blockquote>
<div><p>? (int) termsEnum.ord()
: EarlybirdIndexSegmentAtomicReader.TERM_NOT_FOUND;</p>
</div></blockquote>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public Terms terms(String field) throws IOException {</p>
<blockquote>
<div><p>return delegate.terms(field);</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public FieldInfos getFieldInfos() {</p>
<blockquote>
<div><p>return delegate.getFieldInfos();</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public Bits getLiveDocs() {</p>
<blockquote>
<div><p>return getDeletesView().getLiveDocs();</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public int numDocs() {</p>
<blockquote>
<div><p>return delegate.numDocs();</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public int maxDoc() {</p>
<blockquote>
<div><p>return delegate.maxDoc();</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public void document(int docID, StoredFieldVisitor visitor) throws IOException {</p>
<blockquote>
<div><p>delegate.document(docID, visitor);</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public boolean hasDeletions() {</p>
<blockquote>
<div><p>return getDeletesView().hasDeletions();</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
protected void doClose() throws IOException {</p>
<blockquote>
<div><p>delegate.close();</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public NumericDocValues getNumericDocValues(String field) throws IOException {</p>
<blockquote>
<div><p>FieldInfo fieldInfo = getSegmentData().getSchema().getFieldInfo(field);
if (fieldInfo == null) {</p>
<blockquote>
<div><p>return null;</p>
</div></blockquote>
<p>}</p>
<p>// If this field is a CSF view field or if it’s not loaded in memory, get the NumericDocValues
// from the delegate.
EarlybirdFieldType fieldType = fieldInfo.getFieldType();
if (fieldType.isCsfViewField() || !fieldInfo.getFieldType().isCsfLoadIntoRam()) {</p>
<blockquote>
<div><p>NumericDocValues delegateVals = delegate.getNumericDocValues(field);
if (delegateVals != null) {</p>
<blockquote>
<div><p>return delegateVals;</p>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>}</p>
<p>// The field is either loaded in memory, or the delegate doesn’t have NumericDocValues for it.
// Return the NumericDocValues for this field stored in the DocValuesManager.
ColumnStrideFieldIndex csf =</p>
<blockquote>
<div><p>getSegmentData().getDocValuesManager().getColumnStrideFieldIndex(field);</p>
</div></blockquote>
<p>return csf != null ? new ColumnStrideFieldDocValues(csf, this) : null;</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public BinaryDocValues getBinaryDocValues(String field) throws IOException {</p>
<blockquote>
<div><p>return delegate.getBinaryDocValues(field);</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public SortedDocValues getSortedDocValues(String field) throws IOException {</p>
<blockquote>
<div><p>return delegate.getSortedDocValues(field);</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public SortedSetDocValues getSortedSetDocValues(String field) throws IOException {</p>
<blockquote>
<div><p>return delegate.getSortedSetDocValues(field);</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public NumericDocValues getNormValues(String field) throws IOException {</p>
<blockquote>
<div><p>return delegate.getNormValues(field);</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public SortedNumericDocValues getSortedNumericDocValues(String field) throws IOException {</p>
<blockquote>
<div><p>return delegate.getSortedNumericDocValues(field);</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public void checkIntegrity() throws IOException {</p>
<blockquote>
<div><p>delegate.checkIntegrity();</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public PointValues getPointValues(String field) throws IOException {</p>
<blockquote>
<div><p>return delegate.getPointValues(field);</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public LeafMetaData getMetaData() {</p>
<blockquote>
<div><p>return delegate.getMetaData();</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public CacheHelper getCoreCacheHelper() {</p>
<blockquote>
<div><p>return delegate.getCoreCacheHelper();</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public CacheHelper getReaderCacheHelper() {</p>
<blockquote>
<div><p>return delegate.getReaderCacheHelper();</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}</p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../../../index.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../../../_sources/src/java/com/twitter/search/core/earlybird/index/EarlybirdLuceneIndexSegmentAtomicReader.java.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>