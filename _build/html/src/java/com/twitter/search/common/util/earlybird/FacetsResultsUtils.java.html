<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../../../" id="documentation_options" src="../../../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>package com.twitter.search.common.util.earlybird;</p>
<p>import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;</p>
<p>import com.google.common.collect.Lists;</p>
<p>import org.slf4j.Logger;
import org.slf4j.LoggerFactory;</p>
<p>import com.twitter.search.common.constants.thriftjava.ThriftLanguage;
import com.twitter.search.common.logging.DebugMessageBuilder;
import com.twitter.search.common.ranking.thriftjava.ThriftFacetFinalSortOrder;
import com.twitter.search.common.schema.earlybird.EarlybirdFieldConstants.EarlybirdFieldConstant;
import com.twitter.search.earlybird.thrift.EarlybirdResponse;
import com.twitter.search.earlybird.thrift.ThriftFacetCount;
import com.twitter.search.earlybird.thrift.ThriftFacetCountMetadata;
import com.twitter.search.earlybird.thrift.ThriftFacetFieldRequest;
import com.twitter.search.earlybird.thrift.ThriftFacetFieldResults;
import com.twitter.search.earlybird.thrift.ThriftFacetRankingMode;
import com.twitter.search.earlybird.thrift.ThriftFacetRequest;
import com.twitter.search.earlybird.thrift.ThriftFacetResults;
import com.twitter.search.earlybird.thrift.ThriftTermResults;</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>A utility class to provide some functions for facets results processing.</p></li>
</ul>
<p><a href="#id1"><span class="problematic" id="id2">*</span></a>/</p>
</dd>
</dl>
<p>public final class FacetsResultsUtils {</p>
<blockquote>
<div><p>private static final Logger LOG = LoggerFactory.getLogger(FacetsResultsUtils.class);</p>
<p>private FacetsResultsUtils() {
}</p>
<dl class="simple">
<dt>public static class FacetFieldInfo {</dt><dd><p>public ThriftFacetFieldRequest fieldRequest;
public int totalCounts;
public Map&lt;String, ThriftFacetCount&gt; topFacets;
public List&lt;Map.Entry&lt;ThriftLanguage, Double&gt;&gt; languageHistogramEntries = Lists.newLinkedList();</p>
</dd>
</dl>
<p>}</p>
<p>// Only return top languages in the language histogram which sum up to at least this much
// ratio, here we get first 80 percentiles.
public static final double MIN_PERCENTAGE_SUM_REQUIRED = 0.8;
// if a language ratio is over this number, we already return.
public static final double MIN_PERCENTAGE = 0.01;</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Prepare facet fields with empty entries and check if we need termStats for filtering.</p></li>
<li><p>Returns true if termStats filtering is needed (thus the termStats servie call).</p></li>
<li><p>&#64;param facetRequest The related facet request.</p></li>
<li><p>&#64;param facetFieldInfoMap The facet field info map to fill, a map from facet type to the facet</p></li>
<li><p>fiels results info.</p></li>
<li><p>&#64;return <a class="reference external" href="mailto:{&#37;&#52;&#48;code">{<span>&#64;</span>code</a> true} if termstats request is needed afterwards.</p></li>
</ul>
<p><a href="#id3"><span class="problematic" id="id4">*</span></a>/</p>
</dd>
<dt>public static boolean prepareFieldInfoMap(</dt><dd><blockquote>
<div><p>ThriftFacetRequest facetRequest,
final Map&lt;String, FacetsResultsUtils.FacetFieldInfo&gt; facetFieldInfoMap) {</p>
</div></blockquote>
<p>boolean termStatsFilteringMode = false;</p>
<dl>
<dt>for (ThriftFacetFieldRequest fieldRequest<span class="classifier">facetRequest.getFacetFields()) {</span></dt><dd><p>FacetsResultsUtils.FacetFieldInfo info = new FacetsResultsUtils.FacetFieldInfo();
info.fieldRequest = fieldRequest;
facetFieldInfoMap.put(fieldRequest.getFieldName(), info);
if (fieldRequest.getRankingMode() == ThriftFacetRankingMode.FILTER_WITH_TERM_STATISTICS) {</p>
<blockquote>
<div><p>termStatsFilteringMode = true;</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}</p>
<p>return termStatsFilteringMode;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Extract information from one ThriftFacetResults into facetFieldInfoMap and userIDWhitelist.</p></li>
<li><p>&#64;param facetResults Related facets results.</p></li>
<li><p>&#64;param facetFieldInfoMap The facets field info map to fill, a map from facet type to the facet</p></li>
<li><p>fiels results info.</p></li>
<li><p>&#64;param userIDWhitelist The user whitelist to fill.</p></li>
</ul>
<p><a href="#id5"><span class="problematic" id="id6">*</span></a>/</p>
</dd>
<dt>public static void fillFacetFieldInfo(</dt><dd><blockquote>
<div><p>final ThriftFacetResults facetResults,
final Map&lt;String, FacetsResultsUtils.FacetFieldInfo&gt; facetFieldInfoMap,
final Set&lt;Long&gt; userIDWhitelist) {</p>
</div></blockquote>
<dl>
<dt>for (String facetField<span class="classifier">facetResults.getFacetFields().keySet()) {</span></dt><dd><p>FacetsResultsUtils.FacetFieldInfo info = facetFieldInfoMap.get(facetField);
if (info.topFacets == null) {</p>
<blockquote>
<div><p>info.topFacets = new HashMap&lt;&gt;();</p>
</div></blockquote>
<p>}</p>
<p>ThriftFacetFieldResults results = facetResults.getFacetFields().get(facetField);
if (results.isSetLanguageHistogram()) {</p>
<blockquote>
<div><p>info.languageHistogramEntries.addAll(results.getLanguageHistogram().entrySet());</p>
</div></blockquote>
<p>}
for (ThriftFacetCount newCount : results.getTopFacets()) {</p>
<blockquote>
<div><p>ThriftFacetCount resultCount = info.topFacets.get(newCount.facetLabel);
if (resultCount == null) {</p>
<blockquote>
<div><p>info.topFacets.put(newCount.facetLabel, new ThriftFacetCount(newCount));</p>
</div></blockquote>
<dl>
<dt>} else {</dt><dd><p>resultCount.setFacetCount(resultCount.facetCount + newCount.facetCount);
resultCount.setSimpleCount(resultCount.simpleCount + newCount.simpleCount);
resultCount.setWeightedCount(resultCount.weightedCount + newCount.weightedCount);
resultCount.setPenaltyCount(resultCount.penaltyCount + newCount.penaltyCount);
//  this could pass the old metadata object back or a new merged one.
resultCount.setMetadata(</p>
<blockquote>
<div><dl class="simple">
<dt>mergeFacetMetadata(resultCount.getMetadata(), newCount.getMetadata(),</dt><dd><p>userIDWhitelist));</p>
</dd>
</dl>
</div></blockquote>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}
info.totalCounts += results.totalCount;</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Merge a metadata into an existing one.</p></li>
<li><p>&#64;param baseMetadata the metadata to merge into.</p></li>
<li><p>&#64;param metadataUpdate the new metadata to merge.</p></li>
<li><p>&#64;param userIDWhitelist user id whitelist to filter user id with.</p></li>
<li><p>&#64;return The updated metadata.</p></li>
</ul>
<p><a href="#id7"><span class="problematic" id="id8">*</span></a>/</p>
</dd>
<dt>public static ThriftFacetCountMetadata mergeFacetMetadata(</dt><dd><blockquote>
<div><p>final ThriftFacetCountMetadata baseMetadata,
final ThriftFacetCountMetadata metadataUpdate,
final Set&lt;Long&gt; userIDWhitelist) {</p>
</div></blockquote>
<p>ThriftFacetCountMetadata mergedMetadata = baseMetadata;
if (metadataUpdate != null) {</p>
<blockquote>
<div><p>String mergedExplanation = null;
if (mergedMetadata != null) {</p>
<blockquote>
<div><dl class="simple">
<dt>if (mergedMetadata.maxTweepCred &lt; metadataUpdate.maxTweepCred) {</dt><dd><p>mergedMetadata.setMaxTweepCred(metadataUpdate.maxTweepCred);</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>if (mergedMetadata.isSetExplanation()) {</dt><dd><p>mergedExplanation = mergedMetadata.getExplanation();
if (metadataUpdate.isSetExplanation()) {</p>
<blockquote>
<div><p>mergedExplanation += “n” + metadataUpdate.getExplanation();</p>
</div></blockquote>
<p>}</p>
</dd>
<dt>} else if (metadataUpdate.isSetExplanation()) {</dt><dd><p>mergedExplanation = metadataUpdate.getExplanation();</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>if (mergedMetadata.getStatusId() == -1) {</dt><dd><dl class="simple">
<dt>if (LOG.isDebugEnabled()) {</dt><dd><p>LOG.debug(“status id in facet count metadata is -1: “ + mergedMetadata);</p>
</dd>
</dl>
<p>}
mergedMetadata = metadataUpdate;</p>
</dd>
<dt>} else if (metadataUpdate.getStatusId() != -1</dt><dd><blockquote>
<div><p>&amp;&amp; metadataUpdate.getStatusId() &lt; mergedMetadata.getStatusId()) {</p>
</div></blockquote>
<p>// keep the oldest tweet, ie. the lowest status ID
mergedMetadata = metadataUpdate;</p>
</dd>
<dt>} else if (metadataUpdate.getStatusId() == mergedMetadata.getStatusId()) {</dt><dd><dl class="simple">
<dt>if (mergedMetadata.getTwitterUserId() == -1) {</dt><dd><p>// in this case we didn’t find the user in a previous partition yet
// only update the user if the status id matches
mergedMetadata.setTwitterUserId(metadataUpdate.getTwitterUserId());
mergedMetadata.setDontFilterUser(metadataUpdate.isDontFilterUser());</p>
</dd>
</dl>
<p>}
if (!mergedMetadata.isSetStatusLanguage()) {</p>
<blockquote>
<div><p>mergedMetadata.setStatusLanguage(metadataUpdate.getStatusLanguage());</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}
if (!mergedMetadata.isSetNativePhotoUrl() &amp;&amp; metadataUpdate.isSetNativePhotoUrl()) {</p>
<blockquote>
<div><p>mergedMetadata.setNativePhotoUrl(metadataUpdate.getNativePhotoUrl());</p>
</div></blockquote>
<p>}</p>
</div></blockquote>
<dl class="simple">
<dt>} else {</dt><dd><p>mergedMetadata = metadataUpdate;</p>
</dd>
</dl>
<p>}</p>
<p>// this will not set an explanation if neither oldMetadata nor metadataUpdate
// had an explanation
if (mergedExplanation != null) {</p>
<blockquote>
<div><p>mergedMetadata.setExplanation(mergedExplanation);</p>
</div></blockquote>
<p>}</p>
<dl>
<dt>if (userIDWhitelist != null) {</dt><dd><p>// result must not be null now because of the if above
if (mergedMetadata.getTwitterUserId() != -1 &amp;&amp; !mergedMetadata.isDontFilterUser()) {</p>
<blockquote>
<div><dl class="simple">
<dt>mergedMetadata.setDontFilterUser(</dt><dd><p>userIDWhitelist.contains(mergedMetadata.getTwitterUserId()));</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}</p>
<p>return mergedMetadata;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Appends all twimg results to the image results. Optionally resorts the image results if</p></li>
<li><p>a comparator is passed in.</p></li>
<li><p>Also computes the sums of totalCount, totalScore, totalPenalty.</p></li>
</ul>
<p><a href="#id9"><span class="problematic" id="id10">*</span></a>/</p>
</dd>
<dt>public static void mergeTwimgResults(ThriftFacetResults facetResults,</dt><dd><blockquote>
<div><p>Comparator&lt;ThriftFacetCount&gt; optionalSortComparator) {</p>
</div></blockquote>
<dl class="simple">
<dt>if (facetResults == null || !facetResults.isSetFacetFields()) {</dt><dd><p>return;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>ThriftFacetFieldResults imageResults =</dt><dd><p>facetResults.getFacetFields().get(EarlybirdFieldConstant.IMAGES_FACET);</p>
</dd>
<dt>ThriftFacetFieldResults twimgResults =</dt><dd><p>facetResults.getFacetFields().remove(EarlybirdFieldConstant.TWIMG_FACET);</p>
</dd>
<dt>if (imageResults == null) {</dt><dd><dl class="simple">
<dt>if (twimgResults != null) {</dt><dd><p>facetResults.getFacetFields().put(EarlybirdFieldConstant.IMAGES_FACET, twimgResults);</p>
</dd>
</dl>
<p>}
return;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>if (twimgResults != null) {</dt><dd><p>imageResults.setTotalCount(imageResults.getTotalCount() + twimgResults.getTotalCount());
imageResults.setTotalPenalty(imageResults.getTotalPenalty() + twimgResults.getTotalPenalty());
imageResults.setTotalScore(imageResults.getTotalScore() + twimgResults.getTotalScore());
for (ThriftFacetCount count : twimgResults.getTopFacets()) {</p>
<blockquote>
<div><p>imageResults.addToTopFacets(count);</p>
</div></blockquote>
<p>}
if (optionalSortComparator != null) {</p>
<blockquote>
<div><p>Collections.sort(imageResults.topFacets, optionalSortComparator);</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Dedup twimg facets.</p></li>
<li></li>
<li><p>Twimg facet uses the status ID as the facet label, instead of the twimg URL, a.k.a.</p></li>
<li><p>native photo URL. It is possible to have the same twimg URL appearing in two different</p></li>
<li><p>facet label (RT style retweet? copy &amp; paste the twimg URL?). Therefore, to dedup twimg</p></li>
<li><p>facet correctly, we need to look at ThriftFacetCount.metadata.nativePhotoUrl</p></li>
<li></li>
<li><p>&#64;param dedupSet A set holding the native URLs from the twimg facetFieldResults. By having</p></li>
<li><p>the caller passing in the set, it allows the caller to dedup the facet</p></li>
<li><p>across different ThriftFacetFieldResults.</p></li>
<li><p>&#64;param facetFieldResults The twimg facet field results to be debupped</p></li>
<li><p>&#64;param debugMessageBuilder</p></li>
</ul>
<p><a href="#id11"><span class="problematic" id="id12">*</span></a>/</p>
</dd>
<dt>public static void dedupTwimgFacet(Set&lt;String&gt; dedupSet,</dt><dd><blockquote>
<div><p>ThriftFacetFieldResults facetFieldResults,
DebugMessageBuilder debugMessageBuilder) {</p>
</div></blockquote>
<dl class="simple">
<dt>if (facetFieldResults == null || facetFieldResults.getTopFacets() == null) {</dt><dd><p>return;</p>
</dd>
</dl>
<p>}</p>
<p>Iterator&lt;ThriftFacetCount&gt; iterator = facetFieldResults.getTopFacetsIterator();</p>
<dl>
<dt>while (iterator.hasNext()) {</dt><dd><p>ThriftFacetCount count = iterator.next();
if (count.isSetMetadata() &amp;&amp; count.getMetadata().isSetNativePhotoUrl()) {</p>
<blockquote>
<div><p>String nativeUrl = count.getMetadata().getNativePhotoUrl();</p>
<dl class="simple">
<dt>if (dedupSet.contains(nativeUrl)) {</dt><dd><p>iterator.remove();
debugMessageBuilder.detailed(“dedupTwimgFacet removed %s”, nativeUrl);</p>
</dd>
<dt>} else {</dt><dd><p>dedupSet.add(nativeUrl);</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private static final class LanguageCount {</dt><dd><p>private final ThriftLanguage lang;
private final double count;
private LanguageCount(ThriftLanguage lang, double count) {</p>
<blockquote>
<div><p>this.lang = lang;
this.count = count;</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Calculate the top languages and store them in the results.</p></li>
</ul>
<p><a href="#id13"><span class="problematic" id="id14">*</span></a>/</p>
</dd>
<dt>public static void fillTopLanguages(FacetsResultsUtils.FacetFieldInfo info,</dt><dd><blockquote>
<div><p>final ThriftFacetFieldResults results) {</p>
</div></blockquote>
<p>double sumForLanguage = 0.0;
double[] sums = new double[ThriftLanguage.values().length];
for (Map.Entry&lt;ThriftLanguage, Double&gt; entry : info.languageHistogramEntries) {</p>
<blockquote>
<div><p>sumForLanguage += entry.getValue();
if (entry.getKey() == null) {</p>
<blockquote>
<div><p>// EB might be setting null key for unknown language. SEARCH-1294
continue;</p>
</div></blockquote>
<p>}
sums[entry.getKey().getValue()] += entry.getValue();</p>
</div></blockquote>
<p>}
if (sumForLanguage == 0.0) {</p>
<blockquote>
<div><p>return;</p>
</div></blockquote>
<p>}
List&lt;LanguageCount&gt; langCounts = new ArrayList&lt;&gt;(ThriftLanguage.values().length);
for (int i = 0; i &lt; sums.length; i++) {</p>
<blockquote>
<div><dl class="simple">
<dt>if (sums[i] &gt; 0.0) {</dt><dd><p>// ThriftLanguage.findByValue() might return null, which should fall back to UNKNOWN.
ThriftLanguage lang = ThriftLanguage.findByValue(i);
lang = lang == null ? ThriftLanguage.UNKNOWN : lang;
langCounts.add(new LanguageCount(lang, sums[i]));</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}
Collections.sort(langCounts, (left, right) -&gt; Double.compare(right.count, left.count));
double percentageSum = 0.0;
Map&lt;ThriftLanguage, Double&gt; languageHistogramMap =</p>
<blockquote>
<div><p>new HashMap&lt;&gt;(langCounts.size());</p>
</div></blockquote>
<p>int numAdded = 0;
for (LanguageCount langCount : langCounts) {</p>
<blockquote>
<div><dl class="simple">
<dt>if (langCount.count == 0.0) {</dt><dd><p>break;</p>
</dd>
</dl>
<p>}
double percentage = langCount.count / sumForLanguage;
if (percentageSum &gt; MIN_PERCENTAGE_SUM_REQUIRED</p>
<blockquote>
<div><blockquote>
<div><p>&amp;&amp; percentage &lt; MIN_PERCENTAGE &amp;&amp; numAdded &gt;= 3) {</p>
</div></blockquote>
<p>break;</p>
</div></blockquote>
<p>}
languageHistogramMap.put(langCount.lang, percentage);
percentageSum += percentage;
numAdded++;</p>
</div></blockquote>
<p>}
results.setLanguageHistogram(languageHistogramMap);</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Replace “p.twimg.com/” part of the native photo (twimg) URL with “pbs.twimg.com/media/”.</p></li>
<li><p>We need to do this because of blobstore and it’s suppose to be a temporary measure. This</p></li>
<li><p>code should be removed once we verified that all native photo URL being sent to Search</p></li>
<li><p>are prefixed with “pbs.twimg.com/media/” and no native photo URL in our index contains</p></li>
<li><p>“p.twimg.com/”</p></li>
<li></li>
<li><p>Please see SEARCH-783 and EVENTS-539 for more details.</p></li>
<li></li>
<li><p>&#64;param response response containing the facet results</p></li>
</ul>
<p><a href="#id15"><span class="problematic" id="id16">*</span></a>/</p>
</dd>
<dt>public static void fixNativePhotoUrl(EarlybirdResponse response) {</dt><dd><dl>
<dt>if (response == null</dt><dd><blockquote>
<div><p>|| !response.isSetFacetResults()
|| !response.getFacetResults().isSetFacetFields()) {</p>
</div></blockquote>
<p>return;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>for (Map.Entry&lt;String, ThriftFacetFieldResults&gt; facetMapEntry</dt><dd><blockquote>
<div><p>: response.getFacetResults().getFacetFields().entrySet()) {</p>
</div></blockquote>
<p>final String facetResultField = facetMapEntry.getKey();</p>
<dl>
<dt>if (EarlybirdFieldConstant.TWIMG_FACET.equals(facetResultField)</dt><dd><blockquote>
<div><p>|| EarlybirdFieldConstant.IMAGES_FACET.equals(facetResultField)) {</p>
</div></blockquote>
<p>ThriftFacetFieldResults facetFieldResults = facetMapEntry.getValue();
for (ThriftFacetCount facetCount : facetFieldResults.getTopFacets()) {</p>
<blockquote>
<div><p>replacePhotoUrl(facetCount.getMetadata());</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Replace “p.twimg.com/” part of the native photo (twimg) URL with “pbs.twimg.com/media/”.</p></li>
<li><p>We need to do this because of blobstore and it’s suppose to be a temporary measure. This</p></li>
<li><p>code should be removed once we verified that all native photo URL being sent to Search</p></li>
<li><p>are prefixed with “pbs.twimg.com/media/” and no native photo URL in our index contains</p></li>
<li><p>“p.twimg.com/”</p></li>
<li></li>
<li><p>Please see SEARCH-783 and EVENTS-539 for more details.</p></li>
<li></li>
<li><p>&#64;param termResultsCollection collection of ThriftTermResults containing the native photo URL</p></li>
</ul>
<p><a href="#id17"><span class="problematic" id="id18">*</span></a>/</p>
</dd>
<dt>public static void fixNativePhotoUrl(Collection&lt;ThriftTermResults&gt; termResultsCollection) {</dt><dd><dl class="simple">
<dt>if (termResultsCollection == null) {</dt><dd><p>return;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>for (ThriftTermResults termResults<span class="classifier">termResultsCollection) {</span></dt><dd><dl class="simple">
<dt>if (!termResults.isSetMetadata()) {</dt><dd><p>continue;</p>
</dd>
</dl>
<p>}
replacePhotoUrl(termResults.getMetadata());</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Helper function for fixNativePhotoUrl()</p></li>
</ul>
<p><a href="#id19"><span class="problematic" id="id20">*</span></a>/</p>
</dd>
<dt>private static void replacePhotoUrl(ThriftFacetCountMetadata metadata) {</dt><dd><dl>
<dt>if (metadata != null</dt><dd><blockquote>
<div><p>&amp;&amp; metadata.isSetNativePhotoUrl()) {</p>
</div></blockquote>
<p>String nativePhotoUrl = metadata.getNativePhotoUrl();
nativePhotoUrl = nativePhotoUrl.replace(“://p.twimg.com/”, “://pbs.twimg.com/media/”);
metadata.setNativePhotoUrl(nativePhotoUrl);</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Deepcopy of an EarlybirdResponse without explanation</p></li>
</ul>
<p><a href="#id21"><span class="problematic" id="id22">*</span></a>/</p>
</dd>
<dt>public static EarlybirdResponse deepCopyWithoutExplanation(EarlybirdResponse facetsResponse) {</dt><dd><dl>
<dt>if (facetsResponse == null) {</dt><dd><p>return null;</p>
</dd>
<dt>} else if (!facetsResponse.isSetFacetResults()</dt><dd><blockquote>
<div><p>|| facetsResponse.getFacetResults().getFacetFieldsSize() == 0) {</p>
</div></blockquote>
<p>return facetsResponse.deepCopy();</p>
</dd>
</dl>
<p>}
EarlybirdResponse copy = facetsResponse.deepCopy();
for (Map.Entry&lt;String, ThriftFacetFieldResults&gt; entry</p>
<blockquote>
<div><blockquote>
<div><p>: copy.getFacetResults().getFacetFields().entrySet()) {</p>
</div></blockquote>
<dl>
<dt>if (entry.getValue().getTopFacetsSize() &gt; 0) {</dt><dd><dl class="simple">
<dt>for (ThriftFacetCount fc<span class="classifier">entry.getValue().getTopFacets()) {</span></dt><dd><p>fc.getMetadata().unsetExplanation();</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}
return copy;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Returns a comparator used to compare facet counts by calling</p></li>
<li><p>getFacetCountComparator(ThriftFacetFinalSortOrder).  The sort order is determined by</p></li>
<li><p>the facetRankingOptions on the facet request.</p></li>
</ul>
<p><a href="#id23"><span class="problematic" id="id24">*</span></a>/</p>
</dd>
<dt>public static Comparator&lt;ThriftFacetCount&gt; getFacetCountComparator(</dt><dd><blockquote>
<div><p>ThriftFacetRequest facetRequest) {</p>
</div></blockquote>
<p>ThriftFacetFinalSortOrder sortOrder = ThriftFacetFinalSortOrder.SCORE;</p>
<dl>
<dt>if (facetRequest.isSetFacetRankingOptions()</dt><dd><blockquote>
<div><p>&amp;&amp; facetRequest.getFacetRankingOptions().isSetFinalSortOrder()) {</p>
</div></blockquote>
<p>sortOrder = facetRequest.getFacetRankingOptions().getFinalSortOrder();</p>
</dd>
</dl>
<p>}</p>
<p>return getFacetCountComparator(sortOrder);</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Returns a comparator using the specified order.</p></li>
</ul>
<p><a href="#id25"><span class="problematic" id="id26">*</span></a>/</p>
</dd>
<dt>public static Comparator&lt;ThriftFacetCount&gt; getFacetCountComparator(</dt><dd><blockquote>
<div><p>ThriftFacetFinalSortOrder sortOrder) {</p>
</div></blockquote>
<dl class="simple">
<dt>switch (sortOrder) {</dt><dd><p>case SIMPLE_COUNT:   return SIMPLE_COUNT_COMPARATOR;
case SCORE:          return SCORE_COMPARATOR;
case CREATED_AT:     return CREATED_AT_COMPARATOR;
case WEIGHTED_COUNT: return WEIGHTED_COUNT_COMPARATOR;
default:             return SCORE_COMPARATOR;</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private static final Comparator&lt;ThriftFacetCount&gt; SIMPLE_COUNT_COMPARATOR =</dt><dd><dl>
<dt>(count1, count2) -&gt; {</dt><dd><dl class="simple">
<dt>if (count1.simpleCount &gt; count2.simpleCount) {</dt><dd><p>return 1;</p>
</dd>
<dt>} else if (count1.simpleCount &lt; count2.simpleCount) {</dt><dd><p>return -1;</p>
</dd>
</dl>
<p>}</p>
<p>return count1.facetLabel.compareTo(count2.facetLabel);</p>
</dd>
</dl>
<p>};</p>
</dd>
<dt>private static final Comparator&lt;ThriftFacetCount&gt; WEIGHTED_COUNT_COMPARATOR =</dt><dd><dl>
<dt>(count1, count2) -&gt; {</dt><dd><dl class="simple">
<dt>if (count1.weightedCount &gt; count2.weightedCount) {</dt><dd><p>return 1;</p>
</dd>
<dt>} else if (count1.weightedCount &lt; count2.weightedCount) {</dt><dd><p>return -1;</p>
</dd>
</dl>
<p>}</p>
<p>return SIMPLE_COUNT_COMPARATOR.compare(count1, count2);</p>
</dd>
</dl>
<p>};</p>
</dd>
<dt>private static final Comparator&lt;ThriftFacetCount&gt; SCORE_COMPARATOR =</dt><dd><dl>
<dt>(count1, count2) -&gt; {</dt><dd><dl class="simple">
<dt>if (count1.score &gt; count2.score) {</dt><dd><p>return 1;</p>
</dd>
<dt>} else if (count1.score &lt; count2.score) {</dt><dd><p>return -1;</p>
</dd>
</dl>
<p>}
return SIMPLE_COUNT_COMPARATOR.compare(count1, count2);</p>
</dd>
</dl>
<p>};</p>
</dd>
<dt>private static final Comparator&lt;ThriftFacetCount&gt; CREATED_AT_COMPARATOR =</dt><dd><dl>
<dt>(count1, count2) -&gt; {</dt><dd><dl>
<dt>if (count1.isSetMetadata() &amp;&amp; count1.getMetadata().isSetCreated_at()</dt><dd><blockquote>
<div><p>&amp;&amp; count2.isSetMetadata() &amp;&amp; count2.getMetadata().isSetCreated_at()) {</p>
</div></blockquote>
<p>// more recent items have higher created_at values
if (count1.getMetadata().getCreated_at() &gt; count2.getMetadata().getCreated_at()) {</p>
<blockquote>
<div><p>return 1;</p>
</div></blockquote>
<dl class="simple">
<dt>} else if (count1.getMetadata().getCreated_at() &lt; count2.getMetadata().getCreated_at()) {</dt><dd><p>return -1;</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<p>return SCORE_COMPARATOR.compare(count1, count2);</p>
</dd>
</dl>
<p>};</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../../../index2.rst.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../../../index2.rst.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../../../_sources/src/java/com/twitter/search/common/util/earlybird/FacetsResultsUtils.java.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>