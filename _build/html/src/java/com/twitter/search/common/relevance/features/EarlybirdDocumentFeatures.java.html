<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../../../" id="documentation_options" src="../../../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>package com.twitter.search.common.relevance.features;</p>
<p>import java.io.IOException;
import java.util.Map;
import java.util.function.Function;</p>
<p>import com.google.common.base.Preconditions;
import com.google.common.collect.Maps;</p>
<p>import org.apache.lucene.index.LeafReader;
import org.apache.lucene.index.NumericDocValues;</p>
<p>import com.twitter.search.common.features.thrift.ThriftSearchResultFeatures;
import com.twitter.search.common.metrics.SearchCounter;
import com.twitter.search.common.schema.base.FeatureConfiguration;
import com.twitter.search.common.schema.base.ImmutableSchemaInterface;
import com.twitter.search.common.schema.earlybird.EarlybirdFieldConstants;
import com.twitter.search.common.schema.earlybird.EarlybirdFieldConstants.EarlybirdFieldConstant;
import com.twitter.search.common.schema.thriftjava.ThriftCSFType;
import com.twitter.search.common.schema.thriftjava.ThriftFeatureNormalizationType;</p>
<dl>
<dt>public class EarlybirdDocumentFeatures {</dt><dd><p>private static final Map&lt;Integer, SearchCounter&gt; FEATURE_CONFIG_IS_NULL_MAP = Maps.newHashMap();
private static final Map&lt;Integer, SearchCounter&gt; FEATURE_OUTPUT_TYPE_IS_NULL_MAP =</p>
<blockquote>
<div><p>Maps.newHashMap();</p>
</div></blockquote>
<dl class="simple">
<dt>private static final Map&lt;Integer, SearchCounter&gt; NO_SCHEMA_FIELD_FOR_FEATURE_MAP =</dt><dd><p>Maps.newHashMap();</p>
</dd>
<dt>private static final String FEATURE_CONFIG_IS_NULL_COUNTER_PATTERN =</dt><dd><p>“null_feature_config_for_feature_id_%d”;</p>
</dd>
<dt>private static final String FEATURE_OUTPUT_TYPE_IS_NULL_COUNTER_PATTERN =</dt><dd><p>“null_output_type_for_feature_id_%d”;</p>
</dd>
<dt>private static final String NO_SCHEMA_FIELD_FOR_FEATURE_COUNTER_PATTERN =</dt><dd><p>“no_schema_field_for_feature_id_%d”;</p>
</dd>
<dt>private static final SearchCounter UNKNOWN_FEATURE_OUTPUT_TYPE_COUNTER =</dt><dd><p>SearchCounter.export(“unknown_feature_output_type”);</p>
</dd>
</dl>
<p>private final Map&lt;String, NumericDocValues&gt; numericDocValues = Maps.newHashMap();
private final LeafReader leafReader;
private int docId = -1;</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Creates a new EarlybirdDocumentFeatures instance that will return feature values based on the</p></li>
<li><p>NumericDocValues stored in the given LeafReader for the given document.</p></li>
</ul>
<p><a href="#id1"><span class="problematic" id="id2">*</span></a>/</p>
</dd>
<dt>public EarlybirdDocumentFeatures(LeafReader leafReader) {</dt><dd><p>this.leafReader = Preconditions.checkNotNull(leafReader);</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Advances this instance to the given doc ID. The new doc ID must be greater than or equal to the</p></li>
<li><p>current doc ID stored in this instance.</p></li>
</ul>
<p><a href="#id3"><span class="problematic" id="id4">*</span></a>/</p>
</dd>
<dt>public void advance(int target) {</dt><dd><dl class="simple">
<dt>Preconditions.checkArgument(</dt><dd><p>target &gt;= 0,
“Target (%s) cannot be negative.”,
target);</p>
</dd>
<dt>Preconditions.checkArgument(</dt><dd><p>target &gt;= docId,
“Target (%s) smaller than current doc ID (%s).”,
target,
docId);</p>
</dd>
<dt>Preconditions.checkArgument(</dt><dd><p>target &lt; leafReader.maxDoc(),
“Target (%s) cannot be greater than or equal to the max doc ID (%s).”,
target,
leafReader.maxDoc());</p>
</dd>
</dl>
<p>docId = target;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Returns the feature value for the given field.</p></li>
</ul>
<p><a href="#id5"><span class="problematic" id="id6">*</span></a>/</p>
</dd>
<dt>public long getFeatureValue(EarlybirdFieldConstant field) throws IOException {</dt><dd><p>// The index might not have a NumericDocValues instance for this feature.
// This might happen if we dynamically update the feature schema, for example.
//
// Cache the NumericDocValues instances for all accessed features, even if they’re null.
String fieldName = field.getFieldName();
NumericDocValues docValues;
if (numericDocValues.containsKey(fieldName)) {</p>
<blockquote>
<div><p>docValues = numericDocValues.get(fieldName);</p>
</div></blockquote>
<dl class="simple">
<dt>} else {</dt><dd><p>docValues = leafReader.getNumericDocValues(fieldName);
numericDocValues.put(fieldName, docValues);</p>
</dd>
</dl>
<p>}
return docValues != null &amp;&amp; docValues.advanceExact(docId) ? docValues.longValue() : 0L;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Determines if the given flag is set.</p></li>
</ul>
<p><a href="#id7"><span class="problematic" id="id8">*</span></a>/</p>
</dd>
<dt>public boolean isFlagSet(EarlybirdFieldConstant field) throws IOException {</dt><dd><p>return getFeatureValue(field) != 0;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Returns the unnormalized value for the given field.</p></li>
</ul>
<p><a href="#id9"><span class="problematic" id="id10">*</span></a>/</p>
</dd>
<dt>public double getUnnormalizedFeatureValue(EarlybirdFieldConstant field) throws IOException {</dt><dd><p>long featureValue = getFeatureValue(field);
ThriftFeatureNormalizationType normalizationType = field.getFeatureNormalizationType();
if (normalizationType == null) {</p>
<blockquote>
<div><p>normalizationType = ThriftFeatureNormalizationType.NONE;</p>
</div></blockquote>
<p>}
switch (normalizationType) {</p>
<blockquote>
<div><dl class="simple">
<dt>case NONE:</dt><dd><p>return featureValue;</p>
</dd>
<dt>case LEGACY_BYTE_NORMALIZER:</dt><dd><p>return MutableFeatureNormalizers.BYTE_NORMALIZER.unnormLowerBound((byte) featureValue);</p>
</dd>
<dt>case LEGACY_BYTE_NORMALIZER_WITH_LOG2:</dt><dd><p>return MutableFeatureNormalizers.BYTE_NORMALIZER.unnormAndLog2((byte) featureValue);</p>
</dd>
<dt>case SMART_INTEGER_NORMALIZER:</dt><dd><dl class="simple">
<dt>return MutableFeatureNormalizers.SMART_INTEGER_NORMALIZER.unnormUpperBound(</dt><dd><p>(byte) featureValue);</p>
</dd>
</dl>
</dd>
<dt>case PREDICTION_SCORE_NORMALIZER:</dt><dd><p>return IntNormalizers.PREDICTION_SCORE_NORMALIZER.denormalize((int) featureValue);</p>
</dd>
<dt>default:</dt><dd><dl class="simple">
<dt>throw new IllegalArgumentException(</dt><dd><dl class="simple">
<dt>“Unsupported normalization type “ + normalizationType + “ for feature “</dt><dd><ul class="simple">
<li><p>field.getFieldName());</p></li>
</ul>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Creates a ThriftSearchResultFeatures instance populated with values for all available features</p></li>
<li><p>that have a non-zero value set.</p></li>
</ul>
<p><a href="#id11"><span class="problematic" id="id12">*</span></a>/</p>
</dd>
<dt>public ThriftSearchResultFeatures getSearchResultFeatures(ImmutableSchemaInterface schema)</dt><dd><blockquote>
<div><p>throws IOException {</p>
</div></blockquote>
<p>return getSearchResultFeatures(schema, (featureId) -&gt; true);</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Creates a ThriftSearchResultFeatures instance populated with values for all available features</p></li>
<li><p>that have a non-zero value set.</p></li>
<li></li>
<li><p>&#64;param schema The schema.</p></li>
<li><p>&#64;param shouldCollectFeatureId A predicate that determines which features should be collected.</p></li>
</ul>
<p><a href="#id13"><span class="problematic" id="id14">*</span></a>/</p>
</dd>
<dt>public ThriftSearchResultFeatures getSearchResultFeatures(</dt><dd><blockquote>
<div><p>ImmutableSchemaInterface schema,
Function&lt;Integer, Boolean&gt; shouldCollectFeatureId) throws IOException {</p>
</div></blockquote>
<p>Map&lt;Integer, Boolean&gt; boolValues = Maps.newHashMap();
Map&lt;Integer, Double&gt; doubleValues = Maps.newHashMap();
Map&lt;Integer, Integer&gt; intValues = Maps.newHashMap();
Map&lt;Integer, Long&gt; longValues = Maps.newHashMap();</p>
<p>Map&lt;Integer, FeatureConfiguration&gt; idToFeatureConfigMap = schema.getFeatureIdToFeatureConfig();
for (int featureId : schema.getSearchFeatureSchema().getEntries().keySet()) {</p>
<blockquote>
<div><dl class="simple">
<dt>if (!shouldCollectFeatureId.apply(featureId)) {</dt><dd><p>continue;</p>
</dd>
</dl>
<p>}</p>
<p>FeatureConfiguration featureConfig = idToFeatureConfigMap.get(featureId);
if (featureConfig == null) {</p>
<blockquote>
<div><dl>
<dt>FEATURE_CONFIG_IS_NULL_MAP.computeIfAbsent(</dt><dd><p>featureId,
(fId) -&gt; SearchCounter.export(</p>
<blockquote>
<div><p>String.format(FEATURE_CONFIG_IS_NULL_COUNTER_PATTERN, fId))).increment();</p>
</div></blockquote>
</dd>
</dl>
<p>continue;</p>
</div></blockquote>
<p>}</p>
<p>ThriftCSFType outputType = featureConfig.getOutputType();
if (outputType == null) {</p>
<blockquote>
<div><dl>
<dt>FEATURE_OUTPUT_TYPE_IS_NULL_MAP.computeIfAbsent(</dt><dd><p>featureId,
(fId) -&gt; SearchCounter.export(</p>
<blockquote>
<div><p>String.format(FEATURE_OUTPUT_TYPE_IS_NULL_COUNTER_PATTERN, fId))).increment();</p>
</div></blockquote>
</dd>
</dl>
<p>continue;</p>
</div></blockquote>
<p>}</p>
<dl>
<dt>if (!EarlybirdFieldConstants.hasFieldConstant(featureId)) {</dt><dd><p>// Should only happen for features that were dynamically added to the schema.
NO_SCHEMA_FIELD_FOR_FEATURE_MAP.computeIfAbsent(</p>
<blockquote>
<div><p>featureId,
(fId) -&gt; SearchCounter.export(</p>
<blockquote>
<div><p>String.format(NO_SCHEMA_FIELD_FOR_FEATURE_COUNTER_PATTERN, fId))).increment();</p>
</div></blockquote>
</div></blockquote>
<p>continue;</p>
</dd>
</dl>
<p>}</p>
<p>EarlybirdFieldConstant field = EarlybirdFieldConstants.getFieldConstant(featureId);
switch (outputType) {</p>
<blockquote>
<div><dl>
<dt>case BOOLEAN:</dt><dd><dl class="simple">
<dt>if (isFlagSet(field)) {</dt><dd><p>boolValues.put(featureId, true);</p>
</dd>
</dl>
<p>}
break;</p>
</dd>
<dt>case BYTE:</dt><dd><p>// It’s unclear why we don’t add this feature to a separate byteValues map…
byte byteFeatureValue = (byte) getFeatureValue(field);
if (byteFeatureValue != 0) {</p>
<blockquote>
<div><p>intValues.put(featureId, (int) byteFeatureValue);</p>
</div></blockquote>
<p>}
break;</p>
</dd>
<dt>case INT:</dt><dd><p>int intFeatureValue = (int) getFeatureValue(field);
if (intFeatureValue != 0) {</p>
<blockquote>
<div><p>intValues.put(featureId, intFeatureValue);</p>
</div></blockquote>
<p>}
break;</p>
</dd>
<dt>case LONG:</dt><dd><p>long longFeatureValue = getFeatureValue(field);
if (longFeatureValue != 0) {</p>
<blockquote>
<div><p>longValues.put(featureId, longFeatureValue);</p>
</div></blockquote>
<p>}
break;</p>
</dd>
<dt>case FLOAT:</dt><dd><p>// It’s unclear why we don’t add this feature to a separate floatValues map…
float floatFeatureValue = (float) getFeatureValue(field);
if (floatFeatureValue != 0) {</p>
<blockquote>
<div><p>doubleValues.put(featureId, (double) floatFeatureValue);</p>
</div></blockquote>
<p>}
break;</p>
</dd>
<dt>case DOUBLE:</dt><dd><p>double doubleFeatureValue = getUnnormalizedFeatureValue(field);
if (doubleFeatureValue != 0) {</p>
<blockquote>
<div><p>doubleValues.put(featureId, doubleFeatureValue);</p>
</div></blockquote>
<p>}
break;</p>
</dd>
<dt>default:</dt><dd><p>UNKNOWN_FEATURE_OUTPUT_TYPE_COUNTER.increment();</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>}</p>
<dl class="simple">
<dt>return new ThriftSearchResultFeatures()</dt><dd><p>.setBoolValues(boolValues)
.setIntValues(intValues)
.setLongValues(longValues)
.setDoubleValues(doubleValues);</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../../../index2.rst.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../../../index2.rst.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../../../_sources/src/java/com/twitter/search/common/relevance/features/EarlybirdDocumentFeatures.java.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>