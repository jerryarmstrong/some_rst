<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../../../../" id="documentation_options" src="../../../../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>package com.twitter.tweetypie.config</p>
<p>import com.twitter.finagle.mtls.authentication.ServiceIdentifier
import com.twitter.finagle.stats.StatsReceiver
import com.twitter.tweetypie.Gate
import com.twitter.tweetypie.backends.ConfigBus
import com.twitter.tweetypie.client_id.ClientIdHelper
import com.twitter.util.Activity</p>
<dl>
<dt>case class DynamicConfig(</dt><dd><p>// A map of fully-qualified client ID (including the environment suffix, e.g. tweetypie.prod) to Client case class
clientsByFullyQualifiedId: Option[Map[String, Client]],
// Clients by service identifier parts.
clientsByRole: Option[Map[String, Seq[Client]]] = None,
clientsByService: Option[Map[String, Seq[Client]]] = None,
onlyEnvClients: Option[Seq[Client]] = None,
// These endpoints do not need permissions to be accessed
unprotectedEndpoints: Set[String] = Set(“get_tweet_counts”, “get_tweet_fields”, “get_tweets”)) {</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Function that takes a fully qualified client id and says whether it is included in the allowList</p></li>
</ul>
<p><a href="#id1"><span class="problematic" id="id2">*</span></a>/</p>
</dd>
<dt>val isAllowListedClient: String =&gt; Boolean =</dt><dd><p>clientsByFullyQualifiedId.map(clients =&gt; clients.contains _).getOrElse(_ =&gt; true)</p>
</dd>
<dt>def byServiceIdentifier(serviceIdentifier: ServiceIdentifier): Set[Client] =</dt><dd><dl class="simple">
<dt>Iterable.concat(</dt><dd><p>get(clientsByRole, serviceIdentifier.role),
get(clientsByService, serviceIdentifier.service),
onlyEnvClients.getOrElse(Seq()),</p>
</dd>
</dl>
<dl class="simple">
<dt>)</dt><dd><p>.filter(_.matches(serviceIdentifier))
.toSet</p>
</dd>
</dl>
</dd>
<dt>private def get(clientsByKey: Option[Map[String, Seq[Client]]], key: String): Seq[Client] =</dt><dd><dl class="simple">
<dt>clientsByKey match {</dt><dd><p>case Some(map) =&gt; map.getOrElse(key, Seq())
case None =&gt; Seq()</p>
</dd>
</dl>
<p>}</p>
</dd>
<dt>/**</dt><dd><ul class="simple">
<li><p>Take a fully qualified client id and says if the client has offered to shed reads if tweetypie</p></li>
<li><p>is in an emergency</p></li>
</ul>
<p><a href="#id3"><span class="problematic" id="id4">*</span></a>/</p>
</dd>
<dt>val loadShedEligible: Gate[String] = Gate { (clientId: String) =&gt;</dt><dd><p>val env = ClientIdHelper.getClientIdEnv(clientId)
clientsByFullyQualifiedId.flatMap(clients =&gt; clients.get(clientId)).exists { c =&gt;</p>
<blockquote>
<div><p>c.loadShedEnvs.contains(env)</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>DynamicConfig uses ConfigBus to update Tweetypie with configuration changes</p></li>
<li><p>dynamically. Every time the config changes, the Activity[DynamicConfig] is</p></li>
<li><p>updated, and anything relying on that config will be reinitialized.</p></li>
</ul>
<p><a href="#id5"><span class="problematic" id="id6">*</span></a>/</p>
</dd>
<dt>object DynamicConfig {</dt><dd><dl>
<dt>def fullyQualifiedClientIds(client: Client): Seq[String] = {</dt><dd><p>val clientId = client.clientId
client.environments match {</p>
<blockquote>
<div><p>case Nil =&gt; Seq(clientId)
case envs =&gt; envs.map(env =&gt; s”$clientId.$env”)</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}</p>
<p>// Make a Map of fully qualified client id to Client
def byClientId(clients: Seq[Client]): Map[String, Client] =</p>
<blockquote>
<div><dl class="simple">
<dt>clients.flatMap { client =&gt;</dt><dd><p>fullyQualifiedClientIds(client).map { fullClientId =&gt; fullClientId -&gt; client }</p>
</dd>
</dl>
<p>}.toMap</p>
</div></blockquote>
<dl>
<dt>def by(get: ServiceIdentifierPattern =&gt; Option[String])(clients: Seq[Client]): Map[String, Seq[Client]] =</dt><dd><dl>
<dt>clients.flatMap { c =&gt;</dt><dd><dl class="simple">
<dt>c.serviceIdentifiers.collect {</dt><dd><p>case s if get(s).isDefined =&gt; (get(s).get, c)</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}.groupBy(_._1).mapValues(_.map(_._2))</p>
</dd>
</dl>
<p>private[this] val clientsPath = “config/clients.yml”</p>
<dl>
<dt>def apply(</dt><dd><p>stats: StatsReceiver,
configBus: ConfigBus,
settings: TweetServiceSettings</p>
</dd>
<dt>): Activity[DynamicConfig] =</dt><dd><dl class="simple">
<dt>DynamicConfigLoader(configBus.file)</dt><dd><p>.apply(clientsPath, stats.scope(“client_allowlist”), ClientsParser.apply)
.map(fromClients)</p>
</dd>
</dl>
</dd>
<dt>def fromClients(clients: Option[Seq[Client]]): DynamicConfig =</dt><dd><dl>
<dt>DynamicConfig(</dt><dd><p>clientsByFullyQualifiedId = clients.map(byClientId),
clientsByRole = clients.map(by(_.role)),
clientsByService = clients.map(by(_.service)),
onlyEnvClients = clients.map(_.filter { client =&gt;</p>
<blockquote>
<div><p>client.serviceIdentifiers.exists(_.onlyEnv)</p>
</div></blockquote>
<p>}),</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../../../../index.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../../../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../../../../_sources/tweetypie/server/src/main/scala/com/twitter/tweetypie/config/DynamicConfig.scala.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>