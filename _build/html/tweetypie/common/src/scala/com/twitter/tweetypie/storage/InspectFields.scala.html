<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../../../" id="documentation_options" src="../../../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>package com.twitter.tweetypie.storage</p>
<p>import com.google.common.base.CaseFormat
import com.twitter.conversions.DurationOps._
import com.twitter.finagle.mtls.authentication.ServiceIdentifier
import com.twitter.scrooge.TFieldBlob
import com.twitter.scrooge.ThriftStructFieldInfo
import com.twitter.stitch.Stitch
import com.twitter.storage.client.manhattan.kv._
import com.twitter.tweetypie.additionalfields.AdditionalFields
import com.twitter.tweetypie.storage.ManhattanOperations.Read
import com.twitter.tweetypie.storage.TweetUtils._
import com.twitter.tweetypie.storage_internal.thriftscala.StoredTweet
import com.twitter.tweetypie.thriftscala.{Tweet =&gt; TweetypieTweet}
import com.twitter.util.Duration
import com.twitter.util.Future
import com.twitter.util.Return
import com.twitter.util.Throw
import diffshow.Container
import diffshow.DiffShow
import diffshow.Expr
import org.apache.commons.codec.binary.Base64
import scala.util.Try
import shapeless.Cached
import shapeless.Strict</p>
<p>// This class is used by the Tweetypie Console to inspect tweet field content in Manhattan
class InspectFields(svcIdentifier: ServiceIdentifier) {</p>
<blockquote>
<div><p>val mhApplicationId = “tbird_mh”
val mhDatasetName = “tbird_mh”
val mhDestinationName = “/s/manhattan/cylon.native-thrift”
val mhTimeout: Duration = 5000.milliseconds</p>
<dl>
<dt>val localMhEndpoint: ManhattanKVEndpoint =</dt><dd><dl>
<dt>ManhattanKVEndpointBuilder(</dt><dd><dl class="simple">
<dt>ManhattanKVClient(</dt><dd><p>mhApplicationId,
mhDestinationName,
ManhattanKVClientMtlsParams(svcIdentifier)))</p>
</dd>
</dl>
<p>.defaultGuarantee(Guarantee.SoftDcReadMyWrites)
.defaultMaxTimeout(mhTimeout)
.build()</p>
</dd>
</dl>
</dd>
</dl>
<p>val readOperation: Read = (new ManhattanOperations(mhDatasetName, localMhEndpoint)).read</p>
<dl>
<dt>def lookup(tweetId: Long): Future[String] = {</dt><dd><dl>
<dt>val result = readOperation(tweetId).liftToTry.map {</dt><dd><dl class="simple">
<dt>case Return(mhRecords) =&gt;</dt><dd><p>prettyPrintManhattanRecords(tweetId, TweetKey.padTweetIdStr(tweetId), mhRecords)</p>
</dd>
</dl>
<p>case Throw(e) =&gt; e.toString</p>
</dd>
</dl>
<p>}</p>
<p>Stitch.run(result)</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>def storedTweet(tweetId: Long): Future[StoredTweet] = {</dt><dd><dl class="simple">
<dt>val result = readOperation(tweetId).liftToTry.map {</dt><dd><dl class="simple">
<dt>case Return(mhRecords) =&gt;</dt><dd><p>buildStoredTweet(tweetId, mhRecords)</p>
</dd>
<dt>case Throw(e) =&gt;</dt><dd><p>throw e</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<p>Stitch.run(result)</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private[this] def prettyPrintManhattanRecords(</dt><dd><p>tweetId: Long,
pkey: String,
mhRecords: Seq[TweetManhattanRecord]</p>
</dd>
<dt>): String = {</dt><dd><dl>
<dt>if (mhRecords.isEmpty) {</dt><dd><p>“Not Found”</p>
</dd>
<dt>} else {</dt><dd><p>val formattedRecords = getFormattedManhattanRecords(tweetId, mhRecords)
val keyFieldWidth = formattedRecords.map(_.key.length).max + 2
val fieldNameFieldWidth = formattedRecords.map(_.fieldName.length).max + 2</p>
<p>val formatString = s”    %-${keyFieldWidth}s %-${fieldNameFieldWidth}s %s”</p>
<dl>
<dt>val recordsString =</dt><dd><dl>
<dt>formattedRecords</dt><dd><dl class="simple">
<dt>.map { record =&gt;</dt><dd><p>val content = record.content.replaceAll(”n”, “n” + formatString.format(“”, “”, “”))
formatString.format(record.key, record.fieldName, content)</p>
</dd>
</dl>
<p>}
.mkString(”n”)</p>
</dd>
</dl>
</dd>
</dl>
<p>“/tbird_mh/” + pkey + “/” + “n” + recordsString</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private[this] def getFormattedManhattanRecords(</dt><dd><p>tweetId: Long,
mhRecords: Seq[TweetManhattanRecord]</p>
</dd>
<dt>): Seq[FormattedManhattanRecord] = {</dt><dd><p>val storedTweet = buildStoredTweet(tweetId, mhRecords).copy(updatedAt = None)
val tweetypieTweet: Option[TweetypieTweet] =</p>
<blockquote>
<div><p>Try(StorageConversions.fromStoredTweet(storedTweet)).toOption</p>
</div></blockquote>
<dl class="simple">
<dt>val blobMap: Map[String, TFieldBlob] = getStoredTweetBlobs(mhRecords).map { blob =&gt;</dt><dd><p>getFieldName(blob.field.id) -&gt; blob</p>
</dd>
</dl>
<p>}.toMap</p>
<dl>
<dt>mhRecords</dt><dd><dl>
<dt>.map {</dt><dd><dl>
<dt>case TweetManhattanRecord(fullKey, mhValue) =&gt;</dt><dd><dl>
<dt>FormattedManhattanRecord(</dt><dd><p>key = fullKey.lKey.toString,
fieldName = getFieldName(fullKey.lKey),
content = prettyPrintManhattanValue(</p>
<blockquote>
<div><p>fullKey.lKey,
mhValue,
storedTweet,
tweetypieTweet,
tweetId,
blobMap</p>
</div></blockquote>
<p>)</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
</dd>
</dl>
<p>}
.sortBy(_.key.replace(“external”, “xternal”)) // sort by key, with internal first</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private[this] def getFieldNameFromThrift(</dt><dd><p>fieldId: Short,
fieldInfos: List[ThriftStructFieldInfo]</p>
</dd>
<dt>): String =</dt><dd><dl class="simple">
<dt>fieldInfos</dt><dd><p>.find(info =&gt; info.tfield.id == fieldId)
.map(_.tfield.name)
.getOrElse(“&lt;UNKNOWN FIELD&gt;”)</p>
</dd>
</dl>
</dd>
<dt>private[this] def isLkeyScrubbedField(lkey: String): Boolean =</dt><dd><p>lkey.split(“/”)(1) == “scrubbed_fields”</p>
</dd>
<dt>private[this] def getFieldName(lkey: TweetKey.LKey): String =</dt><dd><dl class="simple">
<dt>lkey match {</dt><dd><p>case fieldKey: TweetKey.LKey.FieldKey =&gt; getFieldName(fieldKey.fieldId)
case _ =&gt; “”</p>
</dd>
</dl>
<p>}</p>
</dd>
<dt>private[this] def getFieldName(fieldId: Short): String =</dt><dd><dl class="simple">
<dt>if (fieldId == 1) {</dt><dd><p>“core_fields”</p>
</dd>
<dt>} else if (AdditionalFields.isAdditionalFieldId(fieldId)) {</dt><dd><p>getFieldNameFromThrift(fieldId, TweetypieTweet.fieldInfos)</p>
</dd>
<dt>} else {</dt><dd><p>getFieldNameFromThrift(fieldId, StoredTweet.fieldInfos)</p>
</dd>
</dl>
<p>}</p>
</dd>
<dt>private[this] def prettyPrintManhattanValue(</dt><dd><p>lkey: TweetKey.LKey,
mhValue: TweetManhattanValue,
storedTweet: StoredTweet,
tweetypieTweet: Option[TweetypieTweet],
tweetId: Long,
tfieldBlobs: Map[String, TFieldBlob]</p>
</dd>
<dt>): String = {</dt><dd><dl class="simple">
<dt>val decoded = lkey match {</dt><dd><dl class="simple">
<dt>case _: TweetKey.LKey.MetadataKey =&gt;</dt><dd><p>decodeMetadata(mhValue)</p>
</dd>
<dt>case fieldKey: TweetKey.LKey.FieldKey =&gt;</dt><dd><dl class="simple">
<dt>tfieldBlobs</dt><dd><p>.get(getFieldName(fieldKey.fieldId))
.map(blob =&gt; decodeField(tweetId, blob, storedTweet, tweetypieTweet))</p>
</dd>
</dl>
</dd>
<dt>case _ =&gt;</dt><dd><p>None</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<dl>
<dt>decoded.getOrElse { // If all else fails, encode the data as a base64 string</dt><dd><p>val contents = mhValue.contents.array
if (contents.isEmpty) {</p>
<blockquote>
<div><p>“&lt;NO DATA&gt;”</p>
</div></blockquote>
<dl class="simple">
<dt>} else {</dt><dd><p>Base64.encodeBase64String(contents)</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>private[this] def decodeMetadata(mhValue: TweetManhattanValue): Option[String] = {</dt><dd><p>val byteArray = ByteArrayCodec.fromByteBuffer(mhValue.contents)
Try(Json.decode(byteArray).toString).toOption</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private[this] def decodeField(</dt><dd><p>tweetId: Long,
blob: TFieldBlob,
storedTweet: StoredTweet,
tweetypieTweet: Option[TweetypieTweet]</p>
</dd>
<dt>): String = {</dt><dd><p>val fieldId = blob.field.id</p>
<dl class="simple">
<dt>if (fieldId == 1) {</dt><dd><p>coreFields(storedTweet)</p>
</dd>
<dt>} else if (AdditionalFields.isAdditionalFieldId(fieldId)) {</dt><dd><p>decodeTweetWithOneField(TweetypieTweet(tweetId).setField(blob))</p>
</dd>
<dt>} else {</dt><dd><p>decodeTweetWithOneField(StoredTweet(tweetId).setField(blob))</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<p>// Takes a Tweet or StoredTweet with a single field set and returns the value of that field
private[this] def decodeTweetWithOneField[T](</p>
<blockquote>
<div><p>tweetWithOneField: T</p>
</div></blockquote>
<dl>
<dt>)(</dt><dd><p>implicit ev: Cached[Strict[DiffShow[T]]]</p>
</dd>
<dt>): String = {</dt><dd><p>val config = diffshow.Config(hideFieldWithEmptyVal = true)
val tree: Expr = config.transform(DiffShow.show(tweetWithOneField))</p>
<p>// matches a Tweet or StoredTweet with two values, the first being the id
val value = tree.transform {</p>
<blockquote>
<div><p>case Container(_, List(diffshow.Field(“id”, _), diffshow.Field(_, value))) =&gt; value</p>
</div></blockquote>
<p>}</p>
<p>config.exprPrinter.apply(value, width = 80).render</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>private[this] def coreFields(storedTweet: StoredTweet): String =</dt><dd><p>diffshow.show(CoreFieldsCodec.fromTweet(storedTweet), hideFieldWithEmptyVal = true)</p>
</dd>
<dt>private[this] def toCamelCase(s: String): String =</dt><dd><p>CaseFormat.LOWER_UNDERSCORE.to(CaseFormat.LOWER_CAMEL, s)</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
<p>case class FormattedManhattanRecord(key: String, fieldName: String, content: String)</p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../../../index2.rst.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../../../index2.rst.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../../../_sources/tweetypie/common/src/scala/com/twitter/tweetypie/storage/InspectFields.scala.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>