<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../../../" id="documentation_options" src="../../../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>package com.twitter.tweetypie.tweettext
import scala.util.matching.Regex</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Code used to convert raw user-provided text into an allowable form.</p></li>
</ul>
<p><a href="#id1"><span class="problematic" id="id2">*</span></a>/</p>
</dd>
<dt>object Preprocessor {</dt><dd><p>import TweetText._
import TextModification.replaceAll</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Regex for dos-style line endings.</p></li>
</ul>
<p><a href="#id3"><span class="problematic" id="id4">*</span></a>/</p>
</dd>
</dl>
<p>val DosLineEndingRegex: Regex = “””rn”””.r</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Converts rn to just n.</p></li>
</ul>
<p><a href="#id5"><span class="problematic" id="id6">*</span></a>/</p>
</dd>
<dt>def normalizeNewlines(text: String): String =</dt><dd><p>DosLineEndingRegex.replaceAllIn(text, “n”)</p>
</dd>
<dt>/**</dt><dd><ul class="simple">
<li><p>Characters to strip out of tweet text at write-time.</p></li>
</ul>
<p><a href="#id7"><span class="problematic" id="id8">*</span></a>/</p>
</dd>
<dt>val unicodeCharsToStrip: Seq[Char] =</dt><dd><dl class="simple">
<dt>Seq(</dt><dd><p>‘uFFFE’, ‘uFEFF’, // BOM
‘uFFFF’, // Special
‘u200E’, ‘u200F’, // ltr, rtl
‘u202A’, ‘u202B’, ‘u202C’, ‘u202D’, ‘u202E’, // Directional change
‘u0000’, ‘u0001’, ‘u0002’, ‘u0003’, ‘u0004’, ‘u0005’, ‘u0006’, ‘u0007’, ‘u0008’,
‘u0009’, ‘u000B’, ‘u000C’, ‘u000E’, ‘u000F’, ‘u0010’, ‘u0011’, ‘u0012’, ‘u0013’,
‘u0014’, ‘u0015’, ‘u0016’, ‘u0017’, ‘u0018’, ‘u0019’, ‘u001A’, ‘u001B’, ‘u001C’,
‘u001D’, ‘u001E’, ‘u001F’, ‘u007F’,
‘u2065’,</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
<p>val UnicodeCharsToStripRegex: Regex = unicodeCharsToStrip.mkString(“[”, “”, “]”).r</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Strips out control characters and other non-textual unicode chars that can break xml and/or</p></li>
<li><p>json rendering, or be used for exploits.</p></li>
</ul>
<p><a href="#id9"><span class="problematic" id="id10">*</span></a>/</p>
</dd>
<dt>def stripControlCharacters(text: String): String =</dt><dd><p>UnicodeCharsToStripRegex.replaceAllIn(text, “”)</p>
</dd>
<dt>val Tweetypie674UnicodeSequence: String =</dt><dd><dl class="simple">
<dt>“u0633u0645u064eu0640u064eu0651u0648u064fu0648u064fu062du062e “ +</dt><dd><p>“u0337u0334u0310u062e u0337u0334u0310u062e u0337u0334u0310u062e “ +
“u0627u0645u0627u0631u062au064au062e u0337u0334u0310u062e”</p>
</dd>
</dl>
</dd>
</dl>
<p>val Tweetypie674UnicodeRegex: Regex = Tweetypie674UnicodeSequence.r</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Replace each <cite>Tweetypie674UnicodeSequence</cite> of this string to REPLACEMENT</p></li>
<li><p>CHARACTER.</p></li>
<li></li>
<li><p>Apple has a bug in its CoreText library. This aims to prevent</p></li>
<li><p>ios clients from being crashed when a tweet contains the specific</p></li>
<li><p>unicode sequence.</p></li>
</ul>
<p><a href="#id11"><span class="problematic" id="id12">*</span></a>/</p>
</dd>
<dt>def avoidCoreTextBug(text: String): String =</dt><dd><p>Tweetypie674UnicodeRegex.replaceAllIn(text, “ufffd”)</p>
</dd>
<dt>/**</dt><dd><ul class="simple">
<li><p>Replace each <cite>Tweetypie674UnicodeSequence</cite> of this string to a REPLACEMENT</p></li>
<li><p>CHARACTER, returns a TextModification object that provides information</p></li>
<li><p>to also update entity indices.</p></li>
</ul>
<p><a href="#id13"><span class="problematic" id="id14">*</span></a>/</p>
</dd>
<dt>def replaceCoreTextBugModification(text: String): Option[TextModification] =</dt><dd><p>replaceAll(text, Tweetypie674UnicodeRegex, “ufffd”)</p>
</dd>
<dt>private val preprocessor: String =&gt; String =</dt><dd><dl class="simple">
<dt>((s: String) =&gt; nfcNormalize(s))</dt><dd><p>.andThen(stripControlCharacters _)
.andThen(trimBlankCharacters _)
.andThen(normalizeNewlines _)
.andThen(collapseBlankLines _)
.andThen(avoidCoreTextBug _)</p>
</dd>
</dl>
</dd>
<dt>/**</dt><dd><ul class="simple">
<li><p>Performs the text modifications that are necessary in the write-path before extracting URLs.</p></li>
</ul>
<p><a href="#id15"><span class="problematic" id="id16">*</span></a>/</p>
</dd>
<dt>def preprocessText(text: String): String =</dt><dd><p>preprocessor(text)</p>
</dd>
<dt>/**</dt><dd><ul class="simple">
<li><p>Replaces all <cite>&lt;</cite>, <cite>&gt;</cite>, and ‘&amp;’ chars with “&amp;lt;”, “&amp;gt;”, and “&amp;amp;”, respectively.</p></li>
<li></li>
<li><p>The original purpose of this was presumably to prevent script injections when</p></li>
<li><p>displaying tweets without proper escaping.  Currently, tweets are encoded before</p></li>
<li><p>they are stored in the database.</p></li>
<li></li>
<li><p>Note that the pre-escaping of &amp; &lt; and &gt; also happens in the rich text editor in javascript</p></li>
</ul>
<p><a href="#id17"><span class="problematic" id="id18">*</span></a>/</p>
</dd>
<dt>def partialHtmlEncode(text: String): String =</dt><dd><p>PartialHtmlEncoding.encode(text)</p>
</dd>
<dt>/**</dt><dd><ul class="simple">
<li><p>The opposite of partialHtmlEncode, it replaces all “&amp;lt;”, “&amp;gt;”, and “&amp;amp;” with</p></li>
<li><p><cite>&lt;</cite>, <cite>&gt;</cite>, and ‘&amp;’, respectively.</p></li>
</ul>
<p><a href="#id19"><span class="problematic" id="id20">*</span></a>/</p>
</dd>
<dt>def partialHtmlDecode(text: String): String =</dt><dd><p>PartialHtmlEncoding.decode(text)</p>
</dd>
<dt>/**</dt><dd><ul class="simple">
<li></li>
<li><p>Detects all forms of whitespace, considering as whitespace the following:</p></li>
<li><p>This regex detects characters that always or often are rendered as blank space. We use</p></li>
<li><p>this to prevent users from inserting excess blank lines and from tweeting effectively</p></li>
<li><p>blank tweets.</p></li>
<li></li>
<li><p>Note that these are not all semantically “whitespace”, so this regex should not be used</p></li>
<li><p>to process non-blank text, e.g. to separate words.</p></li>
<li></li>
<li><p>Codepoints below and the <cite>p{Z}</cite> regex character property alias are defined in the Unicode</p></li>
<li><p>Character Database (UCD) at <a class="reference external" href="https://unicode.org/ucd/">https://unicode.org/ucd/</a> and <a class="reference external" href="https://unicode.org/reports/tr44/">https://unicode.org/reports/tr44/</a></p></li>
<li></li>
<li><p>The <cite>p{Z}</cite> regex character property alias is defined specifically in UCD as:</p></li>
<li></li>
<li><p>Zs |       Space_Separator     | a space character (of various non-zero widths)</p></li>
<li><p>Zl | Line_Separator            | U+2028 LINE SEPARATOR only</p></li>
<li><p>Zp | Paragraph_Separator   | U+2029 PARAGRAPH SEPARATOR only</p></li>
<li><p>Z  | Separator               | Zs | Zl | Zp</p></li>
<li><p>ref: <a class="reference external" href="https://unicode.org/reports/tr44/#GC_Values_Table">https://unicode.org/reports/tr44/#GC_Values_Table</a></p></li>
<li></li>
<li><p>U+0009  Horizontal Tab (included in s)</p></li>
<li><p>U+000B  Vertical Tab (included in s)</p></li>
<li><p>U+000C  Form feed  (included in s)</p></li>
<li><p>U+000D  Carriage return  (included in s)</p></li>
<li><p>U+0020  space  (included in s)</p></li>
<li><p>U+0085  Next line (included in u0085)</p></li>
<li><p>U+061C  arabic letter mark (included in u061C)</p></li>
<li><p>U+00A0  no-break space (included in p{Z})</p></li>
<li><p>U+00AD  soft-hyphen marker (included in u00AD)</p></li>
<li><p>U+1680  ogham space mark (included in p{Z})</p></li>
<li><p>U+180E  mongolian vowel separator (included in p{Z} on jdk8 and included in u180E on jdk11)</p></li>
<li><p>U+2000  en quad (included in p{Z})</p></li>
<li><p>U+2001  em quad (included in p{Z})</p></li>
<li><p>U+2002  en space (included in p{Z})</p></li>
<li><p>U+2003  em space (included in p{Z})</p></li>
<li><p>U+2004  three-per-em space (included in p{Z})</p></li>
<li><p>U+2005  four-per-em space (included in p{Z})</p></li>
<li><p>U+2006  six-per-em space (included in p{Z})</p></li>
<li><p>U+2007  figure space (included in p{Z})</p></li>
<li><p>U+2008  punctuation space (included in p{Z})</p></li>
<li><p>U+2009  thin space (included in p{Z})</p></li>
<li><p>U+200A  hair space (included in p{Z})</p></li>
<li><p>U+200B  zero-width (included in u200B-u200D)</p></li>
<li><p>U+200C  zero-width non-joiner  (included in u200B-u200D)</p></li>
<li><p>U+200D  zero-width joiner (included in u200B-u200D)</p></li>
<li><p>U+2028  line separator (included in p{Z})</p></li>
<li><p>U+2029  paragraph separator (included in p{Z})</p></li>
<li><p>U+202F  narrow no-break space (included in p{Z})</p></li>
<li><p>U+205F  medium mathematical space (included in p{Z})</p></li>
<li><p>U+2061  function application (included in u2061-u2064)</p></li>
<li><p>U+2062  invisible times (included in u2061-u2064)</p></li>
<li><p>U+2063  invisible separator (included in u2061-u2064)</p></li>
<li><p>U+2064  invisible plus (included in u2061-u2064)</p></li>
<li><p>U+2066  left-to-right isolate (included in u2066-u2069)</p></li>
<li><p>U+2067  right-to-left isolate (included in u2066-u2069)</p></li>
<li><p>U+2068  first strong isolate (included in u2066-u2069)</p></li>
<li><p>U+2069  pop directional isolate (included in u2066-u2069)</p></li>
<li><p>U+206A  inhibit symmetric swapping (included in u206A-u206F)</p></li>
<li><p>U+206B  activate symmetric swapping (included in u206A-u206F)</p></li>
<li><p>U+206C  inhibit arabic form shaping (included in u206A-u206F)</p></li>
<li><p>U+206D  activate arabic form shaping (included in u206A-u206F)</p></li>
<li><p>U+206E  national digit shapes (included in u206A-u206F)</p></li>
<li><p>U+206F  nominal digit shapes (included in u206A-u206F)</p></li>
<li><p>U+2800  braille pattern blank (included in u2800)</p></li>
<li><p>U+3164  hongul filler (see UCD Ignorable_Code_Point)</p></li>
<li><p>U+FFA0  halfwidth hongul filler (see UCD Ignorable_Code_Point)</p></li>
<li><p>U+3000  ideographic space (included in p{Z})</p></li>
<li><p>U+FEFF  zero-width no-break space (explicitly included in uFEFF)</p></li>
</ul>
<p><a href="#id21"><span class="problematic" id="id22">*</span></a>/</p>
</dd>
<dt>val BlankTextRegex: Regex =</dt><dd><p>“””[sp{Z}u180Eu0085u00ADu061Cu200B-u200Du2061-u2064u2066-u2069u206A-u206Fu2800u3164uFEFFuFFA0]*”””.r</p>
</dd>
<dt>/**</dt><dd><ul class="simple">
<li><p>Some of the above blank characters are valid at the start of a Tweet (and irrelevant at the end)</p></li>
<li><p>such as characters that change the direction of text. When trimming from the start</p></li>
<li><p>or end of text we use a smaller set of characters</p></li>
</ul>
<p><a href="#id23"><span class="problematic" id="id24">*</span></a>/</p>
</dd>
</dl>
<p>val BlankWhenLeadingOrTrailingRegex: Regex = “””[sp{Z}u180Eu0085u200BuFEFF]*”””.r</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Matches consecutive blanks, starting at a newline.</p></li>
</ul>
<p><a href="#id25"><span class="problematic" id="id26">*</span></a>/</p>
</dd>
</dl>
<p>val ConsecutiveBlankLinesRegex: Regex = (“””n(“”” + BlankTextRegex + “””n){2,}”””).r</p>
<p>val LeadingBlankCharactersRegex: Regex = (“^” + BlankWhenLeadingOrTrailingRegex).r
val TrailingBlankCharactersRegex: Regex = (BlankWhenLeadingOrTrailingRegex + “$”).r</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Is the given text empty or contains nothing but whitespace?</p></li>
</ul>
<p><a href="#id27"><span class="problematic" id="id28">*</span></a>/</p>
</dd>
<dt>def isBlank(text: String): Boolean =</dt><dd><p>BlankTextRegex.pattern.matcher(text).matches()</p>
</dd>
<dt>/**</dt><dd><ul class="simple">
<li><p>See <a class="reference external" href="http://confluence.local.twitter.com/display/PROD/Displaying+line+breaks+in+Tweets">http://confluence.local.twitter.com/display/PROD/Displaying+line+breaks+in+Tweets</a></p></li>
<li></li>
<li><p>Collapses consecutive blanks lines down to a single blank line.  We can assume that</p></li>
<li><p>all newlines have already been normalized to just n, so we don’t have to worry about</p></li>
<li><p>rn.</p></li>
</ul>
<p><a href="#id29"><span class="problematic" id="id30">*</span></a>/</p>
</dd>
<dt>def collapseBlankLinesModification(text: String): Option[TextModification] =</dt><dd><p>replaceAll(text, ConsecutiveBlankLinesRegex, “nn”)</p>
</dd>
<dt>def collapseBlankLines(text: String): String =</dt><dd><p>ConsecutiveBlankLinesRegex.replaceAllIn(text, “nn”)</p>
</dd>
<dt>def trimBlankCharacters(text: String): String =</dt><dd><dl class="simple">
<dt>TrailingBlankCharactersRegex.replaceFirstIn(</dt><dd><p>LeadingBlankCharactersRegex.replaceFirstIn(text, “”),
“”</p>
</dd>
</dl>
<p>)</p>
</dd>
<dt>/** Characters that are not visible on their own. Some of these are used in combination with</dt><dd><ul class="simple">
<li><p>other visible characters, and therefore cannot be always stripped from tweets.</p></li>
</ul>
<p><a href="#id31"><span class="problematic" id="id32">*</span></a>/</p>
</dd>
<dt>private[tweettext] val InvisibleCharacters: Seq[Char] =</dt><dd><dl class="simple">
<dt>Seq(</dt><dd><p>‘u2060’, ‘u2061’, ‘u2062’, ‘u2063’, ‘u2064’, ‘u206A’, ‘u206B’, ‘u206C’, ‘u206D’,
‘u206D’, ‘u206E’, ‘u206F’, ‘u200C’,
‘u200D’, // non-printing chars with valid use in Arabic
‘u2009’, ‘u200A’, ‘u200B’, // include very skinny spaces too
‘ufe00’, ‘ufe01’, ‘ufe02’, ‘ufe03’, ‘ufe04’, ‘ufe05’, ‘ufe06’, ‘ufe07’, ‘ufe08’,
‘ufe09’, ‘ufe0A’, ‘ufe0B’, ‘ufe0C’, ‘ufe0D’, ‘ufe0E’, ‘ufe0F’,</p>
</dd>
</dl>
<p>)</p>
</dd>
<dt>private[tweetypie] val InvisibleUnicodePattern: Regex =</dt><dd><p>(“^[” + InvisibleCharacters.mkString + “]+$”).r</p>
</dd>
<dt>def isInvisibleChar(input: Char): Boolean = {</dt><dd><p>InvisibleCharacters contains input</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/** If string is only “invisible characters”, replace full string with whitespace.</dt><dd><ul class="simple">
<li><p>The purpose of this method is to remove invisible characters when ONLY invisible characters</p></li>
<li><p>appear between two urls, which can be a security vulnerability due to misleading behavior. These</p></li>
<li><p>characters cannot be removed as a rule applied to the tweet, because they are used in</p></li>
<li><p>conjuction with other characters.</p></li>
</ul>
<p><a href="#id33"><span class="problematic" id="id34">*</span></a>/</p>
</dd>
<dt>def replaceInvisiblesWithWhitespace(text: String): String = {</dt><dd><dl class="simple">
<dt>text match {</dt><dd><p>case invisible &#64; InvisibleUnicodePattern() =&gt; “ “ * TweetText.codePointLength(invisible)
case other =&gt; other</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../../../index2.rst.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../../../index2.rst.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../../../_sources/tweetypie/common/src/scala/com/twitter/tweetypie/tweettext/Preprocessor.scala.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>