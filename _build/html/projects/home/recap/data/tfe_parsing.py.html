<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>import functools
import json</p>
<p>from tml.projects.home.recap.data import config as recap_data_config</p>
<p>from absl import logging
import tensorflow as tf</p>
<p>DEFAULTS_MAP = {“int64_list”: 0, “float_list”: 0.0, “bytes_list”: “”}
DTYPE_MAP = {“int64_list”: tf.int64, “float_list”: tf.float32, “bytes_list”: tf.string}</p>
<dl>
<dt>def create_tf_example_schema(</dt><dd><p>data_config: recap_data_config.SegDenseSchema,
segdense_schema,</p>
</dd>
<dt>):</dt><dd><p>“””Generate schema for deseralizing tf.Example.</p>
<dl class="simple">
<dt>Args:</dt><dd><p>segdense_schema: List of dicts of segdense features (includes feature_name, dtype, length).
labels: List of strings denoting labels.</p>
</dd>
<dt>Returns:</dt><dd><p>A dictionary schema suitable for deserializing tf.Example.</p>
</dd>
</dl>
<p>“””
segdense_config = data_config.seg_dense_schema
labels = list(data_config.tasks.keys())
used_features = (</p>
<blockquote>
<div><p>segdense_config.features + list(segdense_config.renamed_features.values()) + labels</p>
</div></blockquote>
<p>)
logging.info(used_features)</p>
<p>tfe_schema = {}
for entry in segdense_schema:</p>
<blockquote>
<div><p>feature_name = entry[“feature_name”]</p>
<dl>
<dt>if feature_name in used_features:</dt><dd><p>length = entry[“length”]
dtype = entry[“dtype”]</p>
<dl>
<dt>if feature_name in labels:</dt><dd><p>logging.info(f”Label: feature name is {feature_name} type is {dtype}”)
tfe_schema[feature_name] = tf.io.FixedLenFeature(</p>
<blockquote>
<div><p>length, DTYPE_MAP[dtype], DEFAULTS_MAP[dtype]</p>
</div></blockquote>
<p>)</p>
</dd>
<dt>elif length == -1:</dt><dd><p>tfe_schema[feature_name] = tf.io.VarLenFeature(DTYPE_MAP[dtype])</p>
</dd>
<dt>else:</dt><dd><dl class="simple">
<dt>tfe_schema[feature_name] = tf.io.FixedLenFeature(</dt><dd><p>length, DTYPE_MAP[dtype], [DEFAULTS_MAP[dtype]] * length</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<dl class="simple">
<dt>for feature_name in used_features:</dt><dd><dl class="simple">
<dt>if feature_name not in tfe_schema:</dt><dd><p>raise ValueError(f”{feature_name} missing from schema: {segdense_config.schema_path}.”)</p>
</dd>
</dl>
</dd>
</dl>
<p>return tfe_schema</p>
</dd>
</dl>
<p>&#64;functools.lru_cache(1)
def make_mantissa_mask(mask_length: int) -&gt; tf.Tensor:</p>
<blockquote>
<div><p>“””For experimentating with emulating bfloat16 or less precise types.”””
return tf.constant((1 &lt;&lt; 32) - (1 &lt;&lt; mask_length), dtype=tf.int32)</p>
</div></blockquote>
<dl>
<dt>def mask_mantissa(tensor: tf.Tensor, mask_length: int) -&gt; tf.Tensor:</dt><dd><p>“””For experimentating with emulating bfloat16 or less precise types.”””
mask: tf.Tensor = make_mantissa_mask(mask_length)
return tf.bitcast(tf.bitwise.bitwise_and(tf.bitcast(tensor, tf.int32), mask), tensor.dtype)</p>
</dd>
<dt>def parse_tf_example(</dt><dd><p>serialized_example,
tfe_schema,
seg_dense_schema_config,</p>
</dd>
<dt>):</dt><dd><p>“””Parse serialized tf.Example into dict of tensors.</p>
<dl class="simple">
<dt>Args:</dt><dd><p>serialized_example: Serialized tf.Example to be parsed.
tfe_schema: Dictionary schema suitable for deserializing tf.Example.</p>
</dd>
<dt>Returns:</dt><dd><p>Dictionary of tensors to be used as model input.</p>
</dd>
</dl>
<p>“””
inputs = tf.io.parse_example(serialized=serialized_example, features=tfe_schema)</p>
<dl class="simple">
<dt>for new_feature_name, old_feature_name in seg_dense_schema_config.renamed_features.items():</dt><dd><p>inputs[new_feature_name] = inputs.pop(old_feature_name)</p>
</dd>
</dl>
<p># This should not actually be used except for experimentation with low precision floats.
if “mask_mantissa_features” in seg_dense_schema_config:</p>
<blockquote>
<div><dl class="simple">
<dt>for feature_name, mask_length in seg_dense_schema_config.mask_mantissa_features.items():</dt><dd><p>inputs[feature_name] = mask_mantissa(inputs[feature_name], mask_length)</p>
</dd>
</dl>
</div></blockquote>
<p># DANGER DANGER: This default seems really scary, and it’s only here because it has to be visible
# at TF level.
# We should not return empty tensors if we dont use embeddings.
# Otherwise, it breaks numpy-&gt;pt conversion
renamed_keys = list(seg_dense_schema_config.renamed_features.keys())
for renamed_key in renamed_keys:</p>
<blockquote>
<div><dl class="simple">
<dt>if “embedding” in renamed_key and (renamed_key not in inputs):</dt><dd><p>inputs[renamed_key] = tf.zeros([], tf.float32)</p>
</dd>
</dl>
</div></blockquote>
<p>logging.info(f”parsed example and inputs are {inputs}”)
return inputs</p>
</dd>
<dt>def get_seg_dense_parse_fn(data_config: recap_data_config.RecapDataConfig):</dt><dd><p>“””Placeholder for seg dense.</p>
<p>In the future, when we use more seg dense variations, we can change this.
“””
with tf.io.gfile.GFile(data_config.seg_dense_schema.schema_path, “r”) as f:</p>
<blockquote>
<div><p>seg_dense_schema = json.load(f)[“schema”]</p>
</div></blockquote>
<dl class="simple">
<dt>tf_example_schema = create_tf_example_schema(</dt><dd><p>data_config,
seg_dense_schema,</p>
</dd>
</dl>
<p>)</p>
<p>logging.info(”<strong>*</strong> TF Example Schema <strong>*</strong>”)
logging.info(tf_example_schema)</p>
<dl class="simple">
<dt>parse = functools.partial(</dt><dd><p>parse_tf_example,
tfe_schema=tf_example_schema,
seg_dense_schema_config=data_config.seg_dense_schema,</p>
</dd>
</dl>
<p>)
return parse</p>
</dd>
</dl>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index2.rst.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index2.rst.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../_sources/projects/home/recap/data/tfe_parsing.py.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>