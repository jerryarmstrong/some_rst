<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p># Heavy Ranker</p>
<p>## Overview</p>
<p>The heavy ranker is a machine learning model used to rank tweets for the “For You” timeline
which have passed through the candidate retrieval stage. It is one of the final stages of the funnel,
succeeded primarily by a set of filtering heuristics.</p>
<p>The model receives features describing a Tweet and the user that the Tweet is being recommended to
(see [FEATURES.md](./FEATURES.md)). The model architecture is a parallel [MaskNet](<a class="reference external" href="https://arxiv.org/abs/2102.07619">https://arxiv.org/abs/2102.07619</a>)
which outputs a set of numbers between 0 and 1, with each output representing the probability that the user
will engage with the tweet in a particular way. The predicted engagement types are explained below:
<code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">scored_tweets_model_weight_fav:</span> <span class="pre">The</span> <span class="pre">probability</span> <span class="pre">the</span> <span class="pre">user</span> <span class="pre">will</span> <span class="pre">favorite</span> <span class="pre">the</span> <span class="pre">Tweet.</span>
<span class="pre">scored_tweets_model_weight_retweet:</span> <span class="pre">The</span> <span class="pre">probability</span> <span class="pre">the</span> <span class="pre">user</span> <span class="pre">will</span> <span class="pre">Retweet</span> <span class="pre">the</span> <span class="pre">Tweet.</span>
<span class="pre">scored_tweets_model_weight_reply:</span> <span class="pre">The</span> <span class="pre">probability</span> <span class="pre">the</span> <span class="pre">user</span> <span class="pre">replies</span> <span class="pre">to</span> <span class="pre">the</span> <span class="pre">Tweet.</span>
<span class="pre">scored_tweets_model_weight_good_profile_click:</span> <span class="pre">The</span> <span class="pre">probability</span> <span class="pre">the</span> <span class="pre">user</span> <span class="pre">opens</span> <span class="pre">the</span> <span class="pre">Tweet</span> <span class="pre">author</span> <span class="pre">profile</span> <span class="pre">and</span> <span class="pre">Likes</span> <span class="pre">or</span> <span class="pre">replies</span> <span class="pre">to</span> <span class="pre">a</span> <span class="pre">Tweet.</span>
<span class="pre">scored_tweets_model_weight_video_playback50:</span> <span class="pre">The</span> <span class="pre">probability</span> <span class="pre">(for</span> <span class="pre">a</span> <span class="pre">video</span> <span class="pre">Tweet)</span> <span class="pre">that</span> <span class="pre">the</span> <span class="pre">user</span> <span class="pre">will</span> <span class="pre">watch</span> <span class="pre">at</span> <span class="pre">least</span> <span class="pre">half</span> <span class="pre">of</span> <span class="pre">the</span> <span class="pre">video.</span>
<span class="pre">scored_tweets_model_weight_reply_engaged_by_author:</span> <span class="pre">The</span> <span class="pre">probability</span> <span class="pre">the</span> <span class="pre">user</span> <span class="pre">replies</span> <span class="pre">to</span> <span class="pre">the</span> <span class="pre">Tweet</span> <span class="pre">and</span> <span class="pre">this</span> <span class="pre">reply</span> <span class="pre">is</span> <span class="pre">engaged</span> <span class="pre">by</span> <span class="pre">the</span> <span class="pre">Tweet</span> <span class="pre">author.</span>
<span class="pre">scored_tweets_model_weight_good_click:</span> <span class="pre">The</span> <span class="pre">probability</span> <span class="pre">the</span> <span class="pre">user</span> <span class="pre">will</span> <span class="pre">click</span> <span class="pre">into</span> <span class="pre">the</span> <span class="pre">conversation</span> <span class="pre">of</span> <span class="pre">this</span> <span class="pre">Tweet</span> <span class="pre">and</span> <span class="pre">reply</span> <span class="pre">or</span> <span class="pre">Like</span> <span class="pre">a</span> <span class="pre">Tweet.</span>
<span class="pre">scored_tweets_model_weight_good_click_v2:</span> <span class="pre">The</span> <span class="pre">probability</span> <span class="pre">the</span> <span class="pre">user</span> <span class="pre">will</span> <span class="pre">click</span> <span class="pre">into</span> <span class="pre">the</span> <span class="pre">conversation</span> <span class="pre">of</span> <span class="pre">this</span> <span class="pre">Tweet</span> <span class="pre">and</span> <span class="pre">stay</span> <span class="pre">there</span> <span class="pre">for</span> <span class="pre">at</span> <span class="pre">least</span> <span class="pre">2</span> <span class="pre">minutes.</span>
<span class="pre">scored_tweets_model_weight_negative_feedback_v2:</span> <span class="pre">The</span> <span class="pre">probability</span> <span class="pre">the</span> <span class="pre">user</span> <span class="pre">will</span> <span class="pre">react</span> <span class="pre">negatively</span> <span class="pre">(requesting</span> <span class="pre">&quot;show</span> <span class="pre">less</span> <span class="pre">often&quot;</span> <span class="pre">on</span> <span class="pre">the</span> <span class="pre">Tweet</span> <span class="pre">or</span> <span class="pre">author,</span> <span class="pre">block</span> <span class="pre">or</span> <span class="pre">mute</span> <span class="pre">the</span> <span class="pre">Tweet</span> <span class="pre">author).</span>
<span class="pre">scored_tweets_model_weight_report:</span> <span class="pre">The</span> <span class="pre">probability</span> <span class="pre">the</span> <span class="pre">user</span> <span class="pre">will</span> <span class="pre">click</span> <span class="pre">Report</span> <span class="pre">Tweet.</span>
<span class="pre">`</span></code></p>
<p>The outputs of the model are combined into a final model score by doing a weighted sum across the predicted engagement probabilities.
The weight of each engagement probability comes from a configuration file, read by the serving stack
[here](<a class="reference external" href="https://github.com/twitter/the-algorithm/blob/main/home-mixer/server/src/main/scala/com/twitter/home_mixer/product/scored_tweets/param/ScoredTweetsParam.scala#L84">https://github.com/twitter/the-algorithm/blob/main/home-mixer/server/src/main/scala/com/twitter/home_mixer/product/scored_tweets/param/ScoredTweetsParam.scala#L84</a>). The exact weights in the file can be adjusted at any time, but the current weighting of probabilities
(April 5, 2023) is as follows:
<code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">scored_tweets_model_weight_fav:</span> <span class="pre">0.5</span>
<span class="pre">scored_tweets_model_weight_retweet:</span> <span class="pre">1.0</span>
<span class="pre">scored_tweets_model_weight_reply:</span> <span class="pre">13.5</span>
<span class="pre">scored_tweets_model_weight_good_profile_click:</span> <span class="pre">12.0</span>
<span class="pre">scored_tweets_model_weight_video_playback50:</span> <span class="pre">0.005</span>
<span class="pre">scored_tweets_model_weight_reply_engaged_by_author:</span> <span class="pre">75.0</span>
<span class="pre">scored_tweets_model_weight_good_click:</span> <span class="pre">11.0</span>
<span class="pre">scored_tweets_model_weight_good_click_v2:</span> <span class="pre">10.0</span>
<span class="pre">scored_tweets_model_weight_negative_feedback_v2:</span> <span class="pre">-74.0</span>
<span class="pre">scored_tweets_model_weight_report:</span> <span class="pre">-369.0</span>
<span class="pre">`</span></code></p>
<p>Essentially, the formula is:
<code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">score</span> <span class="pre">=</span> <span class="pre">sum_i</span> <span class="pre">{</span> <span class="pre">(weight</span> <span class="pre">of</span> <span class="pre">engagement</span> <span class="pre">i)</span> <span class="pre">*</span> <span class="pre">(probability</span> <span class="pre">of</span> <span class="pre">engagement</span> <span class="pre">i)</span> <span class="pre">}</span>
<span class="pre">`</span></code></p>
<p>Since each engagement has a different average probability, the weights were originally set so that,
on average, each weighted engagement probability contributes a near-equal amount to the score.
Since then, we have periodically adjusted the weights to optimize for platform metrics.</p>
<p>Some disclaimers:
- Due to the need to make sure this runs independently from other parts of Twitter codebase, there may be small differences from the production model.
- We cannot release the real training data due to privacy restrictions. However, we have included a script to generate random data to ensure you can run the model training code.</p>
<p>## Development
After following the repo setup instructions, you can run the following script from a virtual environment to create a
random training dataset in <cite>$HOME/tmp/recap_local_random_data</cite>:
<code class="docutils literal notranslate"><span class="pre">`sh</span>
<span class="pre">projects/home/recap/scripts/create_random_data.sh</span>
<span class="pre">`</span></code></p>
<p>You can then train the model using the following script.
Checkpoints and logs will be written to <cite>$HOME/tmp/runs/recap_local_debug</cite>:
<code class="docutils literal notranslate"><span class="pre">`sh</span>
<span class="pre">projects/home/recap/scripts/run_local.sh</span>
<span class="pre">`</span></code></p>
<p>The model training can be configured in <cite>projects/home/recap/config/local_prod.yaml</cite></p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index2.rst.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index2.rst.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../_sources/projects/home/recap/README.md.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>