<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../../../" id="documentation_options" src="../../../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>package com.twitter.search.common.converter.earlybird;</p>
<p>import java.io.IOException;
import java.util.Date;
import java.util.List;
import java.util.Optional;
import javax.annotation.concurrent.NotThreadSafe;</p>
<p>import com.google.common.base.Preconditions;</p>
<p>import org.apache.commons.collections.CollectionUtils;
import org.joda.time.DateTime;
import org.joda.time.DateTimeZone;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;</p>
<p>import com.twitter.common_internal.text.version.PenguinVersion;
import com.twitter.search.common.converter.earlybird.EncodedFeatureBuilder.TweetFeatureWithEncodeFeatures;
import com.twitter.search.common.indexing.thriftjava.Place;
import com.twitter.search.common.indexing.thriftjava.PotentialLocation;
import com.twitter.search.common.indexing.thriftjava.ProfileGeoEnrichment;
import com.twitter.search.common.indexing.thriftjava.ThriftVersionedEvents;
import com.twitter.search.common.indexing.thriftjava.VersionedTweetFeatures;
import com.twitter.search.common.metrics.SearchCounter;
import com.twitter.search.common.partitioning.snowflakeparser.SnowflakeIdParser;
import com.twitter.search.common.relevance.entities.GeoObject;
import com.twitter.search.common.relevance.entities.TwitterMessage;
import com.twitter.search.common.relevance.entities.TwitterQuotedMessage;
import com.twitter.search.common.schema.base.ImmutableSchemaInterface;
import com.twitter.search.common.schema.base.Schema;
import com.twitter.search.common.schema.earlybird.EarlybirdCluster;
import com.twitter.search.common.schema.earlybird.EarlybirdEncodedFeatures;
import com.twitter.search.common.schema.earlybird.EarlybirdFieldConstants;
import com.twitter.search.common.schema.earlybird.EarlybirdFieldConstants.EarlybirdFieldConstant;
import com.twitter.search.common.schema.earlybird.EarlybirdThriftDocumentBuilder;
import com.twitter.search.common.schema.thriftjava.ThriftDocument;
import com.twitter.search.common.schema.thriftjava.ThriftIndexingEvent;
import com.twitter.search.common.schema.thriftjava.ThriftIndexingEventType;
import com.twitter.search.common.util.spatial.GeoUtil;
import com.twitter.search.common.util.text.NormalizerHelper;
import com.twitter.tweetypie.thriftjava.ComposerSource;</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Converts a TwitterMessage into a ThriftVersionedEvents. This is only responsible for data that</p></li>
<li><p>is available immediately when a Tweet is created. Some data, like URL data, isn’t available</p></li>
<li><p>immediately, and so it is processed later, in the DelayedIndexingConverter and sent as an</p></li>
<li><p>update. In order to achieve this we create the document in 2 passes:</p></li>
<li></li>
<li><ol class="arabic simple">
<li><p>BasicIndexingConverter builds thriftVersionedEvents with the fields that do not require</p></li>
</ol>
</li>
<li><p>external services.</p></li>
<li></li>
<li><ol class="arabic simple" start="2">
<li><p>DelayedIndexingConverter builds all the document fields depending on external services, once</p></li>
</ol>
</li>
<li><p>those services have processed the relevant Tweet and we have retrieved that data.</p></li>
</ul>
<p><a href="#id1"><span class="problematic" id="id2">*</span></a>/</p>
</dd>
</dl>
<p>&#64;NotThreadSafe
public class BasicIndexingConverter {</p>
<blockquote>
<div><p>private static final Logger LOG = LoggerFactory.getLogger(BasicIndexingConverter.class);</p>
<dl class="simple">
<dt>private static final SearchCounter NUM_NULLCAST_FEATURE_FLAG_SET_TWEETS =</dt><dd><p>SearchCounter.export(“num_nullcast_feature_flag_set_tweets”);</p>
</dd>
<dt>private static final SearchCounter NUM_NULLCAST_TWEETS =</dt><dd><p>SearchCounter.export(“num_nullcast_tweets”);</p>
</dd>
<dt>private static final SearchCounter NUM_NON_NULLCAST_TWEETS =</dt><dd><p>SearchCounter.export(“num_non_nullcast_tweets”);</p>
</dd>
<dt>private static final SearchCounter ADJUSTED_BAD_CREATED_AT_COUNTER =</dt><dd><p>SearchCounter.export(“adjusted_incorrect_created_at_timestamp”);</p>
</dd>
<dt>private static final SearchCounter INCONSISTENT_TWEET_ID_AND_CREATED_AT_MS =</dt><dd><p>SearchCounter.export(“inconsistent_tweet_id_and_created_at_ms”);</p>
</dd>
<dt>private static final SearchCounter NUM_SELF_THREAD_TWEETS =</dt><dd><p>SearchCounter.export(“num_self_thread_tweets”);</p>
</dd>
<dt>private static final SearchCounter NUM_EXCLUSIVE_TWEETS =</dt><dd><p>SearchCounter.export(“num_exclusive_tweets”);</p>
</dd>
</dl>
<p>// If a tweet carries a timestamp smaller than this timestamp, we consider the timestamp invalid,
// because twitter does not even exist back then before: Sun, 01 Jan 2006 00:00:00 GMT
private static final long VALID_CREATION_TIME_THRESHOLD_MILLIS =</p>
<blockquote>
<div><p>new DateTime(2006, 1, 1, 0, 0, 0, DateTimeZone.UTC).getMillis();</p>
</div></blockquote>
<p>private final EncodedFeatureBuilder featureBuilder;
private final Schema schema;
private final EarlybirdCluster cluster;</p>
<dl class="simple">
<dt>public BasicIndexingConverter(Schema schema, EarlybirdCluster cluster) {</dt><dd><p>this.featureBuilder = new EncodedFeatureBuilder();
this.schema = schema;
this.cluster = cluster;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>This function converts TwitterMessage to ThriftVersionedEvents, which is a generic data</p></li>
<li><p>structure that can be consumed by Earlybird directly.</p></li>
</ul>
<p><a href="#id3"><span class="problematic" id="id4">*</span></a>/</p>
</dd>
<dt>public ThriftVersionedEvents convertMessageToThrift(</dt><dd><blockquote>
<div><p>TwitterMessage message,
boolean strict,
List&lt;PenguinVersion&gt; penguinVersions) throws IOException {</p>
</div></blockquote>
<p>Preconditions.checkNotNull(message);
Preconditions.checkNotNull(penguinVersions);</p>
<dl class="simple">
<dt>ThriftVersionedEvents versionedEvents = new ThriftVersionedEvents()</dt><dd><p>.setId(message.getId());</p>
</dd>
</dl>
<p>ImmutableSchemaInterface schemaSnapshot = schema.getSchemaSnapshot();</p>
<dl>
<dt>for (PenguinVersion penguinVersion<span class="classifier">penguinVersions) {</span></dt><dd><dl class="simple">
<dt>ThriftDocument document =</dt><dd><p>buildDocumentForPenguinVersion(schemaSnapshot, message, strict, penguinVersion);</p>
</dd>
<dt>ThriftIndexingEvent thriftIndexingEvent = new ThriftIndexingEvent()</dt><dd><p>.setDocument(document)
.setEventType(ThriftIndexingEventType.INSERT)
.setSortId(message.getId());</p>
</dd>
</dl>
<p>message.getFromUserTwitterId().map(thriftIndexingEvent::setUid);
versionedEvents.putToVersionedEvents(penguinVersion.getByteValue(), thriftIndexingEvent);</p>
</dd>
</dl>
<p>}</p>
<p>return versionedEvents;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private ThriftDocument buildDocumentForPenguinVersion(</dt><dd><blockquote>
<div><p>ImmutableSchemaInterface schemaSnapshot,
TwitterMessage message,
boolean strict,
PenguinVersion penguinVersion) throws IOException {</p>
</div></blockquote>
<dl class="simple">
<dt>TweetFeatureWithEncodeFeatures tweetFeature =</dt><dd><dl class="simple">
<dt>featureBuilder.createTweetFeaturesFromTwitterMessage(</dt><dd><p>message, penguinVersion, schemaSnapshot);</p>
</dd>
</dl>
</dd>
<dt>EarlybirdThriftDocumentBuilder builder =</dt><dd><p>buildBasicFields(message, schemaSnapshot, cluster, tweetFeature);</p>
</dd>
</dl>
<p>buildUserFields(builder, message, tweetFeature.versionedFeatures, penguinVersion);
buildGeoFields(builder, message, tweetFeature.versionedFeatures);
buildRetweetAndReplyFields(builder, message, strict);
buildQuotesFields(builder, message);
buildVersionedFeatureFields(builder, tweetFeature.versionedFeatures);
buildAnnotationFields(builder, message);
buildNormalizedMinEngagementFields(builder, tweetFeature.encodedFeatures, cluster);
buildDirectedAtFields(builder, message);</p>
<p>builder.withSpaceIdFields(message.getSpaceIds());</p>
<p>return builder.build();</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Build the basic fields for a tweet.</p></li>
</ul>
<p><a href="#id5"><span class="problematic" id="id6">*</span></a>/</p>
</dd>
<dt>public static EarlybirdThriftDocumentBuilder buildBasicFields(</dt><dd><blockquote>
<div><p>TwitterMessage message,
ImmutableSchemaInterface schemaSnapshot,
EarlybirdCluster cluster,
TweetFeatureWithEncodeFeatures tweetFeature) {</p>
</div></blockquote>
<p>EarlybirdEncodedFeatures extendedEncodedFeatures = tweetFeature.extendedEncodedFeatures;
if (extendedEncodedFeatures == null &amp;&amp; EarlybirdCluster.isTwitterMemoryFormatCluster(cluster)) {</p>
<blockquote>
<div><dl class="simple">
<dt>extendedEncodedFeatures = EarlybirdEncodedFeatures.newEncodedTweetFeatures(</dt><dd><p>schemaSnapshot, EarlybirdFieldConstant.EXTENDED_ENCODED_TWEET_FEATURES_FIELD);</p>
</dd>
</dl>
</div></blockquote>
<p>}
EarlybirdThriftDocumentBuilder builder = new EarlybirdThriftDocumentBuilder(</p>
<blockquote>
<div><p>tweetFeature.encodedFeatures,
extendedEncodedFeatures,
new EarlybirdFieldConstants(),
schemaSnapshot);</p>
</div></blockquote>
<p>builder.withID(message.getId());</p>
<p>final Date createdAt = message.getDate();
long createdAtMs = createdAt == null ? 0L : createdAt.getTime();</p>
<p>createdAtMs = fixCreatedAtTimeStampIfNecessary(message.getId(), createdAtMs);</p>
<dl class="simple">
<dt>if (createdAtMs &gt; 0L) {</dt><dd><p>builder.withCreatedAt((int) (createdAtMs / 1000));</p>
</dd>
</dl>
<p>}</p>
<p>builder.withTweetSignature(tweetFeature.versionedFeatures.getTweetSignature());</p>
<dl>
<dt>if (message.getConversationId() &gt; 0) {</dt><dd><p>long conversationId = message.getConversationId();
builder.withLongField(</p>
<blockquote>
<div><p>EarlybirdFieldConstant.CONVERSATION_ID_CSF.getFieldName(), conversationId);</p>
</div></blockquote>
<p>// We only index conversation ID when it is different from the tweet ID.
if (message.getId() != conversationId) {</p>
<blockquote>
<div><dl class="simple">
<dt>builder.withLongField(</dt><dd><p>EarlybirdFieldConstant.CONVERSATION_ID_FIELD.getFieldName(), conversationId);</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>if (message.getComposerSource().isPresent()) {</dt><dd><p>ComposerSource composerSource = message.getComposerSource().get();
builder.withIntField(</p>
<blockquote>
<div><p>EarlybirdFieldConstant.COMPOSER_SOURCE.getFieldName(), composerSource.getValue());</p>
</div></blockquote>
<dl class="simple">
<dt>if (composerSource == ComposerSource.CAMERA) {</dt><dd><p>builder.withCameraComposerSourceFlag();</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<p>EarlybirdEncodedFeatures encodedFeatures = tweetFeature.encodedFeatures;
if (encodedFeatures.isFlagSet(EarlybirdFieldConstant.FROM_VERIFIED_ACCOUNT_FLAG)) {</p>
<blockquote>
<div><p>builder.addFilterInternalFieldTerm(EarlybirdFieldConstant.VERIFIED_FILTER_TERM);</p>
</div></blockquote>
<p>}
if (encodedFeatures.isFlagSet(EarlybirdFieldConstant.FROM_BLUE_VERIFIED_ACCOUNT_FLAG)) {</p>
<blockquote>
<div><p>builder.addFilterInternalFieldTerm(EarlybirdFieldConstant.BLUE_VERIFIED_FILTER_TERM);</p>
</div></blockquote>
<p>}</p>
<dl class="simple">
<dt>if (encodedFeatures.isFlagSet(EarlybirdFieldConstant.IS_OFFENSIVE_FLAG)) {</dt><dd><p>builder.withOffensiveFlag();</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>if (message.getNullcast()) {</dt><dd><p>NUM_NULLCAST_TWEETS.increment();
builder.addFilterInternalFieldTerm(EarlybirdFieldConstant.NULLCAST_FILTER_TERM);</p>
</dd>
<dt>} else {</dt><dd><p>NUM_NON_NULLCAST_TWEETS.increment();</p>
</dd>
</dl>
<p>}
if (encodedFeatures.isFlagSet(EarlybirdFieldConstant.IS_NULLCAST_FLAG)) {</p>
<blockquote>
<div><p>NUM_NULLCAST_FEATURE_FLAG_SET_TWEETS.increment();</p>
</div></blockquote>
<p>}
if (message.isSelfThread()) {</p>
<blockquote>
<div><dl class="simple">
<dt>builder.addFilterInternalFieldTerm(</dt><dd><p>EarlybirdFieldConstant.SELF_THREAD_FILTER_TERM);</p>
</dd>
</dl>
<p>NUM_SELF_THREAD_TWEETS.increment();</p>
</div></blockquote>
<p>}</p>
<dl>
<dt>if (message.isExclusive()) {</dt><dd><p>builder.addFilterInternalFieldTerm(EarlybirdFieldConstant.EXCLUSIVE_FILTER_TERM);
builder.withLongField(</p>
<blockquote>
<div><p>EarlybirdFieldConstant.EXCLUSIVE_CONVERSATION_AUTHOR_ID_CSF.getFieldName(),
message.getExclusiveConversationAuthorId());</p>
</div></blockquote>
<p>NUM_EXCLUSIVE_TWEETS.increment();</p>
</dd>
</dl>
<p>}</p>
<p>builder.withLanguageCodes(message.getLanguage(), message.getBCP47LanguageTag());</p>
<p>return builder;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Build the user fields.</p></li>
</ul>
<p><a href="#id7"><span class="problematic" id="id8">*</span></a>/</p>
</dd>
<dt>public static void buildUserFields(</dt><dd><blockquote>
<div><p>EarlybirdThriftDocumentBuilder builder,
TwitterMessage message,
VersionedTweetFeatures versionedTweetFeatures,
PenguinVersion penguinVersion) {</p>
</div></blockquote>
<p>// 1. Set all the from user fields.
if (message.getFromUserTwitterId().isPresent()) {</p>
<blockquote>
<div><dl class="simple">
<dt>builder.withLongField(EarlybirdFieldConstant.FROM_USER_ID_FIELD.getFieldName(),</dt><dd><p>message.getFromUserTwitterId().get())</p>
</dd>
</dl>
<p>// CSF
.withLongField(EarlybirdFieldConstant.FROM_USER_ID_CSF.getFieldName(),</p>
<blockquote>
<div><p>message.getFromUserTwitterId().get());</p>
</div></blockquote>
</div></blockquote>
<dl class="simple">
<dt>} else {</dt><dd><p>LOG.warn(“fromUserTwitterId is not set in TwitterMessage! Status id: “ + message.getId());</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>if (message.getFromUserScreenName().isPresent()) {</dt><dd><p>String fromUser = message.getFromUserScreenName().get();
String normalizedFromUser =</p>
<blockquote>
<div><p>NormalizerHelper.normalizeWithUnknownLocale(fromUser, penguinVersion);</p>
</div></blockquote>
<dl class="simple">
<dt>builder</dt><dd><dl class="simple">
<dt>.withWhiteSpaceTokenizedScreenNameField(</dt><dd><p>EarlybirdFieldConstant.TOKENIZED_FROM_USER_FIELD.getFieldName(),
normalizedFromUser)</p>
</dd>
<dt>.withStringField(EarlybirdFieldConstant.FROM_USER_FIELD.getFieldName(),</dt><dd><p>normalizedFromUser);</p>
</dd>
</dl>
</dd>
<dt>if (message.getTokenizedFromUserScreenName().isPresent()) {</dt><dd><dl class="simple">
<dt>builder.withCamelCaseTokenizedScreenNameField(</dt><dd><p>EarlybirdFieldConstant.CAMELCASE_USER_HANDLE_FIELD.getFieldName(),
fromUser,
normalizedFromUser,
message.getTokenizedFromUserScreenName().get());</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<p>Optional&lt;String&gt; toUserScreenName = message.getToUserLowercasedScreenName();
if (toUserScreenName.isPresent() &amp;&amp; !toUserScreenName.get().isEmpty()) {</p>
<blockquote>
<div><dl class="simple">
<dt>builder.withStringField(</dt><dd><p>EarlybirdFieldConstant.TO_USER_FIELD.getFieldName(),
NormalizerHelper.normalizeWithUnknownLocale(toUserScreenName.get(), penguinVersion));</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
<dl class="simple">
<dt>if (versionedTweetFeatures.isSetUserDisplayNameTokenStreamText()) {</dt><dd><dl class="simple">
<dt>builder.withTokenStreamField(EarlybirdFieldConstant.TOKENIZED_USER_NAME_FIELD.getFieldName(),</dt><dd><p>versionedTweetFeatures.getUserDisplayNameTokenStreamText(),
versionedTweetFeatures.getUserDisplayNameTokenStream());</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Build the geo fields.</p></li>
</ul>
<p><a href="#id9"><span class="problematic" id="id10">*</span></a>/</p>
</dd>
<dt>public static void buildGeoFields(</dt><dd><blockquote>
<div><p>EarlybirdThriftDocumentBuilder builder,
TwitterMessage message,
VersionedTweetFeatures versionedTweetFeatures) {</p>
</div></blockquote>
<p>double lat = GeoUtil.ILLEGAL_LATLON;
double lon = GeoUtil.ILLEGAL_LATLON;
if (message.getGeoLocation() != null) {</p>
<blockquote>
<div><p>GeoObject location = message.getGeoLocation();
builder.withGeoField(EarlybirdFieldConstant.GEO_HASH_FIELD.getFieldName(),</p>
<blockquote>
<div><p>location.getLatitude(), location.getLongitude(), location.getAccuracy());</p>
</div></blockquote>
<dl class="simple">
<dt>if (location.getSource() != null) {</dt><dd><dl class="simple">
<dt>builder.withStringField(EarlybirdFieldConstant.INTERNAL_FIELD.getFieldName(),</dt><dd><p>EarlybirdFieldConstants.formatGeoType(location.getSource()));</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>if (GeoUtil.validateGeoCoordinates(location.getLatitude(), location.getLongitude())) {</dt><dd><p>lat = location.getLatitude();
lon = location.getLongitude();</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}</p>
<p>// See SEARCH-14317 for investigation on how much space geo filed is used in archive cluster.
// In lucene archives, this CSF is needed regardless of whether geoLocation is set.
builder.withLatLonCSF(lat, lon);</p>
<dl>
<dt>if (versionedTweetFeatures.isSetTokenizedPlace()) {</dt><dd><p>Place place = versionedTweetFeatures.getTokenizedPlace();
Preconditions.checkArgument(place.isSetId(), “Place ID not set for tweet “</p>
<blockquote>
<div><ul class="simple">
<li><p>message.getId());</p></li>
</ul>
</div></blockquote>
<dl class="simple">
<dt>Preconditions.checkArgument(place.isSetFullName(),</dt><dd><p>“Place full name not set for tweet “ + message.getId());</p>
</dd>
</dl>
<p>builder.addFilterInternalFieldTerm(EarlybirdFieldConstant.PLACE_ID_FIELD.getFieldName());
builder</p>
<blockquote>
<div><p>.withStringField(EarlybirdFieldConstant.PLACE_ID_FIELD.getFieldName(), place.getId())
.withStringField(EarlybirdFieldConstant.PLACE_FULL_NAME_FIELD.getFieldName(),</p>
<blockquote>
<div><p>place.getFullName());</p>
</div></blockquote>
</div></blockquote>
<dl class="simple">
<dt>if (place.isSetCountryCode()) {</dt><dd><dl class="simple">
<dt>builder.withStringField(EarlybirdFieldConstant.PLACE_COUNTRY_CODE_FIELD.getFieldName(),</dt><dd><p>place.getCountryCode());</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>if (versionedTweetFeatures.isSetTokenizedProfileGeoEnrichment()) {</dt><dd><dl>
<dt>ProfileGeoEnrichment profileGeoEnrichment =</dt><dd><p>versionedTweetFeatures.getTokenizedProfileGeoEnrichment();</p>
</dd>
<dt>Preconditions.checkArgument(</dt><dd><p>profileGeoEnrichment.isSetPotentialLocations(),
“ProfileGeoEnrichment.potentialLocations not set for tweet “</p>
<blockquote>
<div><ul class="simple">
<li><p>message.getId());</p></li>
</ul>
</div></blockquote>
</dd>
</dl>
<p>List&lt;PotentialLocation&gt; potentialLocations = profileGeoEnrichment.getPotentialLocations();
Preconditions.checkArgument(</p>
<blockquote>
<div><p>!potentialLocations.isEmpty(),
“Found tweet with an empty ProfileGeoEnrichment.potentialLocations: “</p>
<blockquote>
<div><ul class="simple">
<li><p>message.getId());</p></li>
</ul>
</div></blockquote>
</div></blockquote>
<p>builder.addFilterInternalFieldTerm(EarlybirdFieldConstant.PROFILE_GEO_FILTER_TERM);
for (PotentialLocation potentialLocation : potentialLocations) {</p>
<blockquote>
<div><dl class="simple">
<dt>if (potentialLocation.isSetCountryCode()) {</dt><dd><dl class="simple">
<dt>builder.withStringField(</dt><dd><p>EarlybirdFieldConstant.PROFILE_GEO_COUNTRY_CODE_FIELD.getFieldName(),
potentialLocation.getCountryCode());</p>
</dd>
</dl>
</dd>
</dl>
<p>}
if (potentialLocation.isSetRegion()) {</p>
<blockquote>
<div><dl class="simple">
<dt>builder.withStringField(EarlybirdFieldConstant.PROFILE_GEO_REGION_FIELD.getFieldName(),</dt><dd><p>potentialLocation.getRegion());</p>
</dd>
</dl>
</div></blockquote>
<p>}
if (potentialLocation.isSetLocality()) {</p>
<blockquote>
<div><dl class="simple">
<dt>builder.withStringField(EarlybirdFieldConstant.PROFILE_GEO_LOCALITY_FIELD.getFieldName(),</dt><dd><p>potentialLocation.getLocality());</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}</p>
<p>builder.withPlacesField(message.getPlaces());</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Build the retweet and reply fields.</p></li>
</ul>
<p><a href="#id11"><span class="problematic" id="id12">*</span></a>/</p>
</dd>
<dt>public static void buildRetweetAndReplyFields(</dt><dd><blockquote>
<div><p>EarlybirdThriftDocumentBuilder builder,
TwitterMessage message,
boolean strict) {</p>
</div></blockquote>
<p>long retweetUserIdVal = -1;
long sharedStatusIdVal = -1;
if (message.getRetweetMessage() != null) {</p>
<blockquote>
<div><dl class="simple">
<dt>if (message.getRetweetMessage().getSharedId() != null) {</dt><dd><p>sharedStatusIdVal = message.getRetweetMessage().getSharedId();</p>
</dd>
</dl>
<p>}
if (message.getRetweetMessage().hasSharedUserTwitterId()) {</p>
<blockquote>
<div><p>retweetUserIdVal = message.getRetweetMessage().getSharedUserTwitterId();</p>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>}</p>
<p>long inReplyToStatusIdVal = -1;
long inReplyToUserIdVal = -1;
if (message.isReply()) {</p>
<blockquote>
<div><dl class="simple">
<dt>if (message.getInReplyToStatusId().isPresent()) {</dt><dd><p>inReplyToStatusIdVal = message.getInReplyToStatusId().get();</p>
</dd>
</dl>
<p>}
if (message.getToUserTwitterId().isPresent()) {</p>
<blockquote>
<div><p>inReplyToUserIdVal = message.getToUserTwitterId().get();</p>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>}</p>
<dl class="simple">
<dt>buildRetweetAndReplyFields(</dt><dd><p>retweetUserIdVal,
sharedStatusIdVal,
inReplyToStatusIdVal,
inReplyToUserIdVal,
strict,
builder);</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Build the quotes fields.</p></li>
</ul>
<p><a href="#id13"><span class="problematic" id="id14">*</span></a>/</p>
</dd>
<dt>public static void buildQuotesFields(</dt><dd><blockquote>
<div><p>EarlybirdThriftDocumentBuilder builder,
TwitterMessage message) {</p>
</div></blockquote>
<dl>
<dt>if (message.getQuotedMessage() != null) {</dt><dd><p>TwitterQuotedMessage quoted = message.getQuotedMessage();
if (quoted != null &amp;&amp; quoted.getQuotedStatusId() &gt; 0 &amp;&amp; quoted.getQuotedUserId() &gt; 0) {</p>
<blockquote>
<div><p>builder.withQuote(quoted.getQuotedStatusId(), quoted.getQuotedUserId());</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Build directed at field.</p></li>
</ul>
<p><a href="#id15"><span class="problematic" id="id16">*</span></a>/</p>
</dd>
<dt>public static void buildDirectedAtFields(</dt><dd><blockquote>
<div><p>EarlybirdThriftDocumentBuilder builder,
TwitterMessage message) {</p>
</div></blockquote>
<dl class="simple">
<dt>if (message.getDirectedAtUserId().isPresent() &amp;&amp; message.getDirectedAtUserId().get() &gt; 0) {</dt><dd><p>builder.withDirectedAtUser(message.getDirectedAtUserId().get());
builder.addFilterInternalFieldTerm(EarlybirdFieldConstant.DIRECTED_AT_FILTER_TERM);</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Build the versioned features for a tweet.</p></li>
</ul>
<p><a href="#id17"><span class="problematic" id="id18">*</span></a>/</p>
</dd>
<dt>public static void buildVersionedFeatureFields(</dt><dd><blockquote>
<div><p>EarlybirdThriftDocumentBuilder builder,
VersionedTweetFeatures versionedTweetFeatures) {</p>
</div></blockquote>
<dl>
<dt>builder</dt><dd><p>.withHashtagsField(versionedTweetFeatures.getHashtags())
.withMentionsField(versionedTweetFeatures.getMentions())
.withStocksFields(versionedTweetFeatures.getStocks())
.withResolvedLinksText(versionedTweetFeatures.getNormalizedResolvedUrlText())
.withTokenStreamField(EarlybirdFieldConstant.TEXT_FIELD.getFieldName(),</p>
<blockquote>
<div><p>versionedTweetFeatures.getTweetTokenStreamText(),
versionedTweetFeatures.isSetTweetTokenStream()</p>
<blockquote>
<div><p>? versionedTweetFeatures.getTweetTokenStream() : null)</p>
</div></blockquote>
</div></blockquote>
<dl class="simple">
<dt>.withStringField(EarlybirdFieldConstant.SOURCE_FIELD.getFieldName(),</dt><dd><p>versionedTweetFeatures.getSource())</p>
</dd>
<dt>.withStringField(EarlybirdFieldConstant.NORMALIZED_SOURCE_FIELD.getFieldName(),</dt><dd><p>versionedTweetFeatures.getNormalizedSource());</p>
</dd>
</dl>
</dd>
</dl>
<p>// Internal fields for smileys and question marks
if (versionedTweetFeatures.hasPositiveSmiley) {</p>
<blockquote>
<div><dl class="simple">
<dt>builder.withStringField(</dt><dd><p>EarlybirdFieldConstant.INTERNAL_FIELD.getFieldName(),
EarlybirdFieldConstant.HAS_POSITIVE_SMILEY);</p>
</dd>
</dl>
</div></blockquote>
<p>}
if (versionedTweetFeatures.hasNegativeSmiley) {</p>
<blockquote>
<div><dl class="simple">
<dt>builder.withStringField(</dt><dd><p>EarlybirdFieldConstant.INTERNAL_FIELD.getFieldName(),
EarlybirdFieldConstant.HAS_NEGATIVE_SMILEY);</p>
</dd>
</dl>
</div></blockquote>
<p>}
if (versionedTweetFeatures.hasQuestionMark) {</p>
<blockquote>
<div><dl class="simple">
<dt>builder.withStringField(EarlybirdFieldConstant.TEXT_FIELD.getFieldName(),</dt><dd><p>EarlybirdThriftDocumentBuilder.QUESTION_MARK);</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Build the escherbird annotations for a tweet.</p></li>
</ul>
<p><a href="#id19"><span class="problematic" id="id20">*</span></a>/</p>
</dd>
<dt>public static void buildAnnotationFields(</dt><dd><blockquote>
<div><p>EarlybirdThriftDocumentBuilder builder,
TwitterMessage message) {</p>
</div></blockquote>
<dl class="simple">
<dt>List&lt;TwitterMessage.EscherbirdAnnotation&gt; escherbirdAnnotations =</dt><dd><p>message.getEscherbirdAnnotations();</p>
</dd>
<dt>if (CollectionUtils.isEmpty(escherbirdAnnotations)) {</dt><dd><p>return;</p>
</dd>
</dl>
<p>}</p>
<p>builder.addFacetSkipList(EarlybirdFieldConstant.ENTITY_ID_FIELD.getFieldName());</p>
<dl>
<dt>for (TwitterMessage.EscherbirdAnnotation annotation<span class="classifier">escherbirdAnnotations) {</span></dt><dd><dl class="simple">
<dt>String groupDomainEntity = String.format(“%d.%d.%d”,</dt><dd><p>annotation.groupId, annotation.domainId, annotation.entityId);</p>
</dd>
</dl>
<p>String domainEntity = String.format(“%d.%d”, annotation.domainId, annotation.entityId);
String entity = String.format(“%d”, annotation.entityId);</p>
<dl class="simple">
<dt>builder.withStringField(EarlybirdFieldConstant.ENTITY_ID_FIELD.getFieldName(),</dt><dd><p>groupDomainEntity);</p>
</dd>
<dt>builder.withStringField(EarlybirdFieldConstant.ENTITY_ID_FIELD.getFieldName(),</dt><dd><p>domainEntity);</p>
</dd>
<dt>builder.withStringField(EarlybirdFieldConstant.ENTITY_ID_FIELD.getFieldName(),</dt><dd><p>entity);</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Build the correct ThriftIndexingEvent’s fields based on retweet and reply status.</p></li>
</ul>
<p><a href="#id21"><span class="problematic" id="id22">*</span></a>/</p>
</dd>
<dt>public static void buildRetweetAndReplyFields(</dt><dd><blockquote>
<div><p>long retweetUserIdVal,
long sharedStatusIdVal,
long inReplyToStatusIdVal,
long inReplyToUserIdVal,
boolean strict,
EarlybirdThriftDocumentBuilder builder) {</p>
</div></blockquote>
<p>Optional&lt;Long&gt; retweetUserId = Optional.of(retweetUserIdVal).filter(x -&gt; x &gt; 0);
Optional&lt;Long&gt; sharedStatusId = Optional.of(sharedStatusIdVal).filter(x -&gt; x &gt; 0);
Optional&lt;Long&gt; inReplyToUserId = Optional.of(inReplyToUserIdVal).filter(x -&gt; x &gt; 0);
Optional&lt;Long&gt; inReplyToStatusId = Optional.of(inReplyToStatusIdVal).filter(x -&gt; x &gt; 0);</p>
<p>// We have six combinations here. A Tweet can be
//   1) a reply to another tweet (then it has both in-reply-to-user-id and
//      in-reply-to-status-id set),
//   2) directed-at a user (then it only has in-reply-to-user-id set),
//   3) not a reply at all.
// Additionally, it may or may not be a Retweet (if it is, then it has retweet-user-id and
// retweet-status-id set).
//
// We want to set some fields unconditionally, and some fields (reference-author-id and
// shared-status-id) depending on the reply/retweet combination.
//
// 1. Normal tweet (not a reply, not a retweet). None of the fields should be set.
//
// 2. Reply to a tweet (both in-reply-to-user-id and in-reply-to-status-id set).
//   IN_REPLY_TO_USER_ID_FIELD    should be set to in-reply-to-user-id
//   SHARED_STATUS_ID_CSF         should be set to in-reply-to-status-id
//   IS_REPLY_FLAG                should be set
//
// 3. Directed-at a user (only in-reply-to-user-id is set).
//   IN_REPLY_TO_USER_ID_FIELD    should be set to in-reply-to-user-id
//   IS_REPLY_FLAG                should be set
//
// 4. Retweet of a normal tweet (retweet-user-id and retweet-status-id are set).
//   RETWEET_SOURCE_USER_ID_FIELD should be set to retweet-user-id
//   SHARED_STATUS_ID_CSF         should be set to retweet-status-id
//   IS_RETWEET_FLAG              should be set
//
// 5. Retweet of a reply (both in-reply-to-user-id and in-reply-to-status-id set,
// retweet-user-id and retweet-status-id are set).
//   RETWEET_SOURCE_USER_ID_FIELD should be set to retweet-user-id
//   SHARED_STATUS_ID_CSF         should be set to retweet-status-id (retweet beats reply!)
//   IS_RETWEET_FLAG              should be set
//   IN_REPLY_TO_USER_ID_FIELD    should be set to in-reply-to-user-id
//   IS_REPLY_FLAG                should NOT be set
//
// 6. Retweet of a directed-at tweet (only in-reply-to-user-id is set,
// retweet-user-id and retweet-status-id are set).
//   RETWEET_SOURCE_USER_ID_FIELD should be set to retweet-user-id
//   SHARED_STATUS_ID_CSF         should be set to retweet-status-id
//   IS_RETWEET_FLAG              should be set
//   IN_REPLY_TO_USER_ID_FIELD    should be set to in-reply-to-user-id
//   IS_REPLY_FLAG                should NOT be set
//
// In other words:
// SHARED_STATUS_ID_CSF logic: if this is a retweet SHARED_STATUS_ID_CSF should be set to
// retweet-status-id, otherwise if it’s a reply to a tweet, it should be set to
// in-reply-to-status-id.</p>
<p>Preconditions.checkState(retweetUserId.isPresent() == sharedStatusId.isPresent());</p>
<dl>
<dt>if (retweetUserId.isPresent()) {</dt><dd><p>builder.withNativeRetweet(retweetUserId.get(), sharedStatusId.get());</p>
<dl class="simple">
<dt>if (inReplyToUserId.isPresent()) {</dt><dd><p>// Set IN_REPLY_TO_USER_ID_FIELD even if this is a retweet of a reply.
builder.withInReplyToUserID(inReplyToUserId.get());</p>
</dd>
</dl>
<p>}</p>
</dd>
<dt>} else {</dt><dd><p>// If this is a retweet of a reply, we don’t want to mark it as a reply, or override fields
// set by the retweet logic.
// If we are in this branch, this is not a retweet. Potentially, we set the reply flag,
// and override shared-status-id and reference-author-id.</p>
<dl>
<dt>if (inReplyToStatusId.isPresent()) {</dt><dd><dl class="simple">
<dt>if (strict) {</dt><dd><p>// Enforcing that if this is a reply to a tweet, then it also has a replied-to user.
Preconditions.checkState(inReplyToUserId.isPresent());</p>
</dd>
</dl>
<p>}
builder.withReplyFlag();
builder.withLongField(</p>
<blockquote>
<div><p>EarlybirdFieldConstant.SHARED_STATUS_ID_CSF.getFieldName(),
inReplyToStatusId.get());</p>
</div></blockquote>
<dl class="simple">
<dt>builder.withLongField(</dt><dd><p>EarlybirdFieldConstant.IN_REPLY_TO_TWEET_ID_FIELD.getFieldName(),
inReplyToStatusId.get());</p>
</dd>
</dl>
</dd>
</dl>
<p>}
if (inReplyToUserId.isPresent()) {</p>
<blockquote>
<div><p>builder.withReplyFlag();
builder.withInReplyToUserID(inReplyToUserId.get());</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Build the engagement fields.</p></li>
</ul>
<p><a href="#id23"><span class="problematic" id="id24">*</span></a>/</p>
</dd>
<dt>public static void buildNormalizedMinEngagementFields(</dt><dd><blockquote>
<div><p>EarlybirdThriftDocumentBuilder builder,
EarlybirdEncodedFeatures encodedFeatures,
EarlybirdCluster cluster) throws IOException {</p>
</div></blockquote>
<dl>
<dt>if (EarlybirdCluster.isArchive(cluster)) {</dt><dd><p>int favoriteCount = encodedFeatures.getFeatureValue(EarlybirdFieldConstant.FAVORITE_COUNT);
int retweetCount = encodedFeatures.getFeatureValue(EarlybirdFieldConstant.RETWEET_COUNT);
int replyCount = encodedFeatures.getFeatureValue(EarlybirdFieldConstant.REPLY_COUNT);
builder</p>
<blockquote>
<div><dl>
<dt>.withNormalizedMinEngagementField(</dt><dd><dl class="simple">
<dt>EarlybirdFieldConstant.NORMALIZED_FAVORITE_COUNT_GREATER_THAN_OR_EQUAL_TO_FIELD</dt><dd><p>.getFieldName(),</p>
</dd>
</dl>
<p>favoriteCount);</p>
</dd>
</dl>
</div></blockquote>
<dl>
<dt>builder</dt><dd><dl>
<dt>.withNormalizedMinEngagementField(</dt><dd><dl class="simple">
<dt>EarlybirdFieldConstant.NORMALIZED_RETWEET_COUNT_GREATER_THAN_OR_EQUAL_TO_FIELD</dt><dd><p>.getFieldName(),</p>
</dd>
</dl>
<p>retweetCount);</p>
</dd>
</dl>
</dd>
<dt>builder</dt><dd><dl>
<dt>.withNormalizedMinEngagementField(</dt><dd><dl class="simple">
<dt>EarlybirdFieldConstant.NORMALIZED_REPLY_COUNT_GREATER_THAN_OR_EQUAL_TO_FIELD</dt><dd><p>.getFieldName(),</p>
</dd>
</dl>
<p>replyCount);</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>As seen in SEARCH-5617, we sometimes have incorrect createdAt. This method tries to fix them</p></li>
<li><p>by extracting creation time from snowflake when possible.</p></li>
</ul>
<p><a href="#id25"><span class="problematic" id="id26">*</span></a>/</p>
</dd>
<dt>public static long fixCreatedAtTimeStampIfNecessary(long id, long createdAtMs) {</dt><dd><dl>
<dt>if (createdAtMs &lt; VALID_CREATION_TIME_THRESHOLD_MILLIS</dt><dd><blockquote>
<div><p>&amp;&amp; id &gt; SnowflakeIdParser.SNOWFLAKE_ID_LOWER_BOUND) {</p>
</div></blockquote>
<p>// This tweet has a snowflake ID, and we can extract timestamp from the ID.
ADJUSTED_BAD_CREATED_AT_COUNTER.increment();
return SnowflakeIdParser.getTimestampFromTweetId(id);</p>
</dd>
<dt>} else if (!SnowflakeIdParser.isTweetIDAndCreatedAtConsistent(id, createdAtMs)) {</dt><dd><dl class="simple">
<dt>LOG.error(</dt><dd><p>“Found inconsistent tweet ID and created at timestamp: [statusID={}], [createdAtMs={}]”,
id, createdAtMs);</p>
</dd>
</dl>
<p>INCONSISTENT_TWEET_ID_AND_CREATED_AT_MS.increment();</p>
</dd>
</dl>
<p>}</p>
<p>return createdAtMs;</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}</p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../../../index.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../../../_sources/src/java/com/twitter/search/common/converter/earlybird/BasicIndexingConverter.java.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>