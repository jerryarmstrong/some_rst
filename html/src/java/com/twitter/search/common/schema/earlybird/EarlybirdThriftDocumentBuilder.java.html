<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../../../" id="documentation_options" src="../../../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>package com.twitter.search.common.schema.earlybird;</p>
<p>import java.io.IOException;
import java.util.HashSet;
import java.util.List;
import java.util.Set;
import javax.annotation.Nonnull;
import javax.annotation.Nullable;</p>
<p>import com.google.common.annotations.VisibleForTesting;
import com.google.common.base.Preconditions;
import com.google.common.collect.ImmutableList;
import com.google.common.collect.ImmutableSet;
import com.google.common.collect.Sets;</p>
<p>import org.apache.commons.lang.StringUtils;
import org.apache.lucene.analysis.TokenStream;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;</p>
<p>import com.twitter.common.collections.Pair;
import com.twitter.common.text.util.TokenStreamSerializer;
import com.twitter.cuad.ner.plain.thriftjava.NamedEntity;
import com.twitter.cuad.ner.plain.thriftjava.NamedEntityContext;
import com.twitter.cuad.ner.plain.thriftjava.NamedEntityInputSourceType;
import com.twitter.cuad.ner.thriftjava.WholeEntityType;
import com.twitter.search.common.constants.SearchCardType;
import com.twitter.search.common.indexing.thriftjava.ThriftExpandedUrl;
import com.twitter.search.common.indexing.thriftjava.ThriftGeoLocationSource;
import com.twitter.search.common.indexing.thriftjava.TwitterPhotoUrl;
import com.twitter.search.common.metrics.SearchCounter;
import com.twitter.search.common.schema.ThriftDocumentBuilder;
import com.twitter.search.common.schema.base.FieldNameToIdMapping;
import com.twitter.search.common.schema.base.Schema;
import com.twitter.search.common.schema.earlybird.EarlybirdFieldConstants.EarlybirdFieldConstant;
import com.twitter.search.common.util.analysis.CharTermAttributeSerializer;
import com.twitter.search.common.util.analysis.IntTermAttributeSerializer;
import com.twitter.search.common.util.analysis.TermPayloadAttributeSerializer;
import com.twitter.search.common.util.analysis.TwitterPhotoTokenStream;
import com.twitter.search.common.util.spatial.GeoUtil;
import com.twitter.search.common.util.text.TokenizerHelper;
import com.twitter.search.common.util.text.TweetTokenStreamSerializer;
import com.twitter.search.common.util.text.regex.Regex;
import com.twitter.search.common.util.url.LinkVisibilityUtils;
import com.twitter.search.common.util.url.URLUtils;</p>
<p>import geo.google.datamodel.GeoAddressAccuracy;
import com.twitter.search.common.schema.thriftjava.ThriftDocument;</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Builder class for building a <a class="reference external" href="mailto:{&#37;&#52;&#48;link">{<span>&#64;</span>link</a> ThriftDocument}.</p></li>
</ul>
<p><a href="#id1"><span class="problematic" id="id2">*</span></a>/</p>
</dd>
<dt>public final class EarlybirdThriftDocumentBuilder extends ThriftDocumentBuilder {</dt><dd><p>private static final Logger LOG = LoggerFactory.getLogger(EarlybirdThriftDocumentBuilder.class);</p>
<dl class="simple">
<dt>private static final SearchCounter SERIALIZE_FAILURE_COUNT_NONPENGUIN_DEPENDENT =</dt><dd><p>SearchCounter.export(“tokenstream_serialization_failure_non_penguin_dependent”);</p>
</dd>
</dl>
<p>private static final String HASHTAG_SYMBOL = “#”;
private static final String CASHTAG_SYMBOL = “$”;
private static final String MENTION_SYMBOL = “&#64;”;</p>
<dl>
<dt>private static final SearchCounter BCP47_LANGUAGE_TAG_COUNTER =</dt><dd><p>SearchCounter.export(“bcp47_language_tag”);</p>
</dd>
<dt>/**</dt><dd><ul class="simple">
<li><p>Used to check if a card is video card.</p></li>
<li></li>
<li><p>&#64;see #withSearchCard</p></li>
</ul>
<p><a href="#id3"><span class="problematic" id="id4">*</span></a>/</p>
</dd>
</dl>
<p>private static final String AMPLIFY_CARD_NAME = “amplify”;
private static final String PLAYER_CARD_NAME = “player”;</p>
<p>// Extra term indexed for native retweets, to ensure that the “-rt” query excludes them.
public static final String RETWEET_TERM = “rt”;
public static final String QUESTION_MARK = “?”;</p>
<dl class="simple">
<dt>private static final Set&lt;NamedEntityInputSourceType&gt; NAMED_ENTITY_URL_SOURCE_TYPES =</dt><dd><dl class="simple">
<dt>ImmutableSet.of(</dt><dd><p>NamedEntityInputSourceType.URL_TITLE, NamedEntityInputSourceType.URL_DESCRIPTION);</p>
</dd>
</dl>
</dd>
<dt>private final TokenStreamSerializer intTermAttributeSerializer =</dt><dd><dl class="simple">
<dt>new TokenStreamSerializer(ImmutableList.of(</dt><dd><p>new IntTermAttributeSerializer()));</p>
</dd>
</dl>
</dd>
<dt>private final TokenStreamSerializer photoUrlSerializer =</dt><dd><dl class="simple">
<dt>new TokenStreamSerializer(ImmutableList</dt><dd><dl class="simple">
<dt>.&lt;TokenStreamSerializer.AttributeSerializer&gt;of(</dt><dd><p>new CharTermAttributeSerializer(), new TermPayloadAttributeSerializer()));</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p>private final Schema schema;</p>
<p>private boolean isSetLatLonCSF = false;
private boolean addLatLonCSF = true;
private boolean addEncodedTweetFeatures = true;</p>
<p>&#64;Nonnull
private final EarlybirdEncodedFeatures encodedTweetFeatures;
&#64;Nullable
private final EarlybirdEncodedFeatures extendedEncodedTweetFeatures;</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Default constructor</p></li>
</ul>
<p><a href="#id5"><span class="problematic" id="id6">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder(</dt><dd><blockquote>
<div><p>&#64;Nonnull EarlybirdEncodedFeatures encodedTweetFeatures,
&#64;Nullable EarlybirdEncodedFeatures extendedEncodedTweetFeatures,
FieldNameToIdMapping idMapping,
Schema schema) {</p>
</div></blockquote>
<p>super(idMapping);
this.schema = schema;
this.encodedTweetFeatures = Preconditions.checkNotNull(encodedTweetFeatures);</p>
<p>this.extendedEncodedTweetFeatures = extendedEncodedTweetFeatures;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Get internal <a class="reference external" href="mailto:{&#37;&#52;&#48;link">{<span>&#64;</span>link</a> EarlybirdEncodedFeatures}</p></li>
</ul>
<p><a href="#id7"><span class="problematic" id="id8">*</span></a>/</p>
</dd>
<dt>public EarlybirdEncodedFeatures getEncodedTweetFeatures() {</dt><dd><p>return encodedTweetFeatures;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add skip list entry for the given field.</p></li>
<li><p>This adds a term __has_fieldName in the INTERNAL field.</p></li>
</ul>
<p><a href="#id9"><span class="problematic" id="id10">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder addFacetSkipList(String fieldName) {</dt><dd><dl class="simple">
<dt>withStringField(EarlybirdFieldConstant.INTERNAL_FIELD.getFieldName(),</dt><dd><p>EarlybirdFieldConstant.getFacetSkipFieldName(fieldName));</p>
</dd>
</dl>
<p>return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add a filter term in the INTERNAL field.</p></li>
</ul>
<p><a href="#id11"><span class="problematic" id="id12">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder addFilterInternalFieldTerm(String filterName) {</dt><dd><dl class="simple">
<dt>withStringField(EarlybirdFieldConstant.INTERNAL_FIELD.getFieldName(),</dt><dd><p>EarlybirdThriftDocumentUtil.formatFilter(filterName));</p>
</dd>
</dl>
<p>return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add id field and id csf field.</p></li>
</ul>
<p><a href="#id13"><span class="problematic" id="id14">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withID(long id) {</dt><dd><p>withLongField(EarlybirdFieldConstant.ID_FIELD.getFieldName(), id);
withLongField(EarlybirdFieldConstant.ID_CSF_FIELD.getFieldName(), id);
return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add created at field and created at csf field.</p></li>
</ul>
<p><a href="#id15"><span class="problematic" id="id16">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withCreatedAt(int createdAt) {</dt><dd><p>withIntField(EarlybirdFieldConstant.CREATED_AT_FIELD.getFieldName(), createdAt);
withIntField(EarlybirdFieldConstant.CREATED_AT_CSF_FIELD.getFieldName(), createdAt);
return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add tweet text field.</p></li>
</ul>
<p><a href="#id17"><span class="problematic" id="id18">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withTweetText(</dt><dd><blockquote>
<div><p>String text, byte[] textTokenStream) throws IOException {</p>
</div></blockquote>
<dl class="simple">
<dt>withTokenStreamField(EarlybirdFieldConstants.EarlybirdFieldConstant.TEXT_FIELD.getFieldName(),</dt><dd><p>text, textTokenStream);</p>
</dd>
</dl>
<p>return this;</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>public EarlybirdThriftDocumentBuilder withTweetText(String text) throws IOException {</dt><dd><p>withTweetText(text, null);
return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add a list of cashTags. Like $TWTR.</p></li>
</ul>
<p><a href="#id19"><span class="problematic" id="id20">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withStocksFields(List&lt;String&gt; cashTags) {</dt><dd><dl>
<dt>if (isNotEmpty(cashTags)) {</dt><dd><p>addFacetSkipList(EarlybirdFieldConstant.STOCKS_FIELD.getFieldName());
for (String cashTag : cashTags) {</p>
<blockquote>
<div><dl class="simple">
<dt>withStringField(</dt><dd><p>EarlybirdFieldConstant.STOCKS_FIELD.getFieldName(), CASHTAG_SYMBOL + cashTag);</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}
return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add a list of hashtags.</p></li>
</ul>
<p><a href="#id21"><span class="problematic" id="id22">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withHashtagsField(List&lt;String&gt; hashtags) {</dt><dd><dl>
<dt>if (isNotEmpty(hashtags)) {</dt><dd><dl>
<dt>int numHashtags = Math.min(</dt><dd><p>hashtags.size(),
schema.getFeatureConfigurationById(</p>
<blockquote>
<div><p>EarlybirdFieldConstant.NUM_HASHTAGS.getFieldId()).getMaxValue());</p>
</div></blockquote>
</dd>
</dl>
<p>encodedTweetFeatures.setFeatureValue(EarlybirdFieldConstant.NUM_HASHTAGS, numHashtags);
addFacetSkipList(EarlybirdFieldConstant.HASHTAGS_FIELD.getFieldName());
for (String hashtag : hashtags) {</p>
<blockquote>
<div><dl class="simple">
<dt>withStringField(</dt><dd><p>EarlybirdFieldConstant.HASHTAGS_FIELD.getFieldName(), HASHTAG_SYMBOL + hashtag);</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}
return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Added a list of mentions.</p></li>
</ul>
<p><a href="#id23"><span class="problematic" id="id24">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withMentionsField(List&lt;String&gt; mentions) {</dt><dd><dl>
<dt>if (isNotEmpty(mentions)) {</dt><dd><dl>
<dt>int numMentions = Math.min(</dt><dd><p>mentions.size(),
schema.getFeatureConfigurationById(</p>
<blockquote>
<div><p>EarlybirdFieldConstant.NUM_HASHTAGS.getFieldId()).getMaxValue());</p>
</div></blockquote>
</dd>
</dl>
<p>encodedTweetFeatures.setFeatureValue(EarlybirdFieldConstant.NUM_MENTIONS, numMentions);
addFacetSkipList(EarlybirdFieldConstant.MENTIONS_FIELD.getFieldName());
for (String mention : mentions) {</p>
<blockquote>
<div><dl class="simple">
<dt>withStringField(</dt><dd><p>EarlybirdFieldConstant.MENTIONS_FIELD.getFieldName(), MENTION_SYMBOL + mention);</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}
return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add a list of Twitter Photo URLs (twimg URLs). These are different from regular URLs, because</p></li>
<li><p>we use the TwitterPhotoTokenStream to index them, and we also include the status ID as payload.</p></li>
</ul>
<p><a href="#id25"><span class="problematic" id="id26">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withTwimgURLs(</dt><dd><blockquote>
<div><p>List&lt;TwitterPhotoUrl&gt; urls) throws IOException {</p>
</div></blockquote>
<dl>
<dt>if (isNotEmpty(urls)) {</dt><dd><dl>
<dt>for (TwitterPhotoUrl photoUrl<span class="classifier">urls) {</span></dt><dd><dl class="simple">
<dt>TokenStream ts = new TwitterPhotoTokenStream(photoUrl.getPhotoStatusId(),</dt><dd><p>photoUrl.getMediaUrl());</p>
</dd>
</dl>
<p>byte[] serializedTs = photoUrlSerializer.serialize(ts);
withTokenStreamField(EarlybirdFieldConstant.TWIMG_LINKS_FIELD.getFieldName(),</p>
<blockquote>
<div><p>Long.toString(photoUrl.getPhotoStatusId()), serializedTs);</p>
</div></blockquote>
<p>addFacetSkipList(EarlybirdFieldConstant.TWIMG_LINKS_FIELD.getFieldName());</p>
</dd>
</dl>
<p>}
encodedTweetFeatures.setFlag(EarlybirdFieldConstant.HAS_IMAGE_URL_FLAG);
encodedTweetFeatures.setFlag(EarlybirdFieldConstant.HAS_NATIVE_IMAGE_FLAG);</p>
</dd>
</dl>
<p>}
return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add a list of URLs. This also add facet skip list terms for news / images / videos if needed.</p></li>
</ul>
<p><a href="#id27"><span class="problematic" id="id28">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withURLs(List&lt;ThriftExpandedUrl&gt; urls) {</dt><dd><dl>
<dt>if (isNotEmpty(urls)) {</dt><dd><p>Set&lt;String&gt; dedupedLinks = Sets.newHashSet();</p>
<dl>
<dt>for (ThriftExpandedUrl expandedUrl<span class="classifier">urls) {</span></dt><dd><dl class="simple">
<dt>if (expandedUrl.isSetOriginalUrl()) {</dt><dd><p>String normalizedOriginalUrl = URLUtils.normalizePath(expandedUrl.getOriginalUrl());
dedupedLinks.add(normalizedOriginalUrl);</p>
</dd>
</dl>
<p>}
if (expandedUrl.isSetExpandedUrl()) {</p>
<blockquote>
<div><p>dedupedLinks.add(URLUtils.normalizePath(expandedUrl.getExpandedUrl()));</p>
</div></blockquote>
<p>}</p>
<dl>
<dt>if (expandedUrl.isSetCanonicalLastHopUrl()) {</dt><dd><p>String url = URLUtils.normalizePath(expandedUrl.getCanonicalLastHopUrl());
dedupedLinks.add(url);</p>
<p>String facetUrl = URLUtils.normalizeFacetURL(url);</p>
<dl>
<dt>if (expandedUrl.isSetMediaType()) {</dt><dd><dl class="simple">
<dt>switch (expandedUrl.getMediaType()) {</dt><dd><dl class="simple">
<dt>case NEWS:</dt><dd><p>withStringField(EarlybirdFieldConstant.NEWS_LINKS_FIELD.getFieldName(), url);
addFacetSkipList(EarlybirdFieldConstant.NEWS_LINKS_FIELD.getFieldName());
encodedTweetFeatures.setFlag(EarlybirdFieldConstant.HAS_NEWS_URL_FLAG);
break;</p>
</dd>
<dt>case VIDEO:</dt><dd><p>withStringField(EarlybirdFieldConstant.VIDEO_LINKS_FIELD.getFieldName(), facetUrl);
addFacetSkipList(EarlybirdFieldConstant.VIDEO_LINKS_FIELD.getFieldName());
encodedTweetFeatures.setFlag(EarlybirdFieldConstant.HAS_VIDEO_URL_FLAG);
break;</p>
</dd>
<dt>case IMAGE:</dt><dd><p>withStringField(EarlybirdFieldConstant.IMAGE_LINKS_FIELD.getFieldName(), facetUrl);
addFacetSkipList(EarlybirdFieldConstant.IMAGE_LINKS_FIELD.getFieldName());
encodedTweetFeatures.setFlag(EarlybirdFieldConstant.HAS_IMAGE_URL_FLAG);
break;</p>
</dd>
<dt>case NATIVE_IMAGE:</dt><dd><p>// Nothing done here. Native images are handled separately.
// They are in PhotoUrls instead of expandedUrls.
break;</p>
</dd>
<dt>case UNKNOWN:</dt><dd><p>break;</p>
</dd>
<dt>default:</dt><dd><p>throw new RuntimeException(“Unknown Media Type: “ + expandedUrl.getMediaType());</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>if (expandedUrl.isSetLinkCategory()) {</dt><dd><dl class="simple">
<dt>withIntField(EarlybirdFieldConstant.LINK_CATEGORY_FIELD.getFieldName(),</dt><dd><p>expandedUrl.getLinkCategory().getValue());</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>if (!dedupedLinks.isEmpty()) {</dt><dd><p>encodedTweetFeatures.setFlag(EarlybirdFieldConstant.HAS_LINK_FLAG);</p>
<p>addFacetSkipList(EarlybirdFieldConstant.LINKS_FIELD.getFieldName());</p>
<dl class="simple">
<dt>for (String linkUrl<span class="classifier">dedupedLinks) {</span></dt><dd><p>withStringField(EarlybirdFieldConstant.LINKS_FIELD.getFieldName(), linkUrl);</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>encodedTweetFeatures.setFlagValue(</dt><dd><p>EarlybirdFieldConstant.HAS_VISIBLE_LINK_FLAG,
LinkVisibilityUtils.hasVisibleLink(urls));</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<p>return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add a list of places. The place are U64 encoded place IDs.</p></li>
</ul>
<p><a href="#id29"><span class="problematic" id="id30">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withPlacesField(List&lt;String&gt; places) {</dt><dd><dl>
<dt>if (isNotEmpty(places)) {</dt><dd><dl class="simple">
<dt>for (String place<span class="classifier">places) {</span></dt><dd><p>withStringField(EarlybirdFieldConstant.PLACE_FIELD.getFieldName(), place);</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}
return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add tweet text signature field.</p></li>
</ul>
<p><a href="#id31"><span class="problematic" id="id32">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withTweetSignature(int signature) {</dt><dd><p>encodedTweetFeatures.setFeatureValue(EarlybirdFieldConstant.TWEET_SIGNATURE, signature);
return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add geo hash field and internal filter field.</p></li>
</ul>
<p><a href="#id33"><span class="problematic" id="id34">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withGeoHash(double lat, double lon, int accuracy) {</dt><dd><dl>
<dt>if (GeoUtil.validateGeoCoordinates(lat, lon)) {</dt><dd><dl class="simple">
<dt>withGeoField(</dt><dd><p>EarlybirdFieldConstant.GEO_HASH_FIELD.getFieldName(),
lat, lon, accuracy);</p>
</dd>
</dl>
<p>withLatLonCSF(lat, lon);</p>
</dd>
</dl>
<p>}
return this;</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>public EarlybirdThriftDocumentBuilder withGeoHash(double lat, double lon) {</dt><dd><p>withGeoHash(lat, lon, GeoAddressAccuracy.UNKNOWN_LOCATION.getCode());
return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add geo location source to the internal field with ThriftGeoLocationSource object.</p></li>
</ul>
<p><a href="#id35"><span class="problematic" id="id36">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withGeoLocationSource(</dt><dd><blockquote>
<div><p>ThriftGeoLocationSource geoLocationSource) {</p>
</div></blockquote>
<dl class="simple">
<dt>if (geoLocationSource != null) {</dt><dd><p>withGeoLocationSource(EarlybirdFieldConstants.formatGeoType(geoLocationSource));</p>
</dd>
</dl>
<p>}
return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add geo location source to the internal field.</p></li>
</ul>
<p><a href="#id37"><span class="problematic" id="id38">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withGeoLocationSource(String geoLocationSource) {</dt><dd><p>withStringField(EarlybirdFieldConstant.INTERNAL_FIELD.getFieldName(), geoLocationSource);
return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add encoded lat and lon to LatLonCSF field.</p></li>
</ul>
<p><a href="#id39"><span class="problematic" id="id40">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withLatLonCSF(double lat, double lon) {</dt><dd><p>isSetLatLonCSF = true;
long encodedLatLon = GeoUtil.encodeLatLonIntoInt64((float) lat, (float) lon);
withLongField(EarlybirdFieldConstant.LAT_LON_CSF_FIELD.getFieldName(), encodedLatLon);
return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add from verified account flag to internal field.</p></li>
</ul>
<p><a href="#id41"><span class="problematic" id="id42">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withFromVerifiedAccountFlag() {</dt><dd><p>encodedTweetFeatures.setFlag(EarlybirdFieldConstant.FROM_VERIFIED_ACCOUNT_FLAG);
addFilterInternalFieldTerm(EarlybirdFieldConstant.VERIFIED_FILTER_TERM);
return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add from blue-verified account flag to internal field.</p></li>
</ul>
<p><a href="#id43"><span class="problematic" id="id44">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withFromBlueVerifiedAccountFlag() {</dt><dd><p>encodedTweetFeatures.setFlag(EarlybirdFieldConstant.FROM_BLUE_VERIFIED_ACCOUNT_FLAG);
addFilterInternalFieldTerm(EarlybirdFieldConstant.BLUE_VERIFIED_FILTER_TERM);
return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add offensive flag to internal field.</p></li>
</ul>
<p><a href="#id45"><span class="problematic" id="id46">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withOffensiveFlag() {</dt><dd><p>encodedTweetFeatures.setFlag(EarlybirdFieldConstant.IS_OFFENSIVE_FLAG);
withStringField(</p>
<blockquote>
<div><p>EarlybirdFieldConstant.INTERNAL_FIELD.getFieldName(),
EarlybirdFieldConstant.IS_OFFENSIVE);</p>
</div></blockquote>
<p>return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add user reputation value to encoded feature.</p></li>
</ul>
<p><a href="#id47"><span class="problematic" id="id48">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withUserReputation(byte score) {</dt><dd><p>encodedTweetFeatures.setFeatureValue(EarlybirdFieldConstant.USER_REPUTATION, score);
return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>This method creates the fields related to document language.</p></li>
<li><p>For most languages, their isoLanguageCode and bcp47LanguageTag are the same.</p></li>
<li><p>For some languages with variants, these two fields are different.</p></li>
<li><p>E.g. for simplified Chinese, their isoLanguageCode is zh, but their bcp47LanguageTag is zh-cn.</p></li>
<li><p>&lt;p&gt;</p></li>
<li><p>This method adds fields for both the isoLanguageCode and bcp47LanguageTag.</p></li>
</ul>
<p><a href="#id49"><span class="problematic" id="id50">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withLanguageCodes(</dt><dd><blockquote>
<div><p>String isoLanguageCode, String bcp47LanguageTag) {</p>
</div></blockquote>
<dl class="simple">
<dt>if (isoLanguageCode != null) {</dt><dd><p>withISOLanguage(isoLanguageCode);</p>
</dd>
</dl>
<p>}
if (bcp47LanguageTag != null &amp;&amp; !bcp47LanguageTag.equals(isoLanguageCode)) {</p>
<blockquote>
<div><p>BCP47_LANGUAGE_TAG_COUNTER.increment();
withISOLanguage(bcp47LanguageTag);</p>
</div></blockquote>
<p>}
return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Adds a String field into the ISO_LANGUAGE_FIELD.</p></li>
</ul>
<p><a href="#id51"><span class="problematic" id="id52">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withISOLanguage(String languageString) {</dt><dd><dl class="simple">
<dt>withStringField(</dt><dd><p>EarlybirdFieldConstant.ISO_LANGUAGE_FIELD.getFieldName(), languageString.toLowerCase());</p>
</dd>
</dl>
<p>return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add from user ID fields.</p></li>
</ul>
<p><a href="#id53"><span class="problematic" id="id54">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withFromUserID(long fromUserId) {</dt><dd><p>withLongField(EarlybirdFieldConstant.FROM_USER_ID_FIELD.getFieldName(), fromUserId);
withLongField(EarlybirdFieldConstant.FROM_USER_ID_CSF.getFieldName(), fromUserId);
return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add from user information fields.</p></li>
</ul>
<p><a href="#id55"><span class="problematic" id="id56">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withFromUser(</dt><dd><blockquote>
<div><p>long fromUserId, String fromUser) {</p>
</div></blockquote>
<p>withFromUser(fromUserId, fromUser, null);
return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add from user information fields.</p></li>
</ul>
<p><a href="#id57"><span class="problematic" id="id58">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withFromUser(String fromUser) {</dt><dd><p>withFromUser(fromUser, null);
return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add from user information fields.</p></li>
</ul>
<p><a href="#id59"><span class="problematic" id="id60">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withFromUser(</dt><dd><blockquote>
<div><p>String fromUser, String tokenizedFromUser) {</p>
</div></blockquote>
<p>withStringField(EarlybirdFieldConstant.FROM_USER_FIELD.getFieldName(), fromUser);
withStringField(EarlybirdFieldConstant.TOKENIZED_FROM_USER_FIELD.getFieldName(),</p>
<blockquote>
<div><p>isNotBlank(tokenizedFromUser) ? tokenizedFromUser : fromUser);</p>
</div></blockquote>
<p>return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add from user information fields.</p></li>
</ul>
<p><a href="#id61"><span class="problematic" id="id62">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withFromUser(</dt><dd><blockquote>
<div><p>long fromUserId, String fromUser, String tokenizedFromUser) {</p>
</div></blockquote>
<p>withFromUserID(fromUserId);
withFromUser(fromUser, tokenizedFromUser);
return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add to user field.</p></li>
</ul>
<p><a href="#id63"><span class="problematic" id="id64">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withToUser(</dt><dd><blockquote>
<div><p>String toUser) {</p>
</div></blockquote>
<p>withStringField(EarlybirdFieldConstant.TO_USER_FIELD.getFieldName(), toUser);
return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add escherbird annotation fields.</p></li>
</ul>
<p><a href="#id65"><span class="problematic" id="id66">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withAnnotationEntities(List&lt;String&gt; entities) {</dt><dd><dl>
<dt>if (isNotEmpty(entities)) {</dt><dd><dl class="simple">
<dt>for (String entity<span class="classifier">entities) {</span></dt><dd><p>withStringField(EarlybirdFieldConstant.ENTITY_ID_FIELD.getFieldName(), entity);</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}
return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add replies to internal field and set is reply flag.</p></li>
</ul>
<p><a href="#id67"><span class="problematic" id="id68">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withReplyFlag() {</dt><dd><p>encodedTweetFeatures.setFlag(EarlybirdFieldConstant.IS_REPLY_FLAG);
addFilterInternalFieldTerm(EarlybirdFieldConstant.REPLIES_FILTER_TERM);
return this;</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>public EarlybirdThriftDocumentBuilder withCameraComposerSourceFlag() {</dt><dd><p>encodedTweetFeatures.setFlag(EarlybirdFieldConstant.COMPOSER_SOURCE_IS_CAMERA_FLAG);
return this;</p>
</dd>
</dl>
<p>}</p>
<blockquote>
<div><dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add in reply to user id.</p></li>
<li><p>&lt;p&gt;</p></li>
<li><p>Notice <a class="reference external" href="mailto:{&#37;&#52;&#48;link">{<span>&#64;</span>link</a> #withReplyFlag} is not automatically called since retweet a tweet that is</p></li>
<li><p>a reply to some other tweet is not considered a reply.</p></li>
<li><p>The caller should call <a class="reference external" href="mailto:{&#37;&#52;&#48;link">{<span>&#64;</span>link</a> #withReplyFlag} separately if this tweet is really a reply tweet.</p></li>
</ul>
<p><a href="#id69"><span class="problematic" id="id70">*</span></a>/</p>
</dd>
</dl>
</div></blockquote>
<dl class="simple">
<dt>public EarlybirdThriftDocumentBuilder withInReplyToUserID(long inReplyToUserID) {</dt><dd><p>withLongField(EarlybirdFieldConstant.IN_REPLY_TO_USER_ID_FIELD.getFieldName(), inReplyToUserID);
return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add reference tweet author id.</p></li>
</ul>
<p><a href="#id71"><span class="problematic" id="id72">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withReferenceAuthorID(long referenceAuthorID) {</dt><dd><p>withLongField(EarlybirdFieldConstant.REFERENCE_AUTHOR_ID_CSF.getFieldName(), referenceAuthorID);
return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add all native retweet related fields/label</p></li>
</ul>
<p><a href="#id73"><span class="problematic" id="id74">*</span></a>/</p>
</dd>
</dl>
<p>&#64;VisibleForTesting
public EarlybirdThriftDocumentBuilder withNativeRetweet(final long retweetUserID,</p>
<blockquote>
<div><blockquote>
<div><p>final long sharedStatusID) {</p>
</div></blockquote>
<p>withLongField(EarlybirdFieldConstant.SHARED_STATUS_ID_CSF.getFieldName(), sharedStatusID);</p>
<dl class="simple">
<dt>withLongField(EarlybirdFieldConstant.RETWEET_SOURCE_TWEET_ID_FIELD.getFieldName(),</dt><dd><p>sharedStatusID);</p>
</dd>
<dt>withLongField(EarlybirdFieldConstant.RETWEET_SOURCE_USER_ID_FIELD.getFieldName(),</dt><dd><p>retweetUserID);</p>
</dd>
</dl>
<p>withLongField(EarlybirdFieldConstant.REFERENCE_AUTHOR_ID_CSF.getFieldName(), retweetUserID);</p>
<p>encodedTweetFeatures.setFlag(EarlybirdFieldConstant.IS_RETWEET_FLAG);</p>
<p>// Add native retweet label to the internal field.
addFilterInternalFieldTerm(EarlybirdFieldConstant.NATIVE_RETWEETS_FILTER_TERM);
withStringField(EarlybirdFieldConstant.TEXT_FIELD.getFieldName(), RETWEET_TERM);
return this;</p>
</div></blockquote>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add quoted tweet id and user id.</p></li>
</ul>
<p><a href="#id75"><span class="problematic" id="id76">*</span></a>/</p>
</dd>
</dl>
<p>&#64;VisibleForTesting
public EarlybirdThriftDocumentBuilder withQuote(</p>
<blockquote>
<div><blockquote>
<div><p>final long quotedStatusId, final long quotedUserId) {</p>
</div></blockquote>
<p>withLongField(EarlybirdFieldConstant.QUOTED_TWEET_ID_FIELD.getFieldName(), quotedStatusId);
withLongField(EarlybirdFieldConstant.QUOTED_USER_ID_FIELD.getFieldName(), quotedUserId);</p>
<p>withLongField(EarlybirdFieldConstant.QUOTED_TWEET_ID_CSF.getFieldName(), quotedStatusId);
withLongField(EarlybirdFieldConstant.QUOTED_USER_ID_CSF.getFieldName(), quotedUserId);</p>
<p>encodedTweetFeatures.setFlag(EarlybirdFieldConstant.HAS_QUOTE_FLAG);</p>
<p>// Add quote label to the internal field.
addFilterInternalFieldTerm(EarlybirdFieldConstant.QUOTE_FILTER_TERM);
return this;</p>
</div></blockquote>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add resolved links text field.</p></li>
</ul>
<p><a href="#id77"><span class="problematic" id="id78">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withResolvedLinksText(String linksText) {</dt><dd><p>withStringField(EarlybirdFieldConstant.RESOLVED_LINKS_TEXT_FIELD.getFieldName(), linksText);
return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add source field.</p></li>
</ul>
<p><a href="#id79"><span class="problematic" id="id80">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withSource(String source) {</dt><dd><p>withStringField(EarlybirdFieldConstant.SOURCE_FIELD.getFieldName(), source);
return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add normalized source field.</p></li>
</ul>
<p><a href="#id81"><span class="problematic" id="id82">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withNormalizedSource(String normalizedSource) {</dt><dd><dl class="simple">
<dt>withStringField(</dt><dd><p>EarlybirdFieldConstant.NORMALIZED_SOURCE_FIELD.getFieldName(), normalizedSource);</p>
</dd>
</dl>
<p>return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add positive smiley to internal field.</p></li>
</ul>
<p><a href="#id83"><span class="problematic" id="id84">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withPositiveSmiley() {</dt><dd><dl class="simple">
<dt>withStringField(</dt><dd><p>EarlybirdFieldConstant.INTERNAL_FIELD.getFieldName(),
EarlybirdFieldConstant.HAS_POSITIVE_SMILEY);</p>
</dd>
</dl>
<p>return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add negative smiley to internal field.</p></li>
</ul>
<p><a href="#id85"><span class="problematic" id="id86">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withNegativeSmiley() {</dt><dd><dl class="simple">
<dt>withStringField(</dt><dd><p>EarlybirdFieldConstant.INTERNAL_FIELD.getFieldName(),
EarlybirdFieldConstant.HAS_NEGATIVE_SMILEY);</p>
</dd>
</dl>
<p>return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add question mark label to a text field.</p></li>
</ul>
<p><a href="#id87"><span class="problematic" id="id88">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withQuestionMark() {</dt><dd><p>withStringField(EarlybirdFieldConstant.TEXT_FIELD.getFieldName(), QUESTION_MARK);
return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add card related fields.</p></li>
</ul>
<p><a href="#id89"><span class="problematic" id="id90">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withSearchCard(</dt><dd><blockquote>
<div><p>String name,
String domain,
String title, byte[] serializedTitleStream,
String description, byte[] serializedDescriptionStream,
String lang) {</p>
</div></blockquote>
<dl class="simple">
<dt>if (isNotBlank(title)) {</dt><dd><dl class="simple">
<dt>withTokenStreamField(</dt><dd><p>EarlybirdFieldConstants.EarlybirdFieldConstant.CARD_TITLE_FIELD.getFieldName(),
title, serializedTitleStream);</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>if (isNotBlank(description)) {</dt><dd><dl class="simple">
<dt>withTokenStreamField(</dt><dd><p>EarlybirdFieldConstants.EarlybirdFieldConstant.CARD_DESCRIPTION_FIELD.getFieldName(),
description, serializedDescriptionStream);</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>if (isNotBlank(lang)) {</dt><dd><p>withStringField(EarlybirdFieldConstant.CARD_LANG.getFieldName(), lang);</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>if (isNotBlank(domain)) {</dt><dd><dl class="simple">
<dt>withStringField(</dt><dd><p>EarlybirdFieldConstants.EarlybirdFieldConstant.CARD_DOMAIN_FIELD.getFieldName(), domain);</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>if (isNotBlank(name)) {</dt><dd><dl class="simple">
<dt>withStringField(</dt><dd><p>EarlybirdFieldConstants.EarlybirdFieldConstant.CARD_NAME_FIELD.getFieldName(), name);</p>
</dd>
<dt>withIntField(</dt><dd><p>EarlybirdFieldConstants.EarlybirdFieldConstant.CARD_TYPE_CSF_FIELD.getFieldName(),
SearchCardType.cardTypeFromStringName(name).getByteValue());</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<dl>
<dt>if (AMPLIFY_CARD_NAME.equalsIgnoreCase(name)</dt><dd><blockquote>
<div><p>|| PLAYER_CARD_NAME.equalsIgnoreCase(name)) {</p>
</div></blockquote>
<p>// Add into “internal” field so that this tweet is returned by filter:videos.
addFacetSkipList(</p>
<blockquote>
<div><p>EarlybirdFieldConstants.EarlybirdFieldConstant.VIDEO_LINKS_FIELD.getFieldName());</p>
</div></blockquote>
</dd>
</dl>
<p>}</p>
<p>return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>public EarlybirdThriftDocumentBuilder withNormalizedMinEngagementField(</dt><dd><blockquote>
<div><p>String fieldName, int normalizedNumEngagements) throws IOException {</p>
</div></blockquote>
<dl class="simple">
<dt>EarlybirdThriftDocumentUtil.addNormalizedMinEngagementField(doc, fieldName,</dt><dd><p>normalizedNumEngagements);</p>
</dd>
</dl>
<p>return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add named entity with given canonical name and type to document.</p></li>
</ul>
<p><a href="#id91"><span class="problematic" id="id92">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withNamedEntity(NamedEntity namedEntity) {</dt><dd><dl class="simple">
<dt>if (namedEntity.getContexts() == null) {</dt><dd><p>// In this unlikely case, we don’t have any context for named entity type or source,
// so we can’t properly index it in any of our fields. We’ll just skip it in this case.
return this;</p>
</dd>
</dl>
<p>}</p>
<p>// Keep track of the fields we’ve applied in the builder already, to ensure we only index
// each term (field/value pair) once
Set&lt;Pair&lt;EarlybirdFieldConstant, String&gt;&gt; fieldsApplied = new HashSet&lt;&gt;();
for (NamedEntityContext context : namedEntity.getContexts()) {</p>
<blockquote>
<div><dl>
<dt>if (context.isSetInput_source()</dt><dd><blockquote>
<div><p>&amp;&amp; NAMED_ENTITY_URL_SOURCE_TYPES.contains(context.getInput_source().getSource_type())) {</p>
</div></blockquote>
<p>// If the source is one of the URL* types, add the named entity to the “from_url” fields,
// ensuring we add it only once
addNamedEntityFields(</p>
<blockquote>
<div><p>fieldsApplied,
EarlybirdFieldConstant.NAMED_ENTITY_FROM_URL_FIELD,
EarlybirdFieldConstant.NAMED_ENTITY_WITH_TYPE_FROM_URL_FIELD,
namedEntity.getCanonical_name(),
context);</p>
</div></blockquote>
</dd>
<dt>} else {</dt><dd><dl class="simple">
<dt>addNamedEntityFields(</dt><dd><p>fieldsApplied,
EarlybirdFieldConstant.NAMED_ENTITY_FROM_TEXT_FIELD,
EarlybirdFieldConstant.NAMED_ENTITY_WITH_TYPE_FROM_TEXT_FIELD,
namedEntity.getCanonical_name(),
context);</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}</p>
<p>return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add space id fields.</p></li>
</ul>
<p><a href="#id93"><span class="problematic" id="id94">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withSpaceIdFields(Set&lt;String&gt; spaceIds) {</dt><dd><dl>
<dt>if (!spaceIds.isEmpty()) {</dt><dd><p>addFacetSkipList(EarlybirdFieldConstant.SPACE_ID_FIELD.getFieldName());
for (String spaceId : spaceIds) {</p>
<blockquote>
<div><p>withStringField(EarlybirdFieldConstant.SPACE_ID_FIELD.getFieldName(), spaceId);</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}
return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add directed at user.</p></li>
</ul>
<p><a href="#id95"><span class="problematic" id="id96">*</span></a>/</p>
</dd>
</dl>
<p>&#64;VisibleForTesting
public EarlybirdThriftDocumentBuilder withDirectedAtUser(final long directedAtUserId) {</p>
<blockquote>
<div><dl class="simple">
<dt>withLongField(EarlybirdFieldConstant.DIRECTED_AT_USER_ID_FIELD.getFieldName(),</dt><dd><p>directedAtUserId);</p>
</dd>
</dl>
<p>withLongField(EarlybirdFieldConstant.DIRECTED_AT_USER_ID_CSF.getFieldName(), directedAtUserId);</p>
<p>return this;</p>
</div></blockquote>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add a white space tokenized screen name field.</p></li>
<li></li>
<li><p>Example:</p></li>
<li><p>screenName - “super_hero”</p></li>
<li><p>tokenized version - “super hero”</p></li>
</ul>
<p><a href="#id97"><span class="problematic" id="id98">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withWhiteSpaceTokenizedScreenNameField(</dt><dd><blockquote>
<div><p>String fieldName,
String normalizedScreenName) {</p>
</div></blockquote>
<dl class="simple">
<dt>String whiteSpaceTokenizableScreenName = StringUtils.join(</dt><dd><p>normalizedScreenName.split(Regex.HASHTAG_USERNAME_PUNCTUATION_REGEX), “ “);</p>
</dd>
</dl>
<p>withStringField(fieldName, whiteSpaceTokenizableScreenName);
return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add a camel case tokenized screen name field.</p></li>
</ul>
<p><a href="#id99"><span class="problematic" id="id100">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder withCamelCaseTokenizedScreenNameField(</dt><dd><blockquote>
<div><p>String fieldName,
String screenName,
String normalizedScreenName,
TokenStream screenNameTokenStream) {</p>
</div></blockquote>
<p>// this normalized text is consistent to how the tokenized stream is created from
// TokenizerHelper.getNormalizedCamelcaseTokenStream - ie. just lowercasing.
String camelCaseTokenizedScreenNameText =</p>
<blockquote>
<div><p>TokenizerHelper.getNormalizedCamelcaseTokenStreamText(screenName);</p>
</div></blockquote>
<dl>
<dt>try {</dt><dd><p>// Reset the token stream in case it has been read before.
screenNameTokenStream.reset();
byte[] camelCaseTokenizedScreenName =</p>
<blockquote>
<div><dl class="simple">
<dt>TweetTokenStreamSerializer.getTweetTokenStreamSerializer()</dt><dd><p>.serialize(screenNameTokenStream);</p>
</dd>
</dl>
</div></blockquote>
<dl>
<dt>withTokenStreamField(</dt><dd><p>fieldName,
camelCaseTokenizedScreenNameText.isEmpty()</p>
<blockquote>
<div><p>? normalizedScreenName : camelCaseTokenizedScreenNameText,</p>
</div></blockquote>
<p>camelCaseTokenizedScreenName);</p>
</dd>
</dl>
</dd>
<dt>} catch (IOException e) {</dt><dd><p>LOG.error(“TwitterTokenStream serialization error! Could not serialize: “ + screenName);
SERIALIZE_FAILURE_COUNT_NONPENGUIN_DEPENDENT.increment();</p>
</dd>
</dl>
<p>}
return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private void addNamedEntityFields(</dt><dd><blockquote>
<div><p>Set&lt;Pair&lt;EarlybirdFieldConstant, String&gt;&gt; fieldsApplied,
EarlybirdFieldConstant nameOnlyField,
EarlybirdFieldConstant nameWithTypeField,
String name,
NamedEntityContext context) {</p>
</div></blockquote>
<p>withOneTimeStringField(fieldsApplied, nameOnlyField, name, false);
if (context.isSetEntity_type()) {</p>
<blockquote>
<div><dl class="simple">
<dt>withOneTimeStringField(fieldsApplied, nameWithTypeField,</dt><dd><p>formatNamedEntityString(name, context.getEntity_type()), true);</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private void withOneTimeStringField(</dt><dd><blockquote>
<div><p>Set&lt;Pair&lt;EarlybirdFieldConstant, String&gt;&gt; fieldsApplied, EarlybirdFieldConstant field,
String value, boolean addToFacets) {</p>
</div></blockquote>
<p>Pair&lt;EarlybirdFieldConstant, String&gt; fieldValuePair = new Pair&lt;&gt;(field, value);
if (!fieldsApplied.contains(fieldValuePair)) {</p>
<blockquote>
<div><dl class="simple">
<dt>if (addToFacets) {</dt><dd><p>addFacetSkipList(field.getFieldName());</p>
</dd>
</dl>
<p>}
withStringField(field.getFieldName(), value);
fieldsApplied.add(fieldValuePair);</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>private String formatNamedEntityString(String name, WholeEntityType type) {</dt><dd><p>return String.format(“%s:%s”, name, type).toLowerCase();</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Set whether set LAT_LON_CSF_FIELD or not before build</p></li>
<li><p>if LAT_LON_CSF_FIELD is not set deliberately.</p></li>
<li></li>
<li><p>&#64;see #prepareToBuild()</p></li>
</ul>
<p><a href="#id101"><span class="problematic" id="id102">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder setAddLatLonCSF(boolean isSet) {</dt><dd><p>addLatLonCSF = isSet;
return this;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Set if add encoded tweet feature field in the end.</p></li>
<li></li>
<li><p>&#64;see #prepareToBuild()</p></li>
</ul>
<p><a href="#id103"><span class="problematic" id="id104">*</span></a>/</p>
</dd>
<dt>public EarlybirdThriftDocumentBuilder setAddEncodedTweetFeatures(boolean isSet) {</dt><dd><p>addEncodedTweetFeatures = isSet;
return this;</p>
</dd>
</dl>
<p>}</p>
<p>&#64;Override
protected void prepareToBuild() {</p>
<blockquote>
<div><dl class="simple">
<dt>if (!isSetLatLonCSF &amp;&amp; addLatLonCSF) {</dt><dd><p>// In lucene archives, this CSF is needed regardless of whether geoLocation is set.
withLatLonCSF(GeoUtil.ILLEGAL_LATLON, GeoUtil.ILLEGAL_LATLON);</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>if (addEncodedTweetFeatures) {</dt><dd><p>// Add encoded_tweet_features before building the document.
withBytesField(</p>
<blockquote>
<div><p>EarlybirdFieldConstant.ENCODED_TWEET_FEATURES_FIELD.getFieldName(),
EarlybirdEncodedFeaturesUtil.toBytesForThriftDocument(encodedTweetFeatures));</p>
</div></blockquote>
</dd>
</dl>
<p>}</p>
<dl>
<dt>if (extendedEncodedTweetFeatures != null) {</dt><dd><p>// Add extended_encoded_tweet_features before building the document.
withBytesField(</p>
<blockquote>
<div><p>EarlybirdFieldConstant.EXTENDED_ENCODED_TWEET_FEATURES_FIELD.getFieldName(),
EarlybirdEncodedFeaturesUtil.toBytesForThriftDocument(extendedEncodedTweetFeatures));</p>
</div></blockquote>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}</p>
<dl class="simple">
<dt>private static boolean isNotBlank(String value) {</dt><dd><p>return value != null &amp;&amp; !value.isEmpty();</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>private static boolean isNotEmpty(List&lt;?&gt; value) {</dt><dd><p>return value != null &amp;&amp; !value.isEmpty();</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../../../index.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../../../_sources/src/java/com/twitter/search/common/schema/earlybird/EarlybirdThriftDocumentBuilder.java.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>