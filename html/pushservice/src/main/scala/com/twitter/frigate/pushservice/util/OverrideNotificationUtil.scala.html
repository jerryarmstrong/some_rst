<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../../../../" id="documentation_options" src="../../../../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>package com.twitter.frigate.pushservice.util</p>
<p>import com.twitter.finagle.stats.StatsReceiver
import com.twitter.frigate.common.base.MagicFanoutEventCandidate
import com.twitter.frigate.common.history.History
import com.twitter.frigate.common.rec_types.RecTypes
import com.twitter.frigate.common.store.deviceinfo.DeviceInfo
import com.twitter.frigate.pushservice.model.PushTypes.PushCandidate
import com.twitter.frigate.pushservice.model.PushTypes.RawCandidate
import com.twitter.frigate.pushservice.model.PushTypes
import com.twitter.frigate.pushservice.model.ibis.PushOverrideInfo
import com.twitter.frigate.pushservice.params.PushConstants
import com.twitter.frigate.pushservice.params.PushFeatureSwitchParams
import com.twitter.frigate.pushservice.params.{PushFeatureSwitchParams =&gt; FSParams}
import com.twitter.frigate.thriftscala.CollapseInfo
import com.twitter.frigate.thriftscala.CommonRecommendationType
import com.twitter.frigate.thriftscala.CommonRecommendationType.MagicFanoutSportsEvent
import com.twitter.frigate.thriftscala.OverrideInfo
import com.twitter.util.Future
import java.util.UUID</p>
<p>object OverrideNotificationUtil {</p>
<blockquote>
<div><dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Gets Override Info for the current notification.</p></li>
<li><p>&#64;param candidate [[PushCandidate]] object representing the recommendation candidate</p></li>
<li><p>&#64;param stats     StatsReceiver to track stats for this function as well as the subsequent funcs. called</p></li>
<li><p>&#64;return          Returns OverrideInfo if CollapseInfo exists, else None</p></li>
</ul>
<p><a href="#id1"><span class="problematic" id="id2">*</span></a>/</p>
</dd>
<dt>def getOverrideInfo(</dt><dd><p>candidate: PushCandidate,
stats: StatsReceiver</p>
</dd>
<dt>): Future[Option[OverrideInfo]] = {</dt><dd><dl class="simple">
<dt>if (candidate.target.isLoggedOutUser) {</dt><dd><p>Future.None</p>
</dd>
<dt>} else if (isOverrideEnabledForCandidate(candidate))</dt><dd><p>getCollapseInfo(candidate, stats).map(_.map(OverrideInfo(_)))</p>
</dd>
</dl>
<p>else Future.None</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private def getCollapseInfo(</dt><dd><p>candidate: PushCandidate,
stats: StatsReceiver</p>
</dd>
<dt>): Future[Option[CollapseInfo]] = {</dt><dd><p>val target = candidate.target
for {</p>
<blockquote>
<div><p>targetHistory &lt;- target.history
deviceInfo &lt;- target.deviceInfo</p>
</div></blockquote>
<p>} yield getCollapseInfo(target, targetHistory, deviceInfo, stats)</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Get Collapse Info for the current notification.</p></li>
<li><p>&#64;param target          Push Target - recipient of the notification</p></li>
<li><p>&#64;param targetHistory   Target’s History</p></li>
<li><p>&#64;param deviceInfoOpt   <cite>Option</cite> of the Target’s Device Info</p></li>
<li><p>&#64;param stats           StatsReceiver to track stats for this function as well as the subsequent funcs. called</p></li>
<li><p>&#64;return                Returns CollapseInfo if the Target is eligible for Override Notifs, else None</p></li>
</ul>
<p><a href="#id3"><span class="problematic" id="id4">*</span></a>/</p>
</dd>
<dt>def getCollapseInfo(</dt><dd><p>target: PushTypes.Target,
targetHistory: History,
deviceInfoOpt: Option[DeviceInfo],
stats: StatsReceiver</p>
</dd>
<dt>): Option[CollapseInfo] = {</dt><dd><dl>
<dt>val overrideInfoOfLastNotif =</dt><dd><dl class="simple">
<dt>PushOverrideInfo.getOverrideInfoOfLastEligiblePushNotif(</dt><dd><p>targetHistory,
target.params(FSParams.OverrideNotificationsLookbackDurationForOverrideInfo),
stats)</p>
</dd>
</dl>
</dd>
<dt>overrideInfoOfLastNotif match {</dt><dd><dl>
<dt>case Some(prevOverrideInfo) if isOverrideEnabled(target, deviceInfoOpt, stats) =&gt;</dt><dd><dl class="simple">
<dt>val notifsInLastOverrideChain =</dt><dd><dl class="simple">
<dt>PushOverrideInfo.getMrPushNotificationsInOverrideChain(</dt><dd><p>targetHistory,
prevOverrideInfo.collapseInfo.overrideChainId,
stats)</p>
</dd>
</dl>
</dd>
</dl>
<p>val numNotifsInLastOverrideChain = notifsInLastOverrideChain.size
val timestampOfFirstNotifInOverrideChain =</p>
<blockquote>
<div><dl class="simple">
<dt>PushOverrideInfo</dt><dd><dl class="simple">
<dt>.getTimestampInMillisForFrigateNotification(</dt><dd><p>notifsInLastOverrideChain.last,
targetHistory,
stats).getOrElse(PushConstants.DefaultLookBackForHistory.ago.inMilliseconds)</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<dl class="simple">
<dt>if (numNotifsInLastOverrideChain &lt; target.params(FSParams.MaxMrPushSends24HoursParam) &amp;&amp;</dt><dd><p>timestampOfFirstNotifInOverrideChain &gt; PushConstants.DefaultLookBackForHistory.ago.inMilliseconds) {
Some(prevOverrideInfo.collapseInfo)</p>
</dd>
<dt>} else {</dt><dd><p>val prevCollapseId = prevOverrideInfo.collapseInfo.collapseId
val newOverrideChainId = UUID.randomUUID.toString.replaceAll(“-”, “”)
Some(CollapseInfo(prevCollapseId, newOverrideChainId))</p>
</dd>
</dl>
<p>}</p>
</dd>
<dt>case None if isOverrideEnabled(target, deviceInfoOpt, stats) =&gt;</dt><dd><p>val newOverrideChainId = UUID.randomUUID.toString.replaceAll(“-”, “”)
Some(CollapseInfo(“”, newOverrideChainId))</p>
</dd>
</dl>
<p>case _ =&gt; None // Override is disabled for everything else</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Gets the collapse and impression identifier for the current override notification</p></li>
<li><p>&#64;param target  Push Target - recipient of the notification</p></li>
<li><p>&#64;param stats   StatsReceiver to track stats for this function as well as the subsequent funcs. called</p></li>
<li><p>&#64;return        A Future of Collapse ID as well as the Impression ID.</p></li>
</ul>
<p><a href="#id5"><span class="problematic" id="id6">*</span></a>/</p>
</dd>
<dt>def getCollapseAndImpressionIdForOverride(</dt><dd><p>candidate: PushCandidate</p>
</dd>
<dt>): Future[Option[(String, Seq[String])]] = {</dt><dd><dl>
<dt>if (isOverrideEnabledForCandidate(candidate)) {</dt><dd><p>val target = candidate.target
val stats = candidate.statsReceiver
Future.join(target.history, target.deviceInfo).map {</p>
<blockquote>
<div><dl>
<dt>case (targetHistory, deviceInfoOpt) =&gt;</dt><dd><p>val collapseInfoOpt = getCollapseInfo(target, targetHistory, deviceInfoOpt, stats)</p>
<dl>
<dt>val impressionIds = candidate.commonRecType match {</dt><dd><dl>
<dt>case MagicFanoutSportsEvent</dt><dd><blockquote>
<div><p>if target.params(FSParams.EnableEventIdBasedOverrideForSportsCandidates) =&gt;</p>
</div></blockquote>
<dl>
<dt>PushOverrideInfo.getImpressionIdsForPrevEligibleMagicFanoutEventCandidates(</dt><dd><p>targetHistory,
target.params(FSParams.OverrideNotificationsLookbackDurationForImpressionId),
stats,
MagicFanoutSportsEvent,
candidate</p>
<blockquote>
<div><p>.asInstanceOf[RawCandidate with MagicFanoutEventCandidate].eventId</p>
</div></blockquote>
</dd>
</dl>
<p>)</p>
</dd>
<dt>case _ =&gt;</dt><dd><dl class="simple">
<dt>PushOverrideInfo.getImpressionIdsOfPrevEligiblePushNotif(</dt><dd><p>targetHistory,
target.params(FSParams.OverrideNotificationsLookbackDurationForImpressionId),
stats)</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<dl>
<dt>collapseInfoOpt match {</dt><dd><dl>
<dt>case Some(collapseInfo) if impressionIds.nonEmpty =&gt;</dt><dd><dl class="simple">
<dt>val notifsInLastOverrideChain =</dt><dd><dl class="simple">
<dt>PushOverrideInfo.getMrPushNotificationsInOverrideChain(</dt><dd><p>targetHistory,
collapseInfo.overrideChainId,
stats)</p>
</dd>
</dl>
</dd>
<dt>stats</dt><dd><dl class="simple">
<dt>.scope(“OverrideNotificationUtil”).stat(“number_of_notifications_sent”).add(</dt><dd><p>notifsInLastOverrideChain.size + 1)</p>
</dd>
</dl>
</dd>
</dl>
<p>Some((collapseInfo.collapseId, impressionIds))</p>
</dd>
</dl>
<p>case _ =&gt; None</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>case _ =&gt; None</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>} else Future.None</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Checks to see if override notifications are enabled based on the Target’s Device Info and Params</p></li>
<li><p>&#64;param target          Push Target - recipient of the notification</p></li>
<li><p>&#64;param deviceInfoOpt   <cite>Option</cite> of the Target’s Device Info</p></li>
<li><p>&#64;param stats           StatsReceiver to track stats for this function</p></li>
<li><p>&#64;return                Returns True if Override Notifications are enabled for the provided</p></li>
<li><p>Target, else False.</p></li>
</ul>
<p><a href="#id7"><span class="problematic" id="id8">*</span></a>/</p>
</dd>
<dt>private def isOverrideEnabled(</dt><dd><p>target: PushTypes.Target,
deviceInfoOpt: Option[DeviceInfo],
stats: StatsReceiver</p>
</dd>
<dt>): Boolean = {</dt><dd><p>val scopedStats = stats.scope(“OverrideNotificationUtil”).scope(“isOverrideEnabled”)
val enabledForAndroidCounter = scopedStats.counter(“android_enabled”)
val disabledForAndroidCounter = scopedStats.counter(“android_disabled”)
val enabledForIosCounter = scopedStats.counter(“ios_enabled”)
val disabledForIosCounter = scopedStats.counter(“ios_disabled”)
val disabledForOtherDevicesCounter = scopedStats.counter(“other_disabled”)</p>
<p>val isPrimaryDeviceAndroid = PushDeviceUtil.isPrimaryDeviceAndroid(deviceInfoOpt)
val isPrimaryDeviceIos = PushDeviceUtil.isPrimaryDeviceIOS(deviceInfoOpt)</p>
<dl class="simple">
<dt>lazy val validAndroidDevice =</dt><dd><p>isPrimaryDeviceAndroid &amp;&amp; target.params(FSParams.EnableOverrideNotificationsForAndroid)</p>
</dd>
<dt>lazy val validIosDevice =</dt><dd><p>isPrimaryDeviceIos &amp;&amp; target.params(FSParams.EnableOverrideNotificationsForIos)</p>
</dd>
<dt>if (isPrimaryDeviceAndroid) {</dt><dd><p>if (validAndroidDevice) enabledForAndroidCounter.incr() else disabledForAndroidCounter.incr()</p>
</dd>
<dt>} else if (isPrimaryDeviceIos) {</dt><dd><p>if (validIosDevice) enabledForIosCounter.incr() else disabledForIosCounter.incr()</p>
</dd>
<dt>} else {</dt><dd><p>disabledForOtherDevicesCounter.incr()</p>
</dd>
</dl>
<p>}</p>
<p>validAndroidDevice || validIosDevice</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Checks if override is enabled for the currently supported types for SendHandler or not.</p></li>
<li><p>This method is package private for unit testing.</p></li>
<li><p>&#64;param candidate [[PushCandidate]]</p></li>
<li><p>&#64;param stats StatsReceiver to track statistics for this function</p></li>
<li><p>&#64;return      Returns True if override notifications are enabled for the current type, otherwise False.</p></li>
</ul>
<p><a href="#id9"><span class="problematic" id="id10">*</span></a>/</p>
</dd>
<dt>private def isOverrideEnabledForSendHandlerCandidate(</dt><dd><p>candidate: PushCandidate</p>
</dd>
<dt>): Boolean = {</dt><dd><dl class="simple">
<dt>val scopedStats = candidate.statsReceiver</dt><dd><p>.scope(“OverrideNotificationUtil”).scope(“isOverrideEnabledForSendHandlerType”)</p>
</dd>
<dt>val overrideSupportedTypesForSpaces: Set[CommonRecommendationType] = Set(</dt><dd><p>CommonRecommendationType.SpaceSpeaker,
CommonRecommendationType.SpaceHost</p>
</dd>
</dl>
<p>)</p>
<dl class="simple">
<dt>val isOverrideSupportedForSpaces = {</dt><dd><p>overrideSupportedTypesForSpaces.contains(candidate.commonRecType) &amp;&amp;
candidate.target.params(FSParams.EnableOverrideForSpaces)</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>val isOverrideSupportedForSports = {</dt><dd><p>candidate.commonRecType == CommonRecommendationType.MagicFanoutSportsEvent &amp;&amp;
candidate.target</p>
<blockquote>
<div><p>.params(PushFeatureSwitchParams.EnableOverrideForSportsCandidates)</p>
</div></blockquote>
</dd>
</dl>
<p>}</p>
<p>val isOverrideSupported = isOverrideSupportedForSpaces || isOverrideSupportedForSports</p>
<p>scopedStats.counter(s”$isOverrideSupported”).incr()
isOverrideSupported</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>private[util] def isOverrideEnabledForCandidate(candidate: PushCandidate) =</dt><dd><dl class="simple">
<dt>!RecTypes.isSendHandlerType(</dt><dd><p>candidate.commonRecType) || isOverrideEnabledForSendHandlerCandidate(candidate)</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>}</p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../../../../index.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../../../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../../../../_sources/pushservice/src/main/scala/com/twitter/frigate/pushservice/util/OverrideNotificationUtil.scala.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>