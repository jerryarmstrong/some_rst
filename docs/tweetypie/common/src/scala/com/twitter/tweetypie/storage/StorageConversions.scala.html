<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../../../" id="documentation_options" src="../../../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>package com.twitter.tweetypie.storage</p>
<p>import com.twitter.mediaservices.commons.tweetmedia.thriftscala._
import com.twitter.scrooge.TFieldBlob
import com.twitter.tweetypie.additionalfields.AdditionalFields
import com.twitter.tweetypie.storage_internal.thriftscala._
import com.twitter.tweetypie.thriftscala._
import com.twitter.tweetypie.util.TweetLenses</p>
<dl>
<dt>object StorageConversions {</dt><dd><dl>
<dt>private val tbTweetCompiledAdditionalFieldIds =</dt><dd><p>StoredTweet.metaData.fields.map(_.id).filter(AdditionalFields.isAdditionalFieldId)</p>
</dd>
<dt>def toStoredReply(reply: Reply, conversationId: Option[TweetId]): StoredReply =</dt><dd><dl class="simple">
<dt>StoredReply(</dt><dd><p>inReplyToStatusId = reply.inReplyToStatusId.getOrElse(0),
inReplyToUserId = reply.inReplyToUserId,
conversationId = conversationId</p>
</dd>
</dl>
<p>)</p>
</dd>
<dt>def toStoredShare(share: Share): StoredShare =</dt><dd><dl class="simple">
<dt>StoredShare(</dt><dd><p>share.sourceStatusId,
share.sourceUserId,
share.parentStatusId</p>
</dd>
</dl>
<p>)</p>
</dd>
<dt>def toStoredQuotedTweet(qt: QuotedTweet, text: String): Option[StoredQuotedTweet] =</dt><dd><dl>
<dt>qt.permalink</dt><dd><dl class="simple">
<dt>.filterNot { p =&gt;</dt><dd><p>text.contains(p.shortUrl)</p>
</dd>
</dl>
<p>} // omit StoredQuotedTweet when url already in text
.map { p =&gt;</p>
<blockquote>
<div><dl class="simple">
<dt>StoredQuotedTweet(</dt><dd><p>qt.tweetId,
qt.userId,
p.shortUrl</p>
</dd>
</dl>
<p>)</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
</dd>
<dt>def toStoredGeo(tweet: Tweet): Option[StoredGeo] =</dt><dd><dl>
<dt>TweetLenses.geoCoordinates.get(tweet) match {</dt><dd><dl>
<dt>case None =&gt;</dt><dd><dl>
<dt>TweetLenses.placeId.get(tweet) match {</dt><dd><p>case None =&gt; None
case Some(placeId) =&gt;</p>
<blockquote>
<div><dl>
<dt>Some(</dt><dd><dl class="simple">
<dt>StoredGeo(</dt><dd><p>latitude = 0.0,
longitude = 0.0,
geoPrecision = 0,
entityId = 0,
name = Some(placeId)</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
<p>)</p>
</div></blockquote>
</dd>
</dl>
<p>}</p>
</dd>
<dt>case Some(coords) =&gt;</dt><dd><dl>
<dt>Some(</dt><dd><dl class="simple">
<dt>StoredGeo(</dt><dd><p>latitude = coords.latitude,
longitude = coords.longitude,
geoPrecision = coords.geoPrecision,
entityId = if (coords.display) 2 else 0,
name = TweetLenses.placeId.get(tweet)</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</dd>
<dt>def toStoredMedia(mediaList: Seq[MediaEntity]): Seq[StoredMediaEntity] =</dt><dd><p>mediaList.filter(_.sourceStatusId.isEmpty).flatMap(toStoredMediaEntity)</p>
</dd>
<dt>def toStoredMediaEntity(media: MediaEntity): Option[StoredMediaEntity] =</dt><dd><dl>
<dt>media.sizes.find(_.sizeType == MediaSizeType.Orig).map { origSize =&gt;</dt><dd><dl class="simple">
<dt>StoredMediaEntity(</dt><dd><p>id = media.mediaId,
mediaType = origSize.deprecatedContentType.value.toByte,
width = origSize.width.toShort,
height = origSize.height.toShort</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>// The language and ids fields are for compatibility with existing tweets stored in manhattan.
def toStoredNarrowcast(narrowcast: Narrowcast): StoredNarrowcast =</p>
<blockquote>
<div><dl class="simple">
<dt>StoredNarrowcast(</dt><dd><p>language = Some(Seq.empty),
location = Some(narrowcast.location),
ids = Some(Seq.empty)</p>
</dd>
</dl>
<p>)</p>
</div></blockquote>
<dl>
<dt>def toStoredAdditionalFields(from: Seq[TFieldBlob], to: StoredTweet): StoredTweet =</dt><dd><p>from.foldLeft(to) { case (t, f) =&gt; t.setField(f) }</p>
</dd>
<dt>def toStoredAdditionalFields(from: Tweet, to: StoredTweet): StoredTweet =</dt><dd><p>toStoredAdditionalFields(AdditionalFields.additionalFields(from), to)</p>
</dd>
<dt>def toStoredTweet(tweet: Tweet): StoredTweet = {</dt><dd><dl>
<dt>val storedTweet =</dt><dd><dl>
<dt>StoredTweet(</dt><dd><p>id = tweet.id,
userId = Some(TweetLenses.userId(tweet)),
text = Some(TweetLenses.text(tweet)),
createdVia = Some(TweetLenses.createdVia(tweet)),
createdAtSec = Some(TweetLenses.createdAt(tweet)),
reply =</p>
<blockquote>
<div><p>TweetLenses.reply(tweet).map { r =&gt; toStoredReply(r, TweetLenses.conversationId(tweet)) },</p>
</div></blockquote>
<p>share = TweetLenses.share(tweet).map(toStoredShare),
contributorId = tweet.contributor.map(_.userId),
geo = toStoredGeo(tweet),
hasTakedown = Some(TweetLenses.hasTakedown(tweet)),
nsfwUser = Some(TweetLenses.nsfwUser(tweet)),
nsfwAdmin = Some(TweetLenses.nsfwAdmin(tweet)),
media = tweet.media.map(toStoredMedia),
narrowcast = TweetLenses.narrowcast(tweet).map(toStoredNarrowcast),
nullcast = Some(TweetLenses.nullcast(tweet)),
trackingId = TweetLenses.trackingId(tweet),
quotedTweet = TweetLenses.quotedTweet(tweet).flatMap { qt =&gt;</p>
<blockquote>
<div><p>toStoredQuotedTweet(qt, TweetLenses.text(tweet))</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
<p>toStoredAdditionalFields(tweet, storedTweet)</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Does not need core data to be set. Constructs on disk tweet by avoiding the TweetLenses object</p></li>
<li><p>and only extracting the specified fields.</p></li>
<li></li>
<li><p>NOTE: Assumes that specified fields are set in the tweet.</p></li>
<li></li>
<li><p>&#64;param tpTweet Tweetypie Tweet to be converted</p></li>
<li><p>&#64;param fields the fields to be populated in the on disk Tweet</p></li>
<li></li>
<li><p>&#64;return an on disk Tweet which has only the specified fields set</p></li>
</ul>
<p><a href="#id1"><span class="problematic" id="id2">*</span></a>/</p>
</dd>
</dl>
<p>def toStoredTweetForFields(tpTweet: Tweet, fields: Set[Field]): StoredTweet = {</p>
<blockquote>
<div><p>// Make sure all the passed in fields are known or additional fields
require(</p>
<blockquote>
<div><dl class="simple">
<dt>(fields – Field.AllUpdatableCompiledFields)</dt><dd><p>.forall(field =&gt; AdditionalFields.isAdditionalFieldId(field.id))</p>
</dd>
</dl>
</div></blockquote>
<p>)</p>
<dl>
<dt>val storedTweet =</dt><dd><dl>
<dt>StoredTweet(</dt><dd><p>id = tpTweet.id,
geo = if (fields.contains(Field.Geo)) {</p>
<blockquote>
<div><dl>
<dt>tpTweet.coreData.get.coordinates match {</dt><dd><dl>
<dt>case None =&gt;</dt><dd><dl>
<dt>tpTweet.coreData.get.placeId match {</dt><dd><p>case None =&gt; None
case Some(placeId) =&gt;</p>
<blockquote>
<div><dl>
<dt>Some(</dt><dd><dl class="simple">
<dt>StoredGeo(</dt><dd><p>latitude = 0.0,
longitude = 0.0,
geoPrecision = 0,
entityId = 0,
name = Some(placeId)</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
<p>)</p>
</div></blockquote>
</dd>
</dl>
<p>}</p>
</dd>
<dt>case Some(coords) =&gt;</dt><dd><dl>
<dt>Some(</dt><dd><dl class="simple">
<dt>StoredGeo(</dt><dd><p>latitude = coords.latitude,
longitude = coords.longitude,
geoPrecision = coords.geoPrecision,
entityId = if (coords.display) 2 else 0,
name = tpTweet.coreData.get.placeId</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<dl class="simple">
<dt>} else {</dt><dd><p>None</p>
</dd>
</dl>
<p>},
hasTakedown =</p>
<blockquote>
<div><dl class="simple">
<dt>if (fields.contains(Field.HasTakedown))</dt><dd><p>Some(tpTweet.coreData.get.hasTakedown)</p>
</dd>
<dt>else</dt><dd><p>None,</p>
</dd>
</dl>
</div></blockquote>
<dl class="simple">
<dt>nsfwUser =</dt><dd><dl class="simple">
<dt>if (fields.contains(Field.NsfwUser))</dt><dd><p>Some(tpTweet.coreData.get.nsfwUser)</p>
</dd>
<dt>else</dt><dd><p>None,</p>
</dd>
</dl>
</dd>
<dt>nsfwAdmin =</dt><dd><dl class="simple">
<dt>if (fields.contains(Field.NsfwAdmin))</dt><dd><p>Some(tpTweet.coreData.get.nsfwAdmin)</p>
</dd>
<dt>else</dt><dd><p>None</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p>)</p>
</dd>
<dt>if (fields.map(_.id).exists(AdditionalFields.isAdditionalFieldId))</dt><dd><p>toStoredAdditionalFields(tpTweet, storedTweet)</p>
</dd>
<dt>else</dt><dd><p>storedTweet</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
<dl>
<dt>def fromStoredReply(reply: StoredReply): Reply =</dt><dd><dl class="simple">
<dt>Reply(</dt><dd><p>Some(reply.inReplyToStatusId).filter(_ &gt; 0),
reply.inReplyToUserId</p>
</dd>
</dl>
<p>)</p>
</dd>
<dt>def fromStoredShare(share: StoredShare): Share =</dt><dd><dl class="simple">
<dt>Share(</dt><dd><p>share.sourceStatusId,
share.sourceUserId,
share.parentStatusId</p>
</dd>
</dl>
<p>)</p>
</dd>
<dt>def fromStoredQuotedTweet(qt: StoredQuotedTweet): QuotedTweet =</dt><dd><dl>
<dt>QuotedTweet(</dt><dd><p>qt.tweetId,
qt.userId,
Some(</p>
<blockquote>
<div><dl class="simple">
<dt>ShortenedUrl(</dt><dd><p>shortUrl = qt.shortUrl,
longUrl = “”, // will be hydrated later via tweetypie’s QuotedTweetRefUrlsHydrator
displayText = “” //will be hydrated later via tweetypie’s QuotedTweetRefUrlsHydrator</p>
</dd>
</dl>
<p>)</p>
</div></blockquote>
<p>)</p>
</dd>
</dl>
<p>)</p>
</dd>
<dt>def fromStoredGeo(geo: StoredGeo): GeoCoordinates =</dt><dd><dl class="simple">
<dt>GeoCoordinates(</dt><dd><p>latitude = geo.latitude,
longitude = geo.longitude,
geoPrecision = geo.geoPrecision,
display = geo.entityId == 2</p>
</dd>
</dl>
<p>)</p>
</dd>
<dt>def fromStoredMediaEntity(media: StoredMediaEntity): MediaEntity =</dt><dd><dl>
<dt>MediaEntity(</dt><dd><p>fromIndex = -1, // will get filled in later
toIndex = -1, // will get filled in later
url = null, // will get filled in later
mediaPath = “”, // field is obsolete
mediaUrl = null, // will get filled in later
mediaUrlHttps = null, // will get filled in later
displayUrl = null, // will get filled in later
expandedUrl = null, // will get filled in later
mediaId = media.id,
nsfw = false,
sizes = Set(</p>
<blockquote>
<div><dl class="simple">
<dt>MediaSize(</dt><dd><p>sizeType = MediaSizeType.Orig,
resizeMethod = MediaResizeMethod.Fit,
deprecatedContentType = MediaContentType(media.mediaType),
width = media.width,
height = media.height</p>
</dd>
</dl>
<p>)</p>
</div></blockquote>
<p>)</p>
</dd>
</dl>
<p>)</p>
</dd>
<dt>def fromStoredNarrowcast(narrowcast: StoredNarrowcast): Narrowcast =</dt><dd><dl class="simple">
<dt>Narrowcast(</dt><dd><p>location = narrowcast.location.getOrElse(Seq())</p>
</dd>
</dl>
<p>)</p>
</dd>
<dt>def fromStoredTweet(storedTweet: StoredTweet): Tweet = {</dt><dd><dl>
<dt>val coreData =</dt><dd><dl class="simple">
<dt>TweetCoreData(</dt><dd><p>userId = storedTweet.userId.get,
text = storedTweet.text.get,
createdVia = storedTweet.createdVia.get,
createdAtSecs = storedTweet.createdAtSec.get,
reply = storedTweet.reply.map(fromStoredReply),
share = storedTweet.share.map(fromStoredShare),
hasTakedown = storedTweet.hasTakedown.getOrElse(false),
nsfwUser = storedTweet.nsfwUser.getOrElse(false),
nsfwAdmin = storedTweet.nsfwAdmin.getOrElse(false),
narrowcast = storedTweet.narrowcast.map(fromStoredNarrowcast),
nullcast = storedTweet.nullcast.getOrElse(false),
trackingId = storedTweet.trackingId,
conversationId = storedTweet.reply.flatMap(_.conversationId),
placeId = storedTweet.geo.flatMap(_.name),
coordinates = storedTweet.geo.map(fromStoredGeo),
hasMedia = if (storedTweet.media.exists(_.nonEmpty)) Some(true) else None</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
<p>// retweets should never have their media, but some tweets incorrectly do.
val storedMedia = if (coreData.share.isDefined) Nil else storedTweet.media.toSeq</p>
<dl>
<dt>val tpTweet =</dt><dd><dl class="simple">
<dt>Tweet(</dt><dd><p>id = storedTweet.id,
coreData = Some(coreData),
contributor = storedTweet.contributorId.map(Contributor(_)),
media = Some(storedMedia.flatten.map(fromStoredMediaEntity)),
mentions = Some(Seq.empty),
urls = Some(Seq.empty),
cashtags = Some(Seq.empty),
hashtags = Some(Seq.empty),
quotedTweet = storedTweet.quotedTweet.map(fromStoredQuotedTweet)</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
<p>fromStoredAdditionalFields(storedTweet, tpTweet)</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>def fromStoredTweetAllowInvalid(storedTweet: StoredTweet): Tweet = {</dt><dd><dl>
<dt>fromStoredTweet(</dt><dd><dl class="simple">
<dt>storedTweet.copy(</dt><dd><p>userId = storedTweet.userId.orElse(Some(-1L)),
text = storedTweet.text.orElse(Some(“”)),
createdVia = storedTweet.createdVia.orElse(Some(“”)),
createdAtSec = storedTweet.createdAtSec.orElse(Some(-1L))</p>
</dd>
</dl>
<p>))</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<dl>
<dt>def fromStoredAdditionalFields(from: StoredTweet, to: Tweet): Tweet = {</dt><dd><dl class="simple">
<dt>val passThroughAdditionalFields =</dt><dd><p>from._passthroughFields.filterKeys(AdditionalFields.isAdditionalFieldId)</p>
</dd>
<dt>val allAdditionalFields =</dt><dd><p>from.getFieldBlobs(tbTweetCompiledAdditionalFieldIds) ++ passThroughAdditionalFields</p>
</dd>
</dl>
<p>allAdditionalFields.values.foldLeft(to) { case (t, f) =&gt; t.setField(f) }</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>def toDeletedTweet(storedTweet: StoredTweet): DeletedTweet = {</dt><dd><p>val noteTweetBlob = storedTweet.getFieldBlob(Tweet.NoteTweetField.id)
val noteTweetOption = noteTweetBlob.map(blob =&gt; NoteTweet.decode(blob.read))
DeletedTweet(</p>
<blockquote>
<div><p>id = storedTweet.id,
userId = storedTweet.userId,
text = storedTweet.text,
createdAtSecs = storedTweet.createdAtSec,
share = storedTweet.share.map(toDeletedShare),
media = storedTweet.media.map(_.map(toDeletedMediaEntity)),
noteTweetId = noteTweetOption.map(_.id),
isExpandable = noteTweetOption.flatMap(_.isExpandable)</p>
</div></blockquote>
<p>)</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>def toDeletedShare(storedShare: StoredShare): DeletedTweetShare =</dt><dd><dl class="simple">
<dt>DeletedTweetShare(</dt><dd><p>sourceStatusId = storedShare.sourceStatusId,
sourceUserId = storedShare.sourceUserId,
parentStatusId = storedShare.parentStatusId</p>
</dd>
</dl>
<p>)</p>
</dd>
<dt>def toDeletedMediaEntity(storedMediaEntity: StoredMediaEntity): DeletedTweetMediaEntity =</dt><dd><dl class="simple">
<dt>DeletedTweetMediaEntity(</dt><dd><p>id = storedMediaEntity.id,
mediaType = storedMediaEntity.mediaType,
width = storedMediaEntity.width,
height = storedMediaEntity.height</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../../../index.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../../../_sources/tweetypie/common/src/scala/com/twitter/tweetypie/storage/StorageConversions.scala.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>