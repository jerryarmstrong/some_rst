<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>docs/01-programs/02-candy-machine/07-special-guard-instructions.md &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="docs-01-programs-02-candy-machine-07-special-guard-instructions-md">
<h1>docs/01-programs/02-candy-machine/07-special-guard-instructions.md<a class="headerlink" href="#docs-01-programs-02-candy-machine-07-special-guard-instructions-md" title="Permalink to this heading">¶</a></h1>
<p>Last edited: 2023-08-08 19:56:25</p>
<p>Contents:</p>
<div class="highlight-md notranslate"><div class="highlight"><pre><span></span>---
</pre></div>
</div>
<p>description: “Explains how to execute guard-specific instructions.”
—</p>
<p>import { Accordion, AccordionItem } from ‘/src/accordion.jsx’;</p>
<p># Special Guard Instructions</p>
<p>## Introduction</p>
<p>As we’ve seen on the previous pages, guards are a powerful way to customize the minting process of your Candy Machines. But did you know guards can even provide their own custom instructions?</p>
<p>## The Route Instruction</p>
<p>The Candy Guard program ships with a special instruction called <strong>the “Route” instruction</strong>.</p>
<p>This instruction allows us to <strong>select a specific guard</strong> from our Candy Machine and <strong>run a custom instruction</strong> that is specific to this guard. We call it the “Route” instruction because it will route our request to the selected guard.</p>
<p>This feature makes guards even more powerful as they can ship with their own program logic. It enables guards to:</p>
<ul class="simple">
<li><p>Decouple the verification process from the minting process for heavy operations.</p></li>
<li><p>Provide custom features that would otherwise require the deployment of a custom program.</p></li>
</ul>
<p>To call a route instruction, we must specify which guard we want to route that instruction to as well as <strong>provide the route settings it expects</strong>. Note that if we try to execute the “route” instruction by selecting a guard that does not support it, the transaction will fail.</p>
<p>Since there can only be one “route” instruction per registered guard on a Candy Guard program, it is common to provide a <strong>Path</strong> attribute in the route settings to distinguish between multiple features offered by the same guard.</p>
<p>For instance, a guard adding support for Frozen NFTs — that can only be thawed once minting is over — could use their route instruction to initialize the treasury escrow account as well as allow anyone to thaw a minted NFT under the right conditions. We could distinguish these two features by using a <strong>Path</strong> attribute equal to “init” for the former and “thaw” for the latter.</p>
<p>You will find a detailed explanation of the route instruction of each guard that supports it and their underlying paths [on their respective pages](/programs/candy-machine/available-guards).</p>
<p>Let’s take a minute to illustrate how the route instruction works by providing an example. The [<strong>Allow List</strong>](/programs/candy-machine/available-guards/allow-list) guard, for instance, supports the route instruction in order to verify that the minting wallet is part of the preconfigured list of wallets.</p>
<p>It does that using [Merkle Trees](<a class="reference external" href="https://en.m.wikipedia.org/wiki/Merkle_tree">https://en.m.wikipedia.org/wiki/Merkle_tree</a>) which means we need to create a hash of the entire list of allowed wallets and store that hash — known as the <strong>Merkle Root</strong> — on the guard settings. For a wallet to prove it is on the allowed list, it must provide a list of hashes — known as the <strong>Merkle Proof</strong> — that allows the program to compute the Merkle Root and ensure it matches the guard’s settings.</p>
<p>Therefore, the Allow List guard <strong>uses its route instruction to verify the Merkle Proof of a given wallet</strong> and, if successful, creates a small PDA account on the blockchain that acts as verification proof for the mint instruction.</p>
<p>![CandyMachinesV3-SpecialGuardInstructions1.png](/assets/candy-machine-v3/CandyMachinesV3-SpecialGuardInstructions1.png#radius)</p>
<p>So why can’t we just verify the Merkle Proof directly within the mint instruction? That’s simply because, for big allow lists, Merkle Proofs can end up being pretty lengthy. After a certain size, it becomes impossible to include it within the mint transaction that already contains a decent amount of instructions. By separating the validation process from the minting process, we make it possible for allow lists to be as big as we need them to be.</p>
<p>&lt;Accordion&gt;
&lt;AccordionItem title=”JavaScript — Umi library (recommended)” open={true}&gt;
&lt;div className=”accordion-item-padding”&gt;</p>
<p>You may use the <cite>route</cite> function to call the route instruction of a guard using the Umi library. You will need to pass the guard’s name via the <cite>guard</cite> attribute and its route settings via the <cite>routeArgs</cite> attribute.</p>
<p>Here is an example using the Allow List guard which validates the wallet’s Merkle Proof before minting.</p>
<p><a href="#id1"><span class="problematic" id="id2">``</span></a><a href="#id3"><span class="problematic" id="id4">`</span></a>ts
import {</p>
<blockquote>
<div><p>create,
route,
getMerkleProof,
getMerkleRoot,</p>
</div></blockquote>
<p>} from “&#64;metaplex-foundation/mpl-candy-machine”;</p>
<p>// Prepare the allow list.
// Let’s assume the first wallet on the list is the Metaplex identity.
const allowList = [</p>
<blockquote>
<div><p>“GjwcWFQYzemBtpUoN5fMAP2FZviTtMRWCmrppGuTthJS”,
“2vjCrmEFiN9CLLhiqy8u1JPh48av8Zpzp3kNkdTtirYG”,
“AT8nPwujHAD14cLojTcB1qdBzA1VXnT6LVGuUd6Y73Cy”,</p>
</div></blockquote>
<p>];
const merkleRoot = getMerkleRoot(allowList);</p>
<p>// Create a Candy Machine with an Allow List guard.
await create(umi, {</p>
<blockquote>
<div><p>// …
guards: {</p>
<blockquote>
<div><p>allowList: some({ merkleRoot }),</p>
</div></blockquote>
<p>},</p>
</div></blockquote>
<p>}).sendAndConfirm(umi);</p>
<p>// If we try to mint now, it will fail because
// we did not verify our Merkle Proof.</p>
<p>// Verify the Merkle Proof using the route instruction.
await route(umi, {</p>
<blockquote>
<div><p>candyMachine: candyMachine.publicKey,
guard: “allowList”,
routeArgs: {</p>
<blockquote>
<div><p>path: “proof”,
merkleRoot,
merkleProof: getMerkleProof(</p>
<blockquote>
<div><p>allowList,
“GjwcWFQYzemBtpUoN5fMAP2FZviTtMRWCmrppGuTthJS”</p>
</div></blockquote>
<p>),</p>
</div></blockquote>
<p>},</p>
</div></blockquote>
<p>}).sendAndConfirm(umi);</p>
<p>// If we try to mint now, it will succeed.
<a href="#id5"><span class="problematic" id="id6">``</span></a><a href="#id7"><span class="problematic" id="id8">`</span></a></p>
<p>API References: [route](<a class="reference external" href="https://mpl-candy-machine-js-docs.vercel.app/functions/route.html">https://mpl-candy-machine-js-docs.vercel.app/functions/route.html</a>), [DefaultGuardSetRouteArgs](<a class="reference external" href="https://mpl-candy-machine-js-docs.vercel.app/types/DefaultGuardSetRouteArgs.html">https://mpl-candy-machine-js-docs.vercel.app/types/DefaultGuardSetRouteArgs.html</a>)</p>
<p>&lt;/div&gt;
&lt;/AccordionItem&gt;
&lt;AccordionItem title=”JavaScript — SDK”&gt;
&lt;div className=”accordion-item-padding”&gt;</p>
<p>You may use the <cite>callGuardRoute</cite> operation to call the route instruction of a guard using the JS SDK. You must pass the guard’s name via the <cite>guard</cite> attribute and the route settings via the <cite>settings</cite> attribute.
Here is an example using the Allow List guard which validates the wallet’s Merkle Proof before minting.</p>
<p><a href="#id9"><span class="problematic" id="id10">``</span></a><a href="#id11"><span class="problematic" id="id12">`</span></a>tsx
import { getMerkleProof, getMerkleRoot } from “&#64;metaplex-foundation/js”;</p>
<p>// Prepare the allow list.
// Let’s assume the first wallet on the list is the Metaplex identity.
const allowList = [</p>
<blockquote>
<div><p>“GjwcWFQYzemBtpUoN5fMAP2FZviTtMRWCmrppGuTthJS”,
“2vjCrmEFiN9CLLhiqy8u1JPh48av8Zpzp3kNkdTtirYG”,
“AT8nPwujHAD14cLojTcB1qdBzA1VXnT6LVGuUd6Y73Cy”,</p>
</div></blockquote>
<p>];</p>
<p>// Create a Candy Machine with an Allow List guard.
const { candyMachine } = await metaplex.candyMachines().create({</p>
<blockquote>
<div><p>// …
guards: {</p>
<blockquote>
<div><p>allowList: { merkleRoot: getMerkleRoot(allowList) },</p>
</div></blockquote>
<p>},</p>
</div></blockquote>
<p>});</p>
<p>// If we try to mint now, it will fail because
// we did not verify our Merkle Proof.</p>
<p>// Verify the Merkle Proof using the route instruction.
await metaplex.candyMachines().callGuardRoute({</p>
<blockquote>
<div><p>candyMachine,
guard: “allowList”,
settings: {</p>
<blockquote>
<div><p>path: “proof”,
merkleProof: getMerkleProof(</p>
<blockquote>
<div><p>allowList,
“GjwcWFQYzemBtpUoN5fMAP2FZviTtMRWCmrppGuTthJS”</p>
</div></blockquote>
<p>),</p>
</div></blockquote>
<p>},</p>
</div></blockquote>
<p>});</p>
<p>// If we try to mint now, it will succeed.
<a href="#id13"><span class="problematic" id="id14">``</span></a><a href="#id15"><span class="problematic" id="id16">`</span></a></p>
<p>API References: [Operation](<a class="reference external" href="https://metaplex-foundation.github.io/js/classes/js.CandyMachineClient.html#callGuardRoute">https://metaplex-foundation.github.io/js/classes/js.CandyMachineClient.html#callGuardRoute</a>), [Input](<a class="reference external" href="https://metaplex-foundation.github.io/js/types/js.CallCandyGuardRouteInput.html">https://metaplex-foundation.github.io/js/types/js.CallCandyGuardRouteInput.html</a>), [Output](<a class="reference external" href="https://metaplex-foundation.github.io/js/types/js.CallCandyGuardRouteOutput.html">https://metaplex-foundation.github.io/js/types/js.CallCandyGuardRouteOutput.html</a>), [Transaction Builder](<a class="reference external" href="https://metaplex-foundation.github.io/js/classes/js.CandyMachineBuildersClient.html#callGuardRoute">https://metaplex-foundation.github.io/js/classes/js.CandyMachineBuildersClient.html#callGuardRoute</a>), [Default Route Settings](<a class="reference external" href="https://metaplex-foundation.github.io/js/types/js.DefaultCandyGuardRouteSettings.html">https://metaplex-foundation.github.io/js/types/js.DefaultCandyGuardRouteSettings.html</a>).</p>
<p>&lt;/div&gt;
&lt;/AccordionItem&gt;
&lt;/Accordion&gt;</p>
<p>## Route Instruction With Groups</p>
<p>When calling the route instruction whilst using guard groups, it is important to <strong>specify the group label</strong> of the guard we wish to select. This is because we may have multiple guards of the same type across different groups and the program needs to know which one it should use for the route instruction.</p>
<p>For instance, say we had an <strong>Allow List</strong> of handpicked VIP wallets in one group and another <strong>Allow List</strong> for the winners of a raffle in another group. Then saying we want to verify the Merkle Proof for the Allow List guard is not enough, we also need to know for which group we should perform that verification.</p>
<p>&lt;Accordion&gt;
&lt;AccordionItem title=”JavaScript — Umi library (recommended)” open={true}&gt;
&lt;div className=”accordion-item-padding”&gt;</p>
<p>When using groups, the <cite>route</cite> function of the Umi library accepts an additional <cite>group</cite> attribute of type <cite>Option&lt;string&gt;</cite> which must be set to the label of the group we want to select.</p>
<p><a href="#id17"><span class="problematic" id="id18">``</span></a><a href="#id19"><span class="problematic" id="id20">`</span></a>ts
import {</p>
<blockquote>
<div><p>create,
route,
getMerkleProof,
getMerkleRoot,</p>
</div></blockquote>
<p>} from “&#64;metaplex-foundation/mpl-candy-machine”;
import { base58PublicKey, some } from “&#64;metaplex-foundation/umi”;</p>
<p>// Prepare the allow lists.
const allowListA = […];
const allowListB = […];</p>
<p>// Create a Candy Machine with two Allow List guards.
await create(umi, {</p>
<blockquote>
<div><p>// …
groups: [</p>
<blockquote>
<div><dl>
<dt>{</dt><dd><p>label: “listA”,
guards: {</p>
<blockquote>
<div><p>allowList: some({ merkleRoot: getMerkleRoot(allowListA) }),</p>
</div></blockquote>
<p>},</p>
</dd>
</dl>
<p>},
{</p>
<blockquote>
<div><p>label: “listB”,
guards: {</p>
<blockquote>
<div><p>allowList: some({ merkleRoot: getMerkleRoot(allowListB) }),</p>
</div></blockquote>
<p>},</p>
</div></blockquote>
<p>},</p>
</div></blockquote>
<p>],</p>
</div></blockquote>
<p>}).sendAndConfirm(umi);</p>
<p>// Verify the Merkle Proof by specifying which group to select.
await route(umi, {</p>
<blockquote>
<div><p>candyMachine: candyMachine.publicKey,
guard: ‘allowList’,
group: some(‘listA’), // &lt;- We are veryfing using “allowListA”.
routeArgs: {</p>
<blockquote>
<div><p>path: ‘proof’,
merkleRoot: getMerkleRoot(allowListA),
merkleProof: getMerkleProof(</p>
<blockquote>
<div><p>allowListA,
base58PublicKey(umi.identity),</p>
</div></blockquote>
<p>),</p>
</div></blockquote>
<p>},</p>
</div></blockquote>
<p>}).sendAndConfirm(umi);
<a href="#id21"><span class="problematic" id="id22">``</span></a><a href="#id23"><span class="problematic" id="id24">`</span></a></p>
<p>API References: [route](<a class="reference external" href="https://mpl-candy-machine-js-docs.vercel.app/functions/route.html">https://mpl-candy-machine-js-docs.vercel.app/functions/route.html</a>), [DefaultGuardSetRouteArgs](<a class="reference external" href="https://mpl-candy-machine-js-docs.vercel.app/types/DefaultGuardSetRouteArgs.html">https://mpl-candy-machine-js-docs.vercel.app/types/DefaultGuardSetRouteArgs.html</a>)</p>
<p>&lt;/div&gt;
&lt;/AccordionItem&gt;
&lt;AccordionItem title=”JavaScript — SDK”&gt;
&lt;div className=”accordion-item-padding”&gt;</p>
<p>When using groups in the JS SDK, the <cite>callGuardRoute</cite> operation accepts an additional <cite>group</cite> attribute which must be set to the label of the group we want to select.</p>
<p><a href="#id25"><span class="problematic" id="id26">``</span></a><a href="#id27"><span class="problematic" id="id28">`</span></a>tsx
import { getMerkleProof, getMerkleRoot } from <a class="reference external" href="mailto:'&#37;&#52;&#48;metaplex-foundation/js">‘<span>&#64;</span>metaplex-foundation/js</a>’;</p>
<p>// Prepare the allow lists.
const allowListA = […];
const allowListB = […];</p>
<p>// Create a Candy Machine with two Allow List guards.
const { candyMachine } = await metaplex.candyMachines().create({</p>
<blockquote>
<div><p>// …
groups: [</p>
<blockquote>
<div><dl>
<dt>{</dt><dd><p>label: “listA”,
guards: {</p>
<blockquote>
<div><p>allowList: { merkleRoot: getMerkleRoot(allowListA) },</p>
</div></blockquote>
<p>},</p>
</dd>
</dl>
<p>},
{</p>
<blockquote>
<div><p>label: “listB”,
guards: {</p>
<blockquote>
<div><p>allowList: { merkleRoot: getMerkleRoot(allowListB) },</p>
</div></blockquote>
<p>},</p>
</div></blockquote>
<p>},</p>
</div></blockquote>
<p>],</p>
</div></blockquote>
<p>});</p>
<p>// Verify the Merkle Proof by specifying which group to select.
await metaplex.candyMachines().callGuardRoute({</p>
<blockquote>
<div><p>candyMachine,
guard: ‘allowList’,
group: ‘listA’, // &lt;- We are veryfing using “allowListA”.
settings: {</p>
<blockquote>
<div><p>path: ‘proof’,
merkleProof: getMerkleProof(</p>
<blockquote>
<div><p>allowListA,
metaplex.identity().publicKey.toBase58(),</p>
</div></blockquote>
<p>),</p>
</div></blockquote>
<p>},</p>
</div></blockquote>
<section id="id29">
<h2>});<a class="headerlink" href="#id29" title="Permalink to this heading">¶</a></h2>
<p>API References: [Operation](<a class="reference external" href="https://metaplex-foundation.github.io/js/classes/js.CandyMachineClient.html#callGuardRoute">https://metaplex-foundation.github.io/js/classes/js.CandyMachineClient.html#callGuardRoute</a>), [Input](<a class="reference external" href="https://metaplex-foundation.github.io/js/types/js.CallCandyGuardRouteInput.html">https://metaplex-foundation.github.io/js/types/js.CallCandyGuardRouteInput.html</a>), [Output](<a class="reference external" href="https://metaplex-foundation.github.io/js/types/js.CallCandyGuardRouteOutput.html">https://metaplex-foundation.github.io/js/types/js.CallCandyGuardRouteOutput.html</a>), [Transaction Builder](<a class="reference external" href="https://metaplex-foundation.github.io/js/classes/js.CandyMachineBuildersClient.html#callGuardRoute">https://metaplex-foundation.github.io/js/classes/js.CandyMachineBuildersClient.html#callGuardRoute</a>), [Default Route Settings](<a class="reference external" href="https://metaplex-foundation.github.io/js/types/js.DefaultCandyGuardRouteSettings.html">https://metaplex-foundation.github.io/js/types/js.DefaultCandyGuardRouteSettings.html</a>).</p>
<p>&lt;/div&gt;
&lt;/AccordionItem&gt;
&lt;/Accordion&gt;</p>
<p>## Conclusion</p>
<p>The route instruction makes guards even more powerful by allowing them to ship with their own custom program logic. Check out the dedicated pages of [all available guards](/programs/candy-machine/available-guards) to see the full feature set of each guard.</p>
<p>Now that we know everything there is to know about setting up Candy Machines and their guards, it’s about time we talk about minting. See you on [the next page](/programs/candy-machine/minting)!</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../_sources/01-programs/02-candy-machine/07-special-guard-instructions.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>