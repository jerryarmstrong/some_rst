<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../../../../../" id="documentation_options" src="../../../../../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>package com.twitter.home_mixer.product.for_you</p>
<p>import com.twitter.tweetconvosvc.tweet_ancestor.{thriftscala =&gt; ta}
import com.twitter.home_mixer.model.HomeFeatures._
import com.twitter.mediaservices.commons.tweetmedia.{thriftscala =&gt; mt}
import com.twitter.product_mixer.component_library.candidate_source.timeline_scorer.ScoredTweetCandidateWithFocalTweet
import com.twitter.product_mixer.core.feature.Feature
import com.twitter.product_mixer.core.feature.featuremap.FeatureMap
import com.twitter.product_mixer.core.feature.featuremap.FeatureMapBuilder
import com.twitter.product_mixer.core.functional_component.transformer.CandidateFeatureTransformer
import com.twitter.product_mixer.core.model.common.identifier.TransformerIdentifier
import com.twitter.product_mixer.core.model.marshalling.response.urt.metadata.BasicTopicContextFunctionalityType
import com.twitter.product_mixer.core.model.marshalling.response.urt.metadata.RecWithEducationTopicContextFunctionalityType
import com.twitter.product_mixer.core.model.marshalling.response.urt.metadata.RecommendationTopicContextFunctionalityType
import com.twitter.search.common.constants.thriftjava.ThriftLanguage
import com.twitter.search.common.util.lang.ThriftLanguageUtil
import com.twitter.snowflake.id.SnowflakeId
import com.twitter.timelinemixer.injection.model.candidate.AudioSpaceMetaData
import com.twitter.timelines.conversation_features.{thriftscala =&gt; cvt}
import com.twitter.timelinescorer.common.scoredtweetcandidate.{thriftscala =&gt; stc}
import com.twitter.timelineservice.suggests.{thriftscala =&gt; tls}</p>
<dl>
<dt>object ForYouTimelineScorerResponseFeatureTransformer</dt><dd><blockquote>
<div><p>extends CandidateFeatureTransformer[ScoredTweetCandidateWithFocalTweet] {</p>
</div></blockquote>
<dl class="simple">
<dt>override val identifier: TransformerIdentifier =</dt><dd><p>TransformerIdentifier(“ForYouTimelineScorerResponse”)</p>
</dd>
<dt>override val features: Set[Feature[_, _]] = Set(</dt><dd><p>AncestorsFeature,
AudioSpaceMetaDataFeature,
AuthorIdFeature,
AuthorIsBlueVerifiedFeature,
AuthorIsCreatorFeature,
AuthorIsGoldVerifiedFeature,
AuthorIsGrayVerifiedFeature,
AuthorIsLegacyVerifiedFeature,
AuthoredByContextualUserFeature,
CandidateSourceIdFeature,
ConversationFeature,
ConversationModuleFocalTweetIdFeature,
ConversationModuleIdFeature,
DirectedAtUserIdFeature,
EarlybirdFeature,
EntityTokenFeature,
ExclusiveConversationAuthorIdFeature,
FavoritedByUserIdsFeature,
FollowedByUserIdsFeature,
TopicIdSocialContextFeature,
TopicContextFunctionalityTypeFeature,
FromInNetworkSourceFeature,
FullScoringSucceededFeature,
HasDisplayedTextFeature,
InNetworkFeature,
InReplyToTweetIdFeature,
IsAncestorCandidateFeature,
IsExtendedReplyFeature,
IsRandomTweetFeature,
IsReadFromCacheFeature,
IsRetweetFeature,
IsRetweetedReplyFeature,
NonSelfFavoritedByUserIdsFeature,
NumImagesFeature,
OriginalTweetCreationTimeFromSnowflakeFeature,
PredictionRequestIdFeature,
QuotedTweetIdFeature,
ScoreFeature,
SimclustersTweetTopKClustersWithScoresFeature,
SourceTweetIdFeature,
SourceUserIdFeature,
StreamToKafkaFeature,
SuggestTypeFeature,
TweetLanguageFeature,
VideoDurationMsFeature,</p>
</dd>
</dl>
<p>)</p>
<p>// Convert language code to ISO 639-3 format
private def getLanguageISOFormatByValue(languageCodeValue: Int): String =</p>
<blockquote>
<div><p>ThriftLanguageUtil.getLanguageCodeOf(ThriftLanguage.findByValue(languageCodeValue))</p>
</div></blockquote>
<dl>
<dt>override def transform(</dt><dd><p>candidateWithFocalTweet: ScoredTweetCandidateWithFocalTweet</p>
</dd>
<dt>): FeatureMap = {</dt><dd><p>val candidate: stc.v1.ScoredTweetCandidate = candidateWithFocalTweet.candidate
val focalTweetId = candidateWithFocalTweet.focalTweetIdOpt</p>
<p>val originalTweetId = candidate.sourceTweetId.getOrElse(candidate.tweetId)
val tweetFeatures = candidate.tweetFeaturesMap.flatMap(_.get(originalTweetId))
val earlybirdFeatures = tweetFeatures.flatMap(_.recapFeatures.flatMap(_.tweetFeatures))
val directedAtUserIsInFirstDegree =</p>
<blockquote>
<div><p>earlybirdFeatures.flatMap(_.directedAtUserIdIsInFirstDegree)</p>
</div></blockquote>
<p>val isReply = candidate.inReplyToTweetId.nonEmpty
val isRetweet = candidate.isRetweet.getOrElse(false)
val isInNetwork = candidate.isInNetwork.getOrElse(true)
val conversationFeatures = candidate.conversationFeatures.flatMap {</p>
<blockquote>
<div><p>case cvt.ConversationFeatures.V1(candidate) =&gt; Some(candidate)
case _ =&gt; None</p>
</div></blockquote>
<p>}
val numImages = candidate.mediaMetaData</p>
<blockquote>
<div><dl class="simple">
<dt>.map(</dt><dd><dl class="simple">
<dt>_.count(mediaEntity =&gt;</dt><dd><dl class="simple">
<dt>mediaEntity.mediaInfo.exists(_.isInstanceOf[mt.MediaInfo.ImageInfo]) ||</dt><dd><p>mediaEntity.mediaInfo.isEmpty))</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>val hasImage = earlybirdFeatures.exists(_.hasImage)
val hasVideo = earlybirdFeatures.exists(_.hasVideo)
val hasCard = earlybirdFeatures.exists(_.hasCard)
val hasQuote = earlybirdFeatures.exists(_.hasQuote.contains(true))
val hasDisplayedText = earlybirdFeatures.exists(_.tweetLength.exists(length =&gt; {</p>
<blockquote>
<div><p>val numMedia = Seq(hasVideo, (hasImage || hasCard), hasQuote).count(b =&gt; b)
val tcoLengthsPlusSpaces = 23 * numMedia + (if (numMedia &gt; 0) numMedia - 1 else 0)
length &gt; tcoLengthsPlusSpaces</p>
</div></blockquote>
<p>}))
val suggestType = candidate.overrideSuggestType.orElse(Some(tls.SuggestType.Undefined))</p>
<p>val topicSocialProofMetadataOpt = candidate.entityData.flatMap(_.topicSocialProofMetadata)
val topicIdSocialContextOpt = topicSocialProofMetadataOpt.map(_.topicId)
val topicContextFunctionalityTypeOpt =</p>
<blockquote>
<div><dl>
<dt>topicSocialProofMetadataOpt.map(_.topicContextFunctionalityType).collect {</dt><dd><p>case stc.v1.TopicContextFunctionalityType.Basic =&gt; BasicTopicContextFunctionalityType
case stc.v1.TopicContextFunctionalityType.Recommendation =&gt;</p>
<blockquote>
<div><p>RecommendationTopicContextFunctionalityType</p>
</div></blockquote>
<dl class="simple">
<dt>case stc.v1.TopicContextFunctionalityType.RecWithEducation =&gt;</dt><dd><p>RecWithEducationTopicContextFunctionalityType</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<dl>
<dt>FeatureMapBuilder()</dt><dd><dl>
<dt>.add(</dt><dd><p>AncestorsFeature,
candidate.ancestors</p>
<blockquote>
<div><p>.getOrElse(Seq.empty)
.map(ancestor =&gt; ta.TweetAncestor(ancestor.tweetId, ancestor.userId.getOrElse(0L))))</p>
</div></blockquote>
</dd>
<dt>.add(</dt><dd><p>AudioSpaceMetaDataFeature,
candidate.audioSpaceMetaDatalist.map(_.head).map(AudioSpaceMetaData.fromThrift))</p>
</dd>
</dl>
<p>.add(AuthorIdFeature, Some(candidate.authorId))
.add(AuthorIsBlueVerifiedFeature, candidate.authorIsBlueVerified.getOrElse(false))
.add(</p>
<blockquote>
<div><p>AuthorIsCreatorFeature,
candidate.authorIsCreator.getOrElse(false)</p>
</div></blockquote>
<p>)
.add(AuthorIsGoldVerifiedFeature, candidate.authorIsGoldVerified.getOrElse(false))
.add(AuthorIsGrayVerifiedFeature, candidate.authorIsGrayVerified.getOrElse(false))
.add(AuthorIsLegacyVerifiedFeature, candidate.authorIsLegacyVerified.getOrElse(false))
.add(</p>
<blockquote>
<div><p>AuthoredByContextualUserFeature,
candidate.viewerId.contains(candidate.authorId) ||</p>
<blockquote>
<div><p>candidate.viewerId.exists(candidate.sourceUserId.contains))</p>
</div></blockquote>
</div></blockquote>
<p>.add(CandidateSourceIdFeature, candidate.candidateTweetSourceId)
.add(ConversationFeature, conversationFeatures)
.add(ConversationModuleIdFeature, candidate.conversationId)
.add(ConversationModuleFocalTweetIdFeature, focalTweetId)
.add(DirectedAtUserIdFeature, candidate.directedAtUserId)
.add(EarlybirdFeature, earlybirdFeatures)
// This is temporary, will need to be updated with the encoded string.
.add(EntityTokenFeature, Some(“test_EntityTokenForYou”))
.add(ExclusiveConversationAuthorIdFeature, candidate.exclusiveConversationAuthorId)
.add(FavoritedByUserIdsFeature, candidate.favoritedByUserIds.getOrElse(Seq.empty))
.add(FollowedByUserIdsFeature, candidate.followedByUserIds.getOrElse(Seq.empty))
.add(TopicIdSocialContextFeature, topicIdSocialContextOpt)
.add(TopicContextFunctionalityTypeFeature, topicContextFunctionalityTypeOpt)
.add(FullScoringSucceededFeature, candidate.fullScoringSucceeded.getOrElse(false))
.add(HasDisplayedTextFeature, hasDisplayedText)
.add(InNetworkFeature, candidate.isInNetwork.getOrElse(true))
.add(InReplyToTweetIdFeature, candidate.inReplyToTweetId)
.add(IsAncestorCandidateFeature, candidate.isAncestorCandidate.getOrElse(false))
.add(</p>
<blockquote>
<div><p>IsExtendedReplyFeature,
isInNetwork &amp;&amp; isReply &amp;&amp; !isRetweet &amp;&amp; directedAtUserIsInFirstDegree.contains(false))</p>
</div></blockquote>
<p>.add(FromInNetworkSourceFeature, candidate.isInNetwork.getOrElse(true))
.add(IsRandomTweetFeature, candidate.isRandomTweet.getOrElse(false))
.add(IsReadFromCacheFeature, candidate.isReadFromCache.getOrElse(false))
.add(IsRetweetFeature, candidate.isRetweet.getOrElse(false))
.add(IsRetweetedReplyFeature, isReply &amp;&amp; isRetweet)
.add(</p>
<blockquote>
<div><p>NonSelfFavoritedByUserIdsFeature,
candidate.favoritedByUserIds.getOrElse(Seq.empty).filterNot(_ == candidate.authorId))</p>
</div></blockquote>
<p>.add(NumImagesFeature, numImages)
.add(</p>
<blockquote>
<div><p>OriginalTweetCreationTimeFromSnowflakeFeature,
SnowflakeId.timeFromIdOpt(originalTweetId))</p>
</div></blockquote>
<p>.add(PredictionRequestIdFeature, candidate.predictionRequestId)
.add(ScoreFeature, Some(candidate.score))
.add(</p>
<blockquote>
<div><p>SimclustersTweetTopKClustersWithScoresFeature,
candidate.simclustersTweetTopKClustersWithScores.map(_.toMap).getOrElse(Map.empty))</p>
</div></blockquote>
<dl class="simple">
<dt>.add(</dt><dd><p>StreamToKafkaFeature,
candidate.predictionRequestId.nonEmpty &amp;&amp; candidate.fullScoringSucceeded.getOrElse(false))</p>
</dd>
</dl>
<p>.add(SourceTweetIdFeature, candidate.sourceTweetId)
.add(SourceUserIdFeature, candidate.sourceUserId)
.add(SuggestTypeFeature, suggestType)
.add(QuotedTweetIdFeature, candidate.quotedTweetId)
.add(</p>
<blockquote>
<div><p>TweetLanguageFeature,
earlybirdFeatures.flatMap(_.language.map(_.value)).map(getLanguageISOFormatByValue))</p>
</div></blockquote>
<p>.add(VideoDurationMsFeature, earlybirdFeatures.flatMap(_.videoDurationMs))
.build()</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../../../../../index.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../../../../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../../../../../_sources/home-mixer/server/src/main/scala/com/twitter/home_mixer/product/for_you/ForYouTimelineScorerResponseFeatureTransformer.scala.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>