<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../../../" id="documentation_options" src="../../../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>package com.twitter.recosinjector</p>
<p>import com.twitter.app.Flag
import com.twitter.finagle.http.HttpMuxer
import com.twitter.finagle.mtls.authentication.ServiceIdentifier
import com.twitter.finagle.stats.StatsReceiver
import com.twitter.frigate.common.util.ElfOwlFilter
import com.twitter.recosinjector.clients.Gizmoduck
import com.twitter.recosinjector.clients.RecosHoseEntitiesCache
import com.twitter.recosinjector.clients.SocialGraph
import com.twitter.recosinjector.clients.Tweetypie
import com.twitter.recosinjector.clients.UrlResolver
import com.twitter.recosinjector.config._
import com.twitter.recosinjector.edges.SocialWriteEventToUserUserGraphBuilder
import com.twitter.recosinjector.edges.TimelineEventToUserTweetEntityGraphBuilder
import com.twitter.recosinjector.edges.TweetEventToUserTweetEntityGraphBuilder
import com.twitter.recosinjector.edges.TweetEventToUserUserGraphBuilder
import com.twitter.recosinjector.edges.UnifiedUserActionToUserVideoGraphBuilder
import com.twitter.recosinjector.edges.UnifiedUserActionToUserAdGraphBuilder
import com.twitter.recosinjector.edges.UnifiedUserActionToUserTweetGraphPlusBuilder
import com.twitter.recosinjector.edges.UserTweetEntityEdgeBuilder
import com.twitter.recosinjector.event_processors.SocialWriteEventProcessor
import com.twitter.recosinjector.event_processors.TimelineEventProcessor
import com.twitter.recosinjector.event_processors.TweetEventProcessor
import com.twitter.recosinjector.publishers.KafkaEventPublisher
import com.twitter.recosinjector.uua_processors.UnifiedUserActionProcessor
import com.twitter.recosinjector.uua_processors.UnifiedUserActionsConsumer
import com.twitter.server.logging.{Logging =&gt; JDK14Logging}
import com.twitter.server.Deciderable
import com.twitter.server.TwitterServer
import com.twitter.socialgraph.thriftscala.WriteEvent
import com.twitter.timelineservice.thriftscala.{Event =&gt; TimelineEvent}
import com.twitter.tweetypie.thriftscala.TweetEvent
import com.twitter.util.Await
import com.twitter.util.Duration
import java.util.concurrent.TimeUnit</p>
<p>object Main extends TwitterServer with JDK14Logging with Deciderable { self =&gt;</p>
<blockquote>
<div><p>implicit val stats: StatsReceiver = statsReceiver</p>
<p>private val dataCenter: Flag[String] = flag(“service.cluster”, “atla”, “Data Center”)
private val serviceRole: Flag[String] = flag(“service.role”, “Service Role”)
private val serviceEnv: Flag[String] = flag(“service.env”, “Service Env”)
private val serviceName: Flag[String] = flag(“service.name”, “Service Name”)
private val shardId = flag(“shardId”, 0, “Shard ID”)
private val numShards = flag(“numShards”, 1, “Number of shards for this service”)
private val truststoreLocation =</p>
<blockquote>
<div><p>flag[String](“truststore_location”, “”, “Truststore file location”)</p>
</div></blockquote>
<dl>
<dt>def main(): Unit = {</dt><dd><dl class="simple">
<dt>val serviceIdentifier = ServiceIdentifier(</dt><dd><p>role = serviceRole(),
service = serviceName(),
environment = serviceEnv(),
zone = dataCenter()</p>
</dd>
</dl>
<p>)
println(“ServiceIdentifier = “ + serviceIdentifier.toString)
log.info(“ServiceIdentifier = “ + serviceIdentifier.toString)</p>
<p>val shard = shardId()
val numOfShards = numShards()
val environment = serviceEnv()</p>
<dl>
<dt>implicit val config: DeployConfig = {</dt><dd><dl class="simple">
<dt>environment match {</dt><dd><p>case “prod” =&gt; ProdConfig(serviceIdentifier)(stats)
case “staging” | “devel” =&gt; StagingConfig(serviceIdentifier)
case env =&gt; throw new Exception(s”Unknown environment $env”)</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<p>// Initialize the config and wait for initialization to finish
Await.ready(config.init())</p>
<dl class="simple">
<dt>log.info(</dt><dd><p>“Starting Recos Injector: environment %s, clientId %s”,
environment,
config.recosInjectorThriftClientId</p>
</dd>
</dl>
<p>)
log.info(“Starting shard Id: %d of %d shards…”.format(shard, numOfShards))</p>
<p>// Client wrappers
val cache = new RecosHoseEntitiesCache(config.recosInjectorCoreSvcsCacheClient)
val gizmoduck = new Gizmoduck(config.userStore)
val socialGraph = new SocialGraph(config.socialGraphIdStore)
val tweetypie = new Tweetypie(config.tweetyPieStore)
val urlResolver = new UrlResolver(config.urlInfoStore)</p>
<p>// Edge builders
val userTweetEntityEdgeBuilder = new UserTweetEntityEdgeBuilder(cache, urlResolver)</p>
<p>// Publishers
val kafkaEventPublisher = KafkaEventPublisher(</p>
<blockquote>
<div><p>“/s/kafka/recommendations:kafka-tls”,
config.outputKafkaTopicPrefix,
config.recosInjectorThriftClientId,
truststoreLocation())</p>
</div></blockquote>
<p>// Message Builders
val socialWriteToUserUserMessageBuilder =</p>
<blockquote>
<div><dl class="simple">
<dt>new SocialWriteEventToUserUserGraphBuilder()(</dt><dd><p>statsReceiver.scope(“SocialWriteEventToUserUserGraphBuilder”)</p>
</dd>
</dl>
<p>)</p>
</div></blockquote>
<dl class="simple">
<dt>val timelineToUserTweetEntityMessageBuilder = new TimelineEventToUserTweetEntityGraphBuilder(</dt><dd><p>userTweetEntityEdgeBuilder = userTweetEntityEdgeBuilder</p>
</dd>
</dl>
<p>)(statsReceiver.scope(“TimelineEventToUserTweetEntityGraphBuilder”))</p>
<dl class="simple">
<dt>val tweetEventToUserTweetEntityGraphBuilder = new TweetEventToUserTweetEntityGraphBuilder(</dt><dd><p>userTweetEntityEdgeBuilder = userTweetEntityEdgeBuilder,
tweetCreationStore = config.tweetCreationStore,
decider = config.recosInjectorDecider</p>
</dd>
</dl>
<p>)(statsReceiver.scope(“TweetEventToUserTweetEntityGraphBuilder”))</p>
<dl class="simple">
<dt>val socialWriteEventProcessor = new SocialWriteEventProcessor(</dt><dd><p>eventBusStreamName = s”recos_injector_social_write_event_$environment”,
thriftStruct = WriteEvent,
serviceIdentifier = serviceIdentifier,
kafkaEventPublisher = kafkaEventPublisher,
userUserGraphTopic = KafkaEventPublisher.UserUserTopic,
userUserGraphMessageBuilder = socialWriteToUserUserMessageBuilder</p>
</dd>
</dl>
<p>)(statsReceiver.scope(“SocialWriteEventProcessor”))</p>
<dl class="simple">
<dt>val tweetToUserUserMessageBuilder = new TweetEventToUserUserGraphBuilder()(</dt><dd><p>statsReceiver.scope(“TweetEventToUserUserGraphBuilder”)</p>
</dd>
</dl>
<p>)</p>
<dl class="simple">
<dt>val unifiedUserActionToUserVideoGraphBuilder = new UnifiedUserActionToUserVideoGraphBuilder(</dt><dd><p>userTweetEntityEdgeBuilder = userTweetEntityEdgeBuilder</p>
</dd>
</dl>
<p>)(statsReceiver.scope(“UnifiedUserActionToUserVideoGraphBuilder”))</p>
<dl class="simple">
<dt>val unifiedUserActionToUserAdGraphBuilder = new UnifiedUserActionToUserAdGraphBuilder(</dt><dd><p>userTweetEntityEdgeBuilder = userTweetEntityEdgeBuilder</p>
</dd>
</dl>
<p>)(statsReceiver.scope(“UnifiedUserActionToUserAdGraphBuilder”))</p>
<dl>
<dt>val unifiedUserActionToUserTweetGraphPlusBuilder =</dt><dd><dl class="simple">
<dt>new UnifiedUserActionToUserTweetGraphPlusBuilder(</dt><dd><p>userTweetEntityEdgeBuilder = userTweetEntityEdgeBuilder</p>
</dd>
</dl>
<p>)(statsReceiver.scope(“UnifiedUserActionToUserTweetGraphPlusBuilder”))</p>
</dd>
</dl>
<p>// Processors
val tweetEventProcessor = new TweetEventProcessor(</p>
<blockquote>
<div><p>eventBusStreamName = s”recos_injector_tweet_events_$environment”,
thriftStruct = TweetEvent,
serviceIdentifier = serviceIdentifier,
userUserGraphMessageBuilder = tweetToUserUserMessageBuilder,
userUserGraphTopic = KafkaEventPublisher.UserUserTopic,
userTweetEntityGraphMessageBuilder = tweetEventToUserTweetEntityGraphBuilder,
userTweetEntityGraphTopic = KafkaEventPublisher.UserTweetEntityTopic,
kafkaEventPublisher = kafkaEventPublisher,
socialGraph = socialGraph,
tweetypie = tweetypie,
gizmoduck = gizmoduck</p>
</div></blockquote>
<p>)(statsReceiver.scope(“TweetEventProcessor”))</p>
<dl class="simple">
<dt>val timelineEventProcessor = new TimelineEventProcessor(</dt><dd><p>eventBusStreamName = s”recos_injector_timeline_events_prototype_$environment”,
thriftStruct = TimelineEvent,
serviceIdentifier = serviceIdentifier,
kafkaEventPublisher = kafkaEventPublisher,
userTweetEntityGraphTopic = KafkaEventPublisher.UserTweetEntityTopic,
userTweetEntityGraphMessageBuilder = timelineToUserTweetEntityMessageBuilder,
decider = config.recosInjectorDecider,
gizmoduck = gizmoduck,
tweetypie = tweetypie</p>
</dd>
</dl>
<p>)(statsReceiver.scope(“TimelineEventProcessor”))</p>
<dl class="simple">
<dt>val eventBusProcessors = Seq(</dt><dd><p>timelineEventProcessor,
socialWriteEventProcessor,
tweetEventProcessor</p>
</dd>
</dl>
<p>)</p>
<dl class="simple">
<dt>val uuaProcessor = new UnifiedUserActionProcessor(</dt><dd><p>gizmoduck = gizmoduck,
tweetypie = tweetypie,
kafkaEventPublisher = kafkaEventPublisher,
userVideoGraphTopic = KafkaEventPublisher.UserVideoTopic,
userVideoGraphBuilder = unifiedUserActionToUserVideoGraphBuilder,
userAdGraphTopic = KafkaEventPublisher.UserAdTopic,
userAdGraphBuilder = unifiedUserActionToUserAdGraphBuilder,
userTweetGraphPlusTopic = KafkaEventPublisher.UserTweetPlusTopic,
userTweetGraphPlusBuilder = unifiedUserActionToUserTweetGraphPlusBuilder)(
statsReceiver.scope(“UnifiedUserActionProcessor”))</p>
</dd>
</dl>
<p>val uuaConsumer = new UnifiedUserActionsConsumer(uuaProcessor, truststoreLocation())</p>
<p>// Start-up init and graceful shutdown setup</p>
<p>// wait a bit for services to be ready
Thread.sleep(5000L)</p>
<p>log.info(“Starting the event processors”)
eventBusProcessors.foreach(_.start())</p>
<p>log.info(“Starting the uua processors”)
uuaConsumer.atLeastOnceProcessor.start()</p>
<p>this.addAdminRoute(ElfOwlFilter.getPostbackRoute())</p>
<dl class="simple">
<dt>onExit {</dt><dd><p>log.info(“Shutting down the event processors”)
eventBusProcessors.foreach(_.stop())
log.info(“Shutting down the uua processors”)
uuaConsumer.atLeastOnceProcessor.close()
log.info(“done exit”)</p>
</dd>
</dl>
<p>}</p>
<p>// Wait on the thriftServer so that shutdownTimeout is respected.
Await.result(adminHttpServer)</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}</p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../../../index.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../../../_sources/recos-injector/server/src/main/scala/com/twitter/recosinjector/Main.scala.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>