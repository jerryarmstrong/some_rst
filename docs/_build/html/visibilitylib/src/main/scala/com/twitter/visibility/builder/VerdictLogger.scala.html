<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../../../" id="documentation_options" src="../../../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>package com.twitter.visibility.builder</p>
<p>import com.twitter.datatools.entityservice.entities.thriftscala.FleetInterstitial
import com.twitter.decider.Decider
import com.twitter.decider.Decider.NullDecider
import com.twitter.finagle.stats.NullStatsReceiver
import com.twitter.finagle.stats.StatsReceiver
import com.twitter.logpipeline.client.common.EventPublisher
import com.twitter.logpipeline.client.EventPublisherManager
import com.twitter.logpipeline.client.serializers.EventLogMsgThriftStructSerializer
import com.twitter.spam.rtf.thriftscala.SafetyLevel
import com.twitter.visibility.builder.VerdictLogger.FailureCounterName
import com.twitter.visibility.builder.VerdictLogger.SuccessCounterName
import com.twitter.visibility.features.Feature
import com.twitter.visibility.logging.thriftscala.ActionSource
import com.twitter.visibility.logging.thriftscala.EntityId
import com.twitter.visibility.logging.thriftscala.EntityIdType
import com.twitter.visibility.logging.thriftscala.EntityIdValue
import com.twitter.visibility.logging.thriftscala.HealthActionType
import com.twitter.visibility.logging.thriftscala.MisinfoPolicyCategory
import com.twitter.visibility.logging.thriftscala.VFLibType
import com.twitter.visibility.logging.thriftscala.VFVerdictLogEntry
import com.twitter.visibility.models.ContentId
import com.twitter.visibility.rules._</p>
<p>object VerdictLogger {</p>
<blockquote>
<div><p>private val BaseStatsNamespace = “vf_verdict_logger”
private val FailureCounterName = “failures”
private val SuccessCounterName = “successes”
val LogCategoryName: String = “visibility_filtering_verdicts”</p>
<p>val Empty: VerdictLogger = new VerdictLogger(NullStatsReceiver, NullDecider, None)</p>
<dl>
<dt>def apply(</dt><dd><p>statsReceiver: StatsReceiver,
decider: Decider</p>
</dd>
<dt>): VerdictLogger = {</dt><dd><dl class="simple">
<dt>val eventPublisher: EventPublisher[VFVerdictLogEntry] =</dt><dd><dl class="simple">
<dt>EventPublisherManager</dt><dd><dl class="simple">
<dt>.newScribePublisherBuilder(</dt><dd><p>LogCategoryName,
EventLogMsgThriftStructSerializer.getNewSerializer[VFVerdictLogEntry]()).build()</p>
</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p>new VerdictLogger(statsReceiver.scope(BaseStatsNamespace), decider, Some(eventPublisher))</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}</p>
<dl>
<dt>class VerdictLogger(</dt><dd><p>statsReceiver: StatsReceiver,
decider: Decider,
publisherOpt: Option[EventPublisher[VFVerdictLogEntry]]) {</p>
<dl>
<dt>def log(</dt><dd><p>verdictLogEntry: VFVerdictLogEntry,
publisher: EventPublisher[VFVerdictLogEntry]</p>
</dd>
<dt>): Unit = {</dt><dd><dl>
<dt>publisher</dt><dd><p>.publish(verdictLogEntry)
.onSuccess(_ =&gt; statsReceiver.counter(SuccessCounterName).incr())
.onFailure { e =&gt;</p>
<blockquote>
<div><p>statsReceiver.counter(FailureCounterName).incr()
statsReceiver.scope(FailureCounterName).counter(e.getClass.getName).incr()</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private def toEntityId(contentId: ContentId): Option[EntityId] = {</dt><dd><dl>
<dt>contentId match {</dt><dd><p>case ContentId.TweetId(id) =&gt; Some(EntityId(EntityIdType.TweetId, EntityIdValue.EntityId(id)))
case ContentId.UserId(id) =&gt; Some(EntityId(EntityIdType.UserId, EntityIdValue.EntityId(id)))
case ContentId.QuotedTweetRelationship(outerTweetId, _) =&gt;</p>
<blockquote>
<div><p>Some(EntityId(EntityIdType.TweetId, EntityIdValue.EntityId(outerTweetId)))</p>
</div></blockquote>
<dl class="simple">
<dt>case ContentId.NotificationId(Some(id)) =&gt;</dt><dd><p>Some(EntityId(EntityIdType.NotificationId, EntityIdValue.EntityId(id)))</p>
</dd>
</dl>
<p>case ContentId.DmId(id) =&gt; Some(EntityId(EntityIdType.DmId, EntityIdValue.EntityId(id)))
case ContentId.BlenderTweetId(id) =&gt;</p>
<blockquote>
<div><p>Some(EntityId(EntityIdType.TweetId, EntityIdValue.EntityId(id)))</p>
</div></blockquote>
<p>case ContentId.SpacePlusUserId(_) =&gt;</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private def getLogEntryData(</dt><dd><p>actingRule: Option[Rule],
secondaryActingRules: Seq[Rule],
verdict: Action,
secondaryVerdicts: Seq[Action],
resolvedFeatureMap: Map[Feature[_], Any]</p>
</dd>
<dt>): (Seq[String], Seq[ActionSource], Seq[HealthActionType], Option[FleetInterstitial]) = {</dt><dd><dl>
<dt>actingRule</dt><dd><dl>
<dt>.filter {</dt><dd><dl class="simple">
<dt>case decideredRule: DoesLogVerdictDecidered =&gt;</dt><dd><p>decider.isAvailable(decideredRule.verdictLogDeciderKey.toString)</p>
</dd>
</dl>
<p>case rule: DoesLogVerdict =&gt; true
case _ =&gt; false</p>
</dd>
</dl>
<p>}
.map { primaryRule =&gt;</p>
<blockquote>
<div><p>val secondaryRulesAndVerdicts = secondaryActingRules zip secondaryVerdicts
var actingRules: Seq[Rule] = Seq(primaryRule)
var actingRuleNames: Seq[String] = Seq(primaryRule.name)
var actionSources: Seq[ActionSource] = Seq()
var healthActionTypes: Seq[HealthActionType] = Seq(verdict.toHealthActionTypeThrift.get)</p>
<dl>
<dt>val misinfoPolicyCategory: Option[FleetInterstitial] = {</dt><dd><dl>
<dt>verdict match {</dt><dd><dl class="simple">
<dt>case softIntervention: SoftIntervention =&gt;</dt><dd><p>softIntervention.fleetInterstitial</p>
</dd>
<dt>case tweetInterstitial: TweetInterstitial =&gt;</dt><dd><p>tweetInterstitial.softIntervention.flatMap(_.fleetInterstitial)</p>
</dd>
</dl>
<p>case _ =&gt; None</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>secondaryRulesAndVerdicts.foreach(ruleAndVerdict =&gt; {</dt><dd><dl class="simple">
<dt>if (ruleAndVerdict._1.isInstanceOf[DoesLogVerdict]) {</dt><dd><p>actingRules = actingRules :+ ruleAndVerdict._1
actingRuleNames = actingRuleNames :+ ruleAndVerdict._1.name
healthActionTypes = healthActionTypes :+ ruleAndVerdict._2.toHealthActionTypeThrift.get</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>})</p>
<dl>
<dt>actingRules.foreach(rule =&gt; {</dt><dd><dl>
<dt>rule.actionSourceBuilder</dt><dd><p>.flatMap(_.build(resolvedFeatureMap, verdict))
.map(actionSource =&gt; {</p>
<blockquote>
<div><p>actionSources = actionSources :+ actionSource</p>
</div></blockquote>
<p>})</p>
</dd>
</dl>
</dd>
</dl>
<p>})
(actingRuleNames, actionSources, healthActionTypes, misinfoPolicyCategory)</p>
</div></blockquote>
<p>}
.getOrElse((Seq.empty[String], Seq.empty[ActionSource], Seq.empty[HealthActionType], None))</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<dl>
<dt>def scribeVerdict(</dt><dd><p>visibilityResult: VisibilityResult,
safetyLevel: SafetyLevel,
vfLibType: VFLibType,
viewerId: Option[Long] = None</p>
</dd>
<dt>): Unit = {</dt><dd><dl>
<dt>publisherOpt.foreach { publisher =&gt;</dt><dd><dl>
<dt>toEntityId(visibilityResult.contentId).foreach { entityId =&gt;</dt><dd><dl>
<dt>visibilityResult.verdict.toHealthActionTypeThrift.foreach { healthActionType =&gt;</dt><dd><dl>
<dt>val (actioningRules, actionSources, healthActionTypes, misinfoPolicyCategory) =</dt><dd><dl class="simple">
<dt>getLogEntryData(</dt><dd><p>actingRule = visibilityResult.actingRule,
secondaryActingRules = visibilityResult.secondaryActingRules,
verdict = visibilityResult.verdict,
secondaryVerdicts = visibilityResult.secondaryVerdicts,
resolvedFeatureMap = visibilityResult.resolvedFeatureMap</p>
</dd>
</dl>
<p>)</p>
</dd>
<dt>if (actioningRules.nonEmpty) {</dt><dd><dl>
<dt>log(</dt><dd><dl>
<dt>VFVerdictLogEntry(</dt><dd><p>entityId = entityId,
viewerId = viewerId,
timestampMsec = System.currentTimeMillis(),
vfLibType = vfLibType,
healthActionType = healthActionType,
safetyLevel = safetyLevel,
actioningRules = actioningRules,
actionSources = actionSources,
healthActionTypes = healthActionTypes,
misinfoPolicyCategory =</p>
<blockquote>
<div><p>fleetInterstitialToMisinfoPolicyCategory(misinfoPolicyCategory)</p>
</div></blockquote>
</dd>
</dl>
<p>),
publisher</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>def fleetInterstitialToMisinfoPolicyCategory(</dt><dd><p>fleetInterstitialOption: Option[FleetInterstitial]</p>
</dd>
<dt>): Option[MisinfoPolicyCategory] = {</dt><dd><dl>
<dt>fleetInterstitialOption.map {</dt><dd><dl class="simple">
<dt>case FleetInterstitial.Generic =&gt;</dt><dd><p>MisinfoPolicyCategory.Generic</p>
</dd>
<dt>case FleetInterstitial.Samm =&gt;</dt><dd><p>MisinfoPolicyCategory.Samm</p>
</dd>
<dt>case FleetInterstitial.CivicIntegrity =&gt;</dt><dd><p>MisinfoPolicyCategory.CivicIntegrity</p>
</dd>
</dl>
<p>case _ =&gt; MisinfoPolicyCategory.Unknown</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../../../index.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../../../_sources/visibilitylib/src/main/scala/com/twitter/visibility/builder/VerdictLogger.scala.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>