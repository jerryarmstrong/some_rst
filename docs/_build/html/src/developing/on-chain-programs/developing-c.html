<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>docs/src/developing/on-chain-programs/developing-c.md &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="docs-src-developing-on-chain-programs-developing-c-md">
<h1>docs/src/developing/on-chain-programs/developing-c.md<a class="headerlink" href="#docs-src-developing-on-chain-programs-developing-c-md" title="Permalink to this heading">¶</a></h1>
<p>Last edited: 2023-08-11 21:38:33</p>
<p>Contents:</p>
<div class="highlight-md notranslate"><div class="highlight"><pre><span></span>---
</pre></div>
</div>
<p>title: “Developing with C”
—</p>
<p>Solana supports writing on-chain programs using the C and C++ programming
languages.</p>
<p>## Project Layout</p>
<p>C projects are laid out as follows:</p>
<p><code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">/src/&lt;program</span> <span class="pre">name&gt;</span>
<span class="pre">/makefile</span>
<span class="pre">`</span></code></p>
<p>The <cite>makefile</cite> should contain the following:</p>
<p><code class="docutils literal notranslate"><span class="pre">`bash</span>
<span class="pre">OUT_DIR</span> <span class="pre">:=</span> <span class="pre">&lt;path</span> <span class="pre">to</span> <span class="pre">place</span> <span class="pre">to</span> <span class="pre">resulting</span> <span class="pre">shared</span> <span class="pre">object&gt;</span>
<span class="pre">include</span> <span class="pre">~/.local/share/solana/install/active_release/bin/sdk/sbf/c/sbf.mk</span>
<span class="pre">`</span></code></p>
<p>The sbf-sdk may not be in the exact place specified above but if you setup your
environment per [How to Build](#how-to-build) then it should be.</p>
<p>## How to Build</p>
<p>First setup the environment:</p>
<ul class="simple">
<li><p>Install the latest Rust stable from <a class="reference external" href="https://rustup.rs">https://rustup.rs</a></p></li>
<li><p>Install the latest [Solana command-line tools](../../cli/install-solana-cli-tools.md)</p></li>
</ul>
<p>Then build using make:</p>
<p><code class="docutils literal notranslate"><span class="pre">`bash</span>
<span class="pre">make</span> <span class="pre">-C</span> <span class="pre">&lt;program</span> <span class="pre">directory&gt;</span>
<span class="pre">`</span></code></p>
<p>## How to Test</p>
<p>Solana uses the [Criterion](<a class="reference external" href="https://github.com/Snaipe/Criterion">https://github.com/Snaipe/Criterion</a>) test framework
and tests are executed each time the program is built [How to
Build](#how-to-build).</p>
<p>To add tests, create a new file next to your source file named <cite>test_&lt;program name&gt;.c</cite>
and populate it with criterion test cases. See the [Criterion docs](<a class="reference external" href="https://criterion.readthedocs.io/en/master">https://criterion.readthedocs.io/en/master</a>)
for information on how to write a test case.</p>
<p>## Program Entrypoint</p>
<p>Programs export a known entrypoint symbol which the Solana runtime looks up and
calls when invoking a program. Solana supports multiple versions of the SBF loader and the entrypoints may vary between them.
Programs must be written for and deployed to the same loader. For more details
see the [FAQ section on Loaders](./faq.md#loaders).</p>
<p>Currently there are two supported loaders [SBF
Loader](<a class="reference external" href="https://github.com/solana-labs/solana/blob/7ddf10e602d2ed87a9e3737aa8c32f1db9f909d8/sdk/program/src/bpf_loader.rs#L17">https://github.com/solana-labs/solana/blob/7ddf10e602d2ed87a9e3737aa8c32f1db9f909d8/sdk/program/src/bpf_loader.rs#L17</a>)
and [SBF loader
deprecated](<a class="reference external" href="https://github.com/solana-labs/solana/blob/7ddf10e602d2ed87a9e3737aa8c32f1db9f909d8/sdk/program/src/bpf_loader_deprecated.rs#L14">https://github.com/solana-labs/solana/blob/7ddf10e602d2ed87a9e3737aa8c32f1db9f909d8/sdk/program/src/bpf_loader_deprecated.rs#L14</a>).</p>
<p>They both have the same raw entrypoint definition, the following is the raw
symbol that the runtime looks up and calls:</p>
<p><code class="docutils literal notranslate"><span class="pre">`c</span>
<span class="pre">extern</span> <span class="pre">uint64_t</span> <span class="pre">entrypoint(const</span> <span class="pre">uint8_t</span> <span class="pre">*input)</span>
<span class="pre">`</span></code></p>
<p>This entrypoint takes a generic byte array which contains the serialized program
parameters (program id, accounts, instruction data, etc…). To deserialize the
parameters each loader contains its own [helper function](#Serialization).</p>
<p>### Serialization</p>
<p>Each loader provides a helper function that deserializes the program’s input
parameters into C types:</p>
<ul class="simple">
<li><p>[SBF Loader
deserialization](<a class="reference external" href="https://github.com/solana-labs/solana/blob/d2ee9db2143859fa5dc26b15ee6da9c25cc0429c/sdk/sbf/c/inc/solana_sdk.h#L304">https://github.com/solana-labs/solana/blob/d2ee9db2143859fa5dc26b15ee6da9c25cc0429c/sdk/sbf/c/inc/solana_sdk.h#L304</a>)</p></li>
<li><p>[SBF Loader deprecated
deserialization](<a class="reference external" href="https://github.com/solana-labs/solana/blob/8415c22b593f164020adc7afe782e8041d756ddf/sdk/sbf/c/inc/deserialize_deprecated.h#L25">https://github.com/solana-labs/solana/blob/8415c22b593f164020adc7afe782e8041d756ddf/sdk/sbf/c/inc/deserialize_deprecated.h#L25</a>)</p></li>
</ul>
<p>Some programs may want to perform deserialization themselves, and they can by
providing their own implementation of the [raw entrypoint](#program-entrypoint).
Take note that the provided deserialization functions retain references back to
the serialized byte array for variables that the program is allowed to modify
(lamports, account data). The reason for this is that upon return the loader
will read those modifications so they may be committed. If a program implements
their own deserialization function they need to ensure that any modifications
the program wishes to commit must be written back into the input byte array.</p>
<p>Details on how the loader serializes the program inputs can be found in the
[Input Parameter Serialization](./faq.md#input-parameter-serialization) docs.</p>
<p>## Data Types</p>
<p>The loader’s deserialization helper function populates the
[SolParameters](<a class="reference external" href="https://github.com/solana-labs/solana/blob/8415c22b593f164020adc7afe782e8041d756ddf/sdk/sbf/c/inc/solana_sdk.h#L276">https://github.com/solana-labs/solana/blob/8415c22b593f164020adc7afe782e8041d756ddf/sdk/sbf/c/inc/solana_sdk.h#L276</a>)
structure:</p>
<p><a href="#id1"><span class="problematic" id="id2">``</span></a><a href="#id3"><span class="problematic" id="id4">`</span></a>c
/**</p>
<blockquote>
<div><ul class="simple">
<li><p>Structure that the program’s entrypoint input data is deserialized into.</p></li>
</ul>
<p><a href="#id5"><span class="problematic" id="id6">*</span></a>/</p>
</div></blockquote>
<dl>
<dt>typedef struct {</dt><dd><dl class="simple">
<dt>SolAccountInfo* ka; /** Pointer to an array of SolAccountInfo, must already</dt><dd><p>point to an array of SolAccountInfos <a href="#id7"><span class="problematic" id="id8">*</span></a>/</p>
</dd>
</dl>
<p>uint64_t ka_num; /** Number of SolAccountInfo entries in <cite>ka</cite> <em>/
const uint8_t *data; /*</em> pointer to the instruction data <em>/
uint64_t data_len; /*</em> Length in bytes of the instruction data <em>/
const SolPubkey *program_id; /*</em> program_id of the currently executing program <a href="#id9"><span class="problematic" id="id10">*</span></a>/</p>
</dd>
</dl>
<p>} SolParameters;
<a href="#id11"><span class="problematic" id="id12">``</span></a><a href="#id13"><span class="problematic" id="id14">`</span></a></p>
<p>‘ka’ is an ordered array of the accounts referenced by the instruction and
represented as a
[SolAccountInfo](<a class="reference external" href="https://github.com/solana-labs/solana/blob/8415c22b593f164020adc7afe782e8041d756ddf/sdk/sbf/c/inc/solana_sdk.h#L173">https://github.com/solana-labs/solana/blob/8415c22b593f164020adc7afe782e8041d756ddf/sdk/sbf/c/inc/solana_sdk.h#L173</a>)
structures. An account’s place in the array signifies its meaning, for example,
when transferring lamports an instruction may define the first account as the
source and the second as the destination.</p>
<p>The members of the <cite>SolAccountInfo</cite> structure are read-only except for
<cite>lamports</cite> and <cite>data</cite>. Both may be modified by the program in accordance with
the [runtime enforcement
policy](developing/programming-model/accounts.md#policy). When an instruction
reference the same account multiple times there may be duplicate
<cite>SolAccountInfo</cite> entries in the array but they both point back to the original
input byte array. A program should handle these cases delicately to avoid
overlapping read/writes to the same buffer. If a program implements their own
deserialization function care should be taken to handle duplicate accounts
appropriately.</p>
<p><cite>data</cite> is the general purpose byte array from the [instruction’s instruction
data](developing/programming-model/transactions.md#instruction-data) being
processed.</p>
<p><cite>program_id</cite> is the public key of the currently executing program.</p>
<p>## Heap</p>
<p>C programs can allocate memory via the system call
[<cite>calloc</cite>](<a class="reference external" href="https://github.com/solana-labs/solana/blob/c3d2d2134c93001566e1e56f691582f379b5ae55/sdk/sbf/c/inc/solana_sdk.h#L245">https://github.com/solana-labs/solana/blob/c3d2d2134c93001566e1e56f691582f379b5ae55/sdk/sbf/c/inc/solana_sdk.h#L245</a>)
or implement their own heap on top of the 32KB heap region starting at virtual
address x300000000. The heap region is also used by <cite>calloc</cite> so if a program
implements their own heap it should not also call <cite>calloc</cite>.</p>
<p>## Logging</p>
<p>The runtime provides two system calls that take data and log it to the program
logs.</p>
<ul class="simple">
<li><p>[<cite>sol_log(const char*)</cite>](<a class="reference external" href="https://github.com/solana-labs/solana/blob/d2ee9db2143859fa5dc26b15ee6da9c25cc0429c/sdk/sbf/c/inc/solana_sdk.h#L128">https://github.com/solana-labs/solana/blob/d2ee9db2143859fa5dc26b15ee6da9c25cc0429c/sdk/sbf/c/inc/solana_sdk.h#L128</a>)</p></li>
<li><p>[<cite>sol_log_64(uint64_t, uint64_t, uint64_t, uint64_t, uint64_t)</cite>](<a class="reference external" href="https://github.com/solana-labs/solana/blob/d2ee9db2143859fa5dc26b15ee6da9c25cc0429c/sdk/sbf/c/inc/solana_sdk.h#L134">https://github.com/solana-labs/solana/blob/d2ee9db2143859fa5dc26b15ee6da9c25cc0429c/sdk/sbf/c/inc/solana_sdk.h#L134</a>)</p></li>
</ul>
<p>The [debugging](debugging.md#logging) section has more information about working
with program logs.</p>
<p>## Compute Budget</p>
<p>Use the system call
[<cite>sol_log_compute_units()</cite>](<a class="reference external" href="https://github.com/solana-labs/solana/blob/d3a3a7548c857f26ec2cb10e270da72d373020ec/sdk/sbf/c/inc/solana_sdk.h#L140">https://github.com/solana-labs/solana/blob/d3a3a7548c857f26ec2cb10e270da72d373020ec/sdk/sbf/c/inc/solana_sdk.h#L140</a>)
to log a message containing the remaining number of compute units the program
may consume before execution is halted</p>
<p>See [compute budget](developing/programming-model/runtime.md#compute-budget)
for more information.</p>
<p>## ELF Dump</p>
<p>The SBF shared object internals can be dumped to a text file to gain more
insight into a program’s composition and what it may be doing at runtime. The
dump will contain both the ELF information as well as a list of all the symbols
and the instructions that implement them. Some of the SBF loader’s error log
messages will reference specific instruction numbers where the error occurred.
These references can be looked up in the ELF dump to identify the offending
instruction and its context.</p>
<p>To create a dump file:</p>
<p><code class="docutils literal notranslate"><span class="pre">`bash</span>
<span class="pre">$</span> <span class="pre">cd</span> <span class="pre">&lt;program</span> <span class="pre">directory&gt;</span>
<span class="pre">$</span> <span class="pre">make</span> <span class="pre">dump_&lt;program</span> <span class="pre">name&gt;</span>
<span class="pre">`</span></code></p>
<p>## Examples</p>
<p>The [Solana Program Library github](<a class="reference external" href="https://github.com/solana-labs/solana-program-library/tree/master/examples/c">https://github.com/solana-labs/solana-program-library/tree/master/examples/c</a>) repo contains a collection of C examples</p>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../_sources/src/developing/on-chain-programs/developing-c.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>