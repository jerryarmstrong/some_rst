<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>docs/src/developing/on-chain-programs/deploying.md &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="docs-src-developing-on-chain-programs-deploying-md">
<h1>docs/src/developing/on-chain-programs/deploying.md<a class="headerlink" href="#docs-src-developing-on-chain-programs-deploying-md" title="Permalink to this heading">¶</a></h1>
<p>Last edited: 2023-08-11 21:38:33</p>
<p>Contents:</p>
<div class="highlight-md notranslate"><div class="highlight"><pre><span></span>---
</pre></div>
</div>
<p>title: “Deploying Programs”
description: “Deploying on-chain programs can be done using the Solana CLI using the Upgradable BPF loader to upload the compiled byte-code to the Solana blockchain.”
—</p>
<p>Solana on-chain programs (otherwise known as “smart contracts”) are stored in “executable” accounts on Solana. These accounts are identical to any other account but with the exception of:</p>
<ul class="simple">
<li><p>having the “executable” flag enabled, and</p></li>
<li><p>the owner being assigned to a BPF loader</p></li>
</ul>
<p>Besides those exceptions, they are governed by the same runtime rules as non-executable accounts, hold SOL tokens for rent fees, and store a data buffer which is managed by the BPF loader program. The latest BPF loader is called the “Upgradeable BPF Loader”.</p>
<p>## Overview of the Upgradeable BPF Loader</p>
<p>### State accounts</p>
<p>The Upgradeable BPF loader program supports three different types of state accounts:</p>
<ol class="arabic simple">
<li><p>[Program account](<a class="reference external" href="https://github.com/solana-labs/solana/blob/master/sdk/program/src/bpf_loader_upgradeable.rs#L34">https://github.com/solana-labs/solana/blob/master/sdk/program/src/bpf_loader_upgradeable.rs#L34</a>): This is the main account of an on-chain program and its address is commonly referred to as a “program id.” Program id’s are what transaction instructions reference in order to invoke a program. Program accounts are immutable once deployed, so you can think of them as a proxy account to the byte-code and state stored in other accounts.</p></li>
<li><p>[Program data account](<a class="reference external" href="https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/sdk/program/src/bpf_loader_upgradeable.rs#L39">https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/sdk/program/src/bpf_loader_upgradeable.rs#L39</a>): This account is what stores the executable byte-code of an on-chain program. When a program is upgraded, this account’s data is updated with new byte-code. In addition to byte-code, program data accounts are also responsible for storing the slot when it was last modified and the address of the sole account authorized to modify the account (this address can be cleared to make a program immutable).</p></li>
<li><p>[Buffer accounts](<a class="reference external" href="https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/sdk/program/src/bpf_loader_upgradeable.rs#L27">https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/sdk/program/src/bpf_loader_upgradeable.rs#L27</a>): These accounts temporarily store byte-code while a program is being actively deployed through a series of transactions. They also each store the address of the sole account which is authorized to do writes.</p></li>
</ol>
<p>### Instructions</p>
<p>The state accounts listed above can only be modified with one of the following instructions supported by the Upgradeable BPF Loader program:</p>
<ol class="arabic simple">
<li><p>[Initialize buffer](<a class="reference external" href="https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/sdk/program/src/loader_upgradeable_instruction.rs#L21">https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/sdk/program/src/loader_upgradeable_instruction.rs#L21</a>): Creates a buffer account and stores an authority address which is allowed to modify the buffer.</p></li>
<li><p>[Write](<a class="reference external" href="https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/sdk/program/src/loader_upgradeable_instruction.rs#L28">https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/sdk/program/src/loader_upgradeable_instruction.rs#L28</a>): Writes byte-code at a specified byte offset inside a buffer account. Writes are processed in small chunks due to a limitation of Solana transactions having a maximum serialized size of 1232 bytes.</p></li>
<li><p>[Deploy](<a class="reference external" href="https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/sdk/program/src/loader_upgradeable_instruction.rs#L77">https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/sdk/program/src/loader_upgradeable_instruction.rs#L77</a>): Creates both a program account and a program data account. It fills the program data account by copying the byte-code stored in a buffer account. If the byte-code is valid, the program account will be set as executable, allowing it to be invoked. If the byte-code is invalid, the instruction will fail and all changes are reverted.</p></li>
<li><p>[Upgrade](<a class="reference external" href="https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/sdk/program/src/loader_upgradeable_instruction.rs#L102">https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/sdk/program/src/loader_upgradeable_instruction.rs#L102</a>): Fills an existing program data account by copying executable byte-code from a buffer account. Similar to the deploy instruction, it will only succeed if the byte-code is valid.</p></li>
<li><p>[Set authority](<a class="reference external" href="https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/sdk/program/src/loader_upgradeable_instruction.rs#L114">https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/sdk/program/src/loader_upgradeable_instruction.rs#L114</a>): Updates the authority of a program data or buffer account if the account’s current authority has signed the transaction being processed. If the authority is deleted without replacement, it can never be set to a new address and the account can never be closed.</p></li>
<li><p>[Close](<a class="reference external" href="https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/sdk/program/src/loader_upgradeable_instruction.rs#L127">https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/sdk/program/src/loader_upgradeable_instruction.rs#L127</a>): Clears the data of a program data account or buffer account and reclaims the SOL used for the rent exemption deposit.</p></li>
</ol>
<p>## How <cite>solana program deploy</cite> works</p>
<p>Deploying a program on Solana requires hundreds, if not thousands of transactions, due to the max size limit of 1232 bytes for Solana transactions. The Solana CLI takes care of this rapid firing of transactions with the <cite>solana program deploy</cite> subcommand. The process can be broken down into the following 3 phases:</p>
<ol class="arabic simple">
<li><p>[Buffer initialization](<a class="reference external" href="https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/cli/src/program.rs#L2113">https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/cli/src/program.rs#L2113</a>): First, the CLI sends a transaction which [creates a buffer account](<a class="reference external" href="https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/cli/src/program.rs#L1903">https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/cli/src/program.rs#L1903</a>) large enough for the byte-code being deployed. It also invokes the [initialize buffer instruction](<a class="reference external" href="https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/programs/bpf_loader/src/lib.rs#L320">https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/programs/bpf_loader/src/lib.rs#L320</a>) to set the buffer authority to restrict writes to the deployer’s chosen address.</p></li>
<li><p>[Buffer writes](<a class="reference external" href="https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/cli/src/program.rs#L2129">https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/cli/src/program.rs#L2129</a>): Once the buffer account is initialized, the CLI [breaks up the program byte-code](<a class="reference external" href="https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/cli/src/program.rs#L1940">https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/cli/src/program.rs#L1940</a>) into ~1KB chunks and [sends transactions at a rate of 100 transactions per second](<a class="reference external" href="https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/client/src/tpu_client.rs#L133">https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/client/src/tpu_client.rs#L133</a>) to write each chunk with [the write buffer instruction](<a class="reference external" href="https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/programs/bpf_loader/src/lib.rs#L334">https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/programs/bpf_loader/src/lib.rs#L334</a>). These transactions are sent directly to the current leader’s transaction processing (TPU) port and are processed in parallel with each other. Once all transactions have been sent, the CLI [polls the RPC API with batches of transaction signatures](<a class="reference external" href="https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/client/src/tpu_client.rs#L216">https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/client/src/tpu_client.rs#L216</a>) to ensure that every write was successful and confirmed.</p></li>
<li><p>[Finalization](<a class="reference external" href="https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/cli/src/program.rs#L1807">https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/cli/src/program.rs#L1807</a>): Once writes are completed, the CLI [sends a final transaction](<a class="reference external" href="https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/cli/src/program.rs#L2150">https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/cli/src/program.rs#L2150</a>) to either [deploy a new program](<a class="reference external" href="https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/programs/bpf_loader/src/lib.rs#L362">https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/programs/bpf_loader/src/lib.rs#L362</a>) or [upgrade an existing program](<a class="reference external" href="https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/programs/bpf_loader/src/lib.rs#L513">https://github.com/solana-labs/solana/blob/7409d9d2687fba21078a745842c25df805cdf105/programs/bpf_loader/src/lib.rs#L513</a>). In either case, the byte-code written to the buffer account will be copied into a program data account and verified.</p></li>
</ol>
<p>## Reclaim rent from program accounts</p>
<p>The storage of data on the Solana blockchain requires the payment of [rent](./../intro/rent.md), including for the byte-code for on-chain programs. Therefore as you deploy more or larger programs, the amount of rent paid to remain rent-exempt will also become larger.</p>
<p>Using the current rent cost model configuration, a rent-exempt account requires a deposit of ~0.7 SOL per 100KB stored. These costs can have an outsized impact on developers who deploy their own programs since [program accounts](./../programming-model/accounts.md#executable) are among the largest we typically see on Solana.</p>
<p>#### Example of how much data is used for programs</p>
<p>As a data point of the number of accounts and potential data stored on-chain, below is the distribution of the largest accounts (at least 100KB) at slot <cite>103,089,804</cite> on <cite>mainnet-beta</cite> by assigned on-chain program:</p>
<ol class="arabic simple">
<li><p><strong>Serum Dex v3</strong>: 1798 accounts</p></li>
<li><p><strong>Metaplex Candy Machine</strong>: 1089 accounts</p></li>
<li><p><strong>Serum Dex v2</strong>: 864 accounts</p></li>
<li><p><strong>Upgradeable BPF Program Loader</strong>: 824 accounts</p></li>
<li><p><strong>BPF Program Loader v2</strong>: 191 accounts</p></li>
<li><p><strong>BPF Program Loader v1</strong>: 150 accounts</p></li>
</ol>
<p>&gt; _Note: this data was pulled with a modified <cite>solana-ledger-tool</cite> built from this branch: [<a class="reference external" href="https://github.com/jstarry/solana/tree/large-account-stats](https://github.com/jstarry/solana/tree/large-account-stats)_">https://github.com/jstarry/solana/tree/large-account-stats](https://github.com/jstarry/solana/tree/large-account-stats)_</a></p>
<p>### Reclaiming buffer accounts</p>
<p>Buffer accounts are used by the Upgradeable BPF loader to temporarily store byte-code that is in the process of being deployed on-chain. This temporary buffer is required when upgrading programs because the currently deployed program’s byte-code cannot be affected by an in-progress upgrade.</p>
<p>Unfortunately, deploys fail occasionally and instead of reusing the buffer account, developers might retry their deployment with a new buffer and not realize that they stored a good chunk of SOL in a forgotten buffer account from an earlier deploy.</p>
<p>&gt; As of slot <cite>103,089,804</cite> on <cite>mainnet-beta</cite> there are 276 abandoned buffer accounts that could be reclaimed!</p>
<p>Developers can check if they own any abandoned buffer accounts by using the Solana CLI:</p>
<p><a href="#id1"><span class="problematic" id="id2">``</span></a><a href="#id3"><span class="problematic" id="id4">`</span></a>bash
solana program show –buffers –keypair ~/.config/solana/MY_KEYPAIR.json</p>
<p>Buffer Address                               | Authority                                    | Balance
9vXW2c3qo6DrLHa1Pkya4Mw2BWZSRYs9aoyoP3g85wCA | 2nr1bHFT86W9tGnyvmYW4vcHKsQB3sVQfnddasz4kExM | 3.41076888 SOL
<a href="#id5"><span class="problematic" id="id6">``</span></a><a href="#id7"><span class="problematic" id="id8">`</span></a></p>
<p>And they can close those buffers to reclaim the SOL balance with the following command:</p>
<p><code class="docutils literal notranslate"><span class="pre">`bash</span>
<span class="pre">solana</span> <span class="pre">program</span> <span class="pre">close</span> <span class="pre">--buffers</span> <span class="pre">--keypair</span> <span class="pre">~/.config/solana/MY_KEYPAIR.json</span>
<span class="pre">`</span></code></p>
<p>#### Fetch the owners of buffer accounts via RPC API</p>
<p>The owners of all abandoned program deploy buffer accounts can be fetched via the RPC API:</p>
<p><a href="#id9"><span class="problematic" id="id10">``</span></a><a href="#id11"><span class="problematic" id="id12">`</span></a>bash
curl <a class="reference external" href="http://api.mainnet-beta.solana.com">http://api.mainnet-beta.solana.com</a> -H “Content-Type: application/json” –data-binary &#64;- &lt;&lt; EOF | jq –raw-output ‘.result | .[] | .account.data[0]’
{</p>
<blockquote>
<div><p>“jsonrpc”:”2.0”, “id”:1, “method”:”getProgramAccounts”,
“params”:[</p>
<blockquote>
<div><p>“BPFLoaderUpgradeab1e11111111111111111111111”,
{</p>
<blockquote>
<div><p>“dataSlice”: {“offset”: 5, “length”: 32},
“filters”: [{“memcmp”: {“offset”: 0, “bytes”: “2UzHM”}}],
“encoding”: “base64”</p>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>}
EOF
<a href="#id13"><span class="problematic" id="id14">``</span></a><a href="#id15"><span class="problematic" id="id16">`</span></a></p>
<p>After re-encoding the base64 encoded keys into base58 and grouping by key, we see some accounts have over 10 buffer accounts they could close, yikes!</p>
<p><code class="docutils literal notranslate"><span class="pre">`bash</span>
<span class="pre">'BE3G2F5jKygsSNbPFKHHTxvKpuFXSumASeGweLcei6G3'</span> <span class="pre">=&gt;</span> <span class="pre">10</span> <span class="pre">buffer</span> <span class="pre">accounts</span>
<span class="pre">'EsQ179Q8ESroBnnmTDmWEV4rZLkRc3yck32PqMxypE5z'</span> <span class="pre">=&gt;</span> <span class="pre">10</span> <span class="pre">buffer</span> <span class="pre">accounts</span>
<span class="pre">'6KXtB89kAgzW7ApFzqhBg5tgnVinzP4NSXVqMAWnXcHs'</span> <span class="pre">=&gt;</span> <span class="pre">12</span> <span class="pre">buffer</span> <span class="pre">accounts</span>
<span class="pre">'FinVobfi4tbdMdfN9jhzUuDVqGXfcFnRGX57xHcTWLfW'</span> <span class="pre">=&gt;</span> <span class="pre">15</span> <span class="pre">buffer</span> <span class="pre">accounts</span>
<span class="pre">'TESAinbTL2eBLkWqyGA82y1RS6kArHvuYWfkL9dKkbs'</span> <span class="pre">=&gt;</span> <span class="pre">42</span> <span class="pre">buffer</span> <span class="pre">accounts</span>
<span class="pre">`</span></code></p>
<p>### Reclaiming program data accounts</p>
<p>You may now realize that program data accounts (the accounts that store the executable byte-code for an on-chain program) can also be closed.</p>
<p>&gt; <strong>Note:</strong> This does _not_ mean that _program <a href="#id25"><span class="problematic" id="id26">accounts_</span></a> can be closed (those are immutable and can never be reclaimed, but it’s fine they’re pretty small). It’s also important to keep in mind that once program data accounts are deleted, they can never be recreated for an existing program. Therefore, the corresponding program (and its program id) for any closed program data account is effectively disabled forever and may not be re-deployed</p>
<p>While it would be uncommon for developers to need to close program data accounts since they can be rewritten during upgrades, one potential scenario is that since program data accounts can’t be _resized_. You may wish to deploy your program at a new address to accommodate larger executables.</p>
<p>The ability to reclaim program data account rent deposits also makes testing and experimentation on the <cite>mainnet-beta</cite> cluster a lot less costly since you could reclaim everything except the transaction fees and a small amount of rent for the program account. Lastly, this could help developers recover most of their funds if they mistakenly deploy a program at an unintended address or on the wrong cluster.</p>
<p>To view the programs which are owned by your wallet address, you can run:</p>
<p><a href="#id17"><span class="problematic" id="id18">``</span></a><a href="#id19"><span class="problematic" id="id20">`</span></a>bash
solana -V # must be 1.7.11 or higher!
solana program show –programs –keypair ~/.config/solana/MY_KEYPAIR.json</p>
<p>Program Id                                   | Slot      | Authority                                    | Balance
CN5x9WEusU6pNH66G22SnspVx4cogWLqMfmb85Z3GW7N | 53796672  | 2nr1bHFT86W9tGnyvmYW4vcHKsQB3sVQfnddasz4kExM | 0.54397272 SOL
<a href="#id21"><span class="problematic" id="id22">``</span></a><a href="#id23"><span class="problematic" id="id24">`</span></a></p>
<p>To close those program data accounts and reclaim their SOL balance, you can run:</p>
<p><code class="docutils literal notranslate"><span class="pre">`bash</span>
<span class="pre">solana</span> <span class="pre">program</span> <span class="pre">close</span> <span class="pre">--programs</span> <span class="pre">--keypair</span> <span class="pre">~/.config/solana/MY_KEYPAIR.json</span>
<span class="pre">`</span></code></p>
<p>You might be concerned about this feature allowing malicious actors to close a program in a way that negatively impacts end users. While this is a valid concern in general, closing program data accounts doesn’t make this any more exploitable than was already possible.</p>
<p>Even without the ability to close a program data account, any upgradeable program could be upgraded to a no-op implementation and then have its upgrade authority cleared to make it immutable forever. This new feature for closing program data accounts merely adds the ability to reclaim the rent deposit, disabling a program was already technically possible.</p>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../_sources/src/developing/on-chain-programs/deploying.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>