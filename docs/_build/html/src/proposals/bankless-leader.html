<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>docs/src/proposals/bankless-leader.md &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="docs-src-proposals-bankless-leader-md">
<h1>docs/src/proposals/bankless-leader.md<a class="headerlink" href="#docs-src-proposals-bankless-leader-md" title="Permalink to this heading">¶</a></h1>
<p>Last edited: 2023-08-11 21:38:33</p>
<p>Contents:</p>
<div class="highlight-md notranslate"><div class="highlight"><pre><span></span>---
</pre></div>
</div>
<p>title: Bankless Leader
—</p>
<p>A bankless leader does the minimum amount of work to produce a valid block. The leader is tasked with ingress transactions, sorting and filtering valid transactions, arranging them into entries, shredding the entries and broadcasting the shreds. While a validator only needs to reassemble the block and replay execution of well formed entries. The leader does 3x more memory operations before any bank execution than the validator per processed transaction.</p>
<p>## Rationale</p>
<p>Normal bank operation for a spend needs to do 2 loads and 2 stores. With this design leader just does 1 load. so 4x less account_db work before generating the block. The store operations are likely to be more expensive than reads.</p>
<p>When replay stage starts processing the same transactions, it can assume that PoH is valid, and that all the entries are safe for parallel execution. The fee accounts that have been loaded to produce the block are likely to still be in memory, so the additional load should be warm and the cost is likely to be amortized.</p>
<p>## Fee Account</p>
<p>The [fee account](../terminology.md#fee_account) pays for the transaction to be included in the block. The leader only needs to validate that the fee account has the balance to pay for the fee.</p>
<p>## Balance Cache</p>
<p>For the duration of the leaders consecutive blocks, the leader maintains a temporary balance cache for all the processed fee accounts. The cache is a map of pubkeys to lamports.</p>
<p>At the start of the first block the balance cache is empty. At the end of the last block the cache is destroyed.</p>
<p>The balance cache lookups must reference the same base fork for the entire duration of the cache. At the block boundary, the cache can be reset along with the base fork after replay stage finishes verifying the previous block.</p>
<p>## Balance Check</p>
<p>Prior to the balance check, the leader validates all the signatures in the transaction.</p>
<ol class="arabic simple">
<li><p>Verify the accounts are not in use and BlockHash is valid.</p></li>
<li><p>Check if the fee account is present in the cache, or load the account from accounts_db and store the lamport balance in the cache.</p></li>
<li><p>If the balance is less than the fee, drop the transaction.</p></li>
<li><p>Subtract the fee from the balance.</p></li>
<li><p>For all the keys in the transaction that are Credit-Debit and are referenced by an instruction, reduce their balance to 0 in the cache. The account fee is declared as Credit-Debit, but as long as it is not used in any instruction its balance will not be reduced to 0.</p></li>
</ol>
<p>## Leader Replay</p>
<p>Leaders will need to replay their blocks as part of the standard replay stage operation.</p>
<p>## Leader Replay With Consecutive Blocks</p>
<p>A leader can be scheduled to produce multiple blocks in a row. In that scenario the leader is likely to be producing the next block while the replay stage for the first block is playing.</p>
<p>When the leader finishes the replay stage it can reset the balance cache by clearing it, and set a new fork as the base for the cache which can become active on the next block.</p>
<p>## Resetting the Balance Cache</p>
<ol class="arabic simple">
<li><p>At the start of the block, if the balance cache is uninitialized, set the base fork for the balance cache to be the parent of the block and create an empty cache.</p></li>
<li><p>if the cache is initialized, check if block’s parents has a new frozen bank that is newer than the current base fork for the balance cache.</p></li>
<li><p>if a parent newer than the cache’s base fork exist, reset the cache to the parent.</p></li>
</ol>
<p>## Impact on Clients</p>
<p>The same fee account can be reused many times in the same block until it is used once as Credit-Debit by an instruction.</p>
<p>Clients that transmit a large number of transactions per second should use a dedicated fee account that is not used as Credit-Debit in any instruction.</p>
<p>Once an account fee is used as Credit-Debit, it will fail the balance check until the balance cache is reset.</p>
<p>### Check out the [SIMD here to contribute](<a class="reference external" href="https://github.com/solana-foundation/solana-improvement-documents/pull/5">https://github.com/solana-foundation/solana-improvement-documents/pull/5</a>)</p>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../_sources/src/proposals/bankless-leader.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>