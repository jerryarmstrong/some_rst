<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>docs/src/running-validator/restart-cluster.md &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="docs-src-running-validator-restart-cluster-md">
<h1>docs/src/running-validator/restart-cluster.md<a class="headerlink" href="#docs-src-running-validator-restart-cluster-md" title="Permalink to this heading">¶</a></h1>
<p>Last edited: 2023-08-11 21:38:33</p>
<p>Contents:</p>
<div class="highlight-md notranslate"><div class="highlight"><pre><span></span><span class="gu">## Restarting a cluster</span>
</pre></div>
</div>
<p>### Step 1. Identify the latest optimistically confirmed slot for the cluster</p>
<p>In Solana 1.14 or greater, run the following command to output the latest
optimistically confirmed slot your validator observed:
<code class="docutils literal notranslate"><span class="pre">`bash</span>
<span class="pre">solana-ledger-tool</span> <span class="pre">-l</span> <span class="pre">ledger</span> <span class="pre">latest-optimistic-slots</span>
<span class="pre">`</span></code></p>
<p>In Solana 1.13 or less, the latest optimistically confirmed can be found by looking for the more recent occurrence of
[this](<a class="reference external" href="https://github.com/solana-labs/solana/blob/0264147d42d506fb888f5c4c021a998e231a3e74/core/src/optimistic_confirmation_verifier.rs#L71">https://github.com/solana-labs/solana/blob/0264147d42d506fb888f5c4c021a998e231a3e74/core/src/optimistic_confirmation_verifier.rs#L71</a>)
metrics datapoint.</p>
<p>Call this slot <cite>SLOT_X</cite></p>
<p>Note that it’s possible that some validators observed an optimistically
confirmed slot that’s greater than others before the outage.  Survey the other
validators on the cluster to ensure that a greater optimistically confirmed slot
does not exist before proceeding. If a greater slot value is found use it
instead.</p>
<p>### Step 2. Stop the validator(s)</p>
<p>### Step 3. Optionally install the new solana version</p>
<p>### Step 4. Create a new snapshot for slot <cite>SLOT_X</cite> with a hard fork at slot <cite>SLOT_X</cite></p>
<p><code class="docutils literal notranslate"><span class="pre">`bash</span>
<span class="pre">$</span> <span class="pre">solana-ledger-tool</span> <span class="pre">-l</span> <span class="pre">&lt;LEDGER_PATH&gt;</span> <span class="pre">--snapshot-archive-path</span> <span class="pre">&lt;SNAPSHOTS_PATH&gt;</span> <span class="pre">--incremental-snapshot-archive-path</span> <span class="pre">&lt;INCREMENTAL_SNAPSHOTS_PATH&gt;</span> <span class="pre">create-snapshot</span> <span class="pre">SLOT_X</span> <span class="pre">&lt;SNAPSHOTS_PATH&gt;</span> <span class="pre">--hard-fork</span> <span class="pre">SLOT_X</span>
<span class="pre">`</span></code></p>
<p>The snapshots directory should now contain the new snapshot.
<cite>solana-ledger-tool create-snapshot</cite> will also output the new shred version, and bank hash value,
call this NEW_SHRED_VERSION and NEW_BANK_HASH respectively.</p>
<p>Adjust your validator’s arguments:</p>
<dl class="simple">
<dt><a href="#id1"><span class="problematic" id="id2">``</span></a><a href="#id3"><span class="problematic" id="id4">`</span></a>bash</dt><dd><p>–wait-for-supermajority SLOT_X
–expected-bank-hash NEW_BANK_HASH</p>
</dd>
</dl>
<p><a href="#id5"><span class="problematic" id="id6">``</span></a><a href="#id7"><span class="problematic" id="id8">`</span></a></p>
<p>Then restart the validator.</p>
<p>Confirm with the log that the validator booted and is now in a holding pattern at <cite>SLOT_X</cite>, waiting for a super majority.</p>
<p>Once NEW_SHRED_VERSION is determined, nudge foundation entrypoint operators to update entrypoints.</p>
<p>### Step 5. Announce the restart on Discord:</p>
<p>Post something like the following to #announcements (adjusting the text as appropriate):</p>
<p>&gt; Hi &#64;Validators,
&gt;
&gt; We’ve released v1.1.12 and are ready to get testnet back up again.
&gt;
&gt; Steps:
&gt;
&gt; 1. Install the v1.1.12 release: <a class="reference external" href="https://github.com/solana-labs/solana/releases/tag/v1.1.12">https://github.com/solana-labs/solana/releases/tag/v1.1.12</a>
&gt; 2. a. Preferred method, start from your local ledger with:
&gt;
&gt; <code class="docutils literal notranslate"><span class="pre">`bash</span>
<span class="pre">&gt;</span> <span class="pre">solana-validator</span>
<span class="pre">&gt;</span>&#160;&#160; <span class="pre">--wait-for-supermajority</span> <span class="pre">SLOT_X</span>&#160;&#160;&#160;&#160; <span class="pre">#</span> <span class="pre">&lt;--</span> <span class="pre">NEW!</span> <span class="pre">IMPORTANT!</span> <span class="pre">REMOVE</span> <span class="pre">AFTER</span> <span class="pre">THIS</span> <span class="pre">RESTART</span>
<span class="pre">&gt;</span>&#160;&#160; <span class="pre">--expected-bank-hash</span> <span class="pre">NEW_BANK_HASH</span>&#160; <span class="pre">#</span> <span class="pre">&lt;--</span> <span class="pre">NEW!</span> <span class="pre">IMPORTANT!</span> <span class="pre">REMOVE</span> <span class="pre">AFTER</span> <span class="pre">THIS</span> <span class="pre">RESTART</span>
<span class="pre">&gt;</span>&#160;&#160; <span class="pre">--hard-fork</span> <span class="pre">SLOT_X</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">#</span> <span class="pre">&lt;--</span> <span class="pre">NEW!</span> <span class="pre">IMPORTANT!</span> <span class="pre">REMOVE</span> <span class="pre">AFTER</span> <span class="pre">THIS</span> <span class="pre">RESTART</span>
<span class="pre">&gt;</span>&#160;&#160; <span class="pre">--no-snapshot-fetch</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">#</span> <span class="pre">&lt;--</span> <span class="pre">NEW!</span> <span class="pre">IMPORTANT!</span> <span class="pre">REMOVE</span> <span class="pre">AFTER</span> <span class="pre">THIS</span> <span class="pre">RESTART</span>
<span class="pre">&gt;</span>&#160;&#160; <span class="pre">--entrypoint</span> <span class="pre">entrypoint.testnet.solana.com:8001</span>
<span class="pre">&gt;</span>&#160;&#160; <span class="pre">--known-validator</span> <span class="pre">5D1fNXzvv5NjV1ysLjirC4WY92RNsVH18vjmcszZd8on</span>
<span class="pre">&gt;</span>&#160;&#160; <span class="pre">--expected-genesis-hash</span> <span class="pre">4uhcVJyU9pJkvQyS88uRDiswHXSCkY3zQawwpjk2NsNY</span>
<span class="pre">&gt;</span>&#160;&#160; <span class="pre">--only-known-rpc</span>
<span class="pre">&gt;</span>&#160;&#160; <span class="pre">--limit-ledger-size</span>
<span class="pre">&gt;</span>&#160;&#160; <span class="pre">...</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">#</span> <span class="pre">&lt;--</span> <span class="pre">your</span> <span class="pre">other</span> <span class="pre">--identity/--vote-account/etc</span> <span class="pre">arguments</span>
<span class="pre">&gt;</span> <span class="pre">`</span></code>
&gt;
&gt; b. If your validator doesn’t have ledger up to slot SLOT_X or if you have deleted your ledger, have it instead download a snapshot with:
&gt;
&gt; <code class="docutils literal notranslate"><span class="pre">`bash</span>
<span class="pre">&gt;</span> <span class="pre">solana-validator</span>
<span class="pre">&gt;</span>&#160;&#160; <span class="pre">--wait-for-supermajority</span> <span class="pre">SLOT_X</span>&#160;&#160;&#160;&#160; <span class="pre">#</span> <span class="pre">&lt;--</span> <span class="pre">NEW!</span> <span class="pre">IMPORTANT!</span> <span class="pre">REMOVE</span> <span class="pre">AFTER</span> <span class="pre">THIS</span> <span class="pre">RESTART</span>
<span class="pre">&gt;</span>&#160;&#160; <span class="pre">--expected-bank-hash</span> <span class="pre">NEW_BANK_HASH</span>&#160; <span class="pre">#</span> <span class="pre">&lt;--</span> <span class="pre">NEW!</span> <span class="pre">IMPORTANT!</span> <span class="pre">REMOVE</span> <span class="pre">AFTER</span> <span class="pre">THIS</span> <span class="pre">RESTART</span>
<span class="pre">&gt;</span>&#160;&#160; <span class="pre">--entrypoint</span> <span class="pre">entrypoint.testnet.solana.com:8001</span>
<span class="pre">&gt;</span>&#160;&#160; <span class="pre">--known-validator</span> <span class="pre">5D1fNXzvv5NjV1ysLjirC4WY92RNsVH18vjmcszZd8on</span>
<span class="pre">&gt;</span>&#160;&#160; <span class="pre">--expected-genesis-hash</span> <span class="pre">4uhcVJyU9pJkvQyS88uRDiswHXSCkY3zQawwpjk2NsNY</span>
<span class="pre">&gt;</span>&#160;&#160; <span class="pre">--only-known-rpc</span>
<span class="pre">&gt;</span>&#160;&#160; <span class="pre">--limit-ledger-size</span>
<span class="pre">&gt;</span>&#160;&#160; <span class="pre">...</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">#</span> <span class="pre">&lt;--</span> <span class="pre">your</span> <span class="pre">other</span> <span class="pre">--identity/--vote-account/etc</span> <span class="pre">arguments</span>
<span class="pre">&gt;</span> <span class="pre">`</span></code>
&gt;
&gt;      You can check for which slots your ledger has with: <cite>solana-ledger-tool -l path/to/ledger bounds</cite>
&gt;
&gt; 3. Wait until 80% of the stake comes online
&gt;
&gt; To confirm your restarted validator is correctly waiting for the 80%:
&gt; a. Look for <cite>N% of active stake visible in gossip</cite> log messages
&gt; b. Ask it over RPC what slot it’s on: <cite>solana –url http://127.0.0.1:8899 slot</cite>. It should return <cite>SLOT_X</cite> until we get to 80% stake
&gt;
&gt; Thanks!</p>
<p>### Step 7. Wait and listen</p>
<p>Monitor the validators as they restart. Answer questions, help folks,</p>
<p>## Troubleshooting</p>
<p>### 80% of the stake didn’t participate in the restart, now what?
If less than 80% of the stake join the restart after a reasonable amount of
time, it will be necessary to retry the restart attempt with the stake from the
non-responsive validators removed.</p>
<p>The community should identify and come to social consensus on the set of
non-responsive validators. Then all participating validators return to Step 4
and create a new snapshot with additional <cite>–destake-vote-account &lt;PUBKEY&gt;</cite>
arguments for each of the non-responsive validator’s vote account address</p>
<p><a href="#id9"><span class="problematic" id="id10">``</span></a><a href="#id11"><span class="problematic" id="id12">`</span></a>bash
$ solana-ledger-tool -l ledger create-snapshot SLOT_X ledger –hard-fork SLOT_X </p>
<blockquote>
<div><p>–destake-vote-account &lt;VOTE_ACCOUNT_1&gt; –destake-vote-account &lt;VOTE_ACCOUNT_2&gt; .
.
–destake-vote-account &lt;VOTE_ACCOUNT_N&gt; </p>
</div></blockquote>
<p><a href="#id13"><span class="problematic" id="id14">``</span></a><a href="#id15"><span class="problematic" id="id16">`</span></a></p>
<p>This will cause all stake associated with the non-responsive validators to be
immediately deactivated. All their stakers will need to re-delegate their stake
once the cluster restart is successful.</p>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../_sources/src/running-validator/restart-cluster.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>