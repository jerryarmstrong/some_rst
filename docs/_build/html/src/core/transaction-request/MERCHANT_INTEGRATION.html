<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>docs/src/core/transaction-request/MERCHANT_INTEGRATION.md &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="docs-src-core-transaction-request-merchant-integration-md">
<h1>docs/src/core/transaction-request/MERCHANT_INTEGRATION.md<a class="headerlink" href="#docs-src-core-transaction-request-merchant-integration-md" title="Permalink to this heading">¶</a></h1>
<p>Last edited: 2023-05-03 15:27:33</p>
<p>Contents:</p>
<div class="highlight-md notranslate"><div class="highlight"><pre><span></span>---
</pre></div>
</div>
<p>title: Create a transaction request
slug: /core/transaction-request/merchant-integration
—</p>
<p>This section describes how a merchant can integrate Solana Pay transaction requests into their payments flow.</p>
<p>This guide walks through an example of how you can configure a server to respond to a Solana Pay transaction request to initiate a simple native SOL transfer.</p>
<p>A complete example can be found [here][4].</p>
<p>## Requirements</p>
<p>For this example, we’ll be building our server using [NextJS API routes][1]. There are no rigid requirements on where your server is deployed and what technologies or languages are used.</p>
<p>—</p>
<p>## 1. Set-up Solana Pay</p>
<p>Install Solana Pay libraries to access the API from your application:</p>
<p><strong>npm</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">npm</span> <span class="pre">install</span> <span class="pre">&#64;solana/pay</span> <span class="pre">&#64;solana/web3.js</span> <span class="pre">bignumber.js</span> <span class="pre">&#64;solana/spl-token</span> <span class="pre">--save</span>
<span class="pre">`</span></code></p>
<p><strong>yarn</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">yarn</span> <span class="pre">add</span> <span class="pre">&#64;solana/pay</span> <span class="pre">&#64;solana/web3.js</span> <span class="pre">bignumber.js</span> <span class="pre">&#64;solana/spl-token</span>
<span class="pre">`</span></code></p>
<p>### 1. Create the handler</p>
<p>The handler is the entry point of the API, and “handles” all incoming requests.</p>
<p><a href="#id1"><span class="problematic" id="id2">``</span></a><a href="#id3"><span class="problematic" id="id4">`</span></a>javascript
const index = async (request, response) =&gt; {</p>
<blockquote>
<div><p>// We set up our handler to only respond to <cite>GET</cite> and <cite>POST</cite> requests.
if (request.method === ‘GET’) return get(request, response);
if (request.method === ‘POST’) return post(request, response);</p>
<p>throw new Error(<cite>Unexpected method ${request.method}</cite>);</p>
</div></blockquote>
<section id="id5">
<h2>};<a class="headerlink" href="#id5" title="Permalink to this heading">¶</a></h2>
<p>## 2. The link</p>
<p>A Solana Pay transaction request URL describes an interactive request for any Solana transaction.</p>
<p><code class="docutils literal notranslate"><span class="pre">`html</span>
<span class="pre">solana:&lt;link&gt;</span>
<span class="pre">`</span></code></p>
<p>A single [link][3] field is required as the pathname. The value must be an absolute HTTPS URL. If the URL contains query parameters, it must be URL-encoded.</p>
<p><code class="docutils literal notranslate"><span class="pre">`html</span>
<span class="pre">solana:https://example.solanapay.com</span>
<span class="pre">`</span></code></p>
<p>Our server <cite>https://example.solanapay.com</cite> needs to be configured to respond correctly to <cite>GET</cite> and <cite>POST</cite> requests.</p>
<p>## 3. The GET request</p>
<p>The first part of the transaction request spec is for the wallet to make a <cite>GET</cite> request to the specified link.</p>
<p><a href="#id6"><span class="problematic" id="id7">``</span></a><a href="#id8"><span class="problematic" id="id9">`</span></a>javascript
const get = async (request, response) =&gt; {</p>
<blockquote>
<div><p>const label = ‘Exiled Apes Academy’;
const icon = ‘<a class="reference external" href="https://exiledapes.academy/wp-content/uploads/2021/09/X_share.png">https://exiledapes.academy/wp-content/uploads/2021/09/X_share.png</a>’;</p>
<dl class="simple">
<dt>response.status(200).send({</dt><dd><p>label,
icon,</p>
</dd>
</dl>
<p>});</p>
</div></blockquote>
</section>
<section id="id10">
<h2>};<a class="headerlink" href="#id10" title="Permalink to this heading">¶</a></h2>
<p>The <cite>GET</cite> endpoint should respond with two properties. <cite>label</cite> describes the source of the transaction request. For example, this might be the name of a brand, store, application, or person making the request. <cite>icon</cite> must be an SVG, PNG, or WebP image. The icon and label will be displayed to the user.</p>
<p>## 4. The POST request</p>
<p>The second part of the transaction request spec is the <cite>POST</cite> request.</p>
<p><a href="#id11"><span class="problematic" id="id12">``</span></a><a href="#id13"><span class="problematic" id="id14">`</span></a>javascript
import { clusterApiUrl, Connection, Keypair, PublicKey, Transaction } from <a class="reference external" href="mailto:'&#37;&#52;&#48;solana/web3&#46;js">‘<span>&#64;</span>solana/web3<span>&#46;</span>js</a>’;
import BigNumber from ‘bignumber.js’;
import { createTransferCheckedInstruction, getAccount, getAssociatedTokenAddress, getMint } from <a class="reference external" href="mailto:'&#37;&#52;&#48;solana/spl-token">‘<span>&#64;</span>solana/spl-token</a>’;
import { TEN } from <a class="reference external" href="mailto:'&#37;&#52;&#48;solana/pay">‘<span>&#64;</span>solana/pay</a>’;</p>
<p>const splToken = new PublicKey(process.env.USDC_MINT);
const MERCHANT_WALLET = new PublicKey(process.env.MERCHANT_WALLET);</p>
<dl>
<dt>const post = async (request, response) =&gt; {</dt><dd><p>// Account provided in the transaction request body by the wallet.
const accountField = request.body?.account;
if (!accountField) throw new Error(‘missing account’);</p>
<p>const sender = new PublicKey(accountField);</p>
<p>// create spl transfer instruction
const splTransferIx = await createSplTransferIx(sender, connection);</p>
<p>// create the transaction
const transaction = new Transaction();</p>
<p>// add the instruction to the transaction
transaction.add(splTransferIx);</p>
<p>// Serialize and return the unsigned transaction.
const serializedTransaction = transaction.serialize({</p>
<blockquote>
<div><p>verifySignatures: false,
requireAllSignatures: false,</p>
</div></blockquote>
<p>});</p>
<p>const base64Transaction = serializedTransaction.toString(‘base64’);
const message = ‘Thank you for your purchase of ExiledApe #518’;</p>
<p>response.status(200).send({ transaction: base64Transaction, message });</p>
</dd>
</dl>
</section>
<section id="id15">
<h2>};<a class="headerlink" href="#id15" title="Permalink to this heading">¶</a></h2>
<p>The wallet will make a <cite>POST</cite> request to the specified link with the user’s wallet address as the <cite>account</cite> property of the request body.</p>
<p>The <cite>POST</cite> endpoint should respond with a base64-encoded <cite>transaction</cite>. You can return an optional <cite>message</cite> property to describe the transaction.</p>
<p>### 4.1 The transaction response</p>
<p>The <cite>transaction</cite> that’s returned can be – anything. It doesn’t even need to be a payment. For example, it could be a transaction to receive a gift or an invitation from the merchant for scanning a wallet.</p>
<dl class="simple">
<dt>&lt;details&gt;</dt><dd><p>&lt;summary&gt;Some ideas of what transactions you can do.&lt;/summary&gt;</p>
</dd>
</dl>
<ul class="simple">
<li><p>Merchants get an atomic bidirectional communication channel with customers. They can mint an NFT or transfer loyalty reward tokens in the transaction.</p></li>
<li><p>Merchants could potentially see what tokens a user has, accepting and denominating payment in any of them.</p></li>
<li><p>Merchants can pay for transactions on their user’s behalf so they don’t need SOL in a wallet.</p></li>
<li><p>Merchants can return an error from the server to decline to respond with a transaction. This could be used to allow permissioned payments.</p></li>
<li><p>Payments can be directed to escrow-like programs, enabling things like refunds, chargebacks, and other return mechanisms.</p></li>
<li><p>DeFi transactions could be bridged to all kinds of web2 / IRL portals.</p></li>
<li><p>Wallets can retrieve other information, or merchants can pass it to them, like an icon to display, or other fields in the JSON response.</p></li>
<li><p>It doesn’t even need to be a payment. Merchants could send tokens, invitations, gifts to customers that connect a wallet, perhaps one that meets some criteria, such as possessing an NFT.</p></li>
</ul>
<p>&lt;/details&gt;</p>
<p><a href="#id16"><span class="problematic" id="id17">``</span></a><a href="#id18"><span class="problematic" id="id19">`</span></a>javascript
async function createSplTransferIx(sender, connection) {</p>
<blockquote>
<div><p>const senderInfo = await connection.getAccountInfo(sender);
if (!senderInfo) throw new Error(‘sender not found’);</p>
<p>// Get the sender’s ATA and check that the account exists and can send tokens
const senderATA = await getAssociatedTokenAddress(splToken, sender);
const senderAccount = await getAccount(connection, senderATA);
if (!senderAccount.isInitialized) throw new Error(‘sender not initialized’);
if (senderAccount.isFrozen) throw new Error(‘sender frozen’);</p>
<p>// Get the merchant’s ATA and check that the account exists and can receive tokens
const merchantATA = await getAssociatedTokenAddress(splToken, MERCHANT_WALLET);
const merchantAccount = await getAccount(connection, merchantATA);
if (!merchantAccount.isInitialized) throw new Error(‘merchant not initialized’);
if (merchantAccount.isFrozen) throw new Error(‘merchant frozen’);</p>
<p>// Check that the token provided is an initialized mint
const mint = await getMint(connection, splToken);
if (!mint.isInitialized) throw new Error(‘mint not initialized’);</p>
<p>// You should always calculate the order total on the server to prevent
// people from directly manipulating the amount on the client
let amount = calculateCheckoutAmount();
amount = amount.times(TEN.pow(mint.decimals)).integerValue(BigNumber.ROUND_FLOOR);</p>
<p>// Check that the sender has enough tokens
const tokens = BigInt(String(amount));
if (tokens &gt; senderAccount.amount) throw new Error(‘insufficient funds’);</p>
<p>// Create an instruction to transfer SPL tokens, asserting the mint and decimals match
const splTransferIx = createTransferCheckedInstruction(</p>
<blockquote>
<div><p>senderATA,
splToken,
merchantATA,
sender,
tokens,
mint.decimals</p>
</div></blockquote>
<p>);</p>
<p>// Create a reference that is unique to each checkout session
const references = [new Keypair().publicKey];</p>
<p>// add references to the instruction
for (const pubkey of references) {</p>
<blockquote>
<div><p>splTransferIx.keys.push({ pubkey, isWritable: false, isSigner: false });</p>
</div></blockquote>
<p>}</p>
<p>return splTransferIx;</p>
</div></blockquote>
</section>
<section id="id20">
<h2>}<a class="headerlink" href="#id20" title="Permalink to this heading">¶</a></h2>
<p>For our example, we create a simple transfer for a SPL token, serialize the transaction, and base64 encode it.</p>
<p>## Best Practices</p>
<p>We recommend handling a customer session in a secure environment. Building a secure integration with Solana Pay requires a payment flow as follows:</p>
<p>![](../../images/transaction-request-flow-dark.png)</p>
<ol class="arabic simple">
<li><p>Customer goes to the payment page</p></li>
<li><p>Merchant frontend (client) sends order information to the backend</p></li>
<li><p>Merchant backend (server) generates a reference public key and stores it in a database with the expected amount for the shopping cart / pending purchase (unique to each customer’s checkout session).</p></li>
<li><p>Merchant backend redirects the user to the confirmation page with the generated reference public key.</p></li>
<li><p>The confirmation page redirects to the merchant with the transaction signature.</p></li>
<li><p>Merchant backend checks that the transaction is valid for the checkout session by validating the transaction with the reference and amount stored in step 3.</p></li>
</ol>
<p>&lt;!– References –&gt;</p>
<p>[1]: <a class="reference external" href="https://nextjs.org/docs/api-routes/introduction">https://nextjs.org/docs/api-routes/introduction</a>
[2]: <a class="reference external" href="https://github.com/solana-labs/solana-pay/tree/master/point-of-sale">https://github.com/solana-labs/solana-pay/tree/master/point-of-sale</a>
[3]: <a class="reference external" href="https://github.com/solana-labs/solana-pay/blob/master/SPEC.md#link">https://github.com/solana-labs/solana-pay/blob/master/SPEC.md#link</a>
[4]: <a class="reference external" href="https://github.com/solana-labs/solana-pay">https://github.com/solana-labs/solana-pay</a></p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../_sources/src/core/transaction-request/MERCHANT_INTEGRATION.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>