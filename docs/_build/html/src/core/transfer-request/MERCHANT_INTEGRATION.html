<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>docs/src/core/transfer-request/MERCHANT_INTEGRATION.md &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="docs-src-core-transfer-request-merchant-integration-md">
<h1>docs/src/core/transfer-request/MERCHANT_INTEGRATION.md<a class="headerlink" href="#docs-src-core-transfer-request-merchant-integration-md" title="Permalink to this heading">¶</a></h1>
<p>Last edited: 2023-05-03 15:27:33</p>
<p>Contents:</p>
<div class="highlight-md notranslate"><div class="highlight"><pre><span></span>---
</pre></div>
</div>
<p>title: Create a transfer request
slug: /core/transfer-request/merchant-integration
—</p>
<p>This section describes how a merchant can integrate Solana Pay transfer requests into their payments flow. It shows how to create a payment request link, encode it into a QR code, find the transaction, and validate it.</p>
<p>This guide walks through an example of a QR code-based Point of Sale system that accepts payments via Solana Pay.</p>
<p>The complete example code can be found [here][5].</p>
<p>## Requirements</p>
<p>Before you can receive payments, you’ll need to obtain a native SOL address. This doesn’t cost anything, and you can use any wallet to get started.</p>
<p>If you want to receive USDC or another SPL token on Solana, you’ll need to create a token account, which may require a small amount of SOL.</p>
<p>One way to do both is to use Coinbase, which will provide a native SOL deposit address and an associated USDC token account to receive payments.</p>
<p>—</p>
<p>## 1. Set up Solana Pay</p>
<p>Install the packages and import them in your code.</p>
<p><strong>npm</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">npm</span> <span class="pre">install</span> <span class="pre">&#64;solana/pay</span> <span class="pre">&#64;solana/web3.js</span> <span class="pre">bignumber.js</span> <span class="pre">--save</span>
<span class="pre">`</span></code></p>
<p><strong>yarn</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">`shell</span>
<span class="pre">yarn</span> <span class="pre">add</span> <span class="pre">&#64;solana/pay</span> <span class="pre">&#64;solana/web3.js</span> <span class="pre">bignumber.js</span>
<span class="pre">`</span></code></p>
<p>### 1.1 Import necessary modules</p>
<p>Import the modules used to work with Solana Pay.</p>
<p><code class="docutils literal notranslate"><span class="pre">`typescript</span>
<span class="pre">import</span> <span class="pre">{</span> <span class="pre">Cluster,</span> <span class="pre">clusterApiUrl,</span> <span class="pre">Connection,</span> <span class="pre">PublicKey</span> <span class="pre">}</span> <span class="pre">from</span> <span class="pre">'&#64;solana/web3.js';</span>
<span class="pre">import</span> <span class="pre">{</span> <span class="pre">encodeURL,</span> <span class="pre">createQR</span> <span class="pre">}</span> <span class="pre">from</span> <span class="pre">'&#64;solana/pay';</span>
<span class="pre">import</span> <span class="pre">BigNumber</span> <span class="pre">from</span> <span class="pre">'bignumber.js';</span>
<span class="pre">`</span></code></p>
<p>### 1.2 Establish a connection</p>
<p>When working on Solana, you will need to connect to the network. For our example, we will connect to <cite>devnet</cite>.</p>
<dl>
<dt>&lt;details open&gt;</dt><dd><dl class="simple">
<dt>&lt;summary&gt;</dt><dd><p>Establish a connection to the &lt;code&gt;devnet&lt;/code&gt; network</p>
</dd>
</dl>
<p>&lt;/summary&gt;</p>
</dd>
</dl>
<p>&lt;br/&gt;</p>
<p><a href="#id1"><span class="problematic" id="id2">``</span></a><a href="#id3"><span class="problematic" id="id4">`</span></a>typescript
async function main() {</p>
<blockquote>
<div><p>// Variable to keep state of the payment status
let paymentStatus: string;</p>
<p>// Connecting to devnet for this example
console.log(‘1. ✅ Establish connection to the network’);
const connection = new Connection(clusterApiUrl(‘devnet’), ‘confirmed’);</p>
</div></blockquote>
<section id="id5">
<h2>}<a class="headerlink" href="#id5" title="Permalink to this heading">¶</a></h2>
<p>&lt;/details&gt;</p>
<p>## 2. Create a payment request link</p>
<p>Solana Pay uses a [standard URL scheme](../../SPEC.md) across wallets for native SOL and SPL Token payments. Several parameters are encoded within the link representing an intent to collect payment from a customer.</p>
<dl>
<dt>&lt;details&gt;</dt><dd><dl class="simple">
<dt>&lt;summary&gt;</dt><dd><p>Create a payment request link with a &lt;code&gt;recipient&lt;/code&gt;, &lt;code&gt;amount&lt;/code&gt;, &lt;code&gt;label&lt;/code&gt;, &lt;code&gt;message&lt;/code&gt; ,  &lt;code&gt;memo&lt;/code&gt; and &lt;code&gt;reference&lt;/code&gt;.</p>
</dd>
</dl>
<p>&lt;/summary&gt;</p>
</dd>
</dl>
<p>&lt;br/&gt;</p>
<p><a href="#id6"><span class="problematic" id="id7">``</span></a><a href="#id8"><span class="problematic" id="id9">`</span></a>typescript
// – snippet – //</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Simulate a checkout experience</p></li>
<li></li>
<li><p>Recommendation:</p></li>
<li><p><cite>amount</cite> and <cite>reference</cite> should be created in a trusted environment (server).</p></li>
<li><p>The <cite>reference</cite> should be unique to a single customer session,</p></li>
<li><p>and will be used to find and validate the payment in the future.</p></li>
<li></li>
</ul>
<p><a href="#id10"><span class="problematic" id="id11">*</span></a>/</p>
</dd>
</dl>
<p>console.log(‘2. 🛍 Simulate a customer checkout n’);
const recipient = new PublicKey(‘MERCHANT_WALLET’);
const amount = new BigNumber(20);
const reference = new Keypair().publicKey;
const label = ‘Jungle Cats store’;
const message = ‘Jungle Cats store - your order - #001234’;
const memo = ‘JC#4098’;</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Create a payment request link</p></li>
<li></li>
<li><p>Solana Pay uses a standard URL scheme across wallets for native SOL and SPL Token payments.</p></li>
<li><p>Several parameters are encoded within the link representing an intent to collect payment from a customer.</p></li>
</ul>
<p><a href="#id12"><span class="problematic" id="id13">*</span></a>/</p>
</dd>
</dl>
<p>console.log(‘3. 💰 Create a payment request link n’);
const url = encodeURL({ recipient, amount, reference, label, message, memo });
<a href="#id14"><span class="problematic" id="id15">``</span></a><a href="#id16"><span class="problematic" id="id17">`</span></a></p>
<p>See [full code snippet][6]</p>
<p>&lt;/details&gt;</p>
<p>### Optional. SPL token transfer</p>
<p>For SPL Token transfers, use the <cite>spl-token</cite> parameter. The <cite>spl-token</cite> is the mint address of the SPL token.</p>
<dl class="simple">
<dt>&lt;details&gt;</dt><dd><p>&lt;summary&gt;See code snippet&lt;/summary&gt;</p>
</dd>
</dl>
<p><a href="#id18"><span class="problematic" id="id19">``</span></a><a href="#id20"><span class="problematic" id="id21">`</span></a>typescript
/**</p>
<blockquote>
<div><ul class="simple">
<li><p>Simulate a checkout experience with an SPL token</p></li>
</ul>
<p><a href="#id22"><span class="problematic" id="id23">*</span></a>/</p>
</div></blockquote>
<p>console.log(‘2. 🛍 Simulate a customer checkout n’);
const splToken = new PublicKey(‘EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v’);</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Create a payment request link</p></li>
<li></li>
<li><p>Solana Pay uses a standard URL scheme across wallets for native SOL and SPL Token payments.</p></li>
<li><p>Several parameters are encoded within the link representing an intent to collect payment from a customer.</p></li>
</ul>
<p><a href="#id24"><span class="problematic" id="id25">*</span></a>/</p>
</dd>
</dl>
<p>console.log(‘3. 💰 Create a payment request link n’);
const url = encodeURL({</p>
<blockquote>
<div><p>recipient,
amount,
splToken,
reference,
label,
message,
memo,</p>
</div></blockquote>
</section>
<section id="id26">
<h2>});<a class="headerlink" href="#id26" title="Permalink to this heading">¶</a></h2>
<p>&lt;/details&gt;</p>
<p>## 3. Encode link into a QR code</p>
<p>Now that you’ve created a payment link, you need a way to show it to your customers.</p>
<dl>
<dt>&lt;details&gt;</dt><dd><dl class="simple">
<dt>&lt;summary&gt;</dt><dd><p>Encode the link into a QR code.</p>
</dd>
</dl>
<p>&lt;/summary&gt;</p>
</dd>
</dl>
<p><a href="#id27"><span class="problematic" id="id28">``</span></a><a href="#id29"><span class="problematic" id="id30">`</span></a>typescript
// – snippet – //</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Create a payment request link</p></li>
<li></li>
<li><p>Solana Pay uses a standard URL scheme across wallets for native SOL and SPL Token payments.</p></li>
<li><p>Several parameters are encoded within the link representing an intent to collect payment from a customer.</p></li>
</ul>
<p><a href="#id31"><span class="problematic" id="id32">*</span></a>/</p>
</dd>
</dl>
<p>console.log(‘3. 💰 Create a payment request link n’);
const url = encodeURL({ recipient, amount, reference, label, message, memo });</p>
<p>// encode URL in QR code
const qrCode = createQR(url);
<a href="#id33"><span class="problematic" id="id34">``</span></a><a href="#id35"><span class="problematic" id="id36">`</span></a></p>
<p>&lt;/details&gt;</p>
<p>&lt;br/&gt;</p>
<p>![qr code](../../images/solana-pay.png)</p>
<p>### 3.1 Add the QR code to your payment page</p>
<p>The QR code needs to be visible on your payment page.</p>
<dl>
<dt>&lt;details&gt;</dt><dd><dl class="simple">
<dt>&lt;summary&gt;</dt><dd><p>Add the QR code to an element on the payment page</p>
</dd>
</dl>
<p>&lt;/summary&gt;</p>
</dd>
</dl>
<p><a href="#id37"><span class="problematic" id="id38">``</span></a><a href="#id39"><span class="problematic" id="id40">`</span></a>typescript
// – snippet – //</p>
<p>console.log(‘3. 💰 Create a payment request link n’);
const url = encodeURL({ recipient, amount, reference, label, message, memo });</p>
<p>// encode URL in QR code
const qrCode = createQR(url);</p>
<p>// get a handle of the element
const element = document.getElementById(‘qr-code’);</p>
<p>// append QR code to the element
qrCode.append(element);
<a href="#id41"><span class="problematic" id="id42">``</span></a><a href="#id43"><span class="problematic" id="id44">`</span></a></p>
<p>&lt;/details&gt;</p>
<p>Instructions on integrating with your framework of choice can be found [here][1].</p>
<p>## 4. Show a payment status page</p>
<p>With the payment link set up and shown to the customer, you will need to ensure that the customer has paid for the item before shipping their order.</p>
<p>When a customer approves the payment request in their wallet, this transaction exists on-chain. You can use any references encoded into the payment link to find the exact transaction on-chain.</p>
<dl>
<dt>&lt;details&gt;</dt><dd><dl class="simple">
<dt>&lt;summary&gt;</dt><dd><p>Use &lt;code&gt;findReference&lt;/code&gt; to find the on-chain transaction. Provide a &lt;code&gt;reference&lt;/code&gt; to this function that identifies the transaction associated with the order.</p>
</dd>
</dl>
<p>&lt;/summary&gt;</p>
</dd>
</dl>
<p>&lt;br/&gt;</p>
<p><a href="#id45"><span class="problematic" id="id46">``</span></a><a href="#id47"><span class="problematic" id="id48">`</span></a>typescript
// – snippet – //</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Simulate wallet interaction</p></li>
<li></li>
<li><p>This is only for example purposes. This interaction will be handled by a wallet provider</p></li>
</ul>
<p><a href="#id49"><span class="problematic" id="id50">*</span></a>/</p>
</dd>
</dl>
<p>console.log(‘4. 🔐 Simulate wallet interaction n’);
simulateWalletInteraction(connection, url);</p>
<p>// Update payment status
paymentStatus = ‘pending’;</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Wait for payment to be confirmed</p></li>
<li></li>
<li><p>When a customer approves the payment request in their wallet, this transaction exists on-chain.</p></li>
<li><p>You can use any references encoded into the payment link to find the exact transaction on-chain.</p></li>
<li><p>Important to note that we can only find the transaction when it’s <strong>confirmed</strong></p></li>
</ul>
<p><a href="#id51"><span class="problematic" id="id52">*</span></a>/</p>
</dd>
</dl>
<p>console.log(’n5. Find the transaction’);
const signatureInfo = await findReference(connection, reference, { finality: ‘confirmed’ });</p>
<p>// Update payment status
paymentStatus = ‘confirmed’;
<a href="#id53"><span class="problematic" id="id54">``</span></a><a href="#id55"><span class="problematic" id="id56">`</span></a></p>
<p><strong>Note</strong>: The <cite>findReference</cite> function uses <cite>confirmed</cite> as the default finality value. This can, on rare occasions, result in a transaction that is not fully complete. For full finality, use <cite>finalized</cite>. This can result in slower transaction completion.</p>
<p>See [full code snippet][7]</p>
<p>&lt;/details&gt;</p>
<p>### 4.1 Retries</p>
<p>If a transaction with the given reference can’t be found, the <cite>findReference</cite> function will throw an error. There are a few reasons why this could be:</p>
<ul class="simple">
<li><p>Transaction is not yet confirmed</p></li>
<li><p>Customer is yet to approve/complete the transaction</p></li>
</ul>
<dl>
<dt>&lt;details&gt;</dt><dd><dl class="simple">
<dt>&lt;summary&gt;</dt><dd><p>You can implement a polling strategy to query for the transaction periodically.</p>
</dd>
</dl>
<p>&lt;/summary&gt;</p>
</dd>
</dl>
<p><a href="#id57"><span class="problematic" id="id58">``</span></a><a href="#id59"><span class="problematic" id="id60">`</span></a>typescript
// – snippet – //</p>
<p>let signatureInfo: ConfirmedSignatureInfo;</p>
<dl>
<dt>return new Promise((resolve, reject) =&gt; {</dt><dd><dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Retry until we find the transaction</p></li>
<li></li>
<li><p>If a transaction with the given reference can’t be found, the <cite>findReference</cite></p></li>
<li><p>function will throw an error. There are a few reasons why this could be a false negative:</p></li>
<li></li>
<li><ul>
<li><p>Transaction is not yet confirmed</p></li>
</ul>
</li>
<li><ul>
<li><p>Customer is yet to approve/complete the transaction</p></li>
</ul>
</li>
<li></li>
<li><p>You can implement a polling strategy to query for the transaction periodically.</p></li>
</ul>
<p><a href="#id61"><span class="problematic" id="id62">*</span></a>/</p>
</dd>
<dt>const interval = setInterval(async () =&gt; {</dt><dd><p>console.log(‘Checking for transaction…’, count);
try {</p>
<blockquote>
<div><p>signatureInfo = await findReference(connection, reference, { finality: ‘confirmed’ });
console.log(’n 🖌  Signature found: ‘, signatureInfo.signature);
clearInterval(interval);
resolve(signatureInfo);</p>
</div></blockquote>
<dl>
<dt>} catch (error: any) {</dt><dd><dl class="simple">
<dt>if (!(error instanceof FindReferenceError)) {</dt><dd><p>console.error(error);
clearInterval(interval);
reject(error);</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}, 250);</p>
</dd>
</dl>
</section>
<section id="id63">
<h2>});<a class="headerlink" href="#id63" title="Permalink to this heading">¶</a></h2>
<p>See [full code snippet][7]</p>
<p>&lt;/details&gt;</p>
<p>### 4.2 Validating the transaction</p>
<p>Once the <cite>findReference</cite> function returns a signature, it confirms that a transaction that references the order has been recorded on-chain. But it doesn’t guarantee that a valid transfer with the expected amount and recipient happened.</p>
<dl>
<dt>&lt;details&gt;</dt><dd><dl class="simple">
<dt>&lt;summary&gt;</dt><dd><p>&lt;code&gt;validateTransfer&lt;/code&gt; allows you to validate that the transaction signature found matches the transaction that you expected.</p>
</dd>
</dl>
<p>&lt;/summary&gt;</p>
</dd>
</dl>
<p><a href="#id64"><span class="problematic" id="id65">``</span></a><a href="#id66"><span class="problematic" id="id67">`</span></a>typescript
// – snippet – //</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Validate transaction</p></li>
<li></li>
<li><p>Once the <cite>findReference</cite> function returns a signature,</p></li>
<li><p>it confirms that a transaction with reference to this order has been recorded on-chain.</p></li>
<li></li>
<li><p><cite>validateTransfer</cite> allows you to validate that the transaction signature</p></li>
<li><p>found matches the transaction that you expected.</p></li>
</ul>
<p><a href="#id68"><span class="problematic" id="id69">*</span></a>/</p>
</dd>
</dl>
<p>console.log(’n6. 🔗 Validate transaction n’);</p>
<dl>
<dt>try {</dt><dd><p>await validateTransfer(connection, signature, { recipient: MERCHANT_WALLET, amount });</p>
<p>// Update payment status
paymentStatus = ‘validated’;
console.log(’✅ Payment validated’);
console.log(’📦 Ship order to customer’);</p>
</dd>
<dt>} catch (error) {</dt><dd><p>console.error(’❌ Payment failed’, error);</p>
</dd>
</dl>
</section>
<section id="id70">
<h2>}<a class="headerlink" href="#id70" title="Permalink to this heading">¶</a></h2>
<p>See [full code snippet][8]</p>
<p>&lt;/details&gt;</p>
<p>## Best practices</p>
<p>We recommend handling a customer session in a secure environment. Building a secure integration with Solana Pay requires a payment flow as follows:</p>
<p>![best practices diagram](../../images/transfer-request-best-practice-dark.png)</p>
<ol class="arabic simple">
<li><p>Customer goes to the payment page</p></li>
<li><p>Merchant frontend (client) sends order information to the backend</p></li>
<li><p>Merchant backend (server) generates a reference public key and stores it in a database with the expected amount for the shopping cart / pending purchase (unique to each customer’s checkout session).</p></li>
<li><p>Merchant backend redirects the user to the confirmation page with the generated reference public key.</p></li>
<li><p>The confirmation page redirects to the merchant with the transaction signature.</p></li>
<li><p>Merchant backend checks that the transaction is valid for the checkout session by validating the transaction with the reference and amount stored in step 3.</p></li>
</ol>
<p>The steps outlined above prevents:</p>
<ul class="simple">
<li><p>A different transaction from being used to trick the merchant</p></li>
<li><p>The frontend from being manipulated to show a confirmed transaction</p></li>
</ul>
<p>&lt;!– References –&gt;</p>
<p>[1]: <a class="reference external" href="https://github.com/solana-labs/qr-code-styling">https://github.com/solana-labs/qr-code-styling</a>
[2]: <a class="reference external" href="https://spl.solana.com/memo">https://spl.solana.com/memo</a>
[3]: <a class="reference external" href="https://github.com/solana-labs/solana/issues/19535">https://github.com/solana-labs/solana/issues/19535</a>
[4]: <a class="reference external" href="https://github.com/solana-labs/solana-pay/tree/master/examples/point-of-sale">https://github.com/solana-labs/solana-pay/tree/master/examples/point-of-sale</a>
[5]: <a class="reference external" href="https://github.com/solana-labs/solana-pay/tree/master/core/example/payment-flow-merchant">https://github.com/solana-labs/solana-pay/tree/master/core/example/payment-flow-merchant</a>
[6]: <a class="reference external" href="https://github.com/solana-labs/solana-pay/blob/master/core/example/payment-flow-merchant/simulateCheckout.ts">https://github.com/solana-labs/solana-pay/blob/master/core/example/payment-flow-merchant/simulateCheckout.ts</a>
[7]: <a class="reference external" href="https://github.com/solana-labs/solana-pay/blob/master/core/example/payment-flow-merchant/main.ts#L61">https://github.com/solana-labs/solana-pay/blob/master/core/example/payment-flow-merchant/main.ts#L61</a>
[8]: <a class="reference external" href="https://github.com/solana-labs/solana-pay/blob/master/core/example/payment-flow-merchant/main.ts#L105">https://github.com/solana-labs/solana-pay/blob/master/core/example/payment-flow-merchant/main.ts#L105</a></p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../_sources/src/core/transfer-request/MERCHANT_INTEGRATION.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>