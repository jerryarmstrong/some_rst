<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../../../../" id="documentation_options" src="../../../../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>package com.twitter.search.earlybird.search.relevance.scoring;</p>
<p>import java.io.IOException;
import java.util.List;</p>
<p>import com.google.common.base.Preconditions;</p>
<p>import org.apache.lucene.index.IndexReader;
import org.apache.lucene.search.Explanation;</p>
<p>import com.twitter.common.collections.Pair;
import com.twitter.search.common.constants.thriftjava.ThriftLanguage;
import com.twitter.search.common.features.thrift.ThriftSearchResultFeatures;
import com.twitter.search.common.query.HitAttributeHelper;
import com.twitter.search.common.relevance.features.EarlybirdDocumentFeatures;
import com.twitter.search.common.results.thriftjava.FieldHitAttribution;
import com.twitter.search.common.schema.base.ImmutableSchemaInterface;
import com.twitter.search.common.schema.earlybird.EarlybirdFieldConstants.EarlybirdFieldConstant;
import com.twitter.search.core.earlybird.index.DocIDToTweetIDMapper;
import com.twitter.search.core.earlybird.index.EarlybirdIndexSegmentAtomicReader;
import com.twitter.search.core.earlybird.index.TimeMapper;
import com.twitter.search.earlybird.common.config.EarlybirdConfig;
import com.twitter.search.earlybird.search.relevance.LinearScoringData;
import com.twitter.search.earlybird.thrift.ThriftSearchResultMetadata;
import com.twitter.search.earlybird.thrift.ThriftSearchResultMetadataOptions;
import com.twitter.search.earlybird.thrift.ThriftSearchResultType;
import com.twitter.search.earlybird.thrift.ThriftSearchResultsRelevanceStats;
import com.twitter.search.queryparser.query.Query;</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Defines a ranking function which computes the score of a document that matches a query.</p></li>
</ul>
<p><a href="#id1"><span class="problematic" id="id2">*</span></a>/</p>
</dd>
<dt>public abstract class ScoringFunction {</dt><dd><dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Returned by a <a class="reference external" href="mailto:{&#37;&#52;&#48;link">{<span>&#64;</span>link</a> #score(int, float)} to indicate that a hit should be scored below all.</p></li>
<li></li>
<li><p>We have some equality tests like:</p></li>
<li><p>“if (score == ScoringFunction.SKIP_HIT) {…}” (DefaultScoringFunction#updateRelevanceStats)</p></li>
<li><p>We might also have double to float casts.</p></li>
<li></li>
<li><p>Such castings seem to work with the equality test, but there might corner cases when casting</p></li>
<li><p>this float value to a double (and back) might not work properly.</p></li>
<li></li>
<li><p>If possible, we should choose a constant that is not in the valid score range. Then we can</p></li>
<li><p>turn the float equality tests into Math.abs(…) &lt; EPSILON tests.</p></li>
</ul>
<p><a href="#id3"><span class="problematic" id="id4">*</span></a>/</p>
</dd>
</dl>
<p>public static final float SKIP_HIT = -Float.MAX_VALUE;</p>
<p>private final ImmutableSchemaInterface schema;</p>
<p>// The current doc ID and the reader for the current segment should be private, because we don’t
// want sub-classes to incorrectly update them. The doc ID should only be updated by the score()
// and explain() methods, and the reader should only be updated by the setNextReader() method.
private int currentDocID = -1;</p>
<p>protected DocIDToTweetIDMapper tweetIDMapper = null;
protected TimeMapper timeMapper = null;
protected EarlybirdDocumentFeatures documentFeatures;</p>
<p>protected int debugMode = 0;
protected HitAttributeHelper hitAttributeHelper;
protected Query query;</p>
<p>protected FieldHitAttribution fieldHitAttribution;</p>
<dl class="simple">
<dt>public ScoringFunction(ImmutableSchemaInterface schema) {</dt><dd><p>this.schema = Preconditions.checkNotNull(schema);</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>protected ImmutableSchemaInterface getSchema() {</dt><dd><p>return schema;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Updates the reader that will be used to retrieve the tweet IDs and creation times associated</p></li>
<li><p>with scored doc IDs, as well as the values for various CSFs. Should be called every time the</p></li>
<li><p>searcher starts searching in a new segment.</p></li>
</ul>
<p><a href="#id5"><span class="problematic" id="id6">*</span></a>/</p>
</dd>
<dt>public void setNextReader(EarlybirdIndexSegmentAtomicReader reader) throws IOException {</dt><dd><p>tweetIDMapper = reader.getSegmentData().getDocIDToTweetIDMapper();
timeMapper = reader.getSegmentData().getTimeMapper();
documentFeatures = new EarlybirdDocumentFeatures(reader);
initializeNextSegment(reader);</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>public void setHitAttributeHelperAndQuery(HitAttributeHelper newHitAttributeHelper,</dt><dd><blockquote>
<div><p>Query parsedQuery) {</p>
</div></blockquote>
<p>this.hitAttributeHelper = newHitAttributeHelper;
this.query = parsedQuery;</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>public void setFieldHitAttribution(FieldHitAttribution fieldHitAttribution) {</dt><dd><p>this.fieldHitAttribution = fieldHitAttribution;</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>public void setDebugMode(int debugMode) {</dt><dd><p>this.debugMode = debugMode;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Allow scoring functions to perform more per-segment-specific setup.</p></li>
</ul>
<p><a href="#id7"><span class="problematic" id="id8">*</span></a>/</p>
</dd>
<dt>protected void initializeNextSegment(EarlybirdIndexSegmentAtomicReader reader)</dt><dd><blockquote>
<div><p>throws IOException {</p>
</div></blockquote>
<p>// Noop by default</p>
</dd>
</dl>
<p>}</p>
<p>// Updates the current document ID and advances all NumericDocValues to this doc ID.
private void setCurrentDocID(int currentDocID) throws IOException {</p>
<blockquote>
<div><p>this.currentDocID = currentDocID;
documentFeatures.advance(currentDocID);</p>
</div></blockquote>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Returns the current doc ID stored in this scoring function.</p></li>
</ul>
<p><a href="#id9"><span class="problematic" id="id10">*</span></a>/</p>
</dd>
<dt>public int getCurrentDocID() {</dt><dd><p>return currentDocID;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Compute the score for the current hit.  This is not expected to be thread safe.</p></li>
<li></li>
<li><p>&#64;param internalDocID    internal id of the matching hit</p></li>
<li><p>&#64;param luceneQueryScore the score that lucene’s text query computed for this hit</p></li>
</ul>
<p><a href="#id11"><span class="problematic" id="id12">*</span></a>/</p>
</dd>
<dt>public float score(int internalDocID, float luceneQueryScore) throws IOException {</dt><dd><p>setCurrentDocID(internalDocID);
return score(luceneQueryScore);</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Compute the score for the current hit.  This is not expected to be thread safe.</p></li>
<li></li>
<li><p>&#64;param luceneQueryScore the score that lucene’s text query computed for this hit</p></li>
</ul>
<p><a href="#id13"><span class="problematic" id="id14">*</span></a>/</p>
</dd>
</dl>
<p>protected abstract float score(float luceneQueryScore) throws IOException;</p>
<p>/** Returns an explanation for the given hit. <a href="#id15"><span class="problematic" id="id16">*</span></a>/
public final Explanation explain(IndexReader reader, int internalDocID, float luceneScore)</p>
<blockquote>
<div><blockquote>
<div><p>throws IOException {</p>
</div></blockquote>
<p>setNextReader((EarlybirdIndexSegmentAtomicReader) reader);
setCurrentDocID(internalDocID);
return doExplain(luceneScore);</p>
</div></blockquote>
<p>}</p>
<p>/** Returns an explanation for the current document. <a href="#id17"><span class="problematic" id="id18">*</span></a>/
protected abstract Explanation doExplain(float luceneScore) throws IOException;</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Returns the scoring metadata for the current doc ID.</p></li>
</ul>
<p><a href="#id19"><span class="problematic" id="id20">*</span></a>/</p>
</dd>
<dt>public ThriftSearchResultMetadata getResultMetadata(ThriftSearchResultMetadataOptions options)</dt><dd><blockquote>
<div><p>throws IOException {</p>
</div></blockquote>
<p>ThriftSearchResultMetadata metadata = new ThriftSearchResultMetadata();
metadata.setResultType(ThriftSearchResultType.RELEVANCE);
metadata.setPenguinVersion(EarlybirdConfig.getPenguinVersionByte());
metadata.setLanguage(ThriftLanguage.findByValue(</p>
<blockquote>
<div><p>(int) documentFeatures.getFeatureValue(EarlybirdFieldConstant.LANGUAGE)));</p>
</div></blockquote>
<dl class="simple">
<dt>metadata.setSignature(</dt><dd><p>(int) documentFeatures.getFeatureValue(EarlybirdFieldConstant.TWEET_SIGNATURE));</p>
</dd>
</dl>
<p>metadata.setIsNullcast(documentFeatures.isFlagSet(EarlybirdFieldConstant.IS_NULLCAST_FLAG));
return metadata;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Updates the given ThriftSearchResultsRelevanceStats instance based on the scoring metadata for</p></li>
<li><p>the current doc ID.</p></li>
</ul>
<p><a href="#id21"><span class="problematic" id="id22">*</span></a>/</p>
</dd>
</dl>
<p>public abstract void updateRelevanceStats(ThriftSearchResultsRelevanceStats relevanceStats);</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Score a list of hits. Not thread safe.</p></li>
</ul>
<p><a href="#id23"><span class="problematic" id="id24">*</span></a>/</p>
</dd>
<dt>public float[] batchScore(List&lt;BatchHit&gt; hits) throws IOException {</dt><dd><p>throw new UnsupportedOperationException(“This operation (batchScore) is not implemented!”);</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Collect the features and CSFs for the current document. Used for scoring and generating the</p></li>
<li><p>returned metadata.</p></li>
</ul>
<p><a href="#id25"><span class="problematic" id="id26">*</span></a>/</p>
</dd>
<dt>public Pair&lt;LinearScoringData, ThriftSearchResultFeatures&gt; collectFeatures(</dt><dd><blockquote>
<div><p>float luceneQueryScore) throws IOException {</p>
</div></blockquote>
<p>throw new UnsupportedOperationException(“This operation (collectFeatures) is not implemented!”);</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Implement this function to populate the result metadata based on the given scoring data.</p></li>
<li><p>Otherwise, this is a no-op.</p></li>
<li></li>
<li><p>Scoring functions that implement this should also implement getScoringData().</p></li>
</ul>
<p><a href="#id27"><span class="problematic" id="id28">*</span></a>/</p>
</dd>
<dt>public void populateResultMetadataBasedOnScoringData(</dt><dd><blockquote>
<div><p>ThriftSearchResultMetadataOptions options,
ThriftSearchResultMetadata metadata,
LinearScoringData data) throws IOException {</p>
</div></blockquote>
<p>// Make sure that the scoring data passed in is null because getScoringDataForCurrentDocument()
// returns null by default and if a subclass overrides one of these two methods, it should
// override both.
Preconditions.checkState(data == null, “LinearScoringData should be null”);</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>This should only be called at hit collection time because it relies on the internal doc id.</p></li>
<li></li>
<li><p>Scoring functions that implement this should also implement the function</p></li>
<li><p>populateResultMetadataBasedOnScoringData().</p></li>
</ul>
<p><a href="#id29"><span class="problematic" id="id30">*</span></a>/</p>
</dd>
<dt>public LinearScoringData getScoringDataForCurrentDocument() {</dt><dd><p>return null;</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../../../../index.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../../../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../../../../_sources/src/java/com/twitter/search/earlybird/search/relevance/scoring/ScoringFunction.java.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>