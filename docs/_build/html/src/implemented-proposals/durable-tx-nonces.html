<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>docs/src/implemented-proposals/durable-tx-nonces.md &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="docs-src-implemented-proposals-durable-tx-nonces-md">
<h1>docs/src/implemented-proposals/durable-tx-nonces.md<a class="headerlink" href="#docs-src-implemented-proposals-durable-tx-nonces-md" title="Permalink to this heading">¶</a></h1>
<p>Last edited: 2023-08-11 21:38:33</p>
<p>Contents:</p>
<div class="highlight-md notranslate"><div class="highlight"><pre><span></span>---
</pre></div>
</div>
<p>title: Durable Transaction Nonces
—</p>
<p>## Problem</p>
<p>To prevent replay, Solana transactions contain a nonce field populated with a
“recent” blockhash value. A transaction containing a blockhash that is too old
(~2min as of this writing) is rejected by the network as invalid. Unfortunately
certain use cases, such as custodial services, require more time to produce a
signature for the transaction. A mechanism is needed to enable these potentially
offline network participants.</p>
<p>## Requirements</p>
<ol class="arabic simple">
<li><p>The transaction’s signature needs to cover the nonce value</p></li>
<li><p>The nonce must not be reusable, even in the case of signing key disclosure</p></li>
</ol>
<p>## A Contract-based Solution</p>
<p>Here we describe a contract-based solution to the problem, whereby a client can
“stash” a nonce value for future use in a transaction’s <cite>recent_blockhash</cite>
field. This approach is akin to the Compare and Swap atomic instruction,
implemented by some CPU ISAs.</p>
<p>When making use of a durable nonce, the client must first query its value from
account data. A transaction is now constructed in the normal way, but with the
following additional requirements:</p>
<ol class="arabic simple">
<li><p>The durable nonce value is used in the <cite>recent_blockhash</cite> field</p></li>
<li><p>An <cite>AdvanceNonceAccount</cite> instruction is the first issued in the transaction</p></li>
</ol>
<p>### Contract Mechanics</p>
<p>TODO: svgbob this into a flowchart</p>
<p><a href="#id1"><span class="problematic" id="id2">``</span></a><a href="#id3"><span class="problematic" id="id4">`</span></a>text
Start
Create Account</p>
<blockquote>
<div><p>state = Uninitialized</p>
</div></blockquote>
<dl>
<dt>NonceInstruction</dt><dd><dl>
<dt>if state == Uninitialized</dt><dd><dl class="simple">
<dt>if account.balance &lt; rent_exempt</dt><dd><p>error InsufficientFunds</p>
</dd>
</dl>
<p>state = Initialized</p>
</dd>
<dt>elif state != Initialized</dt><dd><p>error BadState</p>
</dd>
<dt>if sysvar.recent_blockhashes.is_empty()</dt><dd><p>error EmptyRecentBlockhashes</p>
</dd>
<dt>if !sysvar.recent_blockhashes.contains(stored_nonce)</dt><dd><p>error NotReady</p>
</dd>
</dl>
<p>stored_hash = sysvar.recent_blockhashes[0]
success</p>
</dd>
<dt>WithdrawInstruction(to, lamports)</dt><dd><dl class="simple">
<dt>if state == Uninitialized</dt><dd><dl class="simple">
<dt>if !signers.contains(owner)</dt><dd><p>error MissingRequiredSignatures</p>
</dd>
</dl>
</dd>
<dt>elif state == Initialized</dt><dd><dl class="simple">
<dt>if !sysvar.recent_blockhashes.contains(stored_nonce)</dt><dd><p>error NotReady</p>
</dd>
<dt>if lamports != account.balance &amp;&amp; lamports + rent_exempt &gt; account.balance</dt><dd><p>error InsufficientFunds</p>
</dd>
</dl>
</dd>
</dl>
<p>account.balance -= lamports
to.balance += lamports
success</p>
</dd>
</dl>
<p><a href="#id5"><span class="problematic" id="id6">``</span></a><a href="#id7"><span class="problematic" id="id8">`</span></a></p>
<p>A client wishing to use this feature starts by creating a nonce account under
the system program. This account will be in the <cite>Uninitialized</cite> state with no
stored hash, and thus unusable.</p>
<p>To initialize a newly created account, an <cite>InitializeNonceAccount</cite> instruction must be
issued. This instruction takes one parameter, the <cite>Pubkey</cite> of the account’s
[authority](../offline-signing/durable-nonce.md#nonce-authority). Nonce accounts
must be [rent-exempt](rent.md#two-tiered-rent-regime) to meet the data-persistence
requirements of the feature, and as such, require that sufficient lamports be
deposited before they can be initialized. Upon successful initialization, the
cluster’s most recent blockhash is stored along with specified nonce authority
<cite>Pubkey</cite>.</p>
<p>The <cite>AdvanceNonceAccount</cite> instruction is used to manage the account’s stored nonce
value. It stores the cluster’s most recent blockhash in the account’s state data,
failing if that matches the value already stored there. This check prevents
replaying transactions within the same block.</p>
<p>Due to nonce accounts’ [rent-exempt](rent.md#two-tiered-rent-regime) requirement,
a custom withdraw instruction is used to move funds out of the account.
The <cite>WithdrawNonceAccount</cite> instruction takes a single argument, lamports to withdraw,
and enforces rent-exemption by preventing the account’s balance from falling
below the rent-exempt minimum. An exception to this check is if the final balance
would be zero lamports, which makes the account eligible for deletion. This
account closure detail has an additional requirement that the stored nonce value
must not match the cluster’s most recent blockhash, as per <cite>AdvanceNonceAccount</cite>.</p>
<p>The account’s [nonce authority](../offline-signing/durable-nonce.md#nonce-authority)
can be changed using the <cite>AuthorizeNonceAccount</cite> instruction. It takes one parameter,
the <cite>Pubkey</cite> of the new authority. Executing this instruction grants full
control over the account and its balance to the new authority.</p>
<p>&gt; <cite>AdvanceNonceAccount</cite>, <cite>WithdrawNonceAccount</cite> and <cite>AuthorizeNonceAccount</cite> all require the current [nonce authority](../offline-signing/durable-nonce.md#nonce-authority) for the account to sign the transaction.</p>
<p>### Runtime Support</p>
<p>The contract alone is not sufficient for implementing this feature. To enforce
an extant <cite>recent_blockhash</cite> on the transaction and prevent fee theft via
failed transaction replay, runtime modifications are necessary.</p>
<p>Any transaction failing the usual <cite>check_hash_age</cite> validation will be tested
for a Durable Transaction Nonce. This is signaled by including a <cite>AdvanceNonceAccount</cite>
instruction as the first instruction in the transaction.</p>
<p>If the runtime determines that a Durable Transaction Nonce is in use, it will
take the following additional actions to validate the transaction:</p>
<ol class="arabic simple">
<li><p>The <cite>NonceAccount</cite> specified in the <cite>Nonce</cite> instruction is loaded.</p></li>
<li><p>The <cite>NonceState</cite> is deserialized from the <cite>NonceAccount</cite>’s data field and
confirmed to be in the <cite>Initialized</cite> state.</p></li>
<li><p>The nonce value stored in the <cite>NonceAccount</cite> is tested to match against the
one specified in the transaction’s <cite>recent_blockhash</cite> field.</p></li>
</ol>
<p>If all three of the above checks succeed, the transaction is allowed to continue
validation.</p>
<p>Since transactions that fail with an <cite>InstructionError</cite> are charged a fee and
changes to their state rolled back, there is an opportunity for fee theft if an
<cite>AdvanceNonceAccount</cite> instruction is reverted. A malicious validator could replay the
failed transaction until the stored nonce is successfully advanced. Runtime
changes prevent this behavior. When a durable nonce transaction fails with an
<cite>InstructionError</cite> aside from the <cite>AdvanceNonceAccount</cite> instruction, the nonce account
is rolled back to its pre-execution state as usual. Then the runtime advances
its nonce value and the advanced nonce account stored as if it succeeded.</p>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../_sources/src/implemented-proposals/durable-tx-nonces.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>