<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>docs/src/implemented-proposals/commitment.md &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="docs-src-implemented-proposals-commitment-md">
<h1>docs/src/implemented-proposals/commitment.md<a class="headerlink" href="#docs-src-implemented-proposals-commitment-md" title="Permalink to this heading">¶</a></h1>
<p>Last edited: 2023-08-11 21:38:33</p>
<p>Contents:</p>
<div class="highlight-md notranslate"><div class="highlight"><pre><span></span>---
</pre></div>
</div>
<p>title: Commitment
—</p>
<p>The commitment metric aims to give clients a measure of the network confirmation
and stake levels on a particular block. Clients can then use this information to
derive their own [measures of commitment](../cluster/commitments.md).</p>
<p># Calculation RPC</p>
<p>Clients can request commitment metrics from a validator for a signature <cite>s</cite>
through <cite>get_block_commitment(s: Signature) -&gt; BlockCommitment</cite> over RPC. The
<cite>BlockCommitment</cite> struct contains an array of u64 <cite>[u64, MAX_CONFIRMATIONS]</cite>. This
array represents the commitment metric for the particular block <cite>N</cite> that
contains the signature <cite>s</cite> as of the last block <cite>M</cite> that the validator voted on.</p>
<p>An entry <cite>s</cite> at index <cite>i</cite> in the <cite>BlockCommitment</cite> array implies that the
validator observed <cite>s</cite> total stake in the cluster reaching <cite>i</cite> confirmations on
block <cite>N</cite> as observed in some block <cite>M</cite>. There will be <cite>MAX_CONFIRMATIONS</cite> elements in
this array, representing all the possible number of confirmations from 1 to
<cite>MAX_CONFIRMATIONS</cite>.</p>
<p># Computation of commitment metric</p>
<p>Building this <cite>BlockCommitment</cite> struct leverages the computations already being
performed for building consensus. The <cite>collect_vote_lockouts</cite> function in
<cite>consensus.rs</cite> builds a HashMap, where each entry is of the form <cite>(b, s)</cite>
where <cite>s</cite> is the amount of stake on a bank <cite>b</cite>.</p>
<p>This computation is performed on a votable candidate bank <cite>b</cite> as follows.</p>
<dl>
<dt><a href="#id1"><span class="problematic" id="id2">``</span></a><a href="#id3"><span class="problematic" id="id4">`</span></a>text</dt><dd><p>let output: HashMap&lt;b, Stake&gt; = HashMap::new();
for vote_account in b.vote_accounts {</p>
<blockquote>
<div><dl>
<dt>for v in vote_account.vote_stack {</dt><dd><dl class="simple">
<dt>for a in ancestors(v) {</dt><dd><p>f(<a href="#id5"><span class="problematic" id="id6">*</span></a>output.get_mut(a), vote_account, v);</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p><a href="#id7"><span class="problematic" id="id8">``</span></a><a href="#id9"><span class="problematic" id="id10">`</span></a></p>
<p>Where <cite>f</cite> is some accumulation function that modifies the <cite>Stake</cite> entry
for slot <cite>a</cite> with some data derivable from vote <cite>v</cite> and <cite>vote_account</cite>
(stake, lockout, etc.). Note here that the <cite>ancestors</cite> here only includes
slots that are present in the current status cache. Signatures for banks earlier
than those present in the status cache would not be queryable anyway, so those
banks are not included in the commitment calculations here.</p>
<p>Now we can naturally augment the above computation to also build a
<cite>BlockCommitment</cite> array for every bank <cite>b</cite> by:</p>
<ol class="arabic simple">
<li><p>Adding a <cite>ForkCommitmentCache</cite> to collect the <cite>BlockCommitment</cite> structs</p></li>
<li><p>Replacing <cite>f</cite> with <cite>f’</cite> such that the above computation also builds this
<cite>BlockCommitment</cite> for every bank <cite>b</cite>.</p></li>
</ol>
<p>We will proceed with the details of 2) as 1) is trivial.</p>
<p>Before continuing, it is noteworthy that for some validator’s vote account <cite>a</cite>,
the number of local confirmations for that validator on slot <cite>s</cite> is
<cite>v.num_confirmations</cite>, where <cite>v</cite> is the smallest vote in the stack of votes
<cite>a.votes</cite> such that <cite>v.slot &gt;= s</cite> (i.e. there is no need to look at any
votes &gt; v as the number of confirmations will be lower).</p>
<p>Now more specifically, we augment the above computation to:</p>
<dl>
<dt><a href="#id11"><span class="problematic" id="id12">``</span></a><a href="#id13"><span class="problematic" id="id14">`</span></a>text</dt><dd><p>let output: HashMap&lt;b, Stake&gt; = HashMap::new();
let fork_commitment_cache = ForkCommitmentCache::default();
for vote_account in b.vote_accounts {</p>
<blockquote>
<div><p>// vote stack is sorted from oldest vote to newest vote
for (v1, v2) in vote_account.vote_stack.windows(2) {</p>
<blockquote>
<div><dl class="simple">
<dt>for a in ancestors(v1).difference(ancestors(v2)) {</dt><dd><p>f’(<a href="#id15"><span class="problematic" id="id16">*</span></a>output.get_mut(a), <a href="#id17"><span class="problematic" id="id18">*</span></a>fork_commitment_cache.get_mut(a), vote_account, v);</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p><a href="#id19"><span class="problematic" id="id20">``</span></a><a href="#id21"><span class="problematic" id="id22">`</span></a></p>
<p>where <cite>f’</cite> is defined as:</p>
<dl>
<dt><a href="#id23"><span class="problematic" id="id24">``</span></a><a href="#id25"><span class="problematic" id="id26">`</span></a>text</dt><dd><dl class="simple">
<dt>fn f`(</dt><dd><p>stake: &amp;mut Stake,
some_ancestor: &amp;mut BlockCommitment,
vote_account: VoteAccount,
v: Vote, total_stake: u64</p>
</dd>
<dt>){</dt><dd><p>f(stake, vote_account, v);
<a href="#id27"><span class="problematic" id="id28">*</span></a>some_ancestor.commitment[v.num_confirmations] += vote_account.stake;</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p><a href="#id29"><span class="problematic" id="id30">``</span></a><a href="#id31"><span class="problematic" id="id32">`</span></a></p>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../_sources/src/implemented-proposals/commitment.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>