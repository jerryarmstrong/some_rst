<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>docs/src/implemented-proposals/repair-service.md &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="docs-src-implemented-proposals-repair-service-md">
<h1>docs/src/implemented-proposals/repair-service.md<a class="headerlink" href="#docs-src-implemented-proposals-repair-service-md" title="Permalink to this heading">¶</a></h1>
<p>Last edited: 2023-08-11 21:38:33</p>
<p>Contents:</p>
<div class="highlight-md notranslate"><div class="highlight"><pre><span></span>---
</pre></div>
</div>
<p>title: Repair Service
—</p>
<p>## Repair Service</p>
<p>The RepairService is in charge of retrieving missing shreds that failed to be
delivered by primary communication protocols like Turbine. It is in charge of
managing the protocols described below in the <cite>Repair Protocols</cite> section below.</p>
<p>## Challenges:</p>
<p>1) Validators can fail to receive particular shreds due to network failures</p>
<p>2) Consider a scenario where blockstore contains the set of slots {1, 3, 5}.
Then Blockstore receives shreds for some slot 7, where for each of the shreds
b, b.parent == 6, so then the parent-child relation 6 -&amp;gt; 7 is stored in
blockstore. However, there is no way to chain these slots to any of the
existing banks in Blockstore, and thus the <cite>Shred Repair</cite> protocol will not
repair these slots. If these slots happen to be part of the main chain, this
will halt replay progress on this node.</p>
<p>## Repair-related primitives</p>
<p>Epoch Slots:
Each validator advertises separately on gossip the various parts of an
<cite>Epoch Slots</cite>:</p>
<ul class="simple">
<li><p>The <cite>stash</cite>: An epoch-long compressed set of all completed slots.</p></li>
<li><p>The <cite>cache</cite>: The Run-length Encoding (RLE) of the latest <cite>N</cite> completed
slots starting from some some slot <cite>M</cite>, where <cite>N</cite> is the number of slots
that will fit in an MTU-sized packet.</p></li>
</ul>
<p><cite>Epoch Slots</cite> in gossip are updated every time a validator receives a
complete slot within the epoch. Completed slots are detected by blockstore
and sent over a channel to RepairService. It is important to note that we
know that by the time a slot <cite>X</cite> is complete, the epoch schedule must exist
for the epoch that contains slot <cite>X</cite> because WindowService will reject
shreds for unconfirmed epochs.</p>
<p>Every <cite>N/2</cite> completed slots, the oldest <cite>N/2</cite> slots are moved from the
<cite>cache</cite> into the <cite>stash</cite>. The base value <cite>M</cite> for the RLE should also
be updated.</p>
<p>## Repair Request Protocols</p>
<p>The repair protocol makes best attempts to progress the forking structure of
Blockstore.</p>
<p>The different protocol strategies to address the above challenges:</p>
<ol class="arabic">
<li><p>Shred Repair (Addresses Challenge #1): This is the most basic repair
protocol, with the purpose of detecting and filling “holes” in the ledger.
Blockstore tracks the latest root slot. RepairService will then periodically
iterate every fork in blockstore starting from the root slot, sending repair
requests to validators for any missing shreds. It will send at most some <cite>N</cite>
repair reqeusts per iteration. Shred repair should prioritize repairing
forks based on the leader’s fork weight. Validators should only send repair
requests to validators who have marked that slot as completed in their
EpochSlots. Validators should prioritize repairing shreds in each slot
that they are responsible for retransmitting through turbine. Validators can
compute which shreds they are responsible for retransmitting because the
seed for turbine is based on leader id, slot, and shred index.</p>
<p>Note: Validators will only accept shreds within the current verifiable
epoch (epoch the validator has a leader schedule for).</p>
</li>
<li><p>Preemptive Slot Repair (Addresses Challenge #2): The goal of this
protocol is to discover the chaining relationship of “orphan” slots that do not
currently chain to any known fork. Shred repair should prioritize repairing
orphan slots based on the leader’s fork weight.</p>
<ul>
<li><p>Blockstore will track the set of “orphan” slots in a separate column family.</p></li>
<li><p>RepairService will periodically make <cite>Orphan</cite> requests for each of
the orphans in blockstore.</p>
<p><cite>Orphan(orphan)</cite> request - <cite>orphan</cite> is the orphan slot that the
requestor wants to know the parents of <cite>Orphan(orphan)</cite> response -
The highest shreds for each of the first <cite>N</cite> parents of the requested
<cite>orphan</cite></p>
<p>On receiving the responses <cite>p</cite>, where <cite>p</cite> is some shred in a parent slot,
validators will:</p>
<ul class="simple">
<li><p>Insert an empty <cite>SlotMeta</cite> in blockstore for <cite>p.slot</cite> if it doesn’t
already exist.</p></li>
<li><p>If <cite>p.slot</cite> does exist, update the parent of <cite>p</cite> based on <cite>parents</cite></p></li>
</ul>
<p>Note: that once these empty slots are added to blockstore, the
<cite>Shred Repair</cite> protocol should attempt to fill those slots.</p>
<p>Note: Validators will only accept responses containing shreds within the
current verifiable epoch (epoch the validator has a leader schedule
for).</p>
</li>
</ul>
</li>
</ol>
<p>Validators should try to send orphan requests to validators who have marked that
orphan as completed in their EpochSlots. If no such validators exist, then
randomly select a validator in a stake-weighted fashion.</p>
<p>## Repair Response Protocol</p>
<p>When a validator receives a request for a shred <cite>S</cite>, they respond with the
shred if they have it.</p>
<p>When a validator receives a shred through a repair response, they check
<cite>EpochSlots</cite> to see if &lt;= <cite>1/3</cite> of the network has marked this slot as
completed. If so, they resubmit this shred through its associated turbine
path, but only if this validator has not retransmitted this shred before.</p>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../_sources/src/implemented-proposals/repair-service.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>