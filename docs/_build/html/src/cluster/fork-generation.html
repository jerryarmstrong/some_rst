<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>docs/src/cluster/fork-generation.md &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="docs-src-cluster-fork-generation-md">
<h1>docs/src/cluster/fork-generation.md<a class="headerlink" href="#docs-src-cluster-fork-generation-md" title="Permalink to this heading">¶</a></h1>
<p>Last edited: 2023-08-11 21:38:33</p>
<p>Contents:</p>
<div class="highlight-md notranslate"><div class="highlight"><pre><span></span>---
</pre></div>
</div>
<p>title: Fork Generation
description: “A fork is created when validators do not agree on a newly produced block. Using a consensus algorithm validators vote on which will be finalized.”
—</p>
<p>The Solana protocol doesn’t wait for all validators to agree on a newly produced block before the next block is produced. Because of that, it’s quite common for two different blocks to be chained to the same parent block. In those situations, we call each conflicting chain a [“fork.”](./fork-generation.md)</p>
<p>Solana validators need to vote on one of these forks and reach agreement on which one to use through a consensus algorithm (that is beyond the scope of this article). The main point you need to remember is that when there are competing forks, only one fork will be finalized by the cluster and the abandoned blocks in competing forks are all discarded.</p>
<p>This section describes how forks naturally occur as a consequence of [leader rotation](./leader-rotation.md).</p>
<p>## Overview</p>
<p>Nodes take turns being [leader](./../terminology.md#leader) and generating the PoH that encodes state changes. The cluster can tolerate loss of connection to any leader by synthesizing what the leader _**would**_ have generated had it been connected but not ingesting any state changes.</p>
<p>The possible number of forks is thereby limited to a “there/not-there” skip list of forks that may arise on leader rotation slot boundaries. At any given slot, only a single leader’s transactions will be accepted.</p>
<p>### Forking example</p>
<p>The table below illustrates what competing forks could look like. Time progresses from left to right and each slot is assigned to a validator that temporarily becomes the cluster “leader” and may produce a block for that slot.</p>
<p>In this example, the leader for slot 3 chose to chain its “Block 3” directly to “Block 1” and in doing so skipped “Block 2”. Similarly, the leader for slot 5 chose to chain “Block 5” directly to “Block 3” and skipped “Block 4”.</p>
<p>&gt; Note that across different forks, the block produced for a given slot is _always_ the same because producing two different blocks for the same slot is a slashable offense. So the conflicting forks above can be distinguished from each other by which slots they have _skipped_.</p>
<div class="line-block">
<div class="line-block">
<div class="line">| Slot 1  | Slot 2  | Slot 3  | Slot 4  | Slot 5  |</div>
</div>
<div class="line">—— | ——- | ——- | ——- | ——- | ——- |</div>
<div class="line">Fork 1 | Block 1 |         | Block 3 |         | Block 5 |</div>
<div class="line">Fork 2 | Block 1 |         | Block 3 | Block 4 |         |</div>
<div class="line">Fork 3 | Block 1 | Block 2 |         |         |         |</div>
</div>
<p>## Message Flow</p>
<ol class="arabic simple">
<li><p>Transactions are ingested by the current leader.</p></li>
<li><p>Leader filters valid transactions.</p></li>
<li><p>Leader executes valid transactions updating its state.</p></li>
<li><p>Leader packages transactions into entries based off its current PoH slot.</p></li>
<li><p>Leader transmits the entries to validator nodes (in signed shreds)
1. The PoH stream includes ticks; empty entries that indicate liveness of the leader and the passage of time on the cluster.
2. A leader’s stream begins with the tick entries necessary to complete PoH back to the leader’s most recently observed prior leader slot.</p></li>
<li><p>Validators retransmit entries to peers in their set and to further downstream nodes.</p></li>
<li><p>Validators validate the transactions and execute them on their state.</p></li>
<li><p>Validators compute the hash of the state.</p></li>
<li><p>At specific times, i.e. specific PoH tick counts, validators transmit votes to the leader.
1. Votes are signatures of the hash of the computed state at that PoH tick count.
2. Votes are also propagated via gossip.</p></li>
<li><p>Leader executes the votes, the same as any other transaction, and broadcasts them to the cluster.</p></li>
<li><p>Validators observe their votes and all the votes from the cluster.</p></li>
</ol>
<p>## Partitions, Forks</p>
<p>Forks can arise at PoH tick counts that correspond to a vote. The next leader may not have observed the last vote slot and may start their slot with generated virtual PoH entries. These empty ticks are generated by all nodes in the cluster at a cluster-configured rate for hashes/per/tick <cite>Z</cite>.</p>
<p>There are only two possible versions of the PoH during a voting slot: PoH with <cite>T</cite> ticks and entries generated by the current leader, or PoH with just ticks. The “just ticks” version of the PoH can be thought of as a virtual ledger, one that all nodes in the cluster can derive from the last tick in the previous slot.</p>
<p>Validators can ignore forks at other points (e.g. from the wrong leader), or slash the leader responsible for the fork.</p>
<p>Validators vote based on a greedy choice to maximize their reward described in [Tower BFT](../implemented-proposals/tower-bft.md).</p>
<p>### Validator’s View</p>
<p>#### Time Progression</p>
<p>The diagram below represents a validator’s view of the PoH stream with possible forks over time. L1, L2, etc. are leader slots, and <a href="#id1"><span class="problematic" id="id2">`</span></a>E`s represent entries from that leader during that leader’s slot. The <a href="#id3"><span class="problematic" id="id4">`</span></a>x`s represent ticks only, and time flows downwards in the diagram.</p>
<p>![Fork generation](/img/fork-generation.svg)</p>
<p>Note that an <cite>E</cite> appearing on 2 forks at the same slot is a slashable condition, so a validator observing <cite>E3</cite> and <cite>E3’</cite> can slash L3 and safely choose <cite>x</cite> for that slot. Once a validator commits to a fork, other forks can be discarded below that tick count. For any slot, validators need only consider a single “has entries” chain or a “ticks only” chain to be proposed by a leader. But multiple virtual entries may overlap as they link back to the a previous slot.</p>
<p>#### Time Division</p>
<p>It’s useful to consider leader rotation over PoH tick count as time division of the job of encoding state for the cluster. The following table presents the above tree of forks as a time-divided ledger.</p>
<div class="line-block">
<div class="line">leader slot      | L1  | L2  | L3  | L4  | L5  |</div>
<div class="line">:————— | :– | :– | :– | :– | :– |</div>
<div class="line">data             | E1  | E2  | E3  | E4  | E5  |</div>
<div class="line">ticks since prev |     |     |     | x   | xx  |</div>
</div>
<p>Note that only data from leader L3 will be accepted during leader slot L3. Data from L3 may include “catchup” ticks back to a slot other than L2 if L3 did not observe L2’s data. L4 and L5’s transmissions include the “ticks to prev” PoH entries.</p>
<p>This arrangement of the network data streams permits nodes to save exactly this to the ledger for replay, restart, and checkpoints.</p>
<p>### Leader’s View</p>
<p>When a new leader begins a slot, it must first transmit any PoH (ticks) required to link the new slot with the most recently observed and voted slot. The fork the leader proposes would link the current slot to a previous fork that the leader has voted on with virtual ticks.</p>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../_sources/src/cluster/fork-generation.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>