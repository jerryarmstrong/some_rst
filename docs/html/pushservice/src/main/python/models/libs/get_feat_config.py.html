<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../" id="documentation_options" src="../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>import os</p>
<p>from twitter.deepbird.projects.magic_recs.libs.metric_fn_utils import USER_AGE_FEATURE_NAME
from twitter.deepbird.projects.magic_recs.libs.model_utils import read_config
from twml.contrib import feature_config as contrib_feature_config</p>
<p># checkstyle: noqa</p>
<p>FEAT_CONFIG_DEFAULT_VAL = -1.23456789</p>
<p>DEFAULT_INPUT_SIZE_BITS = 18</p>
<p>DEFAULT_FEATURE_LIST_PATH = “./feature_list_default.yaml”
FEATURE_LIST_DEFAULT_PATH = os.path.join(</p>
<blockquote>
<div><p>os.path.dirname(os.path.realpath(__file__)), DEFAULT_FEATURE_LIST_PATH</p>
</div></blockquote>
<p>)</p>
<p>DEFAULT_FEATURE_LIST_LIGHT_RANKING_PATH = “./feature_list_light_ranking.yaml”
FEATURE_LIST_DEFAULT_LIGHT_RANKING_PATH = os.path.join(</p>
<blockquote>
<div><p>os.path.dirname(os.path.realpath(__file__)), DEFAULT_FEATURE_LIST_LIGHT_RANKING_PATH</p>
</div></blockquote>
<p>)</p>
<p>FEATURE_LIST_DEFAULT = read_config(FEATURE_LIST_DEFAULT_PATH).items()
FEATURE_LIST_LIGHT_RANKING_DEFAULT = read_config(FEATURE_LIST_DEFAULT_LIGHT_RANKING_PATH).items()</p>
<p>LABELS = [“label”]
LABELS_MTL = {“OONC”: [“label”], “OONC_Engagement”: [“label”, “label.engagement”]}
LABELS_LR = {</p>
<blockquote>
<div><p>“Sent”: [“label.sent”],
“HeavyRankPosition”: [“meta.ranking.is_top3”],
“HeavyRankProbability”: [“meta.ranking.weighted_oonc_model_score”],</p>
</div></blockquote>
<p>}</p>
<dl>
<dt>def _get_new_feature_config_base(</dt><dd><p>data_spec_path,
labels,
add_sparse_continous=True,
add_gbdt=True,
add_user_id=False,
add_timestamp=False,
add_user_age=False,
feature_list_provided=[],
opt=None,
run_light_ranking_group_metrics_in_bq=False,</p>
</dd>
<dt>):</dt><dd><p>“””
Getter of the feature config based on specification.</p>
<dl>
<dt>Args:</dt><dd><dl class="simple">
<dt>data_spec_path: A string indicating the path of the data_spec.json file, which could be</dt><dd><p>either a local path or a hdfs path.</p>
</dd>
</dl>
<p>labels: A list of strings indicating the name of the label in the data spec.
add_sparse_continous: A bool indicating if sparse_continuous feature needs to be included.
add_gbdt: A bool indicating if gbdt feature needs to be included.
add_user_id: A bool indicating if user_id feature needs to be included.
add_timestamp: A bool indicating if timestamp feature needs to be included. This will be useful</p>
<blockquote>
<div><p>for sequential models and meta learning models.</p>
</div></blockquote>
<p>add_user_age: A bool indicating if the user age feature needs to be included.
feature_list_provided: A list of features thats need to be included. If not specified, will use</p>
<blockquote>
<div><p>FEATURE_LIST_DEFAULT by default.</p>
</div></blockquote>
<p>opt: A namespace of arguments indicating the hyparameters.
run_light_ranking_group_metrics_in_bq: A bool indicating if heavy ranker score info needs to be included to compute group metrics in BigQuery.</p>
</dd>
<dt>Returns:</dt><dd><p>A twml feature config object.</p>
</dd>
</dl>
<p>“””</p>
<p>input_size_bits = DEFAULT_INPUT_SIZE_BITS if opt is None else opt.input_size_bits</p>
<p>feature_list = feature_list_provided if feature_list_provided != [] else FEATURE_LIST_DEFAULT
a_string_feat_list = [f[0] for f in feature_list if f[1] != “S”]</p>
<p>builder = contrib_feature_config.FeatureConfigBuilder(data_spec_path=data_spec_path)</p>
<dl class="simple">
<dt>builder = builder.extract_feature_group(</dt><dd><p>feature_regexes=a_string_feat_list,
group_name=”continuous”,
default_value=FEAT_CONFIG_DEFAULT_VAL,
type_filter=[“CONTINUOUS”],</p>
</dd>
</dl>
<p>)</p>
<dl class="simple">
<dt>builder = builder.extract_features_as_hashed_sparse(</dt><dd><p>feature_regexes=a_string_feat_list,
output_tensor_name=”sparse_no_continuous”,
hash_space_size_bits=input_size_bits,
type_filter=[“BINARY”, “DISCRETE”, “STRING”, “SPARSE_BINARY”],</p>
</dd>
</dl>
<p>)</p>
<dl>
<dt>if add_gbdt:</dt><dd><dl class="simple">
<dt>builder = builder.extract_features_as_hashed_sparse(</dt><dd><p>feature_regexes=[“ads..*”],
output_tensor_name=”gbdt_sparse”,
hash_space_size_bits=input_size_bits,</p>
</dd>
</dl>
<p>)</p>
</dd>
<dt>if add_sparse_continous:</dt><dd><p>s_string_feat_list = [f[0] for f in feature_list if f[1] == “S”]</p>
<dl class="simple">
<dt>builder = builder.extract_features_as_hashed_sparse(</dt><dd><p>feature_regexes=s_string_feat_list,
output_tensor_name=”sparse_continuous”,
hash_space_size_bits=input_size_bits,
type_filter=[“SPARSE_CONTINUOUS”],</p>
</dd>
</dl>
<p>)</p>
</dd>
<dt>if add_user_id:</dt><dd><p>builder = builder.extract_feature(“meta.user_id”)</p>
</dd>
<dt>if add_timestamp:</dt><dd><p>builder = builder.extract_feature(“meta.timestamp”)</p>
</dd>
<dt>if add_user_age:</dt><dd><p>builder = builder.extract_feature(USER_AGE_FEATURE_NAME)</p>
</dd>
<dt>if run_light_ranking_group_metrics_in_bq:</dt><dd><p>builder = builder.extract_feature(“meta.trace_id”)
builder = builder.extract_feature(“meta.ranking.weighted_oonc_model_score”)</p>
</dd>
</dl>
<p>builder = builder.add_labels(labels).define_weight(“meta.weight”)</p>
<p>return builder.build()</p>
</dd>
<dt>def get_feature_config_with_sparse_continuous(</dt><dd><p>data_spec_path,
feature_list_provided=[],
opt=None,
add_user_id=False,
add_timestamp=False,
add_user_age=False,</p>
</dd>
<dt>):</dt><dd><p>task_name = opt.task_name if getattr(opt, “task_name”, None) is not None else “OONC”
if task_name not in LABELS_MTL:</p>
<blockquote>
<div><p>raise ValueError(“Invalid Task Name !”)</p>
</div></blockquote>
<dl class="simple">
<dt>return _get_new_feature_config_base(</dt><dd><p>data_spec_path=data_spec_path,
labels=LABELS_MTL[task_name],
add_sparse_continous=True,
add_user_id=add_user_id,
add_timestamp=add_timestamp,
add_user_age=add_user_age,
feature_list_provided=feature_list_provided,
opt=opt,</p>
</dd>
</dl>
<p>)</p>
</dd>
<dt>def get_feature_config_light_ranking(</dt><dd><p>data_spec_path,
feature_list_provided=[],
opt=None,
add_user_id=True,
add_timestamp=False,
add_user_age=False,
add_gbdt=False,
run_light_ranking_group_metrics_in_bq=False,</p>
</dd>
<dt>):</dt><dd><p>task_name = opt.task_name if getattr(opt, “task_name”, None) is not None else “HeavyRankPosition”
if task_name not in LABELS_LR:</p>
<blockquote>
<div><p>raise ValueError(“Invalid Task Name !”)</p>
</div></blockquote>
<dl class="simple">
<dt>if not feature_list_provided:</dt><dd><p>feature_list_provided = FEATURE_LIST_LIGHT_RANKING_DEFAULT</p>
</dd>
<dt>return _get_new_feature_config_base(</dt><dd><p>data_spec_path=data_spec_path,
labels=LABELS_LR[task_name],
add_sparse_continous=False,
add_gbdt=add_gbdt,
add_user_id=add_user_id,
add_timestamp=add_timestamp,
add_user_age=add_user_age,
feature_list_provided=feature_list_provided,
opt=opt,
run_light_ranking_group_metrics_in_bq=run_light_ranking_group_metrics_in_bq,</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../index.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../_sources/pushservice/src/main/python/models/libs/get_feat_config.py.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>