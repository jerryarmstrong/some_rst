<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../../" id="documentation_options" src="../../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>package com.twitter.search.earlybird_root.mergers;</p>
<p>import java.util.ArrayList;
import java.util.EnumMap;
import java.util.List;
import java.util.Map;</p>
<p>import com.google.common.annotations.VisibleForTesting;
import com.google.common.base.Preconditions;
import com.google.common.collect.Maps;</p>
<p>import com.twitter.search.common.metrics.SearchCounter;
import com.twitter.search.common.util.earlybird.ResponseMergerUtils;
import com.twitter.search.earlybird.thrift.EarlybirdRequest;
import com.twitter.search.earlybird.thrift.EarlybirdResponse;
import com.twitter.search.earlybird.thrift.EarlybirdResponseCode;
import com.twitter.search.earlybird.thrift.ThriftSearchResults;
import com.twitter.search.earlybird_root.common.EarlybirdRequestType;</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Accumulates EarlybirdResponse’s and determines when to early terminate.</p></li>
</ul>
<p><a href="#id1"><span class="problematic" id="id2">*</span></a>/</p>
</dd>
</dl>
<p>public abstract class ResponseAccumulator {</p>
<blockquote>
<div><blockquote>
<div><p>&#64;VisibleForTesting
static class MinMaxSearchedIdStats {</p>
<blockquote>
<div><p>/** How many results did we actually check <a href="#id3"><span class="problematic" id="id4">*</span></a>/
private final SearchCounter checkedMaxMinSearchedStatusId;
private final SearchCounter unsetMaxSearchedStatusId;
private final SearchCounter unsetMinSearchedStatusId;
private final SearchCounter unsetMaxAndMinSearchedStatusId;
private final SearchCounter sameMinMaxSearchedIdWithoutResults;
private final SearchCounter sameMinMaxSearchedIdWithOneResult;
private final SearchCounter sameMinMaxSearchedIdWithResults;
private final SearchCounter flippedMinMaxSearchedId;</p>
<dl>
<dt>MinMaxSearchedIdStats(EarlybirdRequestType requestType) {</dt><dd><p>String statPrefix = “<a href="#id25"><span class="problematic" id="id26">merge_helper_</span></a>” + requestType.getNormalizedName();</p>
<dl class="simple">
<dt>checkedMaxMinSearchedStatusId = SearchCounter.export(statPrefix</dt><dd><ul class="simple">
<li><p>“_max_min_searched_id_checks”);</p></li>
</ul>
</dd>
<dt>unsetMaxSearchedStatusId = SearchCounter.export(statPrefix</dt><dd><ul class="simple">
<li><p>“_unset_max_searched_status_id”);</p></li>
</ul>
</dd>
<dt>unsetMinSearchedStatusId = SearchCounter.export(statPrefix</dt><dd><ul class="simple">
<li><p>“_unset_min_searched_status_id”);</p></li>
</ul>
</dd>
<dt>unsetMaxAndMinSearchedStatusId = SearchCounter.export(statPrefix</dt><dd><ul class="simple">
<li><p>“_unset_max_and_min_searched_status_id”);</p></li>
</ul>
</dd>
<dt>sameMinMaxSearchedIdWithoutResults = SearchCounter.export(statPrefix</dt><dd><ul class="simple">
<li><p>“_same_min_max_searched_id_without_results”);</p></li>
</ul>
</dd>
<dt>sameMinMaxSearchedIdWithOneResult = SearchCounter.export(statPrefix</dt><dd><ul class="simple">
<li><p>“_same_min_max_searched_id_with_one_results”);</p></li>
</ul>
</dd>
<dt>sameMinMaxSearchedIdWithResults = SearchCounter.export(statPrefix</dt><dd><ul class="simple">
<li><p>“_same_min_max_searched_id_with_results”);</p></li>
</ul>
</dd>
<dt>flippedMinMaxSearchedId = SearchCounter.export(statPrefix</dt><dd><ul class="simple">
<li><p>“_flipped_min_max_searched_id”);</p></li>
</ul>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<p>&#64;VisibleForTesting
SearchCounter getCheckedMaxMinSearchedStatusId() {</p>
<blockquote>
<div><p>return checkedMaxMinSearchedStatusId;</p>
</div></blockquote>
<p>}</p>
<p>&#64;VisibleForTesting
SearchCounter getFlippedMinMaxSearchedId() {</p>
<blockquote>
<div><p>return flippedMinMaxSearchedId;</p>
</div></blockquote>
<p>}</p>
<p>&#64;VisibleForTesting
SearchCounter getUnsetMaxSearchedStatusId() {</p>
<blockquote>
<div><p>return unsetMaxSearchedStatusId;</p>
</div></blockquote>
<p>}</p>
<p>&#64;VisibleForTesting
SearchCounter getUnsetMinSearchedStatusId() {</p>
<blockquote>
<div><p>return unsetMinSearchedStatusId;</p>
</div></blockquote>
<p>}</p>
<p>&#64;VisibleForTesting
SearchCounter getUnsetMaxAndMinSearchedStatusId() {</p>
<blockquote>
<div><p>return unsetMaxAndMinSearchedStatusId;</p>
</div></blockquote>
<p>}</p>
<p>&#64;VisibleForTesting
SearchCounter getSameMinMaxSearchedIdWithoutResults() {</p>
<blockquote>
<div><p>return sameMinMaxSearchedIdWithoutResults;</p>
</div></blockquote>
<p>}</p>
<p>&#64;VisibleForTesting
SearchCounter getSameMinMaxSearchedIdWithOneResult() {</p>
<blockquote>
<div><p>return sameMinMaxSearchedIdWithOneResult;</p>
</div></blockquote>
<p>}</p>
<p>&#64;VisibleForTesting
SearchCounter getSameMinMaxSearchedIdWithResults() {</p>
<blockquote>
<div><p>return sameMinMaxSearchedIdWithResults;</p>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>}</p>
<p>&#64;VisibleForTesting
static final Map&lt;EarlybirdRequestType, MinMaxSearchedIdStats&gt; MIN_MAX_SEARCHED_ID_STATS_MAP;
static {</p>
<blockquote>
<div><dl class="simple">
<dt>EnumMap&lt;EarlybirdRequestType, MinMaxSearchedIdStats&gt; statsMap</dt><dd><p>= Maps.newEnumMap(EarlybirdRequestType.class);</p>
</dd>
<dt>for (EarlybirdRequestType earlybirdRequestType<span class="classifier">EarlybirdRequestType.values()) {</span></dt><dd><p>statsMap.put(earlybirdRequestType, new MinMaxSearchedIdStats(earlybirdRequestType));</p>
</dd>
</dl>
<p>}</p>
<p>MIN_MAX_SEARCHED_ID_STATS_MAP = Maps.immutableEnumMap(statsMap);</p>
</div></blockquote>
<p>}</p>
<p>// Merge has encountered at least one early terminated response.
private boolean foundEarlyTermination = false;
// Empty but successful response counter (E.g. when a tier or partition is skipped)
private int successfulEmptyResponseCount = 0;
// The list of the successful responses from all earlybird futures. This does not include empty
// responses resulted from null requests.
private final List&lt;EarlybirdResponse&gt; successResponses = new ArrayList&lt;&gt;();
// The list of the error responses from all earlybird futures.
private final List&lt;EarlybirdResponse&gt; errorResponses = new ArrayList&lt;&gt;();
// the list of max statusIds seen in each earlybird.
private final List&lt;Long&gt; maxIds = new ArrayList&lt;&gt;();
// the list of min statusIds seen in each earlybird.
private final List&lt;Long&gt; minIds = new ArrayList&lt;&gt;();</p>
<p>private int numResponses = 0;</p>
<p>private int numResultsAccumulated = 0;
private int numSearchedSegments = 0;</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Returns a string that can be used for logging to identify a single response out of all the</p></li>
<li><p>responses that are being merged.</p></li>
<li></li>
<li><p>&#64;param responseIndex the index of a response’s partition or tier, depending on the type of</p></li>
<li><p>responses being accumulated.</p></li>
<li><p>&#64;param numTotalResponses the total number of partitions or tiers that are being merged.</p></li>
</ul>
<p><a href="#id5"><span class="problematic" id="id6">*</span></a>/</p>
</dd>
</dl>
<p>public abstract String getNameForLogging(int responseIndex, int numTotalResponses);</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Returns a string that is used to export per-EarlybirdResponseCode stats for partitions and tiers.</p></li>
<li></li>
<li><p>&#64;param responseIndex the index of of a response’s partition or tier.</p></li>
<li><p>&#64;param numTotalResponses the total number of partitions or tiers that are being merged.</p></li>
<li><p>&#64;return a string that is used to export per-EarlybirdResponseCode stats for partitions and tiers.</p></li>
</ul>
<p><a href="#id7"><span class="problematic" id="id8">*</span></a>/</p>
</dd>
<dt>public abstract String getNameForEarlybirdResponseCodeStats(</dt><dd><p>int responseIndex, int numTotalResponses);</p>
</dd>
</dl>
<p>abstract boolean shouldEarlyTerminateMerge(EarlyTerminateTierMergePredicate merger);</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Add a EarlybirdResponse</p></li>
</ul>
<p><a href="#id9"><span class="problematic" id="id10">*</span></a>/</p>
</dd>
<dt>public void addResponse(EarlybirdResponseDebugMessageBuilder responseMessageBuilder,</dt><dd><blockquote>
<div><p>EarlybirdRequest request,
EarlybirdResponse response) {</p>
</div></blockquote>
<p>numResponses++;
numSearchedSegments += response.getNumSearchedSegments();</p>
<dl class="simple">
<dt>if (isSkippedResponse(response)) {</dt><dd><p>// This is an empty response, no processing is required, just need to update statistics.
successfulEmptyResponseCount++;
handleSkippedResponse(response.getResponseCode());</p>
</dd>
<dt>} else if (isErrorResponse(response)) {</dt><dd><p>errorResponses.add(response);
handleErrorResponse(response);</p>
</dd>
<dt>} else {</dt><dd><p>handleSuccessfulResponse(responseMessageBuilder, request, response);</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>private boolean isErrorResponse(EarlybirdResponse response) {</dt><dd><dl class="simple">
<dt>return !response.isSetResponseCode()</dt><dd><p>|| response.getResponseCode() != EarlybirdResponseCode.SUCCESS;</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>private boolean isSkippedResponse(EarlybirdResponse response) {</dt><dd><dl class="simple">
<dt>return response.isSetResponseCode()</dt><dd><p>&amp;&amp; (response.getResponseCode() == EarlybirdResponseCode.PARTITION_SKIPPED
|| response.getResponseCode() == EarlybirdResponseCode.TIER_SKIPPED);</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Record a response corresponding to a skipped partition or skipped tier.</p></li>
</ul>
<p><a href="#id11"><span class="problematic" id="id12">*</span></a>/</p>
</dd>
</dl>
<p>protected abstract void handleSkippedResponse(EarlybirdResponseCode responseCode);</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Handle an error response</p></li>
</ul>
<p><a href="#id13"><span class="problematic" id="id14">*</span></a>/</p>
</dd>
</dl>
<p>protected abstract void handleErrorResponse(EarlybirdResponse response);</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Subclasses can override this to perform more successful response handling.</p></li>
</ul>
<p><a href="#id15"><span class="problematic" id="id16">*</span></a>/</p>
</dd>
</dl>
<p>protected void extraSuccessfulResponseHandler(EarlybirdResponse response) { }</p>
</div></blockquote>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Whether the helper is for merging results from partitions within a single tier.</p></li>
</ul>
<p><a href="#id17"><span class="problematic" id="id18">*</span></a>/
protected final boolean isMergingPartitionsWithinATier() {</p>
<blockquote>
<div><p>return !isMergingAcrossTiers();</p>
</div></blockquote>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Whether the helper is for merging results across different tiers.</p></li>
</ul>
<p><a href="#id19"><span class="problematic" id="id20">*</span></a>/</p>
</dd>
</dl>
<p>protected abstract boolean isMergingAcrossTiers();</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Record a successful response.</p></li>
</ul>
<p><a href="#id21"><span class="problematic" id="id22">*</span></a>/</p>
</dd>
<dt>public final void handleSuccessfulResponse(</dt><dd><blockquote>
<div><p>EarlybirdResponseDebugMessageBuilder responseMessageBuilder,
EarlybirdRequest request,
EarlybirdResponse response) {</p>
</div></blockquote>
<p>successResponses.add(response);
if (response.isSetSearchResults()) {</p>
<blockquote>
<div><p>ThriftSearchResults searchResults = response.getSearchResults();
numResultsAccumulated += searchResults.getResultsSize();</p>
<dl class="simple">
<dt>recordMinMaxSearchedIdsAndUpdateStats(responseMessageBuilder, request, response,</dt><dd><p>searchResults);</p>
</dd>
</dl>
</div></blockquote>
<p>}
if (response.isSetEarlyTerminationInfo()</p>
<blockquote>
<div><blockquote>
<div><p>&amp;&amp; response.getEarlyTerminationInfo().isEarlyTerminated()) {</p>
</div></blockquote>
<p>foundEarlyTermination = true;</p>
</div></blockquote>
<p>}
extraSuccessfulResponseHandler(response);</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private void recordMinMaxSearchedIdsAndUpdateStats(</dt><dd><blockquote>
<div><p>EarlybirdResponseDebugMessageBuilder responseMessageBuidler,
EarlybirdRequest request,
EarlybirdResponse response,
ThriftSearchResults searchResults) {</p>
</div></blockquote>
<p>boolean isMaxIdSet = searchResults.isSetMaxSearchedStatusID();
boolean isMinIdSet = searchResults.isSetMinSearchedStatusID();</p>
<dl class="simple">
<dt>if (isMaxIdSet) {</dt><dd><p>maxIds.add(searchResults.getMaxSearchedStatusID());</p>
</dd>
</dl>
<p>}
if (isMinIdSet) {</p>
<blockquote>
<div><p>minIds.add(searchResults.getMinSearchedStatusID());</p>
</div></blockquote>
<p>}</p>
<dl class="simple">
<dt>updateMinMaxIdStats(responseMessageBuidler, request, response, searchResults, isMaxIdSet,</dt><dd><p>isMinIdSet);</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private void updateMinMaxIdStats(</dt><dd><blockquote>
<div><p>EarlybirdResponseDebugMessageBuilder responseMessageBuilder,
EarlybirdRequest request,
EarlybirdResponse response,
ThriftSearchResults searchResults,
boolean isMaxIdSet,
boolean isMinIdSet) {</p>
</div></blockquote>
<p>// Now just track the stats.
EarlybirdRequestType requestType = EarlybirdRequestType.of(request);
MinMaxSearchedIdStats minMaxSearchedIdStats = MIN_MAX_SEARCHED_ID_STATS_MAP.get(requestType);</p>
<p>minMaxSearchedIdStats.checkedMaxMinSearchedStatusId.increment();
if (isMaxIdSet &amp;&amp; isMinIdSet) {</p>
<blockquote>
<div><dl>
<dt>if (searchResults.getMinSearchedStatusID() &gt; searchResults.getMaxSearchedStatusID()) {</dt><dd><p>// We do not expect this case to happen in production.
minMaxSearchedIdStats.flippedMinMaxSearchedId.increment();</p>
</dd>
<dt>} else if (searchResults.getResultsSize() == 0</dt><dd><blockquote>
<div><p>&amp;&amp; searchResults.getMaxSearchedStatusID() == searchResults.getMinSearchedStatusID()) {</p>
</div></blockquote>
<p>minMaxSearchedIdStats.sameMinMaxSearchedIdWithoutResults.increment();
responseMessageBuilder.debugVerbose(</p>
<blockquote>
<div><p>“Got no results, and same min/max searched ids. Request: %s, Response: %s”,
request, response);</p>
</div></blockquote>
</dd>
<dt>} else if (searchResults.getResultsSize() == 1</dt><dd><blockquote>
<div><p>&amp;&amp; searchResults.getMaxSearchedStatusID() == searchResults.getMinSearchedStatusID()) {</p>
</div></blockquote>
<p>minMaxSearchedIdStats.sameMinMaxSearchedIdWithOneResult.increment();
responseMessageBuilder.debugVerbose(</p>
<blockquote>
<div><p>“Got one results, and same min/max searched ids. Request: %s, Response: %s”,
request, response);</p>
</div></blockquote>
</dd>
<dt>} else if (searchResults.getMaxSearchedStatusID()</dt><dd><blockquote>
<div><p>== searchResults.getMinSearchedStatusID()) {</p>
</div></blockquote>
<p>minMaxSearchedIdStats.sameMinMaxSearchedIdWithResults.increment();
responseMessageBuilder.debugVerbose(</p>
<blockquote>
<div><p>“Got multiple results, and same min/max searched ids. Request: %s, Response: %s”,
request, response);</p>
</div></blockquote>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<dl>
<dt>} else if (!isMaxIdSet &amp;&amp; isMinIdSet) {</dt><dd><p>// We do not expect this case to happen in production.
minMaxSearchedIdStats.unsetMaxSearchedStatusId.increment();
responseMessageBuilder.debugVerbose(</p>
<blockquote>
<div><p>“Got unset maxSearchedStatusID. Request: %s, Response: %s”, request, response);</p>
</div></blockquote>
</dd>
<dt>} else if (isMaxIdSet &amp;&amp; !isMinIdSet) {</dt><dd><p>// We do not expect this case to happen in production.
minMaxSearchedIdStats.unsetMinSearchedStatusId.increment();
responseMessageBuilder.debugVerbose(</p>
<blockquote>
<div><p>“Got unset minSearchedStatusID. Request: %s, Response: %s”, request, response);</p>
</div></blockquote>
</dd>
<dt>} else {</dt><dd><p>Preconditions.checkState(!isMaxIdSet &amp;&amp; !isMinIdSet);
minMaxSearchedIdStats.unsetMaxAndMinSearchedStatusId.increment();
responseMessageBuilder.debugVerbose(</p>
<blockquote>
<div><p>“Got unset maxSearchedStatusID and minSearchedStatusID. Request: %s, Response: %s”,
request, response);</p>
</div></blockquote>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Return partition counts with number of partitions, number of successful responses, and list of</p></li>
<li><p>responses per tier.</p></li>
</ul>
<p><a href="#id23"><span class="problematic" id="id24">*</span></a>/</p>
</dd>
</dl>
<p>public abstract AccumulatedResponses.PartitionCounts getPartitionCounts();</p>
<dl class="simple">
<dt>public final AccumulatedResponses getAccumulatedResults() {</dt><dd><dl class="simple">
<dt>return new AccumulatedResponses(successResponses,</dt><dd><p>errorResponses,
maxIds,
minIds,
ResponseMergerUtils.mergeEarlyTerminationInfo(successResponses),
isMergingAcrossTiers(),
getPartitionCounts(),
getNumSearchedSegments());</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<p>// Getters are only intended to be used by subclasses.  Other users should get data from
// AccumulatedResponses</p>
<dl class="simple">
<dt>int getNumResponses() {</dt><dd><p>return numResponses;</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>int getNumSearchedSegments() {</dt><dd><p>return numSearchedSegments;</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>List&lt;EarlybirdResponse&gt; getSuccessResponses() {</dt><dd><p>return successResponses;</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>int getNumResultsAccumulated() {</dt><dd><p>return numResultsAccumulated;</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>int getSuccessfulEmptyResponseCount() {</dt><dd><p>return successfulEmptyResponseCount;</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>boolean foundError() {</dt><dd><p>return !errorResponses.isEmpty();</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>boolean foundEarlyTermination() {</dt><dd><p>return foundEarlyTermination;</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../../index.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../../_sources/src/java/com/twitter/search/earlybird_root/mergers/ResponseAccumulator.java.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>