<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../../../" id="documentation_options" src="../../../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>package com.twitter.search.ingester.pipeline.twitter;</p>
<p>import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.TimeUnit;
import javax.annotation.Nonnull;</p>
<p>import com.google.common.annotations.VisibleForTesting;</p>
<p>import org.apache.commons.pipeline.StageException;
import org.apache.commons.pipeline.validation.ConsumedTypes;
import org.apache.commons.pipeline.validation.ProducedTypes;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;</p>
<p>import com.twitter.search.common.metrics.SearchCounter;
import com.twitter.search.common.metrics.SearchDelayStats;
import com.twitter.search.common.partitioning.snowflakeparser.SnowflakeIdParser;
import com.twitter.search.ingester.model.IngesterTweetEvent;
import com.twitter.search.ingester.pipeline.util.PipelineStageRuntimeException;
import com.twitter.tweetypie.thriftjava.Tweet;
import com.twitter.tweetypie.thriftjava.TweetCreateEvent;
import com.twitter.tweetypie.thriftjava.TweetEvent;
import com.twitter.tweetypie.thriftjava.TweetEventData;
import com.twitter.tweetypie.thriftjava.TweetEventFlags;</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Only lets through the create events that match the specified safety type.</p></li>
<li><p>Also lets through all delete events.</p></li>
</ul>
<p><a href="#id1"><span class="problematic" id="id2">*</span></a>/</p>
</dd>
</dl>
<p>&#64;ConsumedTypes(IngesterTweetEvent.class)
&#64;ProducedTypes(IngesterTweetEvent.class)
public class FilterEventsBySafetyTypeStage extends TwitterBaseStage</p>
<blockquote>
<div><blockquote>
<div><p>&lt;IngesterTweetEvent, IngesterTweetEvent&gt; {</p>
</div></blockquote>
<p>private static final Logger LOG = LoggerFactory.getLogger(FilterEventsBySafetyTypeStage.class);</p>
<p>private SearchCounter totalEventsCount;
private SearchCounter createEventsCount;
private SearchCounter createPublicEventsCount;
private SearchCounter createProtectedEventsCount;
private SearchCounter createRestrictedEventsCount;
private SearchCounter createInvalidSafetyTypeCount;
private SearchCounter deleteEventsCount;
private SearchCounter deletePublicEventsCount;
private SearchCounter deleteProtectedEventsCount;
private SearchCounter deleteRestrictedEventsCount;
private SearchCounter deleteInvalidSafetyTypeCount;
private SearchCounter otherEventsCount;</p>
<p>private SearchDelayStats tweetCreateDelayStats;</p>
<p>private long tweetCreateLatencyLogThresholdMillis = -1;
private SafetyType safetyType = null;
private Map&lt;String, Map&lt;String, SearchCounter&gt;&gt; invalidSafetyTypeByEventTypeStatMap =</p>
<blockquote>
<div><p>new ConcurrentHashMap&lt;&gt;();</p>
</div></blockquote>
<p>public FilterEventsBySafetyTypeStage() { }</p>
<dl class="simple">
<dt>public FilterEventsBySafetyTypeStage(String safetyType, long tweetCreateLatencyThresholdMillis) {</dt><dd><p>setSafetyType(safetyType);
this.tweetCreateLatencyLogThresholdMillis = tweetCreateLatencyThresholdMillis;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>To be called by XML config. Can be made private after we delete ACP code.</p></li>
</ul>
<p><a href="#id3"><span class="problematic" id="id4">*</span></a>/</p>
</dd>
<dt>public void setSafetyType(&#64;Nonnull String safetyTypeString) {</dt><dd><p>this.safetyType = SafetyType.valueOf(safetyTypeString);
if (this.safetyType == SafetyType.INVALID) {</p>
<blockquote>
<div><dl class="simple">
<dt>throw new UnsupportedOperationException(</dt><dd><p>“Can’t create a stage that permits ‘INVALID’ safetytypes”);</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}</p>
<p>&#64;Override
protected void initStats() {</p>
<blockquote>
<div><p>super.initStats();
innerSetupStats();</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
protected void innerSetupStats() {</p>
<blockquote>
<div><p>totalEventsCount = SearchCounter.export(getStageNamePrefix() + “_total_events_count”);
createEventsCount = SearchCounter.export(getStageNamePrefix() + “_create_events_count”);
createPublicEventsCount =</p>
<blockquote>
<div><p>SearchCounter.export(getStageNamePrefix() + “_create_public_events_count”);</p>
</div></blockquote>
<dl class="simple">
<dt>createProtectedEventsCount =</dt><dd><p>SearchCounter.export(getStageNamePrefix() + “_create_protected_events_count”);</p>
</dd>
<dt>createRestrictedEventsCount =</dt><dd><p>SearchCounter.export(getStageNamePrefix() + “_create_restricted_events_count”);</p>
</dd>
<dt>createInvalidSafetyTypeCount =</dt><dd><p>SearchCounter.export(getStageNamePrefix() + “_create_missing_or_unknown_safetytype”);</p>
</dd>
<dt>deleteEventsCount =</dt><dd><p>SearchCounter.export(getStageNamePrefix() + “_delete_events_count”);</p>
</dd>
<dt>deletePublicEventsCount =</dt><dd><p>SearchCounter.export(getStageNamePrefix() + “_delete_public_events_count”);</p>
</dd>
<dt>deleteProtectedEventsCount =</dt><dd><p>SearchCounter.export(getStageNamePrefix() + “_delete_protected_events_count”);</p>
</dd>
<dt>deleteRestrictedEventsCount =</dt><dd><p>SearchCounter.export(getStageNamePrefix() + “_delete_restricted_events_count”);</p>
</dd>
<dt>deleteInvalidSafetyTypeCount =</dt><dd><p>SearchCounter.export(getStageNamePrefix() + “_delete_missing_or_unknown_safetytype”);</p>
</dd>
<dt>otherEventsCount =</dt><dd><p>SearchCounter.export(getStageNamePrefix() + “_other_events_count”);</p>
</dd>
<dt>tweetCreateDelayStats = SearchDelayStats.export(</dt><dd><p>“<a href="#id7"><span class="problematic" id="id8">create_histogram_</span></a>” + getStageNamePrefix(), 90,
TimeUnit.SECONDS, TimeUnit.MILLISECONDS);</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
<p>&#64;Override
public void innerProcess(Object obj) throws StageException {</p>
<blockquote>
<div><dl>
<dt>if (obj instanceof IngesterTweetEvent) {</dt><dd><p>IngesterTweetEvent tweetEvent = (IngesterTweetEvent) obj;
if (tryToRecordCreateLatency(tweetEvent)) {</p>
<blockquote>
<div><p>emitAndCount(tweetEvent);</p>
</div></blockquote>
<p>}</p>
</dd>
<dt>} else {</dt><dd><p>throw new StageException(this, “Object is not a IngesterTweetEvent: “ + obj);</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}</p>
<p>&#64;Override
protected IngesterTweetEvent innerRunStageV2(IngesterTweetEvent tweetEvent) {</p>
<blockquote>
<div><dl class="simple">
<dt>if (!tryToRecordCreateLatency(tweetEvent)) {</dt><dd><p>throw new PipelineStageRuntimeException(“Event does not have to pass to the next stage.”);</p>
</dd>
</dl>
<p>}
return tweetEvent;</p>
</div></blockquote>
<p>}</p>
<dl>
<dt>private boolean tryToRecordCreateLatency(IngesterTweetEvent tweetEvent) {</dt><dd><p>incrementCounters(tweetEvent);
boolean shouldEmit = shouldEmit(tweetEvent);
if (shouldEmit) {</p>
<blockquote>
<div><dl class="simple">
<dt>if (isCreateEvent(tweetEvent.getData())) {</dt><dd><p>recordCreateLatency(tweetEvent.getData().getTweet_create_event());</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}
return shouldEmit;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private void incrementCounters(&#64;Nonnull TweetEvent tweetEvent) {</dt><dd><p>totalEventsCount.increment();
SafetyType eventSafetyType = getEventSafetyType(tweetEvent);</p>
<dl>
<dt>if (isCreateEvent(tweetEvent.getData())) {</dt><dd><p>createEventsCount.increment();
switch (eventSafetyType) {</p>
<blockquote>
<div><dl class="simple">
<dt>case PUBLIC:</dt><dd><p>createPublicEventsCount.increment();
break;</p>
</dd>
<dt>case PROTECTED:</dt><dd><p>createProtectedEventsCount.increment();
break;</p>
</dd>
<dt>case RESTRICTED:</dt><dd><p>createRestrictedEventsCount.increment();
break;</p>
</dd>
<dt>default:</dt><dd><p>createInvalidSafetyTypeCount.increment();
incrementInvalidSafetyTypeStatMap(tweetEvent, “create”);</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
</dd>
<dt>} else if (isDeleteEvent(tweetEvent.getData())) {</dt><dd><p>deleteEventsCount.increment();
switch (eventSafetyType) {</p>
<blockquote>
<div><dl class="simple">
<dt>case PUBLIC:</dt><dd><p>deletePublicEventsCount.increment();
break;</p>
</dd>
<dt>case PROTECTED:</dt><dd><p>deleteProtectedEventsCount.increment();
break;</p>
</dd>
<dt>case RESTRICTED:</dt><dd><p>deleteRestrictedEventsCount.increment();
break;</p>
</dd>
<dt>default:</dt><dd><p>deleteInvalidSafetyTypeCount.increment();
incrementInvalidSafetyTypeStatMap(tweetEvent, “delete”);</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
</dd>
<dt>} else {</dt><dd><p>otherEventsCount.increment();</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private void incrementInvalidSafetyTypeStatMap(TweetEvent tweetEvent, String eventType) {</dt><dd><dl class="simple">
<dt>com.twitter.tweetypie.thriftjava.SafetyType thriftSafetyType =</dt><dd><p>tweetEvent.getFlags().getSafety_type();</p>
</dd>
<dt>String safetyTypeString =</dt><dd><p>thriftSafetyType == null ? “null” : thriftSafetyType.toString().toLowerCase();</p>
</dd>
</dl>
<p>invalidSafetyTypeByEventTypeStatMap.putIfAbsent(eventType, new ConcurrentHashMap&lt;&gt;());
SearchCounter stat = invalidSafetyTypeByEventTypeStatMap.get(eventType).computeIfAbsent(</p>
<blockquote>
<div><p>safetyTypeString,
safetyTypeStr -&gt; SearchCounter.export(</p>
<blockquote>
<div><dl>
<dt>getStageNamePrefix()</dt><dd><ul class="simple">
<li><p>String.format(“_%s_missing_or_unknown_safetytype_%s”,</p></li>
</ul>
<p>eventType, safetyTypeStr)));</p>
</dd>
</dl>
</div></blockquote>
</div></blockquote>
<p>stat.increment();</p>
</dd>
</dl>
<p>}</p>
<p>&#64;VisibleForTesting
boolean shouldEmit(&#64;Nonnull TweetEvent tweetEvent) {</p>
<blockquote>
<div><p>// Do not emit any undelete events.
if (isUndeleteEvent(tweetEvent.getData())) {</p>
<blockquote>
<div><p>return false;</p>
</div></blockquote>
<p>}</p>
<p>SafetyType eventSafetyType = getEventSafetyType(tweetEvent);
// Custom logic for REALTIME_CG cluster
if (safetyType == SafetyType.PUBLIC_OR_PROTECTED) {</p>
<blockquote>
<div><p>return eventSafetyType == SafetyType.PUBLIC || eventSafetyType == SafetyType.PROTECTED;</p>
</div></blockquote>
<dl class="simple">
<dt>} else {</dt><dd><p>return eventSafetyType == safetyType;</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}</p>
<dl class="simple">
<dt>private SafetyType getEventSafetyType(&#64;Nonnull TweetEvent tweetEvent) {</dt><dd><p>TweetEventFlags tweetEventFlags = tweetEvent.getFlags();
return SafetyType.fromThriftSafetyType(tweetEventFlags.getSafety_type());</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>private boolean isCreateEvent(&#64;Nonnull TweetEventData tweetEventData) {</dt><dd><p>return tweetEventData.isSet(TweetEventData._Fields.TWEET_CREATE_EVENT);</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>private boolean isDeleteEvent(&#64;Nonnull TweetEventData tweetEventData) {</dt><dd><p>return tweetEventData.isSet(TweetEventData._Fields.TWEET_DELETE_EVENT);</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>private boolean isUndeleteEvent(&#64;Nonnull TweetEventData tweetEventData) {</dt><dd><p>return tweetEventData.isSet(TweetEventData._Fields.TWEET_UNDELETE_EVENT);</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private void recordCreateLatency(TweetCreateEvent tweetCreateEvent) {</dt><dd><p>Tweet tweet = tweetCreateEvent.getTweet();
if (tweet != null) {</p>
<blockquote>
<div><dl class="simple">
<dt>long tweetCreateLatency =</dt><dd><p>clock.nowMillis() - SnowflakeIdParser.getTimestampFromTweetId(tweet.getId());</p>
</dd>
</dl>
<p>tweetCreateDelayStats.recordLatency(tweetCreateLatency, TimeUnit.MILLISECONDS);
if (tweetCreateLatency &lt; 0) {</p>
<blockquote>
<div><p>LOG.warn(“Received a tweet created in the future: {}”, tweet);</p>
</div></blockquote>
<dl>
<dt>} else if (tweetCreateLatencyLogThresholdMillis &gt; 0</dt><dd><blockquote>
<div><p>&amp;&amp; tweetCreateLatency &gt; tweetCreateLatencyLogThresholdMillis) {</p>
</div></blockquote>
<dl class="simple">
<dt>LOG.debug(“Found late incoming tweet: {}. Create latency: {}ms. Tweet: {}”,</dt><dd><p>tweet.getId(), tweetCreateLatency, tweet);</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>public void setTweetCreateLatencyLogThresholdMillis(long tweetCreateLatencyLogThresholdMillis) {</dt><dd><dl class="simple">
<dt>LOG.info(“Setting tweetCreateLatencyLogThresholdMillis to {}.”,</dt><dd><p>tweetCreateLatencyLogThresholdMillis);</p>
</dd>
</dl>
<p>this.tweetCreateLatencyLogThresholdMillis = tweetCreateLatencyLogThresholdMillis;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>public enum SafetyType {</dt><dd><p>PUBLIC,
PROTECTED,
RESTRICTED,
PUBLIC_OR_PROTECTED,
INVALID;</p>
<p>/** Converts a tweetypie SafetyType instance to an instance of this enum. <a href="#id5"><span class="problematic" id="id6">*</span></a>/
&#64;Nonnull
public static SafetyType fromThriftSafetyType(</p>
<blockquote>
<div><blockquote>
<div><p>com.twitter.tweetypie.thriftjava.SafetyType safetyType) {</p>
</div></blockquote>
<dl class="simple">
<dt>if (safetyType == null) {</dt><dd><p>return INVALID;</p>
</dd>
</dl>
<p>}
switch(safetyType) {</p>
<blockquote>
<div><dl class="simple">
<dt>case PRIVATE:</dt><dd><p>return PROTECTED;</p>
</dd>
<dt>case PUBLIC:</dt><dd><p>return PUBLIC;</p>
</dd>
<dt>case RESTRICTED:</dt><dd><p>return RESTRICTED;</p>
</dd>
<dt>default:</dt><dd><p>return INVALID;</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}</p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../../../index.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../../../_sources/src/java/com/twitter/search/ingester/pipeline/twitter/FilterEventsBySafetyTypeStage.java.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>