<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../../../" id="documentation_options" src="../../../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>package com.twitter.search.ingester.pipeline.util;</p>
<p>import java.util.Collection;
import java.util.Collections;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.Set;
import javax.annotation.Nullable;</p>
<p>import com.google.common.annotations.VisibleForTesting;
import com.google.common.base.Preconditions;
import com.google.common.collect.ImmutableList;
import com.google.common.collect.Lists;
import com.google.common.collect.Maps;</p>
<p>import org.apache.thrift.TBase;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;</p>
<p>import com.twitter.common_internal.analytics.test_user_filter.TestUserFilter;
import com.twitter.common_internal.text.version.PenguinVersion;
import com.twitter.metastore.client_v2.MetastoreClient;
import com.twitter.metastore.data.MetastoreColumn;
import com.twitter.metastore.data.MetastoreException;
import com.twitter.metastore.data.MetastoreRow;
import com.twitter.metastore.data.MetastoreValue;
import com.twitter.search.common.metrics.RelevanceStats;
import com.twitter.search.common.metrics.SearchCounter;
import com.twitter.search.common.metrics.SearchRateCounter;
import com.twitter.search.common.metrics.SearchRequestStats;
import com.twitter.search.common.relevance.entities.TwitterMessage;
import com.twitter.search.common.relevance.features.RelevanceSignalConstants;
import com.twitter.search.ingester.model.IngesterTwitterMessage;
import com.twitter.service.metastore.gen.ResponseCode;
import com.twitter.service.metastore.gen.TweepCred;
import com.twitter.util.Function;
import com.twitter.util.Future;</p>
<dl>
<dt>public class UserPropertiesManager {</dt><dd><p>private static final Logger LOG = LoggerFactory.getLogger(UserPropertiesManager.class);</p>
<p>&#64;VisibleForTesting
protected static final List&lt;MetastoreColumn&lt;? extends TBase&lt;?, ?&gt;&gt;&gt; COLUMNS =</p>
<blockquote>
<div><p>ImmutableList.of(MetastoreColumn.TWEEPCRED);           // contains tweepcred value</p>
</div></blockquote>
<p>// same spam threshold that is use in tweeypie to spread user level spam to tweets, all tweets
// from user with spam score above such are marked so and removed from search results
&#64;VisibleForTesting
public static final double SPAM_SCORE_THRESHOLD = 4.5;</p>
<p>&#64;VisibleForTesting
static final SearchRequestStats MANHATTAN_METASTORE_STATS =</p>
<blockquote>
<div><p>SearchRequestStats.export(“manhattan_metastore_get”, true);</p>
</div></blockquote>
<dl class="simple">
<dt>private static final MetastoreGetColumnStats GET_TWEEP_CRED</dt><dd><p>= new MetastoreGetColumnStats(“tweep_cred”);</p>
</dd>
</dl>
<p>&#64;VisibleForTesting
static final SearchRateCounter MISSING_REPUTATION_COUNTER = RelevanceStats.exportRate(</p>
<blockquote>
<div><p>“num_missing_reputation”);</p>
</div></blockquote>
<p>&#64;VisibleForTesting
static final SearchRateCounter INVALID_REPUTATION_COUNTER = RelevanceStats.exportRate(</p>
<blockquote>
<div><p>“num_invalid_reputation”);</p>
</div></blockquote>
<p>&#64;VisibleForTesting
static final SearchRateCounter ACCEPTED_REPUTATION_COUNTER = RelevanceStats.exportRate(</p>
<blockquote>
<div><p>“num_accepted_reputation”);</p>
</div></blockquote>
<p>&#64;VisibleForTesting
static final SearchRateCounter SKIPPED_REPUTATION_CHECK_COUNTER = RelevanceStats.exportRate(</p>
<blockquote>
<div><p>“num_skipped_reputation_check_for_test_user”);</p>
</div></blockquote>
<p>&#64;VisibleForTesting
static final SearchCounter DEFAULT_REPUTATION_COUNTER = SearchCounter.export(</p>
<blockquote>
<div><p>“messages_default_reputation_count”);</p>
</div></blockquote>
<p>&#64;VisibleForTesting
static final SearchCounter MESSAGE_FROM_TEST_USER =</p>
<blockquote>
<div><p>SearchCounter.export(“messages_from_test_user”);</p>
</div></blockquote>
<p>// User level bits that are spread onto tweets
private static final SearchRateCounter IS_USER_NSFW_COUNTER = RelevanceStats.exportRate(</p>
<blockquote>
<div><p>“num_is_nsfw”);</p>
</div></blockquote>
<dl class="simple">
<dt>private static final SearchRateCounter IS_USER_SPAM_COUNTER = RelevanceStats.exportRate(</dt><dd><p>“num_is_spam”);</p>
</dd>
</dl>
<p>// count how many tweets has “possibly_sensitive” set to true in the original json message
private static final SearchRateCounter IS_SENSITIVE_FROM_JSON_COUNTER = RelevanceStats.exportRate(</p>
<blockquote>
<div><p>“num_is_sensitive_in_json”);</p>
</div></blockquote>
<dl class="simple">
<dt>private static final SearchCounter SENSITIVE_BITS_COUNTER =</dt><dd><p>SearchCounter.export(“messages_sensitive_bits_set_count”);</p>
</dd>
</dl>
<p>private final MetastoreClient metastoreClient;
private final UserPropertiesManager.MetastoreGetColumnStats tweepCredStats;</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Stats for keeping track of multiGet requests to metastore for a specific data column.</p></li>
</ul>
<p><a href="#id1"><span class="problematic" id="id2">*</span></a>/</p>
</dd>
<dt>&#64;VisibleForTesting static class MetastoreGetColumnStats {</dt><dd><dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>No data was returned from metastore for a specific user.</p></li>
</ul>
<p><a href="#id3"><span class="problematic" id="id4">*</span></a>/</p>
</dd>
</dl>
<p>private final SearchCounter notReturned;
/**</p>
<blockquote>
<div><ul class="simple">
<li><p>Metastore returned a successful OK response.</p></li>
</ul>
<p><a href="#id5"><span class="problematic" id="id6">*</span></a>/</p>
</div></blockquote>
<p>private final SearchCounter metastoreSuccess;
/**</p>
<blockquote>
<div><ul class="simple">
<li><p>Metastore returned a NOT_FOUND response for a user.</p></li>
</ul>
<p><a href="#id7"><span class="problematic" id="id8">*</span></a>/</p>
</div></blockquote>
<p>private final SearchCounter metastoreNotFound;
/**</p>
<blockquote>
<div><ul class="simple">
<li><p>Metastore returned a BAD_INPUT response for a user.</p></li>
</ul>
<p><a href="#id9"><span class="problematic" id="id10">*</span></a>/</p>
</div></blockquote>
<p>private final SearchCounter metastoreBadInput;
/**</p>
<blockquote>
<div><ul class="simple">
<li><p>Metastore returned a TRANSIENT_ERROR response for a user.</p></li>
</ul>
<p><a href="#id11"><span class="problematic" id="id12">*</span></a>/</p>
</div></blockquote>
<p>private final SearchCounter metastoreTransientError;
/**</p>
<blockquote>
<div><ul class="simple">
<li><p>Metastore returned a PERMANENT_ERROR response for a user.</p></li>
</ul>
<p><a href="#id13"><span class="problematic" id="id14">*</span></a>/</p>
</div></blockquote>
<p>private final SearchCounter metastorePermanentError;
/**</p>
<blockquote>
<div><ul class="simple">
<li><p>Metastore returned an unknown response code for a user.</p></li>
</ul>
<p><a href="#id15"><span class="problematic" id="id16">*</span></a>/</p>
</div></blockquote>
<p>private final SearchCounter metastoreUnknownResponseCode;
/**</p>
<blockquote>
<div><ul class="simple">
<li><p>Total number of users that we asked data for in metastore.</p></li>
</ul>
<p><a href="#id17"><span class="problematic" id="id18">*</span></a>/</p>
</div></blockquote>
<p>private final SearchCounter totalRequests;</p>
<dl>
<dt>&#64;VisibleForTesting MetastoreGetColumnStats(String columnName) {</dt><dd><p>String prefix = “<a href="#id29"><span class="problematic" id="id30">manhattan_metastore_get_</span></a>” + columnName;
notReturned = SearchCounter.export(prefix + “_response_not_returned”);
metastoreSuccess = SearchCounter.export(prefix + “_response_success”);
metastoreNotFound = SearchCounter.export(prefix + “_response_not_found”);
metastoreBadInput = SearchCounter.export(prefix + “_response_bad_input”);
metastoreTransientError = SearchCounter.export(prefix + “_response_transient_error”);
metastorePermanentError = SearchCounter.export(prefix + “_response_permanent_error”);
metastoreUnknownResponseCode =</p>
<blockquote>
<div><p>SearchCounter.export(prefix + “_response_unknown_response_code”);</p>
</div></blockquote>
<p>// Have a distinguishable prefix for the total requests stat so that we can use it to get
// a viz rate against wild-carded “prefix_response_*” stats.
totalRequests = SearchCounter.export(prefix + “_requests”);</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Tracks metastore get column stats for an individual user’s response.</p></li>
<li><p>&#64;param responseCode the response code received from metastore. Expected to be null if no</p></li>
<li><p>response came back at all.</p></li>
</ul>
<p><a href="#id19"><span class="problematic" id="id20">*</span></a>/</p>
</dd>
<dt>private void trackMetastoreResponseCode(&#64;Nullable ResponseCode responseCode) {</dt><dd><p>totalRequests.increment();</p>
<dl class="simple">
<dt>if (responseCode == null) {</dt><dd><p>notReturned.increment();</p>
</dd>
<dt>} else if (responseCode == ResponseCode.OK) {</dt><dd><p>metastoreSuccess.increment();</p>
</dd>
<dt>} else if (responseCode == ResponseCode.NOT_FOUND) {</dt><dd><p>metastoreNotFound.increment();</p>
</dd>
<dt>} else if (responseCode == ResponseCode.BAD_INPUT) {</dt><dd><p>metastoreBadInput.increment();</p>
</dd>
<dt>} else if (responseCode == ResponseCode.TRANSIENT_ERROR) {</dt><dd><p>metastoreTransientError.increment();</p>
</dd>
<dt>} else if (responseCode == ResponseCode.PERMANENT_ERROR) {</dt><dd><p>metastorePermanentError.increment();</p>
</dd>
<dt>} else {</dt><dd><p>metastoreUnknownResponseCode.increment();</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>&#64;VisibleForTesting long getTotalRequests() {</dt><dd><p>return totalRequests.get();</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>&#64;VisibleForTesting long getNotReturnedCount() {</dt><dd><p>return notReturned.get();</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>&#64;VisibleForTesting long getMetastoreSuccessCount() {</dt><dd><p>return metastoreSuccess.get();</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>&#64;VisibleForTesting long getMetastoreNotFoundCount() {</dt><dd><p>return metastoreNotFound.get();</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>&#64;VisibleForTesting long getMetastoreBadInputCount() {</dt><dd><p>return metastoreBadInput.get();</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>&#64;VisibleForTesting long getMetastoreTransientErrorCount() {</dt><dd><p>return metastoreTransientError.get();</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>&#64;VisibleForTesting long getMetastorePermanentErrorCount() {</dt><dd><p>return metastorePermanentError.get();</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>&#64;VisibleForTesting long getMetastoreUnknownResponseCodeCount() {</dt><dd><p>return metastoreUnknownResponseCode.get();</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<p>/** Class that holds all user properties from Manhattan. <a href="#id21"><span class="problematic" id="id22">*</span></a>/
&#64;VisibleForTesting
protected static class ManhattanUserProperties {</p>
<blockquote>
<div><p>private double spamScore = 0;
private float tweepcred = RelevanceSignalConstants.UNSET_REPUTATION_SENTINEL;   // default</p>
<dl class="simple">
<dt>public ManhattanUserProperties setSpamScore(double newSpamScore) {</dt><dd><p>this.spamScore = newSpamScore;
return this;</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>public float getTweepcred() {</dt><dd><p>return tweepcred;</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>public ManhattanUserProperties setTweepcred(float newTweepcred) {</dt><dd><p>this.tweepcred = newTweepcred;
return this;</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}</p>
<dl class="simple">
<dt>public UserPropertiesManager(MetastoreClient metastoreClient) {</dt><dd><p>this(metastoreClient, GET_TWEEP_CRED);</p>
</dd>
</dl>
<p>}</p>
<p>&#64;VisibleForTesting
UserPropertiesManager(</p>
<blockquote>
<div><blockquote>
<div><p>MetastoreClient metastoreClient,
MetastoreGetColumnStats tweepCredStats) {</p>
</div></blockquote>
<p>this.metastoreClient = metastoreClient;
this.tweepCredStats = tweepCredStats;</p>
</div></blockquote>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Gets user properties including TWEEPCRED, SpamScore values/flags from metastore for the</p></li>
<li><p>given userids.</p></li>
<li></li>
<li><p>&#64;param userIds the list of users for which to get the properties.</p></li>
<li><p>&#64;return mapping from userId to UserProperties. If a user’s twepcred score is not present in the</p></li>
<li><p>metastore, of if there was a problem retrieving it, that user’s score will not be set in the</p></li>
<li><p>returned map.</p></li>
</ul>
<p><a href="#id23"><span class="problematic" id="id24">*</span></a>/</p>
</dd>
</dl>
<p>&#64;VisibleForTesting
Future&lt;Map&lt;Long, ManhattanUserProperties&gt;&gt; getManhattanUserProperties(final List&lt;Long&gt; userIds) {</p>
<blockquote>
<div><p>Preconditions.checkArgument(userIds != null);
if (metastoreClient == null || userIds.isEmpty()) {</p>
<blockquote>
<div><p>return Future.value(Collections.emptyMap());</p>
</div></blockquote>
<p>}</p>
<p>final long start = System.currentTimeMillis();</p>
<dl>
<dt>return metastoreClient.multiGet(userIds, COLUMNS)</dt><dd><dl>
<dt>.map(new Function&lt;Map&lt;Long, MetastoreRow&gt;, Map&lt;Long, ManhattanUserProperties&gt;&gt;() {</dt><dd><p>&#64;Override
public Map&lt;Long, ManhattanUserProperties&gt; apply(Map&lt;Long, MetastoreRow&gt; response) {</p>
<blockquote>
<div><p>long latencyMs = System.currentTimeMillis() - start;
Map&lt;Long, ManhattanUserProperties&gt; resultMap =</p>
<blockquote>
<div><p>Maps.newHashMapWithExpectedSize(userIds.size());</p>
</div></blockquote>
<dl class="simple">
<dt>for (Long userId<span class="classifier">userIds) {</span></dt><dd><p>MetastoreRow row = response.get(userId);
processTweepCredColumn(userId, row, resultMap);</p>
</dd>
</dl>
<p>}</p>
<p>MANHATTAN_METASTORE_STATS.requestComplete(latencyMs, resultMap.size(), true);
return resultMap;</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>})
.handle(new Function&lt;Throwable, Map&lt;Long, ManhattanUserProperties&gt;&gt;() {</p>
<blockquote>
<div><p>&#64;Override
public Map&lt;Long, ManhattanUserProperties&gt; apply(Throwable t) {</p>
<blockquote>
<div><p>long latencyMs = System.currentTimeMillis() - start;
LOG.error(“Exception talking to metastore after “ + latencyMs + “ ms.”, t);</p>
<p>MANHATTAN_METASTORE_STATS.requestComplete(latencyMs, 0, false);
return Collections.emptyMap();</p>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>});</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Process the TweepCred column data returned from metastore, takes TweepCred, fills in the</p></li>
<li><p>the resultMap as appropriate.</p></li>
</ul>
<p><a href="#id25"><span class="problematic" id="id26">*</span></a>/</p>
</dd>
<dt>private void processTweepCredColumn(</dt><dd><blockquote>
<div><p>Long userId,
MetastoreRow metastoreRow,
Map&lt;Long, ManhattanUserProperties&gt; resultMap) {</p>
</div></blockquote>
<dl class="simple">
<dt>MetastoreValue&lt;TweepCred&gt; tweepCredValue =</dt><dd><p>metastoreRow == null ? null : metastoreRow.getValue(MetastoreColumn.TWEEPCRED);</p>
</dd>
</dl>
<p>ResponseCode responseCode = tweepCredValue == null ? null : tweepCredValue.getResponseCode();
tweepCredStats.trackMetastoreResponseCode(responseCode);</p>
<dl>
<dt>if (responseCode == ResponseCode.OK) {</dt><dd><dl>
<dt>try {</dt><dd><p>TweepCred tweepCred = tweepCredValue.getValue();
if (tweepCred != null &amp;&amp; tweepCred.isSetScore()) {</p>
<blockquote>
<div><dl class="simple">
<dt>ManhattanUserProperties manhattanUserProperties =</dt><dd><p>getOrCreateManhattanUserProperties(userId, resultMap);</p>
</dd>
</dl>
<p>manhattanUserProperties.setTweepcred(tweepCred.getScore());</p>
</div></blockquote>
<p>}</p>
</dd>
<dt>} catch (MetastoreException e) {</dt><dd><p>// guaranteed not to be thrown if ResponseCode.OK
LOG.warn(“Unexpected MetastoreException parsing userinfo column!”, e);</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private static ManhattanUserProperties getOrCreateManhattanUserProperties(</dt><dd><blockquote>
<div><p>Long userId, Map&lt;Long, ManhattanUserProperties&gt; resultMap) {</p>
</div></blockquote>
<p>ManhattanUserProperties manhattanUserProperties = resultMap.get(userId);
if (manhattanUserProperties == null) {</p>
<blockquote>
<div><p>manhattanUserProperties = new ManhattanUserProperties();
resultMap.put(userId, manhattanUserProperties);</p>
</div></blockquote>
<p>}</p>
<p>return manhattanUserProperties;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Populates the user properties from the given batch.</p></li>
</ul>
<p><a href="#id27"><span class="problematic" id="id28">*</span></a>/</p>
</dd>
<dt>public  Future&lt;Collection&lt;IngesterTwitterMessage&gt;&gt; populateUserProperties(</dt><dd><blockquote>
<div><p>Collection&lt;IngesterTwitterMessage&gt; batch) {</p>
</div></blockquote>
<p>Set&lt;Long&gt; userIds = new HashSet&lt;&gt;();
for (IngesterTwitterMessage message : batch) {</p>
<blockquote>
<div><dl>
<dt>if ((message.getUserReputation() == IngesterTwitterMessage.DOUBLE_FIELD_NOT_PRESENT)</dt><dd><blockquote>
<div><p>&amp;&amp; !message.isDeleted()) {</p>
</div></blockquote>
<p>Optional&lt;Long&gt; userId = message.getFromUserTwitterId();
if (userId.isPresent()) {</p>
<blockquote>
<div><p>userIds.add(userId.get());</p>
</div></blockquote>
<dl class="simple">
<dt>} else {</dt><dd><p>LOG.error(“No user id present for tweet {}”, message.getId());</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}
List&lt;Long&gt; uniqIds = Lists.newArrayList(userIds);
Collections.sort(uniqIds);   // for testing predictability</p>
<dl>
<dt>Future&lt;Map&lt;Long, ManhattanUserProperties&gt;&gt; manhattanUserPropertiesMap =</dt><dd><p>getManhattanUserProperties(uniqIds);</p>
</dd>
<dt>return manhattanUserPropertiesMap.map(Function.func(map -&gt; {</dt><dd><dl>
<dt>for (IngesterTwitterMessage message<span class="classifier">batch) {</span></dt><dd><dl>
<dt>if (((message.getUserReputation() != IngesterTwitterMessage.DOUBLE_FIELD_NOT_PRESENT)</dt><dd><blockquote>
<div><p>&amp;&amp; RelevanceSignalConstants.isValidUserReputation(
(int) Math.floor(message.getUserReputation())))
|| message.isDeleted()) {</p>
</div></blockquote>
<p>continue;</p>
</dd>
</dl>
<p>}
Optional&lt;Long&gt; optionalUserId = message.getFromUserTwitterId();
if (optionalUserId.isPresent()) {</p>
<blockquote>
<div><p>long userId = optionalUserId.get();
ManhattanUserProperties manhattanUserProperties =  map.get(userId);</p>
<p>final boolean isTestUser = TestUserFilter.isTestUserId(userId);
if (isTestUser) {</p>
<blockquote>
<div><p>MESSAGE_FROM_TEST_USER.increment();</p>
</div></blockquote>
<p>}</p>
<p>// legacy setting of tweepcred
setTweepCred(isTestUser, manhattanUserProperties, message);</p>
<p>// set additional fields
if (setSensitiveBits(manhattanUserProperties, message)) {</p>
<blockquote>
<div><p>SENSITIVE_BITS_COUNTER.increment();</p>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}
return batch;</p>
</dd>
</dl>
<p>}));</p>
</dd>
</dl>
<p>}</p>
<p>// good old tweepcred
private void setTweepCred(</p>
<blockquote>
<div><blockquote>
<div><p>boolean isTestUser,
ManhattanUserProperties manhattanUserProperties,
TwitterMessage message) {</p>
</div></blockquote>
<p>float score = RelevanceSignalConstants.UNSET_REPUTATION_SENTINEL;
if (manhattanUserProperties == null) {</p>
<blockquote>
<div><dl class="simple">
<dt>if (isTestUser) {</dt><dd><p>SKIPPED_REPUTATION_CHECK_COUNTER.increment();</p>
</dd>
<dt>} else {</dt><dd><p>MISSING_REPUTATION_COUNTER.increment();
DEFAULT_REPUTATION_COUNTER.increment();</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<dl>
<dt>} else if (!RelevanceSignalConstants.isValidUserReputation(</dt><dd><blockquote>
<div><p>(int) Math.floor(manhattanUserProperties.tweepcred))) {</p>
</div></blockquote>
<dl class="simple">
<dt>if (!isTestUser) {</dt><dd><p>INVALID_REPUTATION_COUNTER.increment();
DEFAULT_REPUTATION_COUNTER.increment();</p>
</dd>
</dl>
<p>}</p>
</dd>
<dt>} else {</dt><dd><p>score = manhattanUserProperties.tweepcred;
ACCEPTED_REPUTATION_COUNTER.increment();</p>
</dd>
</dl>
<p>}
message.setUserReputation(score);</p>
</div></blockquote>
<p>}</p>
<p>// Sets sensitive content, nsfw, and spam flags in TwitterMessage, further
// sets the following bits in encoded features:
// EarlybirdFeatureConfiguration.IS_SENSITIVE_FLAG
// EarlybirdFeatureConfiguration.IS_USER_NSFW_FLAG
// EarlybirdFeatureConfiguration.IS_USER_SPAM_FLAG
private boolean setSensitiveBits(</p>
<blockquote>
<div><blockquote>
<div><p>ManhattanUserProperties manhattanUserProperties,
TwitterMessage message) {</p>
</div></blockquote>
<dl class="simple">
<dt>if (manhattanUserProperties == null) {</dt><dd><p>return false;</p>
</dd>
</dl>
<p>}</p>
<p>final boolean isUserSpam = manhattanUserProperties.spamScore &gt; SPAM_SCORE_THRESHOLD;
// SEARCH-17413: Compute the field with gizmoduck data.
final boolean isUserNSFW = false;
final boolean anySensitiveBitSet = isUserSpam || isUserNSFW;</p>
<dl class="simple">
<dt>if (message.isSensitiveContent()) {</dt><dd><p>// original json has possibly_sensitive = true, count it
IS_SENSITIVE_FROM_JSON_COUNTER.increment();</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>if (isUserNSFW) {</dt><dd><p>// set EarlybirdFeatureConfiguration.IS_USER_NSFW_FLAG
for (PenguinVersion penguinVersion : message.getSupportedPenguinVersions()) {</p>
<blockquote>
<div><p>message.getTweetUserFeatures(penguinVersion).setNsfw(isUserNSFW);</p>
</div></blockquote>
<p>}
IS_USER_NSFW_COUNTER.increment();</p>
</dd>
</dl>
<p>}
if (isUserSpam) {</p>
<blockquote>
<div><p>// set EarlybirdFeatureConfiguration.IS_USER_SPAM_FLAG
for (PenguinVersion penguinVersion : message.getSupportedPenguinVersions()) {</p>
<blockquote>
<div><p>message.getTweetUserFeatures(penguinVersion).setSpam(isUserSpam);</p>
</div></blockquote>
<p>}
IS_USER_SPAM_COUNTER.increment();</p>
</div></blockquote>
<p>}</p>
<p>// if any of the sensitive bits are set, we return true
return anySensitiveBitSet;</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}</p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../../../index.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../../../_sources/src/java/com/twitter/search/ingester/pipeline/util/UserPropertiesManager.java.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>