<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>&lt;no title&gt; &#8212; twit  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../../../../../../_static/alabaster.css?v=039e1c02" />
    <script data-url_root="../../../../../../../" id="documentation_options" src="../../../../../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>package com.twitter.search.earlybird_root.mergers;</p>
<p>import javax.annotation.Nullable;</p>
<p>import com.google.common.annotations.VisibleForTesting;
import com.google.common.base.Function;
import com.google.common.base.Joiner;
import com.google.common.collect.Iterables;</p>
<p>import org.slf4j.Logger;
import org.slf4j.LoggerFactory;</p>
<p>import com.twitter.search.common.logging.DebugMessageBuilder;
import com.twitter.search.common.metrics.SearchCounter;
import com.twitter.search.earlybird.thrift.EarlybirdRequest;
import com.twitter.search.earlybird.thrift.EarlybirdResponse;
import com.twitter.search.earlybird.thrift.EarlybirdResponseCode;
import com.twitter.search.earlybird.thrift.ThriftSearchQuery;
import com.twitter.search.earlybird.thrift.ThriftSearchResult;</p>
<dl>
<dt>/**</dt><dd><ul class="simple">
<li><p>Collects debug messages to attach to EarlybirdResponse</p></li>
</ul>
<p><a href="#id1"><span class="problematic" id="id2">*</span></a>/</p>
</dd>
<dt>class EarlybirdResponseDebugMessageBuilder {</dt><dd><dl class="simple">
<dt>private static final Logger LOG =</dt><dd><p>LoggerFactory.getLogger(EarlybirdResponseDebugMessageBuilder.class);</p>
</dd>
<dt>private static final Logger TOO_MANY_FAILED_PARTITIONS_LOG =</dt><dd><dl class="simple">
<dt>LoggerFactory.getLogger(String.format(“%s_too_many_failed_partitions”,</dt><dd><p>EarlybirdResponseDebugMessageBuilder.class.getName()));</p>
</dd>
</dl>
</dd>
</dl>
<p>&#64;VisibleForTesting
protected final SearchCounter insufficientValidResponseCounter =</p>
<blockquote>
<div><p>SearchCounter.export(“insufficient_valid_partition_responses_count”);</p>
</div></blockquote>
<p>&#64;VisibleForTesting
protected final SearchCounter validPartitionResponseCounter =</p>
<blockquote>
<div><p>SearchCounter.export(“valid_partition_response_count”);</p>
</div></blockquote>
<p>// the combined debug string for all earlybird responses
private final StringBuilder debugString;
/**</p>
<blockquote>
<div><ul class="simple">
<li><p>A message builder backed by the same <a class="reference external" href="mailto:{&#37;&#52;&#48;link">{<span>&#64;</span>link</a> #debugString} above.</p></li>
</ul>
<p><a href="#id3"><span class="problematic" id="id4">*</span></a>/</p>
</div></blockquote>
<p>private final DebugMessageBuilder debugMessageBuilder;</p>
<p>private static final Joiner JOINER = Joiner.on(”, “);</p>
<dl class="simple">
<dt>EarlybirdResponseDebugMessageBuilder(EarlybirdRequest request) {</dt><dd><p>this(getDebugLevel(request));</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>EarlybirdResponseDebugMessageBuilder(DebugMessageBuilder.Level level) {</dt><dd><p>this.debugString = new StringBuilder();
this.debugMessageBuilder = new DebugMessageBuilder(debugString, level);</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>private static DebugMessageBuilder.Level getDebugLevel(EarlybirdRequest request) {</dt><dd><dl class="simple">
<dt>if (request.isSetDebugMode() &amp;&amp; request.getDebugMode() &gt; 0) {</dt><dd><p>return DebugMessageBuilder.getDebugLevel(request.getDebugMode());</p>
</dd>
<dt>} else if (request.isSetDebugOptions()) {</dt><dd><p>return DebugMessageBuilder.Level.DEBUG_BASIC;</p>
</dd>
<dt>} else {</dt><dd><p>return DebugMessageBuilder.Level.DEBUG_NONE;</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>protected boolean isDebugMode() {</dt><dd><p>return debugMessageBuilder.getDebugLevel() &gt; 0;</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>void append(String msg) {</dt><dd><p>debugString.append(msg);</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>void debugAndLogWarning(String msg) {</dt><dd><dl class="simple">
<dt>if (isDebugMode()) {</dt><dd><p>debugString.append(msg).append(’n’);</p>
</dd>
</dl>
<p>}
LOG.warn(msg);</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>void debugDetailed(String format, Object… args) {</dt><dd><p>debugAtLevel(DebugMessageBuilder.Level.DEBUG_DETAILED, format, args);</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>void debugVerbose(String format, Object… args) {</dt><dd><p>debugAtLevel(DebugMessageBuilder.Level.DEBUG_VERBOSE, format, args);</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>void debugVerbose2(String format, Object… args) {</dt><dd><p>debugAtLevel(DebugMessageBuilder.Level.DEBUG_VERBOSE_2, format, args);</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>void debugAtLevel(DebugMessageBuilder.Level level, String format, Object… args) {</dt><dd><p>boolean levelOK = debugMessageBuilder.isAtLeastLevel(level);
if (levelOK || LOG.isDebugEnabled()) {</p>
<blockquote>
<div><p>// We check both modes here in order to build the formatted message only once.
String message = String.format(format, args);</p>
<p>LOG.debug(message);</p>
<dl class="simple">
<dt>if (levelOK) {</dt><dd><p>debugString.append(message).append(’n’);</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>String debugString() {</dt><dd><p>return debugString.toString();</p>
</dd>
</dl>
<p>}</p>
<dl class="simple">
<dt>DebugMessageBuilder getDebugMessageBuilder() {</dt><dd><p>return debugMessageBuilder;</p>
</dd>
</dl>
<p>}</p>
<dl>
<dt>void logBelowSuccessThreshold(ThriftSearchQuery searchQuery, int numSuccessResponses,</dt><dd><blockquote>
<div><p>int numPartitions, double successThreshold) {</p>
</div></blockquote>
<dl class="simple">
<dt>String rawQuery = (searchQuery != null &amp;&amp; searchQuery.isSetRawQuery())</dt><dd><p>? “[” + searchQuery.getRawQuery() + “]” : “null”;</p>
</dd>
<dt>String serializedQuery = (searchQuery != null &amp;&amp; searchQuery.isSetSerializedQuery())</dt><dd><p>? “[” + searchQuery.getSerializedQuery() + “]” : “null”;</p>
</dd>
</dl>
<p>// Not enough successful responses from partitions.
String errorMessage = String.format(</p>
<blockquote>
<div><dl class="simple">
<dt>“Only %d valid responses returned out of %d partitions for raw query: %s”</dt><dd><ul class="simple">
<li><p>“ serialized query: %s. Lower than threshold of %s”,</p></li>
</ul>
</dd>
</dl>
<p>numSuccessResponses, numPartitions, rawQuery, serializedQuery, successThreshold);</p>
</div></blockquote>
<p>TOO_MANY_FAILED_PARTITIONS_LOG.warn(errorMessage);</p>
<p>insufficientValidResponseCounter.increment();
validPartitionResponseCounter.add(numSuccessResponses);
debugString.append(errorMessage);</p>
</dd>
</dl>
<p>}</p>
<p>&#64;VisibleForTesting
void logResponseDebugInfo(EarlybirdRequest earlybirdRequest,</p>
<blockquote>
<div><blockquote>
<div><p>String partitionTierName,
EarlybirdResponse response) {</p>
</div></blockquote>
<dl class="simple">
<dt>if (response.isSetDebugString() &amp;&amp; !response.getDebugString().isEmpty()) {</dt><dd><dl class="simple">
<dt>debugString.append(String.format(“Received response from [%s] with debug string [%s]”,</dt><dd><p>partitionTierName, response.getDebugString())).append(”n”);</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<dl>
<dt>if (!response.isSetResponseCode()) {</dt><dd><dl class="simple">
<dt>debugAndLogWarning(String.format(</dt><dd><p>“Received Earlybird null response code for query [%s] from [%s]”,
earlybirdRequest, partitionTierName));</p>
</dd>
</dl>
</dd>
<dt>} else if (response.getResponseCode() != EarlybirdResponseCode.SUCCESS</dt><dd><blockquote>
<div><p>&amp;&amp; response.getResponseCode() != EarlybirdResponseCode.PARTITION_SKIPPED
&amp;&amp; response.getResponseCode() != EarlybirdResponseCode.PARTITION_DISABLED
&amp;&amp; response.getResponseCode() != EarlybirdResponseCode.TIER_SKIPPED) {</p>
</div></blockquote>
<dl class="simple">
<dt>debugAndLogWarning(String.format(</dt><dd><p>“Received Earlybird response error [%s] for query [%s] from [%s]”,
response.getResponseCode(), earlybirdRequest, partitionTierName));</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<dl>
<dt>if (debugMessageBuilder.isVerbose2()) {</dt><dd><p>debugVerbose2(“Earlybird [%s] returned response: %s”, partitionTierName, response);</p>
</dd>
<dt>} else if (debugMessageBuilder.isVerbose()) {</dt><dd><dl>
<dt>if (response.isSetSearchResults() &amp;&amp; response.getSearchResults().getResultsSize() &gt; 0) {</dt><dd><dl>
<dt>String ids = JOINER.join(Iterables.transform(</dt><dd><p>response.getSearchResults().getResults(),
new Function&lt;ThriftSearchResult, Long&gt;() {</p>
<blockquote>
<div><p>&#64;Nullable
&#64;Override
public Long apply(ThriftSearchResult result) {</p>
<blockquote>
<div><p>return result.getId();</p>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>}));</p>
</dd>
</dl>
<p>debugVerbose(“Earlybird [%s] returned TweetIDs: %s”, partitionTierName, ids);</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>}</p>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../../../index.html">twit</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, jare.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../../../_sources/src/java/com/twitter/search/earlybird_root/mergers/EarlybirdResponseDebugMessageBuilder.java.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>